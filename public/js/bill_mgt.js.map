{"version":3,"sources":["bill_mgt.js"],"names":["getTableHtml","allBills","num","w","tw","html","push","forEach","b","block_num","getStrValue","wnum","weight","wnum_danding","format","bill_no","getOrder","order_no","order_item_no","brand_no","thickness","width","len","ship_warehouse","contract_no","join","getBillsByNo","bills","data","res","length","bill","item_no","validFloatInput","elem","initValue","minValue","ForceNumericOnly","on","e","$","this","v","val","isNumeric","validIntInput","min","max","numberIntValider","sameText","src","dst","b1","isEmpty","b2","selectedBill","iBillingName","iContractNo","iShipWarehouse","sOrderNo","sOrderItemNo","sBillNo","data_tbody","selectedIdx","curr_bills","selected_bills","btnDelete","checkSelectAll","isModify","billsByOrder","queryData","select2Setup","inputLength","placeholder","url","change","added","text","items","orderItemNoMap","sort","empty","item","append","unselected","resetTableRow","str","value","i","sOrderNoDel","sBillNoDel","billQueryData","elementEventRegister","status","bootbox","alert","confirm","result","ajaxRequestHandle","tmp_bills","k","found","m","sameBill","remove","setHtmlElementDisabled","prop","iModTotalNum","iModTotalWeight","showModifyForm","left","left_num","create_date","shipping_date","settle_date","sales_dep","size_type","checkStatus","showHtmlElement","billing_name","numOfSent","total_weight","weightSend","modal","backdrop","keyboard","changed","bill_name","brandNo","getElementValue","parseInt","sent","toFixedNumber","parseFloat","sent_weight","isJqueryElementEmpty","first","last","hide","find","eq","makeTableBodyTr","batchModifyValues","sBatchModifyItem","iBatchModifyItemValue","stopImmediatePropagation","me","me_value","trim","itemSelected","idx","index","name","weightFactorChanged","billingNameUpdated","Math","pow","nameChanged","toggle","searchHandler","SearchHandlerD","initial","okEventHandler","isExist","select2","get","search_left","JSON","parse","ok","number","sheetName","saveToExcel","shippingBillBox","html_text","trs","tr_click","dblclick","invoices","inv_no","q","obj","jQuery","parseJSON","selectedWaybill","setElementValue","ship_name","ship_to","waybill_no","String","bill_id","_id","tn","toFixedStr","showWaybillData","afterDelete","tr","closest","is","addClass","removeClass","getStrByStatus","vehs","veh","veh_ves_name","indexOf","dw","shipping_address","date2Str","creater","shipper","settler","stringify","isNeedAnalysis"],"mappings":"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","file":"bill_mgt.js","sourcesContent":["$(function () {\r\n  \"use strict\";\r\n\r\n  var iBillingName   = $('#billing_name');\r\n  var iContractNo    = $('#contract_no');\r\n  var iShipWarehouse = $('#ship_warehouse');\r\n\r\n  var sOrderNo     = $('#mod_order_no');\r\n  var sOrderItemNo = $('#order_item_no');\r\n  var sBillNo      = $('#bill_no');\r\n  var data_tbody   = $('#data_tbody');\r\n\r\n  var selectedBill;\r\n  var selectedIdx = 0;\r\n  var curr_bills = [];\r\n  var selected_bills = [];\r\n\r\n  var btnDelete = $('#remove-some');\r\n  $('#action-button').html('<input id=\"select-all\" type=\"checkbox\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"选择所有记录\" />');\r\n  var checkSelectAll = $('#select-all');\r\n\r\n  var isModify = false;\r\n  if (sOrderNo.length) { // 修改\r\n    isModify = true;\r\n    var billsByOrder = [];\r\n    var queryData = {};\r\n    select2Setup(sOrderNo, {inputLength: 5, placeholder: '查找订单号', url: '/get_bill'}, function(data){\r\n      queryData = data;\r\n    });\r\n\r\n    // 订单号处理\r\n    sOrderNo.change(function (e) {\r\n      if (e.added) {\r\n        var order_no = e.added.text;\r\n        var items = queryData.orderItemNoMap[order_no].sort();\r\n        sOrderItemNo.empty();\r\n        sBillNo.empty();\r\n        items.forEach(function(item) {\r\n          sOrderItemNo.append('<option>' + item + '</option>');\r\n        });\r\n\r\n        unselected(sOrderItemNo);\r\n\r\n        billsByOrder = getBillsByNo(queryData.bills, {order_no: order_no, item_no: ''});\r\n        if (billsByOrder.length == 1) {\r\n          sBillNo.append('<option>' + billsByOrder[0].bill_no + '</option>');\r\n        }\r\n\r\n        curr_bills = billsByOrder;\r\n        resetTableRow();\r\n      }\r\n    });\r\n\r\n    // 订单项次号处理\r\n    sOrderItemNo.change(function () {\r\n      var str = this.value;// $('select#order_item_no option:selected').text();\r\n      if (str.length > 0) {\r\n        sBillNo.empty();\r\n        var bills = getBillsByNo(billsByOrder, {order_no: '', item_no: str});\r\n        curr_bills = bills;\r\n        resetTableRow();\r\n\r\n        bills.forEach(function (bill) {\r\n          sBillNo.append('<option>' + bill.bill_no + '</option>');\r\n        });\r\n\r\n        if (bills.length > 1) {\r\n          unselected(sBillNo);\r\n        }\r\n      }\r\n    });\r\n\r\n    // 提单处理\r\n    sBillNo.change(function () {\r\n      var str = $('select#bill_no option:selected').text();\r\n      if (str) {\r\n        var item_no = $('select#order_item_no option:selected').text();\r\n        if (item_no) {\r\n          for (var i = 0; i < billsByOrder.length; ++i) {\r\n            var bill = billsByOrder[i];\r\n            if (bill.bill_no == str && bill.order_item_no == item_no) {\r\n              curr_bills = [];\r\n              curr_bills.push(bill);\r\n              resetTableRow();\r\n              break;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n  } else {  // end of modify bill\r\n    var sOrderNoDel = $('#del_order_no');\r\n    var sBillNoDel = $('#del_bill_no');\r\n\r\n    var billQueryData = {};\r\n    if (sOrderNoDel.length > 0) {\r\n      select2Setup(sOrderNoDel, {inputLength: 5, placeholder: '查找订单号', url: '/get_bill'}, function (data) {\r\n        queryData = data;\r\n        billQueryData = {};\r\n      });\r\n\r\n      sOrderNoDel.change(function (e) {\r\n        if (e.added) {\r\n          sBillNoDel.empty();\r\n          curr_bills = getBillsByNo(queryData.bills, {order_no: e.added.text});\r\n          resetTableRow();\r\n        }\r\n      });\r\n    }\r\n\r\n    if (sBillNoDel.length > 0) {\r\n      select2Setup(sBillNoDel, {inputLength: 5, placeholder: '查找提单号', url: '/get_bill_by_bno'}, function (data) {\r\n        billQueryData = data;\r\n        queryData = {};\r\n      });\r\n\r\n      sBillNoDel.change(function (e) {\r\n        if (e.added) {\r\n          sOrderNoDel.empty();\r\n          curr_bills = getBillsByNo(billQueryData.bills, {bill_no: e.added.text});\r\n          resetTableRow();\r\n        }\r\n      });\r\n    }\r\n\r\n    elementEventRegister(btnDelete, 'click', function() {\r\n      if (selected_bills.length > 0) {\r\n        for (var i = 0; i < selected_bills.length; ++i) {\r\n          if (selected_bills[i].status != '新建') {\r\n            bootbox.alert('选择的提单中存在状态是\"' + selected_bills[i].status + '\",不能删除!');\r\n            return;\r\n          }\r\n        }\r\n        bootbox.confirm('危险!您确定要全部删除? 删除后不能恢复!', function (result) {\r\n          if (result) {\r\n            ajaxRequestHandle('/delete_bill', 'POST', selected_bills, '删除', function () {\r\n              var tmp_bills = [];\r\n              for (var k = 0; k < curr_bills.length; ++k) {\r\n                var found = false;\r\n                for (var m = 0; m < selected_bills.length; ++m) {\r\n                  if (sameBill(curr_bills[k], selected_bills[m])) {\r\n                    selected_bills.remove(m);\r\n                    found = true;\r\n                    break;\r\n                  }\r\n                }\r\n\r\n                if (!found) {\r\n                  tmp_bills.push(curr_bills[k]);\r\n                }\r\n              }\r\n              curr_bills = tmp_bills;\r\n              selected_bills = [];\r\n              resetTableRow();\r\n              sOrderNoDel.val('');\r\n              sBillNoDel.val('');\r\n              setHtmlElementDisabled(btnDelete, true);\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  function deleteOne(bill, afterDelete) {\r\n    if (bill.status != '新建') {\r\n      bootbox.alert('提单状态是' + bill.status + ',不能删除!');\r\n    } else {\r\n      bootbox.confirm('危险!您确定要删除这条提单? 删除后不能恢复!', function (result) {\r\n        if (result) {\r\n          ajaxRequestHandle('/delete_bill', 'POST', [bill], '单行删除', afterDelete);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  elementEventRegister(checkSelectAll, 'click', function() {\r\n    if (curr_bills.length > 0) {\r\n      if (checkSelectAll.prop(\"checked\")) {\r\n        $('.select-bill').prop(\"checked\", true);\r\n        selected_bills = curr_bills;\r\n        setHtmlElementDisabled(btnDelete, false);\r\n      } else {\r\n        $('.select-bill').prop(\"checked\", false);\r\n        selected_bills = [];\r\n        setHtmlElementDisabled(btnDelete, true);\r\n      }\r\n    }\r\n  });\r\n  /////////////////////////////////////////////////////\r\n  // Modify function\r\n  /////////////////////////////////////////////////////\r\n  var iModTotalNum = $('#mod-total-number');\r\n  var iModTotalWeight = $('#mod-total-weight');\r\n  function showModifyForm() {\r\n    $('#h_order_no').text(selectedBill.order_no);\r\n    $('#h_order_item_no').text(selectedBill.order_item_no);\r\n//    $('#h_bill_no').text(selectedBill.bill_no);\r\n\r\n    $('#mod_len').text(selectedBill.len);\r\n    $('#mod_width').text(selectedBill.width);\r\n    $('#mod_thickness').text(selectedBill.thickness);\r\n\r\n    var num = selectedBill.block_num;\r\n    var left = selectedBill.left_num;\r\n    if (!num) {\r\n      $('#mod_num').text('无数据');\r\n      $('#mod_ship_num').text('无');\r\n    } else {\r\n      $('#mod_num').text(num);\r\n      $('#mod_ship_num').text(num - left);\r\n    }\r\n\r\n    $('#status').text(selectedBill.status);\r\n    $('#create_date').text(selectedBill.create_date);//.yyyymmdd_cn());\r\n    $('#shipping_date').text(selectedBill.shipping_date);//.yyyymmdd_cn());\r\n    $('#settle_date').text(selectedBill.settle_date);//.yyyymmdd_cn());\r\n\r\n    $('#mod-sale-dep').text(selectedBill.sales_dep);\r\n    $('#mod-size-type').text(selectedBill.size_type);\r\n    var checkStatus = (selectedBill.status == '已配发' || selectedBill.status == '已结算');\r\n    if (selectedBill.block_num > 0) {\r\n      showHtmlElement($('#mod-tot-num-grp'), true);\r\n      showHtmlElement($('#mod-tot-weight-grp'), false);\r\n      iModTotalNum.prop('disabled', checkStatus);\r\n    } else {\r\n      showHtmlElement($('#mod-tot-num-grp'), false);\r\n      showHtmlElement($('#mod-tot-weight-grp'), true);\r\n      iModTotalWeight.prop('disabled', checkStatus);\r\n    }\r\n\r\n//    if (checkStatus || selectedBill.status.lastIndexOf('已配发', 0) === 0) {\r\n\r\n    $('#brand_no').val(selectedBill.brand_no);\r\n    iBillingName.val(selectedBill.billing_name);\r\n    iShipWarehouse.val(selectedBill.ship_warehouse);\r\n    iContractNo.val(selectedBill.contract_no);\r\n    iModTotalNum.val(selectedBill.block_num);\r\n\r\n    var numOfSent = selectedBill.block_num - selectedBill.left_num;\r\n    validIntInput(iModTotalNum, numOfSent == 0 ? 1 : numOfSent, 2000);\r\n\r\n    iModTotalWeight.val(selectedBill.total_weight);\r\n    var weightSend = selectedBill.total_weight - selectedBill.left_num;\r\n    validFloatInput(iModTotalWeight, selectedBill.total_weight, weightSend);\r\n\r\n    $('#mod-bill-no').val(selectedBill.bill_no);\r\n\r\n    $('#single-modify-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n  }\r\n\r\n  elementEventRegister($('#single-modify'), 'click', function() {\r\n    if (selectedBill) {\r\n      showModifyForm();\r\n    } else {\r\n      bootbox.alert('请选择表中某一记录');\r\n    }\r\n  });\r\n\r\n  elementEventRegister($('#single-modify-btn-ok'), 'click', function() {\r\n    var changed = false;\r\n    var bill_name = iBillingName.val();\r\n    var contract_no = iContractNo.val();\r\n    var ship_warehouse = iShipWarehouse.val();\r\n    var bill_no = $('#mod-bill-no').val();\r\n    if (!sameText(bill_no, selectedBill.bill_no)) {\r\n      selectedBill.bill_no = bill_no;\r\n      changed = true;\r\n    }\r\n    if (!sameText(bill_name, selectedBill.billing_name)) {\r\n      selectedBill.billing_name = bill_name;\r\n      changed = true;\r\n    }\r\n    if (!sameText(contract_no, selectedBill.contract_no)) {\r\n      selectedBill.contract_no = contract_no;\r\n      changed = true;\r\n    }\r\n    if (!sameText(ship_warehouse, selectedBill.ship_warehouse)) {\r\n      selectedBill.ship_warehouse = ship_warehouse;\r\n      changed = true;\r\n    }\r\n    var brandNo = getElementValue($('#brand_no'));\r\n    if (!sameText(brandNo, selectedBill.brand_no)) {\r\n      selectedBill.brand_no = brandNo;\r\n      changed = true;\r\n    }\r\n\r\n    if (selectedBill.block_num > 0) {\r\n      var num = parseInt(iModTotalNum.val());\r\n      if (selectedBill.block_num != num) {\r\n        var sent = selectedBill.block_num - selectedBill.left_num;\r\n        selectedBill.block_num = num;\r\n        selectedBill.left_num = num - sent;\r\n        selectedBill.total_weight = toFixedNumber(num * selectedBill.weight, 3);\r\n\r\n        if (selectedBill.left_num <= 0) {\r\n          selectedBill.left_num = 0;\r\n          selectedBill.status = '已配发';\r\n        }\r\n        changed = true;\r\n      }\r\n    } else if (selectedBill.total_weight > 0) {\r\n      var w = parseFloat(iModTotalWeight.val());\r\n      if (w > 0 && w != selectedBill.total_weight) {\r\n        var sent_weight = selectedBill.total_weight - selectedBill.left_num;\r\n        selectedBill.total_weight = w;\r\n        selectedBill.left_num = w - sent_weight;\r\n        if (selectedBill.left_num <= 0) {\r\n          selectedBill.left_num = 0;\r\n          selectedBill.status = '已配发';\r\n        }\r\n        changed = true;\r\n      }\r\n    }\r\n\r\n    if (changed) {\r\n      ajaxRequestHandle('/modify_bill/single', 'POST', selectedBill, '单行修改', function() {\r\n        if (!isJqueryElementEmpty(data_tbody)) {\r\n          var first = '',\r\n              last = '';\r\n          if (btnDelete.length || isModify) {\r\n            first += '<td><input class=\"select-bill\" type=\"checkbox\"></td>';\r\n            last += '<td style=\"cursor:pointer\" class=\"td-icon\"><i title=\"删除\" class=\"fa fa-trash-o redlink\"></i></td>';\r\n          } else {\r\n            $('#action-button').hide();\r\n            $('#delete-button').hide();\r\n          }\r\n\r\n          data_tbody.find('tr').eq(selectedIdx).html(first + makeTableBodyTr(selectedBill) + last);\r\n        }\r\n\r\n        $('#single-modify-dialog').modal('hide');\r\n      });\r\n    } else {\r\n      $('#single-modify-dialog').modal('hide');\r\n    }\r\n  });\r\n\r\n  elementEventRegister($('#batch-modify'), 'click', function() {\r\n    if (selected_bills.length > 0) {\r\n      batchModifyValues = [];\r\n      unselected(sBatchModifyItem);\r\n      iBatchModifyItemValue.val('');\r\n      $('#batch-modify-info').html('');\r\n      $('#batch-modify-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n    } else {\r\n      bootbox.alert('无数据可修改');\r\n    }\r\n  });\r\n\r\n  var sBatchModifyItem = $('#batch-modify-item');\r\n  var iBatchModifyItemValue = $('#batch-modify-item-value');\r\n  var batchModifyValues = [];\r\n  elementEventRegister(sBatchModifyItem, 'change', function() {\r\n    iBatchModifyItemValue.val('');\r\n  });\r\n\r\n  elementEventRegister(iBatchModifyItemValue, 'keyup paste', function(e) {\r\n    e.stopImmediatePropagation();\r\n    var me = $(this);\r\n    var me_value = $.trim(me.val());\r\n    var itemSelected = sBatchModifyItem.find('option:selected');\r\n    var item = itemSelected.text();\r\n    var idx = itemSelected.index();\r\n    if (idx >= 0) {\r\n      batchModifyValues[idx] = {name: item, val: me_value};\r\n      var text = '';\r\n      batchModifyValues.forEach(function(value) {\r\n        if (value.val) {\r\n          if (value.name == '销售部门' || value.name == '尺寸') {\r\n            text += '<span class=\"nl_label label-primary col-md-12\">\"' + value.name + '\" 批量修改为:' + value.val + ' <label class=\"nl_label label-warning\"> 注:只有在销售部门为A6,A8,B6,B8,E6,E8和尺寸为定尺时,才使用公式计算重量</label></span>';\r\n          } else {\r\n            text += '<span class=\"nl_label label-primary col-md-12\">\"' + value.name + '\" 批量修改为:' + value.val + '</span>';\r\n          }\r\n        }\r\n      });\r\n      $('#batch-modify-info').html(text);\r\n      setHtmlElementDisabled($('#batch-modify-btn-ok'), isEmpty(text));\r\n    }\r\n  });\r\n\r\n  elementEventRegister($('#batch-modify-btn-ok'), 'click', function() {\r\n    var weightFactorChanged = false;\r\n    var billingNameUpdated = false;\r\n    selected_bills.forEach(function (bill) {\r\n      weightFactorChanged = false;\r\n      batchModifyValues.forEach(function (value) {\r\n        if (value.name == '牌号') {\r\n          bill.brand_no = value.val;\r\n        } else if (value.name == '开单名称') {\r\n          bill.billing_name = value.val;\r\n          billingNameUpdated = true;\r\n        } else if (value.name == '发货仓库') {\r\n          bill.ship_warehouse = value.val;\r\n        } else if (value.name == '提单号') {\r\n          bill.bill_no = value.val;\r\n        } else if (value.name == '合同号') {\r\n          bill.contract_no = value.val;\r\n        } else if (value.name == '销售部门') {\r\n          bill.sales_dep = value.val;\r\n        } else if (value.name == '尺寸') {\r\n          bill.size_type = value.val;\r\n        } else if (value.name == '长度') {\r\n          bill.len = value.val;\r\n          weightFactorChanged = true;\r\n        } else if (value.name == '宽度') {\r\n          bill.width = value.val;\r\n          weightFactorChanged = true;\r\n        } else if (value.name == '厚度') {\r\n          bill.thickness = value.val;\r\n          weightFactorChanged = true;\r\n        }\r\n      });\r\n\r\n      if (weightFactorChanged == true) {\r\n        if (bill.block_num > 0) {\r\n          var w = bill.len * bill.width * bill.thickness * 7.85 * Math.pow(10, -9);\r\n          bill.weight = toFixedNumber(w, 3);\r\n          bill.total_weight = toFixedNumber(bill.block_num * bill.weight, 3);\r\n        }\r\n      }\r\n    });\r\n\r\n    ajaxRequestHandle('/modify_bill/batch', 'POST', {bills: selected_bills, nameChanged: billingNameUpdated}, '批量修改', function() {\r\n      resetTableRow();\r\n      $('#batch-modify-dialog').modal('hide');\r\n    });\r\n  });\r\n\r\n  $('#left-zero').on('click', function() {\r\n    if (selected_bills.length > 0) {\r\n      selected_bills.forEach(function (bill) {\r\n        bill.total_weight -= bill.left_num;\r\n        bill.left_num = 0;\r\n        bill.status = '已配发';\r\n      });\r\n\r\n      ajaxRequestHandle('/modify_bill/batch', 'POST', {bills: selected_bills, nameChanged: false}, '剩余量清零修改', function () {\r\n        resetTableRow();\r\n      });\r\n    } else {\r\n      bootbox.alert('请选择要清零的记录！');\r\n    }\r\n  });\r\n\r\n  /////////////////////////////////////////////////////\r\n  // Search function\r\n  /////////////////////////////////////////////////////\r\n  $('#general-search').on('click', function() {\r\n    $('#general-search-content').toggle();\r\n  });\r\n\r\n  $('#advance-search').on('click', function() {\r\n    var searchHandler = new SearchHandlerD('bill');\r\n    searchHandler.initial('/get_bills_by_condition');\r\n    searchHandler.okEventHandler( function(result) {\r\n      curr_bills = result.bills;\r\n      resetTableRow();\r\n      if (isExist(sBillNoDel) && sBillNoDel.length > 0) {\r\n        sBillNoDel.select2(\"val\", \"\");\r\n        sOrderNoDel.select2(\"val\", \"\");\r\n      } else {\r\n        sOrderNo.select2(\"val\", \"\");\r\n        sOrderItemNo.val('');\r\n        sBillNo.val('');\r\n      }\r\n      $('#search_dialog').modal('hide');\r\n    });\r\n\r\n    $('#search_dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n  });\r\n\r\n  $('#left-search').on('click', function() {\r\n    $('#left-search-weight').val('');\r\n    $('#left-search-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n  });\r\n\r\n  $('#left-search-btn-ok').on('click', function() {\r\n    var v = $('#left-search-weight').val();\r\n    if (v > 0) {\r\n      $.get('/get_bills_by_condition', { search_left: 1, left: parseFloat(v) }, function (data) {\r\n        var result = JSON.parse(data);\r\n        if (result.ok) {\r\n          curr_bills = result.bills;\r\n          resetTableRow();\r\n          $('#left-search-dialog').modal('hide');\r\n        } else if (result.number > 500) {\r\n          bootbox.alert('当前查询结果 = ' + result.number + ', 数量太多（超过500个），请进一步限定条件！');\r\n        } else {\r\n          bootbox.alert(\"找不到您要找的数据,请确认您的查询条件!\");\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  var sheetName = 'sheet';\r\n  elementEventRegister($('#search-export'), 'click', function() {\r\n    saveToExcel(curr_bills, sheetName);\r\n  });\r\n\r\n  // icheck radio button 事件处理\r\n  var shippingBillBox = $('#checkbox-shipping-bill');\r\n  elementEventRegister(shippingBillBox, 'ifChecked', function() {\r\n    sheetName = '已配发';\r\n    var obj = { status: '已配发'  };\r\n    $.get('/get_bills_by_condition', { q: JSON.stringify(obj), isNeedAnalysis: false }, function(data) {\r\n      var result = JSON.parse(data);\r\n      if (result.ok) {\r\n        curr_bills = result.bills;\r\n        resetTableRow();\r\n      }\r\n    });\r\n  });\r\n\r\n  elementEventRegister(shippingBillBox, 'ifUnchecked', function() {\r\n    curr_bills = [];\r\n    data_tbody.empty();\r\n  });\r\n\r\n  ///////////////////////////////////////////////////////////////////////////////////////////\r\n  ///////////////////////////////////////////////////////////////////////////////////////////\r\n  function resetTableRow() {\r\n    data_tbody.empty();\r\n    var first = '<tr>',\r\n        last = '</tr>';\r\n    if (btnDelete.length > 0 || isModify) {\r\n      first = '<tr><td><input class=\"select-bill\" type=\"checkbox\"></td>';\r\n      last = '<td style=\"cursor:pointer\" class=\"td-icon\"><i title=\"删除\" class=\"fa fa-trash-o redlink\"></i></td></tr>';\r\n    } else {\r\n      $('#action-button').hide();\r\n      $('#delete-button').hide();\r\n    }\r\n\r\n    var html_text = [];\r\n    curr_bills.forEach(function (bill) {\r\n      html_text.push(first + makeTableBodyTr(bill) + last);\r\n    });\r\n    data_tbody.append(html_text.join('\\n'));\r\n\r\n    var trs = data_tbody.find('tr');\r\n    tr_click(trs, function (e, index) {\r\n      selectedBill = curr_bills[index];\r\n      selectedIdx = index;\r\n    });\r\n\r\n    trs.dblclick(function () {\r\n      selectedBill = curr_bills[$(this).index()];\r\n      selectedIdx = $(this).index();\r\n      if ($('#single-modify').length > 0) {\r\n        showModifyForm();\r\n      } else if ($('#checkbox-shipping-bill').length > 0) { // 查询界面\r\n        showWaybillData();\r\n      }\r\n    });\r\n\r\n    $('.td-icon').on('click', function (e) {\r\n      e.stopImmediatePropagation();\r\n      var tr = $(this).closest('tr');\r\n      var idx = tr.index();\r\n      deleteOne(curr_bills[idx], function() {\r\n        for (var i = 0; i < selected_bills.length; ++i) {\r\n          if (sameBill(selected_bills[i], curr_bills[idx])) {\r\n            selected_bills.remove(i);\r\n            setHtmlElementDisabled(btnDelete, selected_bills.length === 0);\r\n            break;\r\n          }\r\n        }\r\n\r\n        tr.remove();\r\n        curr_bills.remove(idx);\r\n      });\r\n    });\r\n\r\n    $('.select-bill').on('click', function(e) {\r\n      e.stopImmediatePropagation();\r\n      var tr = $(this).closest('tr');\r\n      var idx = tr.index();\r\n      var b = curr_bills[idx];\r\n      if ($(this).is(\":checked\")) {\r\n        selected_bills.push(b);\r\n        setHtmlElementDisabled(btnDelete, false);\r\n        tr.addClass('selected-highlighted');\r\n        tr.removeClass('invoice-highlighted');\r\n      } else {\r\n        for (var i = 0; i < selected_bills.length; ++i) {\r\n          if (sameBill(selected_bills[i], b)) {\r\n            selected_bills.remove(i);\r\n            setHtmlElementDisabled(btnDelete, selected_bills.length === 0);\r\n            break;\r\n          }\r\n        }\r\n        tr.removeClass('selected-highlighted');\r\n      }\r\n    });\r\n  }\r\n\r\n  function makeTableBodyTr(bill) {\r\n    var str = '<td style=\"text-align: center;\">' + getStrByStatus(bill.status, bill.status) + \"</td>\";\r\n\r\n    var vehs = [];\r\n    for (var idx = 0; idx < bill.invoices.length; ++idx) {\r\n      var veh = bill.invoices[idx].veh_ves_name;\r\n      if (veh && vehs.indexOf(veh) < 0) {\r\n        vehs.push(veh);\r\n      }\r\n    }\r\n    if (vehs.length > 0) {\r\n      str += '<td>' + vehs.join(',') + '</td>';\r\n    } else {\r\n      str += '<td></td>';\r\n    }\r\n\r\n    for (var i = 0; i < 22; ++i) {\r\n      str += \"<td>{\" + i + \"}</td>\";\r\n    }\r\n\r\n    var dw = \"\";\r\n    if (bill.block_num > 0) {\r\n      dw = getStrValue(bill.weight);\r\n    }\r\n\r\n    return str.format(getOrder(bill.order_no, bill.order_item_no), bill.bill_no,\r\n        bill.brand_no ? bill.brand_no : '', bill.billing_name,\r\n        bill.sales_dep ? bill.sales_dep : '',\r\n        getStrValue(bill.thickness), getStrValue(bill.width), getStrValue(bill.len), bill.size_type, \"\",\r\n        dw, bill.block_num, getStrValue(bill.total_weight),\r\n        bill.ship_warehouse ? bill.ship_warehouse : '',\r\n        bill.shipping_address ? bill.shipping_address : '',\r\n        bill.contract_no ? bill.contract_no : '',\r\n        date2Str(bill.create_date), date2Str(bill.shipping_date), date2Str(bill.settle_date),\r\n        bill.creater ? bill.creater : '', bill.shipper ? bill.shipper : '', bill.settler ? bill.settler : '');\r\n  }\r\n\r\n  function showWaybillData() {\r\n    if (selectedBill.invoices.length) {\r\n      var inv_no = selectedBill.invoices[0].inv_no;\r\n      $.get('/get_waybill', { q: inv_no }, function (data) {\r\n        var obj = jQuery.parseJSON(data); // bills: bills, invoices: invoices\r\n        var selectedWaybill = obj.invoices[0];\r\n        setElementValue($('#report-bill-name'), selectedWaybill.ship_name);\r\n        setElementValue($('#report-ship-to'), selectedWaybill.ship_to);\r\n        setElementValue($('#report-waybill-no'), selectedWaybill.waybill_no);\r\n        var allBills = [];\r\n        selectedWaybill.bills.forEach(function(b) {\r\n          obj.bills.forEach(function(b1) {\r\n            if (String(b.bill_id) === String(b1._id)) {\r\n              allBills.push(b1);\r\n              if (b1.block_num > 0) {\r\n                b1.wnum = b.num;\r\n              } else {\r\n                b1.wnum_danding = b.num;\r\n                b1.wnum = b.weight;\r\n              }\r\n            }\r\n          })\r\n        });\r\n        $('#report-table').html(getTableHtml(allBills));\r\n\r\n        var tn = 0;\r\n        selectedWaybill.bills.forEach(function(b) {\r\n          tn += b.num;\r\n        });\r\n        setElementValue($('#report-total-weight'), toFixedStr(selectedWaybill.total_weight, 3));\r\n        setElementValue($('#report-total-number'), tn);\r\n        $('#show-invoice-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n      });\r\n    }\r\n  }\r\n});\r\n\r\nfunction getTableHtml(allBills) {\r\n  var html = [ ];\r\n  var num, w, tw;\r\n  html.push('<thead><tr><th>提单号</th><th>订单号</th><th>牌号</th><th>厚度</th><th>宽度</th><th>长度</th><th>单重</th><th>发运数</th><th>发运重量</th><th>仓库</th><th>合同号</th></tr></thead>');\r\n  var str = '<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td></tr>';\r\n  allBills.forEach(function(b) {\r\n    if (b.block_num > 0) {\r\n      num = getStrValue(b.wnum);\r\n      w = getStrValue(b.weight);\r\n      tw = getStrValue(b.weight * b.wnum);\r\n    } else {\r\n      num = getStrValue(b.wnum_danding);\r\n      w = '';\r\n      tw = getStrValue(b.wnum);\r\n    }\r\n    html.push(str.format(b.bill_no, getOrder(b.order_no, b.order_item_no), b.brand_no ? b.brand_no : \"\",\r\n        getStrValue(b.thickness), getStrValue(b.width), getStrValue(b.len), w, num, tw,\r\n        b.ship_warehouse? b.ship_warehouse : \"\", b.contract_no ? b.contract_no : \"\"));\r\n  });\r\n\r\n  return html.join('');\r\n}\r\n\r\nfunction getBillsByNo(bills, data) {\r\n  var res = [];\r\n  if (bills.length > 0) {\r\n    if (data.order_no) {\r\n      bills.forEach(function (bill) {\r\n        if (bill.order_no == data.order_no) {\r\n          res.push(bill);\r\n        }\r\n      });\r\n    } else if (data.item_no) {\r\n      bills.forEach(function (bill) {\r\n        if (bill.order_item_no == data.item_no) {\r\n          res.push(bill);\r\n        }\r\n      });\r\n    } else if (data.bill_no) {\r\n      bills.forEach(function (bill) {\r\n        if (bill.bill_no == data.bill_no) {\r\n          res.push(bill);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  return res;\r\n}\r\n\r\nfunction validFloatInput(elem, initValue, minValue) {\r\n  elem.data(\"new\", initValue);\r\n  elem.ForceNumericOnly();\r\n  elem.on('keyup paste', function(e) {\r\n    $(this).data(\"old\", $(this).data(\"new\") || \"\");\r\n    var v = $(this).val();\r\n    if (!isNumeric(v)) {\r\n      $(this).val($(this).data(\"old\"));\r\n      $(this).data(\"new\", $(this).val());\r\n    } else {\r\n      if (v < minValue) {\r\n        v = minValue;\r\n      }\r\n      $(this).data(\"new\", v);\r\n      $(this).val(v);\r\n    }\r\n  });\r\n}\r\n\r\nfunction validIntInput(elem, min, max) {\r\n  elem.ForceNumericOnly();\r\n  elem.on('keyup paste', function(e) {\r\n    numberIntValider(elem, min, max);\r\n  });\r\n}\r\n\r\nfunction sameText(src, dst) {\r\n  var b1 = isEmpty(src);\r\n  var b2 = isEmpty(dst);\r\n  if (!b1 && !b2) {\r\n    return src == dst;\r\n  } else if (b1 && b2) {\r\n    return true;\r\n  } else {\r\n    return false;\r\n  }\r\n}"]}