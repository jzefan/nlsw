{"version":3,"sources":["invoice_mgt.js"],"names":["$","vswLabel","btnNew","btnSave","btnSaveShip","invInputUI","invoiceBody","sVehicleName","sShipName","sShipCustomer","iShipTo","sShipTo","sShipFrom","iShipDateGrp","lTotalWeight","lTotalNumber","sBillNo","sOrderNo","vehicleNo","el_origin","vehShipCfm","reportTable","sWaybillNo","curr_invoice_state","username","local_user","userid","dictData","local_dict_data","action","local_action","cNumIdx","waybillNo","innerWaybillNoOrder","selectedWaybill","totalWeight","totalNumber","vehTotShipNum","vehTotShipWeight","waybillHandler","init","length","select2Setup","inputLength","placeholder","url","data","setQueryData","datetimepicker","getDateTimePickerOptions","on","saveButtonAvailable","myWaybillQuery","checkWaybillMe","iCheck","isVessel","allVehicles","isEmpty","warehouse","sort_pinyin","destination","initSelect","select2","vehInfo","forEach","vehicle","veh_type","push","name","initAllHtmlElements","inputForShipTo","route","getAllList","company","vehicles","elementEventRegister","hasClass","bootbox","confirm","result","create_invoice","this","oldName","value","hasSelectedBills","handlerReset","me","isVessel_tmp","getVesselFlag","showHtmlElement","initVehicleElem","inner_id","leftPad","showSelectedBill","bill","total","num","weight","append","buildTableTr","left","getVehTableData","invoiceBodyEventRegister","updateHeadText","showTotalWeightNumber","clearVehicles","text","val","state","alert","buildDataAndSave","toggle","res","findCreate","found","empty","getOptions","option","order_no","bill_no","addAndInsertTable","bills","appendInvoiceBody","trs","find","removeClass","numOfBill","i","tr","getRowChildren","bno","getTableCellChildren","ono","k","getOrder","order_item_no","addClass","updateUIElem","tip","billtips","oldV","td","s","setHtmlElementDisabled","numOfRow","tdAttr","attr","getNumAndWeight","checkNumWeightInput","vno","handleVehicleComplete","insertSelectOptions","extend","tablesorter","defaults","theme","widgets","showEditDialog","setElementValue","getElementValue","rt","ft","window","print","getBillsFromInvoice","customer","ship_customer","ship_name","str","waybill_no","ship_to","vehicle_vessel_name","getTableHtml","tableToExcel","date2Str","Date","get","JSON","parse","ok","max_no","reset","prop","response","shipName","q","obj","jQuery","parseJSON","b","addBill","customers","initInvoiceBody","len","today","$and","ship_date","$gt","setDate","getDate","$or","shipper","stringify","isNeedAnalysis","each","invoices","index","inv","unselected","selectWaybill","e","added","searchHandler","SearchHandlerD","initial","okEventHandler","selectedIdx","resetWithQueryData","modal","openToNew","showWaybillData","backdrop","keyboard","ajaxRequestHandle","remove","saving","status","msg","el","console","log","selectedBills","getSelectedBills","ship_from","slice","total_weight","saveInvoice","undefined","setTimeout","needVehicleInfo","hasMixedBill","t1","t2","send_num","send_weight","dw","block_num","getStrValue","format","ship_warehouse","thickness","width","makeVehSelect","veh_name","wagonNoSelect","vname","attrName","vehNo","findSameTr","needVehicles","onlyForFind","o","nw","veh","bveh","wid","inner_waybill_no","substring","html","prev_wnum_danding","wnum_danding","prepend","left_num","updateLeftNumberCol","lnStr","foundTr","updateVehiclesAndInfo","delta_num","delta_weight","nameAttr","Math","abs","veh_obj","toFixedNumber","stopImmediatePropagation","closest","getBill","modifyVessel","deleteTableRow","billTip","tips","inputEventRegister","oValue","parseInt","nValue","numberIntValider","updateShipNum","parseFloat","numberFloatValider","delta","needUpdateLabel","needVehInfo","vehName","wno","getWaybill","setName","getCopiedBill","copiedBill","bveh_send_num","bveh_send_weight","bveh_name","fadeIn","rbphoneElem","phone","rsphoneElem","rscontactElem","dest","contact_name","allBills","trigger","tn","tw","wnum","toFixedStr","showWaybillForReport","nlApp","setTitle","showPleaseWait","di","billList","addBillAndTableRow_1","updatedBill","sortByKey","sendNumForWaybill","addBillAndTableRow","disableAll","getMaxInnerWaybillNo","hidePleaseWait","s1","s2","s7","s8","b1","b2","s3","b3","b4","b5","compare","b6","moment","isSame","disable","elem","okHandler","dname","dok","allVehBills","inv_no","brand_no","contract_no","join"],"mappings":"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","file":"invoice_mgt.js","sourcesContent":["$(function () {\r\n  \"use strict\";\r\n\r\n  var vswLabel      = $('#vehicle-ship-weight');\r\n  var btnNew        = $('#invoice_new');\r\n  var btnSave       = $('#invoice_save');\r\n  var btnSaveShip   = $('#invoice_save_shipping');\r\n  var invInputUI    = $('#invoice-input-content');\r\n  var invoiceBody   = $('#invoice_tbody');\r\n  var sVehicleName  = $('#vehicle_name');\r\n  var sShipName     = $('#ship_name');      // 开单名称\r\n  var sShipCustomer = $('#ship_customer');  // 发货单位\r\n  var iShipTo       = $('#ship_to_input');\r\n  var sShipTo       = $('#ship-to-select');\r\n  var sShipFrom     = $('#start-warehouse');\r\n  var iShipDateGrp  = $('#ship-date-grp');\r\n  var lTotalWeight  = $('#total_weight_td');\r\n  var lTotalNumber  = $('#total_number_td');\r\n  var sBillNo       = $('#bill_no');\r\n  var sOrderNo      = $('#order_no_by_name');\r\n\r\n  var vehicleNo   = $('#vehicle-no');\r\n  var el_origin   = $('#origin');\r\n  var vehShipCfm  = $('#vehicle-ship-confirm');\r\n  var reportTable = $('#report-table');\r\n  var sWaybillNo  = $('#waybill_no_query');\r\n\r\n  var curr_invoice_state = 'idle'; // idle -> new/open -> save -> idle\r\n  var username = local_user.userid;\r\n  var dictData = local_dict_data;\r\n  var action = local_action;\r\n\r\n  var cNumIdx = 10; // const for num input\r\n  var waybillNo = '';\r\n  var innerWaybillNoOrder = 0;\r\n  var selectedWaybill = null;\r\n  var totalWeight = 0, totalNumber = 0;\r\n  var vehTotShipNum = 0, vehTotShipWeight = 0;\r\n\r\n  waybillHandler.init('');\r\n\r\n  if (sWaybillNo.length) {\r\n    select2Setup(sWaybillNo, {inputLength: 4, placeholder: '查找运单号', url: '/get_waybill'}, function (data) {\r\n      waybillHandler.setQueryData(data);\r\n    });\r\n  }\r\n\r\n  if (iShipDateGrp.length) {\r\n    iShipDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change change', saveButtonAvailable);\r\n  }\r\n\r\n  var myWaybillQuery = $('#my_waybill_query');\r\n  var checkWaybillMe = $('#checkWaybillForMe');\r\n  if (checkWaybillMe.length) {\r\n    checkWaybillMe.iCheck('uncheck');\r\n  }\r\n\r\n  var isVessel = false; // 使用船来配发\r\n  var allVehicles = [];\r\n\r\n  if (!isEmpty(dictData) && action !== \"REPORT\") {\r\n    dictData.warehouse = sort_pinyin(dictData.warehouse);\r\n    dictData.destination = sort_pinyin(dictData.destination);\r\n    initSelect(sShipFrom, dictData.warehouse, false);\r\n    initSelect(sShipTo, dictData.destination, false);\r\n    initSelect(el_origin, dictData.warehouse, false);\r\n    el_origin.select2();\r\n    el_origin.select2('val', '南钢');\r\n    sShipFrom.select2();\r\n    sShipFrom.select2('val', '');\r\n    sShipTo.select2();\r\n    sShipTo.select2('val', '');\r\n\r\n    dictData.vehInfo.forEach(function (vehicle) {\r\n      if (vehicle.veh_type === '车') {\r\n        allVehicles.push(vehicle.name);\r\n      }\r\n    });\r\n\r\n    allVehicles = sort_pinyin(allVehicles);\r\n    initSelect(vehicleNo, allVehicles, false);\r\n    vehicleNo.select2();\r\n    sBillNo.select2();\r\n    sOrderNo.select2();\r\n  }\r\n\r\n  initAllHtmlElements(); // initial element value\r\n\r\n  /*\r\n   * Ship Invoice Function\r\n   */\r\n  var inputForShipTo = false;\r\n  if (action === \"ADD\" || action === \"MODIFY\") {\r\n    var route = '/build_invoice';\r\n    if (action === \"ADD\") {\r\n      if (!isEmpty(dictData)) {\r\n        initSelect(sShipName, sort_pinyin(getAllList(false, dictData.company, \"name\")), false);\r\n        initSelect(sVehicleName, sort_pinyin(dictData.vehicles), false);\r\n        sVehicleName.select2();\r\n        sShipName.select2();\r\n      }\r\n\r\n      elementEventRegister(btnNew, 'click', function () {\r\n        if (!btnSave.hasClass('disabled')) {\r\n          bootbox.confirm('有数据未保存, 确定要重新创建一个运单?', function (result) {\r\n            if (result) {\r\n              create_invoice();\r\n            }\r\n          });\r\n        } else if (curr_invoice_state !== 'idle') {\r\n          bootbox.confirm('确定要重新创建运单?', function (result) {\r\n            if (result) {\r\n              create_invoice();\r\n            }\r\n          });\r\n        } else {\r\n          create_invoice();\r\n        }\r\n      });\r\n\r\n      elementEventRegister(sShipName, 'change', function () {\r\n        $(this).data(\"old\", $(this).data(\"new\") || \"\");\r\n\r\n        var oldName = $(this).data('old');\r\n        var name = this.value;\r\n        if ((totalNumber > 0 && totalWeight > 0) || waybillHandler.hasSelectedBills()) {\r\n          bootbox.confirm('开单名称的改变将导致所有的您选择的提单数据丢失,确认吗?', function (result) {\r\n            if (result) {\r\n              handlerReset(name);\r\n            } else {\r\n              sShipName.select2('val', oldName);\r\n            }\r\n          })\r\n        } else {\r\n          handlerReset(name);\r\n        }\r\n\r\n        $(this).data(\"new\", name);\r\n      });\r\n\r\n      elementEventRegister(sVehicleName, 'change', function () {\r\n        var me = $(this);\r\n        me.data(\"old\", me.data(\"new\") || \"\");   // save old value first\r\n\r\n        var isVessel_tmp = getVesselFlag(this.value);\r\n        if (isVessel !== isVessel_tmp) { // 车到船 或船到车\r\n          isVessel = isVessel_tmp;\r\n          showHtmlElement($('#inv-table-input th:last-child, #inv-table-input td:last-child'), isVessel);\r\n          showHtmlElement($('#vehicle-info'), (action !== \"REMOVE\" && isVessel));\r\n\r\n          if (!isVessel_tmp) { // 船-->车\r\n            if (innerWaybillNoOrder > 0) { // 之前confirm过\r\n              bootbox.confirm(\"你之前选择的是船,现在选择的车,针对每个提单的车号信息都会被清空,确定改变吗?\", function (result) {\r\n                if (result) {\r\n                  waybillHandler.clearVehicles(waybillNo);\r\n                  $('td[name=\"wagon_no\"]').text('');\r\n                  initVehicleElem();\r\n                } else {\r\n                  showHtmlElement($('#inv-table-input th:last-child, #inv-table-input td:last-child'), true);\r\n                  showHtmlElement($('#vehicle-info'), (action !== \"REMOVE\"));\r\n                  $('#lb-vehicle').text('船号');\r\n                  isVessel = true;\r\n\r\n                  me.val(me.data(\"old\"));\r\n                  me.data(\"new\", me.val());\r\n                }\r\n              })\r\n            } else {\r\n              waybillHandler.clearVehicles(waybillNo);\r\n              $('td[name=\"wagon_no\"]').text(\"\");\r\n            }\r\n          } else {  // 车->船\r\n            initVehicleElem();\r\n            if (curr_invoice_state === \"saved\") { // 之前已经保存过, 请为它们输入车号\r\n              var inner_id = waybillNo + leftPad(innerWaybillNoOrder, 3);\r\n              waybillHandler.showSelectedBill(\r\n                inner_id,\r\n                function (bill, total, num, weight) {\r\n                  vehTotShipNum += num;\r\n                  vehTotShipWeight += weight;\r\n                  invoiceBody.append(buildTableTr(bill, total, bill.left, num, weight) + getVehTableData(\"wagon_no\") + '</tr>');\r\n                },\r\n                function () {\r\n                  invoiceBodyEventRegister();\r\n                  updateHeadText(false);\r\n                  showTotalWeightNumber();\r\n                  saveButtonAvailable();\r\n                });\r\n            }\r\n          }\r\n        } else if (isVessel_tmp) { // 不同的船变化\r\n          // 之前所以配置的提单信息都丢失, 类似于从新开始\r\n        }\r\n\r\n        saveButtonAvailable();\r\n        me.data(\"new\", me.val());\r\n      });\r\n    } else {\r\n      route = '/distribute_invoice';\r\n    }\r\n\r\n    elementEventRegister(btnSave, 'click', function () {\r\n      if (selectedWaybill && (selectedWaybill.state === '已结算')) {\r\n        bootbox.alert('此运单已结算,不能修改保存!');\r\n      } else {\r\n        buildDataAndSave('新建', route, '保存配发货/登记');\r\n      }\r\n    });\r\n\r\n    elementEventRegister(btnSaveShip, 'click', function () {\r\n      if (selectedWaybill && (selectedWaybill.state === '已结算')) {\r\n        bootbox.alert('此运单已结算,不能修改配发!');\r\n      } else {\r\n        bootbox.confirm('确定配发当前选择的订单?', function (result) {\r\n          if (result) {\r\n            buildDataAndSave('已配发', route, '保存并确定配发');\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    elementEventRegister(iShipTo, 'keyup paste', saveButtonAvailable);\r\n    elementEventRegister(sShipTo, 'change', saveButtonAvailable);\r\n    elementEventRegister($('#lbl-ship-to'), 'click', function () {\r\n      iShipTo.toggle();\r\n      //sShipTo.toggle();\r\n      showHtmlElement($('#s2id_ship-to-select'), inputForShipTo);\r\n      inputForShipTo = !inputForShipTo;\r\n      iShipTo.val('');\r\n      sShipTo.select2('val', '');\r\n      saveButtonAvailable();\r\n    });\r\n\r\n    elementEventRegister(sOrderNo, 'change', function () {\r\n      var res = waybillHandler.findCreate(this.value, false);\r\n      if (res.found) {\r\n        sBillNo.empty();\r\n        res.data.getOptions(sShipName.val()).forEach(function (option) {\r\n          sBillNo.append(option);\r\n        });\r\n\r\n        sBillNo.select2('val', '');\r\n      }\r\n    });\r\n\r\n    elementEventRegister(sBillNo, 'change', function () {\r\n      var inner_id = isVessel ? (waybillNo + leftPad(innerWaybillNoOrder, 3)) : '';\r\n      var order_no = sOrderNo.val();\r\n      var bill_no = sBillNo.val();\r\n      var result = waybillHandler.addAndInsertTable(order_no, bill_no, inner_id);\r\n      if (result && result.bills.length) {\r\n        result.bills.forEach(function (bill) {\r\n          appendInvoiceBody(bill, 0, false)\r\n        });\r\n\r\n        var trs = invoiceBody.find('tr');\r\n        trs.removeClass('selected-highlighted');\r\n\r\n        var numOfBill = result.bills.length;\r\n        for (var i = 0; i < trs.length; ++i) {\r\n          var tr = getRowChildren(invoiceBody, i);\r\n          var bno = getTableCellChildren(tr, 1).text();\r\n          var ono = getTableCellChildren(tr, 2).text();\r\n          for (var k = 0; k < numOfBill; ++k) {\r\n            if (bno === result.bills[k].bill_no && ono === getOrder(result.bills[k].order_no, result.bills[k].order_item_no)) {\r\n              tr.addClass('selected-highlighted');\r\n              break;\r\n            }\r\n          }\r\n        }\r\n\r\n        invoiceBodyEventRegister();\r\n\r\n        updateUIElem(true, true, order_no, bill_no, result.tip, result.billtips);\r\n      }\r\n    });\r\n\r\n    elementEventRegister(sShipFrom, 'change', saveButtonAvailable); // 车辆始发处理\r\n    elementEventRegister(sShipCustomer, 'change', saveButtonAvailable);\r\n\r\n    elementEventRegister(vehicleNo, 'change', function () {\r\n      $(this).data(\"old\", $(this).data(\"new\") || '');\r\n      var oldV = $(this).data(\"old\");\r\n      var value = this.value;\r\n      $(this).data(\"new\", value);\r\n\r\n      var td = action === 'ADD' ? $('td[name=\"wagon_no\"]') : $('td[name=\"wagon_no_new\"]');\r\n      if (vehTotShipNum > 0) {\r\n        if (oldV) {\r\n          var s = '车辆号:\"' + oldV + '\"还没确定配发完成, 如果更换车辆号,之前的这辆车的配发数据无效并被丢失, 确定吗?';\r\n          bootbox.confirm(s, function (result) {\r\n            if (result) {\r\n              td.text(value);\r\n              setHtmlElementDisabled(vehShipCfm, (vehTotShipNum <= 0 || isEmpty(value)));\r\n            } else {\r\n              vehicleNo.select2('val', oldV);\r\n              $(this).data(\"new\", oldV);\r\n            }\r\n          })\r\n        } else {\r\n          td.text(value);\r\n          setHtmlElementDisabled(vehShipCfm, (vehTotShipNum <= 0 || isEmpty(value)));\r\n        }\r\n      } else {\r\n        td.text(value);\r\n        var numOfRow = invoiceBody.find(\"tr\").length;\r\n        if (numOfRow > 0) {\r\n          for (var i = 0; i < numOfRow; ++i) {\r\n            var tr = getRowChildren(invoiceBody, i);\r\n            var tdAttr = tr.find(\"td:last\").attr(\"name\");\r\n            if (tdAttr === \"wagon_no\" || tdAttr === \"wagon_no_new\") {\r\n              var data = getNumAndWeight(tr);\r\n              vehTotShipNum += data.num;\r\n              vehTotShipWeight += data.weight;\r\n            }\r\n          }\r\n\r\n          showTotalWeightNumber();\r\n        } else {\r\n          initVehicleElem();\r\n        }\r\n      }\r\n    });\r\n\r\n    // 运船: 一车配送确定\r\n    elementEventRegister(vehShipCfm, 'click', function () {\r\n      if (!checkNumWeightInput()) {\r\n        bootbox.alert(\"请完成发运块数和发运重量的输入!\");\r\n      } else {\r\n        var vno = vehicleNo.val();\r\n\r\n        waybillHandler.handleVehicleComplete(waybillNo + leftPad(innerWaybillNoOrder, 3), vno, el_origin.val());\r\n\r\n        if (action === \"ADD\") {\r\n          invoiceBody.empty();\r\n        } else { // Modify\r\n          $('td[name=\"wagon_no_new\"]').attr(\"name\", \"wagon_no_confirm\");\r\n          invoiceBody.find('tr').removeClass('selected-highlighted');\r\n        }\r\n\r\n        sBillNo.select2('val', '');\r\n        vehicleNo.select2('val', '');\r\n        vehicleNo.data(\"old\", \"\");\r\n        vehicleNo.data(\"new\", \"\");\r\n\r\n        waybillHandler.insertSelectOptions(sOrderNo, null);\r\n        initVehicleElem();\r\n\r\n        ++innerWaybillNoOrder; // 内部运单递增\r\n\r\n        bootbox.alert('车辆: \"' + vno + '\"配发完成!');\r\n      }\r\n    });\r\n  }\r\n  else if (action === 'REPORT') {\r\n    $.extend($.tablesorter.defaults, {theme: 'blue'});\r\n    reportTable.tablesorter({widgets: ['stickyHeaders']});\r\n\r\n    $('#lbl-destination').on('click', function () {\r\n      showEditDialog('目的地', $('#report-ship-to'), function () {\r\n        setElementValue($('#report-shipto-phone'), getElementValue($('#phone')));\r\n        setElementValue($('#report-shipto-contact'), getElementValue($('#contact')));\r\n      });\r\n    });\r\n\r\n    $('#lbl-bill-name').on('click', function () {\r\n      showEditDialog('发货单位', $('#report-bill-name'), function () {\r\n        setElementValue($('#report-bill-phone'), getElementValue($('#phone')));\r\n      });\r\n    });\r\n\r\n    elementEventRegister($('#report-print'), 'click', function () {\r\n      var rt = $('#report-tool');\r\n      var ft = $('#footer');\r\n      rt.toggle();\r\n      ft.toggle();\r\n      window.print();\r\n      rt.toggle();\r\n      ft.toggle();\r\n    });\r\n\r\n    elementEventRegister($('#report-export'), 'click', function () {\r\n      var bills = waybillHandler.getBillsFromInvoice(selectedWaybill);\r\n      var customer = selectedWaybill.ship_customer;\r\n      if (isEmpty(customer)) {\r\n        customer = selectedWaybill.ship_name;\r\n      }\r\n      var str = '';\r\n      if (isVessel) {\r\n        str = '<table><tr><th colspan=\"12\">南京鑫鸿图储运有限公司发货单</th>';\r\n        str += '<tr><td colspan=\"3\">运单号：' + selectedWaybill.waybill_no + '</td><td colspan=\"6\">开单名称:' + selectedWaybill.ship_name + '</td><td colspan=\"3\" align=\"right\">目的地:' + selectedWaybill.ship_to + '</td></tr>';\r\n        str += '<tr><td colspan=\"3\">车船号：' + selectedWaybill.vehicle_vessel_name + '</td><td colspan=\"6\">发货单位:' + customer + '</td><td colspan=\"3\" align=\"right\">电话:' + $('#report-shipto-phone').text() + '</td>';\r\n        str += '<tr><td colspan=\"3\">发货日期：' + $('#report-ship-date').text() + '</td></td><td colspan=\"6\">电话:' + $('#report-bill-phone').text() + '</td><td colspan=\"3\" align=\"right\">联系人:' + $('#report-shipto-contact').text() + '</td></tr>';\r\n        str += '<tr><td colspan=\"3\">始发地: ' + $('#report-ship-from').text() + '</td><td colspan=\"9\"></td></tr>';\r\n        str += '<tr><td colspan=\"3\">车船电话: ' + $('#report-ship-phone').text() + '</td><td colspan=\"9\"></td></tr><tr><td colspan=\"12\"></td></tr>';\r\n        str += '<tr><th>提单号</th><th>订单号</th><th>牌号</th><th>厚度</th><th>宽度</th><th>长度</th><th>单重</th><th>发运数</th><th>发运重量</th><th>仓库</th><th>合同号</th><th>车号</th></tr>';\r\n        str += getTableHtml(bills) + '<tr><td colspan=\"12\"></td></tr>';\r\n        str += '<tr><th colspan=\"10\" align=\"right\">总重量:</th><th colspan=\"2\" align=\"left\">' + $('#report-total-weight').text() + '</th></tr>';\r\n        str += '<tr><th colspan=\"10\" align=\"right\">总块数:</th><th colspan=\"2\" align=\"left\">' + $('#report-total-number').text() + '</th></tr></table>';\r\n      } else {\r\n        str = '<table><tr><th colspan=\"11\">南京鑫鸿图储运有限公司发货单</th>';\r\n        str += '<tr><td colspan=\"3\">运单号：' + selectedWaybill.waybill_no + '</td><td colspan=\"5\">开单名称:' + selectedWaybill.ship_name + '</td><td colspan=\"3\" align=\"right\">目的地:' + selectedWaybill.ship_to + '</td></tr>';\r\n        str += '<tr><td colspan=\"3\">车船号：' + selectedWaybill.vehicle_vessel_name + '</td><td colspan=\"5\">发货单位:' + customer + '</td><td colspan=\"3\" align=\"right\">电话:' + $('#report-shipto-phone').text() + '</td>';\r\n        str += '<tr><td colspan=\"3\">发货日期：' + $('#report-ship-date').text() + '</td></td><td colspan=\"5\">电话:' + $('#report-bill-phone').text() + '</td><td colspan=\"3\" align=\"right\">联系人:' + $('#report-shipto-contact').text() + '</td></tr>';\r\n        str += '<tr><td colspan=\"3\">始发地: ' + $('#report-ship-from').text() + '</td><td colspan=\"8\"></td></tr>';\r\n        str += '<tr><td colspan=\"3\">车船电话: ' + $('#report-ship-phone').text() + '</td><td colspan=\"8\"></td></tr><tr><td colspan=\"12\"></td></tr>';\r\n        str += '<tr><th>提单号</th><th>订单号</th><th>牌号</th><th>厚度</th><th>宽度</th><th>长度</th><th>单重</th><th>发运数</th><th>发运重量</th><th>仓库</th><th>合同号</th><th>车号</th></tr>';\r\n        str += getTableHtml(bills) + '<tr><td colspan=\"11\"></td></tr>';\r\n        str += '<tr><th colspan=\"9\" align=\"right\">总重量:</th><th colspan=\"2\" align=\"left\">' + $('#report-total-weight').text() + '</th></tr>';\r\n        str += '<tr><th colspan=\"9\" align=\"right\">总块数:</th><th colspan=\"2\" align=\"left\">' + $('#report-total-number').text() + '</th></tr></table>';\r\n      }\r\n      tableToExcel(str, selectedWaybill.waybill_no, \"运单数据\" + date2Str(new Date()) + \".xls\");\r\n    });\r\n  }\r\n\r\n  function create_invoice() {\r\n    $.get('/get_max_waybill_no', {}, function (data) {\r\n      var result = JSON.parse(data);\r\n      if (result.ok) {\r\n        waybillNo = result.max_no;\r\n        innerWaybillNoOrder = 0;\r\n        selectedWaybill = null;\r\n        curr_invoice_state = 'new';\r\n\r\n        waybillHandler.reset('');\r\n\r\n        showHtmlElement($('#inv-head-info'), true);\r\n        $('#waybill_oper_text').text('新建运单号: ');\r\n        $('#waybill_no').text(waybillNo);\r\n        showHtmlElement(invInputUI, true);\r\n\r\n        initAllHtmlElements();\r\n        sVehicleName.prop(\"disabled\", false);\r\n        sShipName.prop(\"disabled\", false);\r\n      } else {\r\n        bootbox.alert('新建失败:' + result.response);\r\n      }\r\n    })\r\n  }\r\n\r\n  /////////////////////////////////////////////////////////////////////////////\r\n  // MY waybill check event handling \r\n  /////////////////////////////////////////////////////////////////////////////\r\n  elementEventRegister(checkWaybillMe, 'ifChecked', function () {\r\n    showHtmlElement($('#div-my-select'), true);\r\n    showHtmlElement($('#div-select2'), false);\r\n    var today = new Date();\r\n    var before = new Date(today.setDate(today.getDate() - 21));\r\n    var obj = {\r\n      $and: [{ship_date: {$gt: before}}, {\r\n        $or: [\r\n          {shipper: username},\r\n          {username: username}\r\n        ]\r\n      }]\r\n    };\r\n\r\n    $.get('/get_invoices_by_condition', {q: JSON.stringify(obj), isNeedAnalysis: false}, function (data) {\r\n      var result = JSON.parse(data);\r\n      if (result.ok) {\r\n        waybillHandler.setQueryData(result);\r\n\r\n        myWaybillQuery.empty();\r\n        $.each(result.invoices, function (index, inv) {\r\n          myWaybillQuery.append(\"<option value='\" + inv.waybill_no + \"'>\" + inv.waybill_no + \"</option>\");\r\n        });\r\n\r\n        unselected(myWaybillQuery);\r\n      } else {\r\n        bootbox.alert('查询数据库有误！');\r\n      }\r\n    })\r\n  });\r\n\r\n  elementEventRegister(checkWaybillMe, 'ifUnchecked', function () {\r\n    showHtmlElement($('#div-my-select'), false);\r\n    showHtmlElement($('#div-select2'), true);\r\n  });\r\n\r\n  elementEventRegister(myWaybillQuery, 'change', function () {\r\n    selectWaybill(this.value);\r\n  });\r\n\r\n  elementEventRegister(sWaybillNo, 'change', function (e) {\r\n    if (e.added) {\r\n      selectWaybill(e.added.text);\r\n    }\r\n  });\r\n\r\n  //////////////////////////////////////////////////////////////////////\r\n  // Search function handle\r\n  //////////////////////////////////////////////////////////////////////\r\n  elementEventRegister($('#invoice_search'), 'click', function () {\r\n    var searchHandler = new SearchHandlerD('invoice');\r\n    searchHandler.initial('/get_invoices_by_condition');\r\n    searchHandler.okEventHandler(function (result, selectedIdx) {\r\n      selectedWaybill = waybillHandler.resetWithQueryData(result, selectedIdx);\r\n      waybillNo = selectedWaybill.waybill_no;\r\n      innerWaybillNoOrder = 0;\r\n\r\n      $('#search_dialog').modal('hide');\r\n\r\n      if (action === \"ADD\") { // 在配发界面\r\n        waybillHandler.openToNew = true;\r\n        showHtmlElement($('#inv-head-info'), true);\r\n        $('#waybill_oper_text').text('打开运单号: ');\r\n        $('#waybill_no').text(waybillNo);\r\n      }\r\n      else if (sWaybillNo.length) {\r\n        sWaybillNo.select2(\"val\", waybillNo);\r\n        myWaybillQuery.val(waybillNo);\r\n      }\r\n\r\n      showWaybillData();\r\n    });\r\n\r\n    $('#search_dialog').modal({backdrop: 'static', keyboard: false}).modal('show');\r\n  });\r\n\r\n  elementEventRegister($('#waybill_delete'), 'click', function () {\r\n    if (selectedWaybill && waybillNo) {\r\n      if (selectedWaybill.state === '已结算') {\r\n        bootbox.alert('此运单已结算,不能删除!');\r\n      } else {\r\n        bootbox.confirm('您确定要删除吗?', function (result) {\r\n          if (result) {\r\n            ajaxRequestHandle('/delete_invoice', 'POST', selectedWaybill, '运单删除:' + waybillNo, function () {\r\n              waybillHandler.reset('');\r\n              selectedWaybill = null;\r\n              waybillNo = '';\r\n\r\n              myWaybillQuery.find('[value=\"' + waybillNo + '\"]').remove();\r\n              initAllHtmlElements();\r\n            });\r\n          }\r\n        })\r\n      }\r\n    }\r\n  });\r\n\r\n\r\n  // 开单名称改变处理\r\n  function handlerReset(shipName) {\r\n    $.get('/get_bill_by_name', {q: shipName}, function (data) {\r\n      var obj = jQuery.parseJSON(data);\r\n\r\n      waybillHandler.reset(shipName);\r\n\r\n      obj.bills.forEach(function (b) {\r\n        waybillHandler.addBill(b)\r\n      });\r\n\r\n      waybillHandler.insertSelectOptions(sOrderNo, shipName);\r\n\r\n      sOrderNo.select2('val', '');\r\n      sBillNo.select2('val', '');\r\n\r\n      for (var i = 0; i < dictData.company.length; ++i) {\r\n        if (shipName === dictData.company[i].name) {\r\n          initSelect(sShipCustomer, dictData.company[i].customers, false);\r\n          break;\r\n        }\r\n      }\r\n\r\n      initInvoiceBody();\r\n    });\r\n  }\r\n\r\n  function checkNumWeightInput() {\r\n    for (var i = 0, len = invoiceBody.find(\"tr\").length; i < len; ++i) {\r\n      var tr = getRowChildren(invoiceBody, i);\r\n      var td = getTableCellChildren(tr, cNumIdx + 1);\r\n      if (td.find(\"input\").length) {\r\n        var num = (+getTableCellChildren(tr, cNumIdx).find(\"input\").val());\r\n        var weight = (+td.find(\"input\").val());\r\n        if ((num > 0 && weight === 0) || (num === 0 && weight > 0)) {\r\n          return false;\r\n        }\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  var saving = true;\r\n\r\n  /*\r\n   * save data and reset UI\r\n   */\r\n  function buildDataAndSave(status, route, msg) {\r\n    if (isVessel) {\r\n      if (vehTotShipNum > 0) {\r\n        bootbox.alert(\"车号:\" + vehicleNo.val() + \"未确定配发完毕, 保存前请确定.\");\r\n        return;\r\n      } else {\r\n        for (var i = 0, len = invoiceBody.find(\"tr\").length; i < len; ++i) {\r\n          var tr = getRowChildren(invoiceBody, i);\r\n          if (isEmpty(tr.find('td:last-child').text())) {\r\n            bootbox.alert(\"由于你选择了船发运, 请为每个提单选择船发运相对应的车辆号, 否则不能保存!\");\r\n            return;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (!checkNumWeightInput()) {\r\n      bootbox.alert(\"请输入发运块数和发运重量,两者缺一不可, 否则不能保存!\");\r\n      return;\r\n    }\r\n\r\n    if (!waybillNo) {\r\n      bootbox.alert(\"运单号为空，不能保存!\"); return;\r\n    }\r\n\r\n    var el = status === '新建' ? btnSave : btnSaveShip;\r\n    el.prop('disabled', true);\r\n\r\n    if (saving) {\r\n      console.log('saving ....')\r\n      saving = false;\r\n      var selectedBills = waybillHandler.getSelectedBills();\r\n      var data = {\r\n        waybill_no: waybillNo,\r\n        vehicle_vessel_name: sVehicleName.val(),\r\n        ship_name: sShipName.val(),\r\n        ship_customer: sShipCustomer.val(),\r\n        ship_from: sShipFrom.val(),\r\n        ship_to: inputForShipTo ? iShipTo.val() : sShipTo.val(),\r\n        ship_date: iShipDateGrp.data(\"DateTimePicker\").getDate(),\r\n        bills: selectedBills.slice(0),\r\n        total_weight: totalWeight,\r\n        username: username,\r\n        shipper: username,\r\n        state: status\r\n      };\r\n\r\n      ajaxRequestHandle(route, 'POST', data, msg, function () {\r\n        waybillHandler.saveInvoice(data);\r\n        waybillHandler.insertSelectOptions(sOrderNo, waybillHandler.shipName);\r\n\r\n        if (action === 'ADD') {\r\n          invoiceBody.empty();\r\n        }\r\n\r\n        sBillNo.select2('val', '');\r\n\r\n        if (status === '已配发') {\r\n          selectedWaybill = undefined;\r\n          waybillNo = \"\";\r\n          waybillHandler.reset('');\r\n          isVessel = false;\r\n          invInputUI.toggle();\r\n          initAllHtmlElements();\r\n\r\n          if (action === 'MODIFY') {\r\n            sWaybillNo.select2(\"val\", \"\");\r\n            myWaybillQuery.val('');\r\n          } else {\r\n            $('#waybill_no').text(waybillNo);\r\n            curr_invoice_state = 'idle';\r\n          }\r\n        } else {\r\n          setHtmlElementDisabled(btnSave, true);\r\n          curr_invoice_state = 'saved';\r\n        }\r\n\r\n        el.prop('disabled', false);\r\n        saving = true;\r\n      });\r\n    } else {\r\n      console.log(\"cannot click it\")\r\n    }\r\n\r\n    setTimeout(function() {\r\n      saving = true;\r\n    }, 1500)\r\n  }\r\n\r\n  function getNumAndWeight(tr) {\r\n    var td = getTableCellChildren(tr, cNumIdx + 1);\r\n    return {\r\n      num: (+getTableCellChildren(tr, cNumIdx).find('input').val()),\r\n      weight: td.find('input').length ? (+td.find('input').val()) : (+td.text())\r\n    }\r\n  }\r\n\r\n  function updateHeadText(needVehicleInfo) {\r\n    if (needVehicleInfo) {\r\n      showHtmlElement($('#inv-table-input th:last-child, #inv-table-input td:last-child'), isVessel);\r\n      showHtmlElement($('#vehicle-info'), (action === \"REMOVE\") ? false : isVessel);\r\n    }\r\n\r\n    var res = waybillHandler.hasMixedBill();\r\n    var t1 = '实际块数';\r\n    var t2 = '剩余块数';\r\n    if (res === 2) {\r\n      t1 = '实际重量';\r\n      t2 = '剩余重量';\r\n    } else if (res === 3) {\r\n      t1 = '实际块数/重量';\r\n      t2 = '剩余块数/重量';\r\n    }\r\n\r\n    $('#real-head-text').text(t1);\r\n    $('#left-head-text').text(t2);\r\n  }\r\n\r\n  function buildTableTr(bill, total, left, send_num, send_weight) {\r\n    var dw = (bill.block_num > 0) ? getStrValue(bill.weight) : \"\";\r\n    var str = '<tr><td style=\"cursor:pointer\" class=\"td-icon\"><i title=\"删除\" class=\"fa fa-trash-o redlink\"></i></td><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td align=\"center\">{7}</td><td align=\"center\">{8}</td>'\r\n      .format(bill.bill_no, getOrder(bill.order_no, bill.order_item_no), bill.ship_warehouse ? bill.ship_warehouse : \"\",\r\n      getStrValue(bill.thickness), getStrValue(bill.width), getStrValue(bill.len),\r\n      dw, getStrValue(total), getStrValue(left));\r\n\r\n    if (bill.block_num > 0) {\r\n      str += '<td><input type=\"text\" name=\"ship_number\" data-toggle=\"tooltip\" title=\"最大可用块数:{0}, 剩余块数:{1}\" class=\"ship-num form-control\" value=\"{2}\"/></td>'.format(bill.left, left, send_num);\r\n      str += '<td align=\"center\">' + getStrValue(send_weight) + '</td>';\r\n    } else {\r\n      str += '<td><input type=\"text\" name=\"ship_number\" class=\"ship-num form-control\" value=\"' + send_num + '\"/></td>';\r\n      str += '<td><input type=\"text\" name=\"ship_weight\" data-toggle=\"tooltip\" title=\"最大可用重量:{0}, 剩余重量:{1}\" class=\"ship-num form-control\" value=\"{2}\"/></td>'.format(getStrValue(bill.left), left, getStrValue(send_weight));\r\n    }\r\n\r\n    return str;\r\n  }\r\n\r\n  function makeVehSelect(name, veh_name) {\r\n    var wagonNoSelect = '<select disabled style=\"width: 100%\" name=\"' + name + '\">';\r\n    if (isEmpty(veh_name)) {\r\n      wagonNoSelect += '<option selected disabled hidden value=\"\"></option>';\r\n    }\r\n\r\n    allVehicles.forEach(function (vname) {\r\n      wagonNoSelect += '<option ' + (vname === veh_name ? 'selected' : '') + '>' + vname + '</option>';\r\n    });\r\n\r\n    return wagonNoSelect + '</select>';\r\n  }\r\n\r\n  function getVehTableData(attrName) {\r\n    var vehNo = vehicleNo.val();\r\n    var wid = waybillNo + leftPad(innerWaybillNoOrder, 3);\r\n    return '<td align=\"center\" title=\"' + wid + '\" name=\"' + attrName + '\">' + (vehNo ? vehNo : \"\") + '</td>';\r\n  }\r\n\r\n  function findSameTr(bill, needVehicles, onlyForFind) {\r\n    var numOfRow = invoiceBody.find(\"tr\").length;// $('#invoice_tbody tr').length;\r\n    var trs = [];\r\n    for (var i = 0; i < numOfRow; ++i) {\r\n      var tr = getRowChildren(invoiceBody, i);\r\n      var b = getTableCellChildren(tr, 1).text();\r\n      var o = getTableCellChildren(tr, 2).text();\r\n      if (bill.bill_no === b && getOrder(bill.order_no, bill.order_item_no) === o) {\r\n        if (needVehicles && isVessel) {\r\n          if (bill.vehicles && bill.vehicles.length) {\r\n            var nw = getNumAndWeight(tr);\r\n            var veh = tr.find('td:last').find('select').val();\r\n            var found = false;\r\n            bill.vehicles.forEach(function (bveh) {\r\n              var wid = bveh.inner_waybill_no.substring(0, 17);\r\n              if (!found && wid === selectedWaybill.waybill_no && nw.num === bveh.send_num && veh === bveh.veh_name) {\r\n                found = true;\r\n                trs.push(tr);\r\n              }\r\n            })\r\n          }\r\n        } else {\r\n          trs.push(tr);\r\n        }\r\n\r\n        if (onlyForFind && trs.length) {\r\n          return trs;\r\n        }\r\n      }\r\n    }\r\n\r\n    return trs;\r\n  }\r\n\r\n  function appendInvoiceBody(bill, num, initial) {\r\n    if (!isVessel && findSameTr(bill, true, true).length) {\r\n      return; // exist same record and return\r\n    }\r\n\r\n    var left = bill.left - num;\r\n    var total = (bill.block_num > 0) ? bill.block_num : bill.total_weight;\r\n    var send_num = 0, send_weight = 0;\r\n    var html = \"\";\r\n\r\n    if (action === \"ADD\" || action === \"REMOVE\" || (action === 'MODIFY' && !isVessel)) {\r\n      if (bill.block_num > 0) {\r\n        send_num = num;\r\n        send_weight = num * bill.weight;\r\n      } else {\r\n        if (action === \"ADD\") {\r\n          send_num = 0;\r\n        } else {\r\n          send_num = bill.prev_wnum_danding + bill.wnum_danding;\r\n        }\r\n\r\n        send_weight = num;\r\n      }\r\n\r\n      totalNumber += send_num;\r\n      totalWeight += (+send_weight);\r\n\r\n      html = buildTableTr(bill, total, left, send_num, send_weight);\r\n      if (isVessel) {\r\n        if (action === \"REMOVE\") {\r\n          var s = \"<td>\";\r\n          bill.vehicles.forEach(function (bveh) {\r\n            var wid = bveh.inner_waybill_no.substring(0, 17);\r\n            if (wid === selectedWaybill.waybill_no) {\r\n              s += \"<span>\" + bveh.veh_name + \"</span> <code>\" + bveh.send_num + \"</code><br />\";\r\n            }\r\n          });\r\n          html += s + \"</td></tr>\";\r\n        } else {\r\n          html += getVehTableData(\"wagon_no\") + \"</tr>\";\r\n          vehTotShipNum += send_num;\r\n          vehTotShipWeight += (+send_weight);\r\n        }\r\n      } else {\r\n        html += \"<td></td></tr>\";\r\n      }\r\n\r\n      invoiceBody.prepend(html);\r\n    } else { // MODIFY with isVessel true\r\n      if (initial) {\r\n        bill.vehicles.forEach(function (bveh) {\r\n          var wid = bveh.inner_waybill_no.substring(0, 17);\r\n          if (wid === selectedWaybill.waybill_no) {\r\n            send_num = bveh.send_num;\r\n            send_weight = (bill.block_num > 0) ? send_num * bill.weight : bveh.send_weight;\r\n            totalNumber += send_num;\r\n            totalWeight += (+send_weight);\r\n            html = buildTableTr(bill, total, left, send_num, send_weight) + '<td title=\"' + bveh.inner_waybill_no + '\">' + makeVehSelect(\"wagon_no_init\", bveh.veh_name) + \"</td></tr>\";\r\n            invoiceBody.append(html);\r\n          }\r\n        });\r\n      } else {\r\n        html = buildTableTr(bill, total, bill.left_num, 0, 0);\r\n        invoiceBody.prepend(html + getVehTableData(\"wagon_no_new\") + \"</tr>\");\r\n      }\r\n    }\r\n  }\r\n\r\n  function updateLeftNumberCol(bill) {\r\n    var result = findSameTr(bill, false, false);\r\n    if (result.length) {\r\n      var lnStr = getStrValue(bill.left_num);\r\n      result.forEach(function (foundTr) {\r\n        getTableCellChildren(foundTr, cNumIdx - 1).text(lnStr);\r\n      })\r\n    }\r\n  }\r\n\r\n  function updateVehiclesAndInfo(bill, tr, delta_num, delta_weight) {\r\n    /*\r\n     * 1. New added record (tr) by ADD and MODIFY without confirm: Need to update num & weight hint\r\n     * 2. New added record (tr) by MODIFY with confirm:  Don't update num & weight hint\r\n     * 3. Update record by MODIFY with initial: Don't update num & weight hint\r\n     */\r\n    if (isVessel) {\r\n      var td = tr.find('td:last');\r\n      var wid = td.prop(\"title\");\r\n      var veh = td.find(\"select\").length ? td.find(\"select\").val() : td.text();\r\n      var nameAttr = td.attr(\"name\");\r\n      if (nameAttr === \"wagon_no\" || nameAttr === \"wagon_no_new\") {\r\n        vehTotShipNum += delta_num;\r\n        vehTotShipWeight += delta_weight;\r\n        if (vehTotShipNum < 0) {\r\n          vehTotShipNum = 0;\r\n        }\r\n\r\n        if (vehTotShipWeight < 0 || Math.abs(vehTotShipWeight) < 0.00001) {\r\n          vehTotShipWeight = 0;\r\n        }\r\n      }\r\n\r\n      //waybillHandler.updateVehiclesData(bill, delta_num, delta_weight, veh, wid);\r\n      if ((Math.abs(delta_num) > 0 || Math.abs(delta_weight) > 0.00001)) {\r\n        for (var i = 0; i < bill.vehicles.length; ++i) {\r\n          var veh_obj = bill.vehicles[i];\r\n          if (veh_obj.inner_waybill_no === wid) {\r\n            veh_obj.send_num += delta_num;\r\n            veh_obj.send_weight += delta_weight;\r\n            veh_obj.send_weight = toFixedNumber(veh_obj.send_weight, 3);\r\n            veh_obj.veh_name = veh;\r\n            if (veh_obj.send_num === 0 && veh_obj.send_weight < 0.00001) {\r\n              bill.vehicles.remove(i);\r\n            }\r\n\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    totalNumber += delta_num;\r\n    totalWeight += delta_weight;\r\n    if (totalWeight < 0 || Math.abs(totalWeight) < 0.00001) {\r\n      totalWeight = 0;\r\n    }\r\n  }\r\n\r\n  function invoiceBodyEventRegister() {\r\n    elementEventRegister($('.redlink'), 'click', function (e) { // remove & delete\r\n      e.stopImmediatePropagation();\r\n      var tr = $(this).closest('tr');\r\n      var bill = waybillHandler.getBill(tr);\r\n      var nw = getNumAndWeight(tr);\r\n      var modifyVessel = action === 'MODIFY' && isVessel;\r\n      waybillHandler.deleteTableRow(bill, modifyVessel, nw, function (billTip, tips) {\r\n        if (nw.num > 0) {\r\n          updateVehiclesAndInfo(bill, tr, (0 - nw.num), (0 - nw.weight));\r\n        }\r\n\r\n        if (modifyVessel) {\r\n          updateLeftNumberCol(bill);\r\n        }\r\n\r\n        updateUIElem(true, false, bill.order_no, bill.bill_no, tips, billTip);\r\n\r\n        tr.remove();\r\n      });\r\n    });\r\n\r\n    inputEventRegister($('input[name=\"ship_number\"]'), function (me) {\r\n      var tr = me.closest('tr');\r\n      var oValue = parseInt(me.data(\"old\")) || 0;\r\n      var nValue = oValue;\r\n      var bill = waybillHandler.getBill(tr);\r\n      if (bill.block_num > 0) {\r\n        nValue = numberIntValider(me, 0, bill.left_num + oValue);\r\n        var delta_num = nValue - oValue;\r\n        if (delta_num != 0) {\r\n          var delta_weight = delta_num * bill.weight;\r\n          waybillHandler.updateShipNum(bill, delta_num, function (billTip, tips) {\r\n            me.prop(\"title\", \"最大可用块数:{0}, 剩余块数:{1}\".format(bill.left, bill.left_num));\r\n            if (action === 'MODIFY' && isVessel) {\r\n              updateLeftNumberCol(bill);\r\n            } else {\r\n              getTableCellChildren(tr, cNumIdx - 1).text(bill.left_num);\r\n            }\r\n\r\n            getTableCellChildren(tr, cNumIdx + 1).text(getStrValue(nValue * bill.weight));\r\n            updateVehiclesAndInfo(bill, tr, delta_num, delta_weight);\r\n            updateUIElem(false, false, bill.order_no, bill.bill_no, tips, billTip);\r\n\r\n            me.data(\"old\", nValue);\r\n          });\r\n        }\r\n      } else {\r\n        nValue = numberIntValider(me, 0, 2000);\r\n        if (nValue != oValue) {\r\n          if (oValue === 0 && bill.wnum_danding > 0) {\r\n            bill.prev_wnum_danding = bill.wnum_danding;\r\n            bill.wnum_danding = nValue;\r\n          } else {\r\n            bill.wnum_danding += nValue - oValue;\r\n          }\r\n\r\n          // bill.wnum_danding = nValue;\r\n\r\n          updateVehiclesAndInfo(bill, tr, nValue - oValue, 0);\r\n          updateUIElem(false, false, bill.order_no, bill.bill_no, '', '');\r\n\r\n          me.data(\"old\", nValue);\r\n        }\r\n      }\r\n    });\r\n\r\n    inputEventRegister($('input[name=\"ship_weight\"]'), function (me) {\r\n      var oValue = parseFloat(me.data(\"old\")) || 0;\r\n      var tr = me.closest('tr');\r\n      var bill = waybillHandler.getBill(tr);\r\n      var nValue = numberFloatValider(me, oValue, 0, toFixedNumber(bill.left_num + oValue, 3));//Number(max.toFixed(3)));\r\n      var delta = nValue - oValue;\r\n      if (Math.abs(delta) > 0.000001) {\r\n        waybillHandler.updateShipNum(bill, delta, function (billTip, tips) {\r\n          me.prop(\"title\", \"最大可用重量:{0}, 剩余重量:{1}\".format(getStrValue(bill.left), getStrValue(bill.left_num)));\r\n\r\n          if (action === 'MODIFY' && isVessel) {\r\n            updateLeftNumberCol(bill);\r\n          } else {\r\n            getTableCellChildren(tr, cNumIdx - 1).text(getStrValue(bill.left_num));\r\n          }\r\n\r\n          updateVehiclesAndInfo(bill, tr, 0, delta);\r\n          updateUIElem(false, false, bill.order_no, bill.bill_no, tips, billTip);\r\n\r\n          me.data(\"old\", nValue);\r\n        });\r\n      }\r\n    });\r\n\r\n    $('select[name=\"wagon_no_init\"]').on('focus', function () {\r\n      $(this).data(\"old\", this.value || \"\");\r\n    }).on('change', function () {\r\n      $(this).data(\"new\", this.value);\r\n      var me = $(this);\r\n      bootbox.confirm(\"您确定要修改此提单记录的车号?\", function (result) {\r\n        if (result) {\r\n          var tr = me.closest('tr');\r\n        } else {\r\n          me.val(me.data(\"old\"));\r\n          me.data(\"new\", me.data(\"old\"));\r\n        }\r\n      })\r\n    })\r\n  }\r\n\r\n  function updateUIElem(needUpdateLabel, needVehInfo, ono, bno, tips, billTip) {\r\n    if (needUpdateLabel) {\r\n      updateHeadText(needVehInfo);\r\n    }\r\n\r\n    showTotalWeightNumber();\r\n    saveButtonAvailable();\r\n\r\n    sOrderNo.find('option[value=\"{0}\"]'.format(ono)).prop(\"title\", tips);\r\n\r\n    var option = sBillNo.find('option[value=\"{0}\"]'.format(bno));\r\n    option.prop(\"title\", billTip.tip);\r\n    option.prop(\"disabled\", billTip.left_num === 0);\r\n  }\r\n\r\n  function initVehicleElem() {\r\n    vehTotShipNum = 0;\r\n    vehTotShipWeight = 0;\r\n    vswLabel.text(\"0.000\");\r\n    $('#vehicle-ship-num').text(0);\r\n    el_origin.select2('val', '南钢');\r\n    setHtmlElementDisabled(vehShipCfm, true);\r\n  }\r\n\r\n  function getVesselFlag(vehName) {\r\n    var isVessel_tmp = false;\r\n    for (var i = 0; i < dictData.vehInfo.length; ++i) {\r\n      var veh = dictData.vehInfo[i];\r\n      if (veh.name === vehName) {\r\n        var text = '车船号';\r\n        if (veh.veh_type === '车') {\r\n          text = '车号';\r\n        } else if (veh.veh_type === '船') {\r\n          text = '船号';\r\n          isVessel_tmp = true;\r\n        }\r\n\r\n        $('#lb-vehicle').text(text);\r\n        break;\r\n      }\r\n    }\r\n\r\n    return isVessel_tmp;\r\n  }\r\n\r\n  function selectWaybill(wno) {\r\n    waybillHandler.reset(waybillHandler.shipName);\r\n    waybillNo = wno;\r\n    innerWaybillNoOrder = 0;\r\n    selectedWaybill = waybillHandler.getWaybill(wno);\r\n    if (selectedWaybill) {\r\n      waybillHandler.setName(selectedWaybill.ship_name);\r\n      showWaybillData();\r\n    }\r\n  }\r\n\r\n  function getCopiedBill(bill, vehInfo) {\r\n    var copiedBill = jQuery.extend({}, bill);\r\n    copiedBill.inner_waybill_no = vehInfo.inner_waybill_no;\r\n    copiedBill.bveh_send_num = vehInfo.send_num;\r\n    copiedBill.bveh_send_weight = (bill.block_num > 0) ? vehInfo.send_num * bill.weight : vehInfo.send_weight;\r\n    copiedBill.bveh_name = vehInfo.veh_name;\r\n    return copiedBill;\r\n  }\r\n\r\n  function showWaybillData() {\r\n    isVessel = getVesselFlag(selectedWaybill.vehicle_vessel_name);\r\n    if (action === \"REPORT\") {\r\n      showWaybillForReport();\r\n    } else {\r\n      invInputUI.fadeIn('slow');\r\n\r\n      nlApp.setTitle('正在读取运单数据，请稍等...');\r\n      nlApp.showPleaseWait();\r\n\r\n      if (action === \"ADD\") {\r\n        sVehicleName.select2('val', selectedWaybill.vehicle_vessel_name);\r\n        sShipName.select2('val', selectedWaybill.ship_name);\r\n      } else {\r\n        sVehicleName.val(selectedWaybill.vehicle_vessel_name);\r\n        sShipName.val(selectedWaybill.ship_name);\r\n        $('#invoice_state').val(selectedWaybill.state); // Exist on REMOVE UI\r\n      }\r\n\r\n      for (var di = 0; di < dictData.company.length; ++di) {\r\n        if (selectedWaybill.ship_name === dictData.company[di].name) {\r\n          initSelect(sShipCustomer, dictData.company[di].customers, false);\r\n          break;\r\n        }\r\n      }\r\n\r\n      sShipCustomer.val(selectedWaybill.ship_customer);\r\n      iShipTo.val(selectedWaybill.ship_to);\r\n      sShipTo.select2('val', selectedWaybill.ship_to);\r\n      sShipFrom.select2('val', selectedWaybill.ship_from);\r\n      iShipDateGrp.data(\"DateTimePicker\").setDate(selectedWaybill.ship_date);\r\n\r\n      initInvoiceBody();\r\n\r\n      $.get('/get_bill_by_name', {q: selectedWaybill.ship_name}, function (data) {\r\n        var obj = jQuery.parseJSON(data);\r\n        if (obj.ok) {\r\n          obj.bills.forEach(function (bill) {\r\n            waybillHandler.addBill(bill); // 增加所有的提单信息, 并且它选择的发运数为 '0'\r\n          });\r\n        }\r\n\r\n        var bills = waybillHandler.getBillsFromInvoice(selectedWaybill);\r\n        if (action === 'MODIFY' && isVessel) {\r\n          var billList = [];\r\n          bills.forEach(function (bill) {\r\n            var res = waybillHandler.addBillAndTableRow_1(bill, bill.wnum);\r\n\r\n            sOrderNo.find(':selected').prop(\"title\", res.tips);\r\n\r\n            bill.vehicles.forEach(function (bveh) {\r\n              if (bveh.inner_waybill_no && selectedWaybill.waybill_no === bveh.inner_waybill_no.substring(0, 17)) {\r\n                billList.push(getCopiedBill(res.updatedBill, bveh));\r\n              }\r\n            });\r\n          });\r\n\r\n          billList = sortByKey(billList, \"inner_waybill_no\", \"ASC\");\r\n\r\n          billList.forEach(function (bill) {\r\n            var total = (bill.block_num > 0) ? bill.block_num : bill.total_weight;\r\n            totalNumber += bill.bveh_send_num;\r\n            totalWeight += (+bill.bveh_send_weight);\r\n\r\n            var html = buildTableTr(bill, total, bill.left_num, bill.bveh_send_num, bill.bveh_send_weight) +\r\n              '<td title=\"' + bill.inner_waybill_no + '\" name=\"wagon_no_init\">' + makeVehSelect(\"wagon_no_init\", bill.bveh_name) + \"</td></tr>\";\r\n            invoiceBody.append(html);\r\n          })\r\n        } else {\r\n          bills.forEach(function (bill) {\r\n            var sendNumForWaybill = bill.wnum;\r\n            waybillHandler.addBillAndTableRow(bill, sendNumForWaybill, function (b, tips) {\r\n              if (b.openToNew) { // Only TRUE on ADD UI\r\n                if (b.block_num > 0) {\r\n                  totalWeight += (sendNumForWaybill * bill.weight);\r\n                  totalNumber += sendNumForWaybill;\r\n                } else {\r\n                  totalWeight += (+sendNumForWaybill);\r\n                  totalNumber += bill.prev_wnum_danding + bill.wnum_danding;\r\n                }\r\n              } else {\r\n                appendInvoiceBody(b, sendNumForWaybill, true);\r\n              }\r\n\r\n              if (sOrderNo.length) {\r\n                sOrderNo.find(':selected').prop(\"title\", tips);\r\n              }\r\n            });\r\n          })\r\n        }\r\n\r\n        if (action === \"REMOVE\") {\r\n          disableAll();\r\n        } else {\r\n          invoiceBodyEventRegister();\r\n          sVehicleName.prop(\"disabled\", true);\r\n          sShipName.prop(\"disabled\", true);\r\n        }\r\n\r\n        if (isVessel) {\r\n          innerWaybillNoOrder = getMaxInnerWaybillNo(bills, selectedWaybill.waybill_no);\r\n        }\r\n\r\n        showTotalWeightNumber();\r\n        updateHeadText(true);\r\n\r\n        if (sOrderNo.length) {\r\n          waybillHandler.insertSelectOptions(sOrderNo, selectedWaybill.ship_name);\r\n        }\r\n\r\n        setHtmlElementDisabled(btnSave, true);\r\n        setHtmlElementDisabled(btnSaveShip, true);\r\n        sBillNo.select2('val', '');\r\n\r\n        nlApp.hidePleaseWait();\r\n      });\r\n    }\r\n  }\r\n\r\n  // UI Handle\r\n  function showTotalWeightNumber() {\r\n    lTotalWeight.text(toFixedStr(totalWeight, 3));\r\n    lTotalNumber.text(totalNumber);\r\n    if (isVessel) {\r\n      $('#vehicle-ship-num').text(vehTotShipNum);\r\n      vswLabel.text(toFixedStr(vehTotShipWeight, 3));\r\n      setHtmlElementDisabled(vehShipCfm, (vehTotShipNum <= 0 || isEmpty(vehicleNo.val())));\r\n    }\r\n  }\r\n\r\n  function saveButtonAvailable() {\r\n    setHtmlElementDisabled(btnSave, true);\r\n    setHtmlElementDisabled(btnSaveShip, true);\r\n\r\n    if (selectedWaybill && (selectedWaybill.state == '已结算')) {\r\n      return;\r\n    }\r\n\r\n    var s1 = sVehicleName.val();\r\n    var s2 = inputForShipTo ? iShipTo.val() : sShipTo.val();\r\n    var s7 = sShipFrom.val();\r\n    var s8 = sShipCustomer.val();\r\n    var b1 = isEmpty(s1);\r\n    var b2 = isEmpty(s2);\r\n    if (b1 || b2 || isEmpty(s7)) {\r\n      return; // 车船号, 目的地必须存在,才能保存和配发\r\n    }\r\n\r\n    var s3 = iShipDateGrp.data(\"DateTimePicker\").getDate();\r\n    var b3 = isEmpty(s3);\r\n    var b4 = waybillHandler.hasSelectedBills() || (totalNumber > 0 && totalWeight > 0);\r\n\r\n    if (selectedWaybill) {\r\n      var b5 = !waybillHandler.compare(selectedWaybill); // 不相等\r\n      var b6 = true;\r\n      if (selectedWaybill.ship_date && !b3) {\r\n        b6 = !moment(selectedWaybill.ship_date, \"YYYY-MM-DD HH:mm\").isSame(s3);\r\n      }\r\n\r\n      if (selectedWaybill.ship_to != s2 ||\r\n        b6 || selectedWaybill.vehicle_vessel_name != s1 ||\r\n        b5 || selectedWaybill.ship_from != s7 || selectedWaybill.ship_customer != s8) {\r\n        setHtmlElementDisabled(btnSave, false);\r\n        if (!b3 && b4) {\r\n          setHtmlElementDisabled(btnSaveShip, false);\r\n        }\r\n      }\r\n    } else {\r\n      if (!b3 && b4) {\r\n        setHtmlElementDisabled(btnSave, false);\r\n        setHtmlElementDisabled(btnSaveShip, false);\r\n      } else if (b4) {\r\n        setHtmlElementDisabled(btnSave, false);\r\n      }\r\n    }\r\n  }\r\n\r\n  function initAllHtmlElements() {\r\n    sShipFrom.select2('val', '南钢');\r\n    sShipTo.select2('val', '');\r\n    iShipTo.val('');\r\n    if (iShipDateGrp.length) {\r\n      iShipDateGrp.data(\"DateTimePicker\").setDate(\"\");\r\n    }\r\n\r\n    if (action === 'ADD' || action === 'MODIFY') {\r\n      sVehicleName.select2('val', '');\r\n      sShipName.select2('val', '');\r\n    } else {\r\n      sVehicleName.val(\"\");\r\n      sShipName.val(\"\");\r\n    }\r\n\r\n    if (action === 'REMOVE') {\r\n      disableAll();\r\n    } else {\r\n      sOrderNo.empty();\r\n      sBillNo.empty();\r\n      vehicleNo.select2('val', '');\r\n\r\n      setHtmlElementDisabled(btnSave, true);\r\n      setHtmlElementDisabled(btnSaveShip, true);\r\n    }\r\n\r\n    initInvoiceBody();\r\n\r\n    if (sWaybillNo.length > 0) {\r\n      sWaybillNo.val('');\r\n      sWaybillNo.select2(\"val\", \"\");\r\n      unselected(myWaybillQuery);\r\n    }\r\n  }\r\n\r\n  function initInvoiceBody() {\r\n    totalWeight = 0;\r\n    totalNumber = 0;\r\n    invoiceBody.empty();\r\n    showTotalWeightNumber();\r\n  }\r\n\r\n  function disableAll() {\r\n    invInputUI.find('input').prop('disabled', true);\r\n    invInputUI.find('select').prop('disabled', true);\r\n    $('#inv-table-input').find('input').prop('disabled', true);\r\n    if (iShipDateGrp.length) {\r\n      iShipDateGrp.data(\"DateTimePicker\").disable();\r\n    }\r\n  }\r\n\r\n  // import function\r\n  $('#invoice_import').on('click', function () {\r\n    bootbox.alert('功能还在实现中...,请稍等!');\r\n  });\r\n\r\n  // REPORT FUNCTION\r\n  function showEditDialog(name, elem, okHandler) {\r\n    var dname = $('#dict_name');\r\n    var dok = $('#data-btn-ok');\r\n    setElementValue($('#phone'), '');\r\n    setElementValue($('#contact'), '');\r\n    setElementValue($('#address'), '');\r\n    setElementValue(dname, getElementValue(elem));\r\n    dname.prop('disabled', true);\r\n    setHtmlElementDisabled(dok, false);\r\n\r\n    dok.on('click', function () {\r\n      okHandler();\r\n      $('#data-dialog').modal('hide');\r\n    });\r\n\r\n    $('#lbl-name').text(name);\r\n    $('#dialog-title').text('编辑' + name);\r\n    $('#data-dialog').modal({backdrop: 'static', keyboard: false}).modal('show');\r\n  }\r\n\r\n  function showWaybillForReport() {\r\n    showHtmlElement($('#waybill-tools'), true);\r\n    $('#report-content').fadeIn('slow');\r\n    setElementValue($('#report-bill-name'), selectedWaybill.ship_name);\r\n    setElementValue($('#report-ship-customer'), selectedWaybill.ship_customer ? selectedWaybill.ship_customer : selectedWaybill.ship_name);\r\n    var rbphoneElem = $('#report-bill-phone');\r\n    setElementValue(rbphoneElem, '');\r\n    for (var i = 0; i < dictData.company.length; ++i) {\r\n      var company = dictData.company[i];\r\n      if (company.name === selectedWaybill.ship_name) {\r\n        setElementValue(rbphoneElem, company.phone);\r\n        break;\r\n      }\r\n    }\r\n\r\n    setElementValue($('#report-ship-to'), selectedWaybill.ship_to);\r\n    var rsphoneElem = $('#report-shipto-phone');\r\n    var rscontactElem = $('#report-shipto-contact');\r\n    setElementValue(rsphoneElem, '');\r\n    setElementValue(rscontactElem, '');\r\n    for (var k = 0; k < dictData.destination.length; ++k) {\r\n      var dest = dictData.destination[k];\r\n      if (dest.name === selectedWaybill.ship_to) {\r\n        setElementValue(rsphoneElem, dest.phone);\r\n        setElementValue(rscontactElem, dest.contact_name);\r\n        break;\r\n      }\r\n    }\r\n\r\n    setElementValue($('#report-waybill-no'), selectedWaybill.waybill_no);\r\n    setElementValue($('#report-vehicle-name'), selectedWaybill.vehicle_vessel_name);\r\n    if (selectedWaybill.ship_date) {\r\n      setElementValue($('#report-ship-date'), date2Str(selectedWaybill.ship_date, false));\r\n    } else {\r\n      setElementValue($('#report-ship-date'), '');\r\n    }\r\n    setElementValue($('#report-ship-from'), selectedWaybill.ship_from);\r\n    dictData.vehInfo.forEach(function (vehicle) {\r\n      if (vehicle.name === selectedWaybill.vehicle_vessel_name) {\r\n        setElementValue($('#report-ship-phone'), vehicle.phone);\r\n      }\r\n    });\r\n\r\n    var allBills = waybillHandler.getBillsFromInvoice(selectedWaybill);\r\n    $('#report-table-body').html(getTableHtml(allBills));\r\n    showHtmlElement($('#report-th-vessel'), isVessel);\r\n    reportTable.trigger(\"update\");\r\n\r\n    var tn = 0, tw = 0;\r\n    allBills.forEach(function (b) {\r\n      if (b.block_num > 0) {\r\n        tw += b.weight * b.wnum;\r\n        tn += b.wnum;\r\n      } else {\r\n        tw += b.wnum;\r\n        tn += (b.prev_wnum_danding + b.wnum_danding);\r\n      }\r\n    });\r\n\r\n    setElementValue($('#report-total-weight'), toFixedStr(tw, 3));\r\n    setElementValue($('#report-total-number'), tn);\r\n  }\r\n\r\n  function getTableHtml(allBills) {\r\n    var html = [], str = \"<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td></tr>\";\r\n\r\n    if (isVessel) {\r\n      var allVehBills = [];\r\n      allBills.forEach(function (b) {\r\n        b.invoices.forEach(function (inv) {\r\n          if (inv.inv_no === waybillNo) {\r\n            inv.vehicles.forEach(function (veh) {\r\n              allVehBills.push(getCopiedBill(b, veh));\r\n            })\r\n          }\r\n        });\r\n      });\r\n      allVehBills = sortByKey(allVehBills, \"inner_waybill_no\", \"ASC\");\r\n      allVehBills.forEach(function (b) {\r\n        html.push(str.format(b.bill_no, getOrder(b.order_no, b.order_item_no), b.brand_no ? b.brand_no : \"\",\r\n          getStrValue(b.thickness), getStrValue(b.width), getStrValue(b.len), (b.block_num > 0) ? getStrValue(b.weight) : \"\",\r\n          b.bveh_send_num, getStrValue(b.bveh_send_weight), b.ship_warehouse ? b.ship_warehouse : \"\", b.contract_no ? b.contract_no : \"\", b.bveh_name));\r\n      })\r\n    }\r\n    else {\r\n      str = '<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td></tr>';\r\n      allBills.forEach(function (b) {\r\n        if (b.block_num > 0) {\r\n          html.push(str.format(b.bill_no, getOrder(b.order_no, b.order_item_no),\r\n            b.brand_no ? b.brand_no : \"\", getStrValue(b.thickness), getStrValue(b.width), getStrValue(b.len),\r\n            getStrValue(b.weight), getStrValue(b.wnum), getStrValue(b.weight * b.wnum),\r\n            b.ship_warehouse ? b.ship_warehouse : \"\", b.contract_no ? b.contract_no : \"\"));\r\n        } else {\r\n          html.push(str.format(b.bill_no, getOrder(b.order_no, b.order_item_no),\r\n            b.brand_no ? b.brand_no : \"\", getStrValue(b.thickness), getStrValue(b.width), getStrValue(b.len),\r\n            '', getStrValue(b.prev_wnum_danding + b.wnum_danding), getStrValue(b.wnum),\r\n            b.ship_warehouse ? b.ship_warehouse : \"\", b.contract_no ? b.contract_no : \"\"));\r\n        }\r\n      });\r\n    }\r\n\r\n    return html.join('');\r\n  }\r\n\r\n});\r\n"]}