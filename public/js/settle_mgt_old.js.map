{"version":3,"sources":["settle_mgt_old.js"],"names":["$","getNonSettleParamObj","res","action","selected_bills","forEach","b","inv_settle_flag","CUSTOMER_SETTLE_FLAG","price","push","bid","_id","inv_no","COLLECTION_SETTLE_FLAG","collection_price","settle_flag","enableButtons","curr_show_bills","length","setHtmlElementDisabled","btnExport","batchPriceInput","singlePriceInput","btnSettle","btnNonSettle","getPriceText","priceText","getStrValue","updatePriceColumn","tr","bill","find","eq","html","getState","buildPriceDialog","ok","obj","updated","getPriceValue","bill_no","order","veh_ves_name","id","ajaxRequestHandle","data","act","numOfRow","tableBody","i","getRowChildren","getTableCellChildren","text","o","no","getOrder","order_no","order_item_no","msg","str","format","ship_from","ship_to","bootbox","dialog","message","title","buttons","cancel","label","className","main","callback","buildBatchInputForCollection","bills","each","idx","this","buildPriceBatchInputDialog","idxList","name","idata","hasOwnProperty","item","temp","split","replace","index","billing_name","indexOf","isExist","vv2dest","jqId","v","val","value","parseFloatHTML","isNaN","resetTableRow","empty","html_text","curr_bills","showNonSettle","makeTableBodyTr","append","join","prop","on","selectRow","e","stopImmediatePropagation","closest","me","needUpdateCheckbox","found","sameBill","remove","removeClass","addClass","statusStr","isEmpty","getStrByStatus","status","statusText","trHtml","ship_customer","remark","width","len","send_num","send_weight","ship_warehouse","date2Str","inv_ship_date","inv_shipper","filterData","needUpdateDbData","emptyDbData","css","cursor","qFilter","getQueryParams","get","result","jQuery","parseJSON","dbBills","sortByKey","updateOptions","showHintText","totalNumber","totalWeight","num","btnCustomer","btnCollection","btnFilter","QueryFilterD","local_data","local_data_2","elementEventRegister","reset","alert","checkBox","slice","allName","shipToList","settleObj","totPrice","weight","bname","settle_type","billName","shipTo","hasPrice","bothNotSettle","local_user","privilege","confirm","nonSettleObj","showHideNotSettle","iCheck","saveToExcel","toggle","options","options_2","filter","currSelected","self","uiElems","sBfOrder","FilterElementD","isAllEmpty","sBfBillName","sBfDest","sBfVehicle","startDateGrp","endDateGrp","iStartDate","iEndDate","sBfBillNo","selectedVeh","selectedDest","sDate","eDate","initSelect","nameList","vehList","destList","select2","_selectFliterFunc","which","_dateFilterFunc","isStart","isEnd","d1","d2","datetimepicker","getDateTimePickerOptions","preventDefault","date","startOf","setMinDate","endOf","setMaxDate","prototype","fName","fVeh","fDest","fOrder","fBno","fDate1","toISOString","fDate2","fType","selected","bno","getSelectValue","billNo","nOptions","orderList","billNoList","visibleBills","sort_pinyin","vehs","ds","b1","b2","b3","b4","b6","sort","rebuild"],"mappings":"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","file":"settle_mgt_old.js","sourcesContent":["/**\r\n * Created by ezefjia on 12/4/2014.\r\n */\r\n\r\n$(function () {\r\n  \"use strict\";\r\n\r\n  var tableBody        = $('#table-tbody');\r\n  var btnCustomer      = $('#customer-btn');\r\n  var btnCollection    = $('#collection-btn');\r\n  var btnFilter        = $('#filter');\r\n  var btnExport        = $('#search-export');\r\n  var singlePriceInput = $('#single-price-input');\r\n  var batchPriceInput  = $('#batch-price-input');\r\n  var btnSettle        = $('#settle-bill');\r\n  var btnNonSettle     = $('#non-settle-bill');\r\n\r\n  var dbBills = [];\r\n  var curr_bills = []; // 存放查询得到的所有提单\r\n  var selected_bills = [];\r\n  var curr_show_bills = [];\r\n\r\n  var action = \"CUSTOMER\";\r\n\r\n  var CUSTOMER_SETTLE_FLAG   = 1; // 0001\r\n  var COLLECTION_SETTLE_FLAG = 2; // 0010\r\n\r\n  var qFilter = new QueryFilterD(local_data, local_data_2, action, filterData);\r\n\r\n  $('#first-th').html('<input id=\"select-all\" type=\"checkbox\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"选择所有记录\" />');\r\n  enableButtons();\r\n\r\n  elementEventRegister(btnCustomer, 'click', function() {\r\n    if (action != \"CUSTOMER\") {\r\n      action = \"CUSTOMER\";\r\n      btnCustomer.removeClass(\"btn-default\");\r\n      btnCustomer.addClass(\"btn-primary\");\r\n      btnCollection.removeClass(\"btn-primary\");\r\n      btnCollection.addClass(\"btn-default\");\r\n      qFilter.reset(action);\r\n      showHintText();\r\n    }\r\n  });\r\n\r\n  elementEventRegister(btnCollection, 'click', function() {\r\n    if (action != \"COLLECTION\") {\r\n      action = \"COLLECTION\";\r\n      btnCollection.removeClass(\"btn-default\");\r\n      btnCollection.addClass(\"btn-primary\");\r\n      btnCustomer.removeClass(\"btn-primary\");\r\n      btnCustomer.addClass(\"btn-default\");\r\n      qFilter.reset(action);\r\n      showHintText();\r\n    }\r\n  });\r\n\r\n  elementEventRegister(singlePriceInput, 'click', function() {\r\n    if (selected_bills.length === 1) {\r\n      buildPriceDialog(selected_bills[0]);\r\n    } else if (selected_bills.length > 1) {\r\n      bootbox.alert(\"您选择了多行，请使用批量输入！\");\r\n    } else {\r\n      bootbox.alert(\"请先选定某一行才能输入价格\");\r\n    }\r\n  });\r\n\r\n  elementEventRegister(batchPriceInput, 'click', function() {\r\n    if (selected_bills.length) {\r\n      if (action === 'COLLECTION') {\r\n        buildBatchInputForCollection(selected_bills);\r\n      } else {\r\n        buildPriceBatchInputDialog(selected_bills);\r\n      }\r\n    } else {\r\n      if (action === 'COLLECTION') {\r\n        buildBatchInputForCollection(curr_show_bills);\r\n      } else {\r\n        buildPriceBatchInputDialog(curr_show_bills);\r\n      }\r\n    }\r\n  });\r\n\r\n  elementEventRegister($('#select-all'), 'click', function() {\r\n    if (curr_show_bills.length > 0) {\r\n      var checkBox = $('.select-bill');\r\n      if (selected_bills.length === curr_show_bills.length) { // 之前已经选择\r\n        checkBox.prop(\"checked\", false);\r\n        selected_bills = [];\r\n        tableBody.find(\"tr\").removeClass('invoice-highlighted');\r\n      } else {\r\n        checkBox.prop(\"checked\", true);\r\n        selected_bills = curr_show_bills.slice(0);\r\n        tableBody.find(\"tr\").addClass('invoice-highlighted');\r\n      }\r\n      enableButtons();\r\n    }\r\n  });\r\n\r\n  elementEventRegister(btnSettle, 'click', function() {\r\n    if (selected_bills.length) {\r\n      var allName = [];\r\n      var shipToList = [];\r\n      for (var i = 0; i < selected_bills.length; ++i) {\r\n        var b = selected_bills[i];\r\n        if (allName.indexOf(b.billing_name) < 0) {\r\n          allName.push(b.billing_name);\r\n          if (allName.length > 1) {\r\n            bootbox.alert(\"您选择的提单中存在多个开单名称, 一次只能结算一个开单名称的提单\");\r\n            return;\r\n          }\r\n        }\r\n\r\n        if (shipToList.indexOf(b.ship_to) < 0) {\r\n          shipToList.push(b.ship_to);\r\n        }\r\n\r\n        if (action === \"COLLECTION\") {\r\n          if (b.collection_price === -1) {\r\n            bootbox.alert(\"您选择的提单:\" + b.bill_no + \"_\" + b.order + \" 已经确定为不需要结算!\");\r\n            return;\r\n          } else if (b.collection_price === 0) {\r\n            bootbox.alert(\"您选择的提单:\" + b.bill_no + \"_\" + b.order + \" 还没有完全输入价格,不能结算\");\r\n            return;\r\n          }\r\n        } else {\r\n          if (b.price === -1) {\r\n            bootbox.alert(\"您选择的提单:\" + b.bill_no + \"_\" + b.order + \" 已经确定为不需要结算!\");\r\n            return;\r\n          } else if (b.price === 0) {\r\n            bootbox.alert(\"您选择的提单:\" + b.bill_no + \"_\" + b.order + \" 还没有完全输入价格,不能结算\");\r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      var settleObj = [];\r\n      var totPrice = 0;\r\n      selected_bills.forEach(function(b) {\r\n        if (action === \"COLLECTION\") {\r\n          totPrice += b.collection_price * b.send_weight;\r\n          b.inv_settle_flag |= COLLECTION_SETTLE_FLAG;\r\n          b.settle_flag |= COLLECTION_SETTLE_FLAG;\r\n        } else {\r\n          totPrice += b.price * b.send_weight;\r\n          b.inv_settle_flag |= CUSTOMER_SETTLE_FLAG;\r\n        }\r\n\r\n        settleObj.push({\r\n          bid: b._id,\r\n          inv_no: b.inv_no,\r\n          num: b.send_num,\r\n          weight: b.send_weight,\r\n          settle_flag: b.inv_settle_flag // (action === \"COLLECTION\") ? b.settle_flag : b.inv_settle_flag\r\n        });\r\n      });\r\n\r\n      var bname = (selected_bills[0].ship_customer ? (selected_bills[0].billing_name + \"/\" + selected_bills[0].ship_customer) : selected_bills[0].billing_name);\r\n      setHtmlElementDisabled(btnSettle, true);\r\n      ajaxRequestHandle('/settle_bill', 'POST',\r\n        { settleObj: settleObj,\r\n          price: totPrice,\r\n          settle_type: action,\r\n          billName: bname,\r\n          shipTo: shipToList.join(\",\")\r\n        }, '结算', function () {\r\n          resetTableRow();\r\n          setHtmlElementDisabled(btnSettle, false);\r\n        });\r\n    } else {\r\n      bootbox.alert(\"请先选择您要结算的提单\");\r\n    }\r\n  });\r\n\r\n  function getNonSettleParamObj() {\r\n    var res = [];\r\n    if (action === \"CUSTOMER\") {\r\n      selected_bills.forEach(function (b) {\r\n        b.inv_settle_flag &= ~CUSTOMER_SETTLE_FLAG;\r\n        b.price = -1;\r\n        res.push({ bid: b._id, inv_no: b.inv_no });\r\n      });\r\n    } else {\r\n      selected_bills.forEach(function (b) {\r\n        b.inv_settle_flag &= ~COLLECTION_SETTLE_FLAG;\r\n        b.collection_price = -1;\r\n        res.push({ bid: b._id, inv_no: b.inv_no, settle_flag: b.inv_settle_flag });\r\n      });\r\n    }\r\n\r\n    return res;\r\n  }\r\n\r\n  elementEventRegister(btnNonSettle, 'click', function() {\r\n    if (selected_bills.length) {\r\n      var hasPrice = false;\r\n      var bothNotSettle = false;\r\n      selected_bills.forEach(function(b) {\r\n        if (action === \"CUSTOMER\") {\r\n          if (b.price > 0) hasPrice = true;\r\n\r\n          if (b.collection_price < 0) {\r\n            bothNotSettle = true;\r\n          }\r\n        } else {\r\n          if (b.collection_price > 0) hasPrice = true;\r\n\r\n          if (b.price < 0) {\r\n            bothNotSettle = true;\r\n          }\r\n        }\r\n      });\r\n\r\n      if (bothNotSettle) {\r\n        if (local_user.privilege !== '11111111') {\r\n          bootbox.alert('点击此不需要结算后，存在客户和代收代付都不需要结算的情况，你并没有相应权限，请联系管理员！');\r\n        } else {\r\n          bootbox.confirm('点击此不需要结算后，存在客户和代收代付都不需要结算的情况，确定不需要结算？', function() {\r\n            var nonSettleObj = [];\r\n            if (hasPrice) {\r\n              bootbox.confirm(\"您选择的提单中已经输入过价格, 不结算后这些价格都会清除为0, 确认吗?\", function(result) {\r\n                if (result) {\r\n                  nonSettleObj = getNonSettleParamObj();\r\n                  ajaxRequestHandle('/collection_not_require_settle', 'POST',\r\n                    { nonSettleObj: nonSettleObj, settle_type: action }, '不需结算', function () {\r\n                      resetTableRow();\r\n                    });\r\n                }\r\n              })\r\n            } else {\r\n              nonSettleObj = getNonSettleParamObj();\r\n              ajaxRequestHandle('/collection_not_require_settle', 'POST',\r\n                { nonSettleObj: nonSettleObj, settle_type: action }, '不需结算', function () {\r\n                  resetTableRow();\r\n                });\r\n            }\r\n          });\r\n        }\r\n      } else {\r\n        var nonSettleObj = [];\r\n        if (hasPrice) {\r\n          bootbox.confirm(\"您选择的提单中已经输入过价格, 不结算后这些价格都会清除为0, 确认吗?\", function (result) {\r\n            if (result) {\r\n              nonSettleObj = getNonSettleParamObj();\r\n              ajaxRequestHandle('/collection_not_require_settle', 'POST',\r\n                {nonSettleObj: nonSettleObj, settle_type: action}, '不需结算', function () {\r\n                  resetTableRow();\r\n                });\r\n            }\r\n          })\r\n        } else {\r\n          nonSettleObj = getNonSettleParamObj();\r\n          ajaxRequestHandle('/collection_not_require_settle', 'POST',\r\n            {nonSettleObj: nonSettleObj, settle_type: action}, '不需结算', function () {\r\n              resetTableRow();\r\n            });\r\n        }\r\n      }\r\n\r\n    } else {\r\n      bootbox.alert(\"请先选择您不打算进行结算的提单\");\r\n    }\r\n  });\r\n\r\n  elementEventRegister($('#update-bill'), 'click', function() {\r\n    ajaxRequestHandle('/initial_settle_flag', 'POST', {}, '初始化数据', function () { });\r\n  });\r\n\r\n  var showNonSettle = false;\r\n  var showHideNotSettle = $('#show-hide-non-settle');\r\n  showHideNotSettle.iCheck('uncheck');\r\n  showHideNotSettle.on('ifChecked', function() {\r\n    showNonSettle = true;\r\n    showHintText();\r\n  });\r\n  showHideNotSettle.on('ifUnchecked', function() {\r\n    showNonSettle = false;\r\n    showHintText();\r\n  });\r\n\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  /// Function list\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  function enableButtons() {\r\n    if (curr_show_bills.length) {\r\n      setHtmlElementDisabled(btnExport, false);\r\n      setHtmlElementDisabled(batchPriceInput, false);\r\n    } else {\r\n      setHtmlElementDisabled(btnExport, true);\r\n      setHtmlElementDisabled(batchPriceInput, true);\r\n    }\r\n\r\n    if (selected_bills.length) {\r\n      if (selected_bills.length === 1) {\r\n        setHtmlElementDisabled(singlePriceInput, false);\r\n      } else {\r\n        setHtmlElementDisabled(singlePriceInput, true);\r\n      }\r\n\r\n      setHtmlElementDisabled(btnSettle, false);\r\n      setHtmlElementDisabled(btnNonSettle, false);\r\n    } else {\r\n      setHtmlElementDisabled(btnSettle, true);\r\n      setHtmlElementDisabled(btnNonSettle, true);\r\n      setHtmlElementDisabled(singlePriceInput, true);\r\n    }\r\n  }\r\n\r\n  function getPriceText(price) {\r\n    var priceText = \"\";\r\n    if (price > 0) {\r\n      priceText = '<code style=\"color:green\">' + getStrValue(price) + '</code>';\r\n    } else if (price < 0) {\r\n      priceText = '<code style=\"color:blue\">不需要结算</code>';\r\n    } else {\r\n      priceText = '<code style=\"color:red\">0</code>';\r\n    }\r\n\r\n    return priceText;\r\n  }\r\n\r\n  function updatePriceColumn(tr, bill) {\r\n    tr.find(\"td\").eq(1).html(getState(bill));\r\n    tr.find(\"td\").eq(7).html(getPriceText(action === \"CUSTOMER\" ? bill.price : bill.collection_price));\r\n    //tr.popover('hide').attr('data-content', getBillTooltip(bill));\r\n  }\r\n\r\n  function buildPriceDialog(bill) {\r\n    var id = \"\";\r\n    var msg = '<div class=\"row form-horizontal\"><div class=\"col-md-10\">';\r\n    var str = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">{1}</label><div class=\"input-group col-sm-8\"><input id=\"{2}\" type=\"text\" name=\"{3}\" class=\"form-control\" value=\"{4}\"><span style=\"font-size: 11px\">始发: {5}, 目的地: {6}</span></div></div>';\r\n    if (action === 'COLLECTION') {\r\n      id = bill.bill_no + '_' + bill.order;\r\n      msg += str.format(id, '代收代付价格', id, id, getStrValue(bill.collection_price, \"\", \"\"));\r\n    } else {\r\n      if (bill.veh_ves_name) { // 正常有运单一定有运单车船，需要再检查？\r\n        id = bill.inv_no;\r\n        msg += str.format(id, bill.veh_ves_name, id, id, getStrValue(bill.price), bill.ship_from, bill.ship_to);\r\n      }\r\n    }\r\n    msg += '</div>';\r\n\r\n    bootbox.dialog({\r\n      message: msg,\r\n      title: \"单行价格输入\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\" },\r\n        main:   { label: \"确定\", className: \"btn-primary\", callback: ok }\r\n      }\r\n    });\r\n\r\n    function ok() {\r\n      var obj = {\r\n        bid : bill._id,\r\n        inv_no: bill.inv_no,\r\n        price: 0\r\n      };\r\n      var updated = false;\r\n      var price = -1;\r\n      if (action === 'COLLECTION') {\r\n        price = getPriceValue(bill.bill_no + '_' + bill.order);\r\n        if ((price >= 0 || price === -1) && bill.collection_price != price) {\r\n          bill.collection_price = price;\r\n          obj.price = price;\r\n          updated = true;\r\n        }\r\n      } else {\r\n        if (bill.veh_ves_name) {\r\n          id = bill.inv_no;\r\n          price = getPriceValue(id);\r\n          if ((price >= 0 || price === -1) && bill.price != price) {\r\n            bill.price = price;\r\n            obj.price = price;\r\n            updated = true;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (updated) {\r\n        ajaxRequestHandle('/price_input', 'POST', { data: [ obj ], act: action }, 'no_message', function() {\r\n          var numOfRow = tableBody.find(\"tr\").length;\r\n          for (var i = 0; i < numOfRow; ++i) {\r\n            var tr = getRowChildren(tableBody, i);\r\n            var b = getTableCellChildren(tr, 3).text();\r\n            var o = getTableCellChildren(tr, 2).text();\r\n            var no = getTableCellChildren(tr, 13).text();\r\n            if (bill.bill_no === b && getOrder(bill.order_no, bill.order_item_no) === o && bill.inv_no === no) {\r\n              updatePriceColumn(tr, bill);\r\n              break;\r\n            }\r\n          }\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  function buildBatchInputForCollection(bills) {\r\n    bootbox.dialog({\r\n      message: '<div class=\"row form-horizontal\"><div class=\"col-md-10\"><div class=\"form-group\"><label for=\"collection_00001\" class=\"control-label col-sm-4\">批量输入代收代付价格</label><div class=\"input-group col-sm-8\"><input id=\"collection_00001\" type=\"text\" name=\"collection_00001\" class=\"form-control\"></div></div></div></div>',\r\n      title: \"批量价格输入\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\" },\r\n        main:   { label: \"确定\", className: \"btn-primary\", callback: function() {\r\n          var price = getPriceValue(\"collection_00001\");\r\n          if (price >= 0 || price === -1) {\r\n            var obj = [];\r\n            bills.forEach(function(b) {\r\n              b.collection_price = price;\r\n              obj.push({\r\n                bid : b._id,\r\n                inv_no: b.inv_no,\r\n                price: price\r\n              })\r\n            });\r\n            ajaxRequestHandle('/price_input', 'POST', { data: obj, act: action }, 'no_message', function() {\r\n              tableBody.find('tr').each(function(idx) {\r\n              //$('#table-tbody tr').each(function(idx) {\r\n                updatePriceColumn($(this), curr_show_bills[idx]);\r\n              });\r\n            });\r\n          }\r\n        } }\r\n      }\r\n    });\r\n  }\r\n\r\n  function buildPriceBatchInputDialog(bills) {\r\n    var idata = {}; // { billname : { veh_ves_name: [] }  }\r\n    bills.forEach(function(bill) {\r\n      if (!isExist(idata[bill.billing_name])) {\r\n        idata[bill.billing_name] = [];\r\n      }\r\n\r\n      if (bill.veh_ves_name && bill.ship_to) {\r\n        var vv2dest = bill.veh_ves_name + '-' + bill.ship_to;\r\n        if (idata[bill.billing_name].indexOf(vv2dest) < 0) {\r\n          idata[bill.billing_name].push(vv2dest);\r\n        }\r\n      }\r\n    });\r\n\r\n    var msg = '<div class=\"row form-horizontal\">';\r\n    var str = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">{1}</label><div class=\"input-group col-sm-8\"><input id=\"{2}\" type=\"text\" name=\"{3}\" class=\"form-control\"><span style=\"font-size: 11px\">目的地: {4}</span></div></div>';\r\n    var id = \"\";\r\n    for (var name in idata) {\r\n      if (idata.hasOwnProperty(name) && idata[name].length) {\r\n        var html = '<div class=\"col-md-10\"><label>' + name + '</label>';\r\n        idata[name].forEach(function(item) {\r\n          var temp = item.split('-');\r\n          id = name.replace(/[\\s\\(\\)#]+/g, '') + '__' + item.replace(/[\\s\\(\\)#]+/g, \"999\");\r\n          html += str.format(id, temp[0], id, id, temp[1]);\r\n        });\r\n        msg += html + '</div>';\r\n      }\r\n    }\r\n    msg += '</div>';\r\n\r\n    bootbox.dialog({\r\n      message: msg,\r\n      title: \"批量输入价格\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\", callback: function() { }},\r\n        main:   { label: \"确定\", className: \"btn-primary\", callback: ok }\r\n      }\r\n    });\r\n\r\n    function ok() {\r\n      var id = \"\";\r\n      var idxList = [];\r\n      for (var name in idata) {\r\n        if (idata.hasOwnProperty(name)) {\r\n          idata[name].forEach(function (item) {\r\n            var temp = item.split('-');\r\n            id = name.replace(/[\\s\\(\\)#]+/g, '') + '__' + item.replace(/[\\s\\(\\)#]+/g, \"999\");\r\n            var price = getPriceValue(id);\r\n            if (price >= 0 || price === -1) {\r\n              $.each(bills, function (index, b) {\r\n                if (b.billing_name === name && b.veh_ves_name === temp[0] && b.ship_to === temp[1]) {\r\n                  b.price = price;\r\n                  if (idxList.indexOf(index) < 0) {\r\n                    idxList.push(index);\r\n                  }\r\n                }\r\n              });\r\n            }\r\n          });\r\n        }\r\n      }\r\n\r\n      if (idxList.length) {\r\n        var obj = [];\r\n        idxList.forEach(function(idx) {\r\n          obj.push({\r\n            bid : bills[idx]._id,\r\n            inv_no: bills[idx].inv_no,\r\n            price: bills[idx].price\r\n          });\r\n        });\r\n        ajaxRequestHandle('/price_input', 'POST', { data: obj, act: action }, 'no_message', function() {\r\n          tableBody.find('tr').each(function(idx) {\r\n          //$('#table-tbody tr').each(function(idx) {\r\n            updatePriceColumn($(this), curr_show_bills[idx]);\r\n          });\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  function getPriceValue(id) {\r\n    var jqId = '#' + id;\r\n    var v = $(jqId).val();\r\n    if (v) {\r\n      var value = parseFloatHTML($(jqId).val());\r\n      if (isNaN(value) || value == 0) {\r\n        return 0;\r\n      } else {\r\n        return value;\r\n      }\r\n    } else {\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  function resetTableRow() {\r\n    tableBody.empty();\r\n    selected_bills = [];\r\n    curr_show_bills = [];\r\n    var html_text = [];\r\n    curr_bills.forEach(function (bill) {\r\n      if (action === 'CUSTOMER') {\r\n        if (showNonSettle) {\r\n          if (bill.price === -1) {\r\n            html_text.push(makeTableBodyTr(bill));\r\n            curr_show_bills.push(bill);\r\n          }\r\n        }\r\n        else {\r\n          if ((bill.inv_settle_flag & CUSTOMER_SETTLE_FLAG) != CUSTOMER_SETTLE_FLAG && bill.price >= 0) {\r\n            html_text.push(makeTableBodyTr(bill));\r\n            curr_show_bills.push(bill);\r\n          }\r\n        }\r\n      } else if (action === \"COLLECTION\") {\r\n        if (showNonSettle) {\r\n          if (bill.collection_price === -1) {\r\n            html_text.push(makeTableBodyTr(bill));\r\n            curr_show_bills.push(bill);\r\n          }\r\n        }\r\n        else {\r\n          if ((bill.inv_settle_flag & COLLECTION_SETTLE_FLAG) != COLLECTION_SETTLE_FLAG && bill.collection_price >= 0) {\r\n            html_text.push(makeTableBodyTr(bill));\r\n            curr_show_bills.push(bill);\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    tableBody.append(html_text.join('\\n'));\r\n\r\n    //$('#lb-total-weight').text(getStrValue(totalWeight));\r\n    //$('#lb-total-num').text(getStrValue(totalNumber));\r\n    //$('#curr-bills-number').text(tableBody.find(\"tr\").length);\r\n\r\n    $('#select-all').prop(\"checked\", false);\r\n    enableButtons();\r\n\r\n    tableBody.find('tr').on('click', function () {\r\n      selectRow($(this), true);\r\n    });\r\n\r\n    $('.select-bill').on('click', function(e) {\r\n      e.stopImmediatePropagation();\r\n      selectRow($(this).closest('tr'), false);\r\n    });\r\n\r\n//    $('[data-toggle=\"popover\"]').popover({ trigger: \"hover\", html: true, placement: \"bottom\" });\r\n  }\r\n\r\n  function selectRow(me, needUpdateCheckbox) {\r\n    var b = curr_show_bills[me.index()];\r\n    var found = false;\r\n    for (var i = 0; i < selected_bills.length; ++i) {\r\n      if (sameBill(selected_bills[i], b)) {\r\n        selected_bills.remove(i);\r\n        found = true;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (found) {\r\n      me.removeClass('invoice-highlighted');\r\n    } else {\r\n      selected_bills.push(b);\r\n      me.addClass('invoice-highlighted');\r\n    }\r\n\r\n    if (needUpdateCheckbox) {\r\n      me.find('input[type=\"checkbox\"]').prop(\"checked\", !found);\r\n    }\r\n\r\n    $('#select-all').prop(\"checked\", selected_bills.length === tableBody.find(\"tr\").length);\r\n    enableButtons();\r\n  }\r\n\r\n  function getState(bill) {\r\n    var statusStr = \"\";\r\n    if (isEmpty(bill.inv_settle_flag) || bill.inv_settle_flag === 0) {\r\n      if (bill.price === -1 && bill.collection_price === -1) {\r\n        statusStr = getStrByStatus(\"客户,代收不需结算\", bill.status);\r\n      } else if (bill.price === -1) {\r\n        statusStr = getStrByStatus(\"客户不需结算\", bill.status);\r\n      } else if (bill.collection_price === -1) {\r\n        statusStr = getStrByStatus(\"代收不需结算\", bill.status);\r\n      } else {\r\n        statusStr = getStrByStatus(\"未结算\", bill.status);\r\n      }\r\n    } else {\r\n      var statusText = [];\r\n      if ((bill.inv_settle_flag & CUSTOMER_SETTLE_FLAG) === CUSTOMER_SETTLE_FLAG) {\r\n        statusText.push(\"客户\");\r\n      }\r\n      if ((bill.inv_settle_flag & COLLECTION_SETTLE_FLAG) === COLLECTION_SETTLE_FLAG) {\r\n        statusText.push(\"代收付\");\r\n      }\r\n      statusStr = getStrByStatus(statusText.join(',') + '已结算', bill.status);\r\n    }\r\n\r\n    return statusStr;\r\n  }\r\n\r\n  function makeTableBodyTr(bill) {\r\n    //var tipTitle = getOrder(bill.order_no, bill.order_item_no) + ' ' + bill.bill_no;\r\n    //var trHtml = '<tr data-toggle=\"popover\" title=\"{0}\" data-content=\"{1}\"><td align=\"center\"><input class=\"select-bill\" type=\"checkbox\"></td>'.format(tipTitle, getBillTooltip(bill));\r\n    var trHtml = '<tr><td align=\"center\"><input class=\"select-bill\" type=\"checkbox\"></td>';\r\n\r\n    //totalNumber += bill.send_num; // priceInfoObj.totalNumber;\r\n    //totalWeight += bill.send_weight; // bill.total_weight;\r\n\r\n    var priceText = getPriceText(action === \"CUSTOMER\" ? bill.price : bill.collection_price);\r\n    var name = (bill.ship_customer ? (bill.billing_name + \"/\" + bill.ship_customer) : bill.billing_name);\r\n\r\n    var remark = '';\r\n    if (bill.width < 3000 && bill.len < 13500) {\r\n        remark = '正常';\r\n    } else if ((bill.width >= 3000 && bill.width < 3300) || (bill.len >= 13500 && bill.len < 16500)) {\r\n      remark = '超长宽';\r\n    } else if (bill.width >= 3300 || bill.len >= 16500) {\r\n      remark = '特长宽';\r\n    }\r\n\r\n    trHtml += '<td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td></tr>';\r\n    return trHtml.format(getState(bill), getOrder(bill.order_no, bill.order_item_no), bill.bill_no,\r\n      name, bill.veh_ves_name, bill.ship_to, priceText,\r\n      bill.send_num > 0 ? bill.send_num : '', getStrValue(bill.send_weight),\r\n      bill.ship_warehouse ? bill.ship_warehouse : '', date2Str(bill.inv_ship_date), bill.inv_shipper ? bill.inv_shipper : '', bill.inv_no, remark);\r\n  }\r\n\r\n  elementEventRegister(btnExport, 'click', function() { saveToExcel(curr_bills, \"data\"); });\r\n  elementEventRegister(btnFilter, 'click', function() { $('#filter-ui').toggle() });\r\n  elementEventRegister($('#show-data'), 'click', function() { resetTableRow(); });\r\n\r\n  function filterData(needUpdateDbData, emptyDbData) {\r\n    if (needUpdateDbData) {\r\n      $('body').css({'cursor':'wait'});\r\n      var obj = qFilter.getQueryParams();\r\n      $.get('/get_invoices_bill', obj, function (data) {\r\n        var result = jQuery.parseJSON(data);\r\n        dbBills = [];\r\n        if (result.ok) {\r\n          dbBills = sortByKey(result.bills, \"inv_ship_date\", \"DSC\");\r\n        }\r\n        curr_bills = qFilter.updateOptions(dbBills, false);\r\n        showHintText();\r\n        $('body').css({'cursor':'default'});\r\n      });\r\n    } else {\r\n      if (emptyDbData) {\r\n        dbBills = [];\r\n      }\r\n      curr_bills = qFilter.updateOptions(dbBills, emptyDbData);\r\n      showHintText();\r\n    }\r\n  }\r\n\r\n  function showHintText() {\r\n    tableBody.empty();\r\n    selected_bills = [];\r\n    curr_show_bills = [];\r\n    var totalNumber = 0;\r\n    var totalWeight = 0;\r\n    var num = 0;\r\n    var price = 0;\r\n    if (action === 'CUSTOMER') {\r\n      curr_bills.forEach(function (bill) {\r\n        if (showNonSettle) {\r\n          if (bill.price === -1) {\r\n            totalNumber += bill.send_num;\r\n            totalWeight += bill.send_weight;\r\n            ++num;\r\n          }\r\n        }\r\n        else {\r\n          //console.log(bill);\r\n          if ((bill.inv_settle_flag & CUSTOMER_SETTLE_FLAG) != CUSTOMER_SETTLE_FLAG && bill.price >= 0) {\r\n            totalNumber += bill.send_num;\r\n            totalWeight += bill.send_weight;\r\n            ++num;\r\n            price += bill.price * bill.send_weight;\r\n          }\r\n        }\r\n      });\r\n    } else if (action === \"COLLECTION\") {\r\n      curr_bills.forEach(function (bill) {\r\n        if (showNonSettle) {\r\n          if (bill.collection_price === -1) {\r\n            totalNumber += bill.send_num;\r\n            totalWeight += bill.send_weight;\r\n            ++num;\r\n          }\r\n        }\r\n        else {\r\n          if ((bill.inv_settle_flag & COLLECTION_SETTLE_FLAG) != COLLECTION_SETTLE_FLAG && bill.collection_price >= 0) {\r\n            totalNumber += bill.send_num;\r\n            totalWeight += bill.send_weight;\r\n            ++num;\r\n            price += bill.collection_price * bill.send_weight;\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    $('#lb-total-amount').text(getStrValue(price));\r\n    $('#lb-total-weight').text(getStrValue(totalWeight));\r\n    $('#lb-total-num').text(getStrValue(totalNumber));\r\n    $('#curr-bills-number').text(num);\r\n  }\r\n});\r\n\r\n///////////////////////////////////////////////////////////////////////////////\r\n///////////////////////////////////////////////////////////////////////////////\r\nvar QueryFilterD = function(options, options_2, action, filter) {\r\n  this.currSelected = 0;\r\n  var self = this;\r\n\r\n  this.uiElems = {\r\n    sBfOrder : new FilterElementD($('#bf-order-no'), [], false, true, function() {\r\n      self.currSelected = 2;\r\n      filter(false, self.isAllEmpty());\r\n    }),\r\n\r\n    sBfBillName :  $('#bf-bill-name'),\r\n    sBfDest :      $('#bf-destination'),\r\n    sBfVehicle :   $('#bf-vehicle'),\r\n    startDateGrp : $('#start-date-grp'),\r\n    endDateGrp :   $('#end-date-grp'),\r\n    iStartDate :   $('#start-date'),\r\n    iEndDate :     $('#end-date'),\r\n\r\n    sBfBillNo: new FilterElementD($('#bf-bill-no'), [], false, true, function() {\r\n      self.currSelected = 6;\r\n      filter(false, self.isAllEmpty());\r\n    })\r\n  };\r\n\r\n  this.options = options;\r\n  this.options_2 = options_2;\r\n  this.action = action;\r\n  this.selectedVeh = [];\r\n  this.selectedDest = [];\r\n  this.sDate = null;\r\n  this.eDate = null;\r\n\r\n  if (action === \"CUSTOMER\") {\r\n    initSelect(this.uiElems.sBfBillName, options.nameList, true);\r\n    initSelect(this.uiElems.sBfVehicle, options.vehList, false);\r\n    initSelect(this.uiElems.sBfDest, options.destList, false);\r\n  }\r\n  else if (action === \"COLLECTION\") {\r\n    initSelect(this.uiElems.sBfBillName, options_2.nameList, true);\r\n    initSelect(this.uiElems.sBfVehicle, options_2.vehList, false);\r\n    initSelect(this.uiElems.sBfDest, options_2.destList, false);\r\n  }\r\n\r\n  this.uiElems.sBfBillName.select2();\r\n  this.uiElems.sBfVehicle.select2();\r\n  this.uiElems.sBfDest.select2();\r\n  this.uiElems.iStartDate.val(\"\");\r\n  this.uiElems.iEndDate.val(\"\");\r\n\r\n  this._selectFliterFunc = function(which, filter) {\r\n    this.currSelected = which;\r\n    if (this.isAllEmpty()) {\r\n      filter(false, true);       // return to initial state\r\n    }\r\n    else {\r\n      filter(true, false);\r\n    }\r\n  };\r\n\r\n  this._dateFilterFunc = function(isStart, isEnd, filter) {\r\n    var d1 = this.uiElems.iStartDate.val();\r\n    var d2 = this.uiElems.iEndDate.val();\r\n    var b = false;\r\n    if (isStart && isEnd) {\r\n      b = !isEmpty(d1) && !isEmpty(d2);\r\n    } else if (isStart) {\r\n      b = isEmpty(this.uiElems.iStartDate.val());\r\n    } else if (isEnd) {\r\n      b = isEmpty(this.uiElems.iEndDate.val());\r\n    }\r\n\r\n    if (b) {\r\n      this.currSelected = 5;\r\n      filter(true, false);\r\n    }\r\n  };\r\n\r\n  self.uiElems.sBfBillName.on('change', function() { self._selectFliterFunc(1, filter); });\r\n\r\n  self.uiElems.sBfVehicle.on('change', function(e) {\r\n    self.selectedVeh = e.val;\r\n    self._selectFliterFunc(3, filter);\r\n  });\r\n\r\n  self.uiElems.sBfDest.on('change', function(e) {\r\n    self.selectedDest = e.val;\r\n    self._selectFliterFunc(4, filter);\r\n  });\r\n\r\n  self.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.sDate = e.date.startOf('day');\r\n    self.uiElems.endDateGrp.data(\"DateTimePicker\").setMinDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.eDate = e.date.endOf('day');\r\n    self.uiElems.startDateGrp.data(\"DateTimePicker\").setMaxDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.iStartDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(true, false, filter);\r\n  });\r\n  self.uiElems.iEndDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(false, true, filter);\r\n  });\r\n\r\n};\r\n\r\nQueryFilterD.prototype.getQueryParams = function() {\r\n  var name = this.uiElems.sBfBillName.val();\r\n  var d1 = this.uiElems.iStartDate.val();\r\n  var d2 = this.uiElems.iEndDate.val();\r\n  var b = !isEmpty(d1) && !isEmpty(d2);\r\n\r\n  return {\r\n    fName: name ? [ name ] : null,\r\n    fVeh: this.selectedVeh,\r\n    fDest: this.selectedDest,\r\n    fOrder: null, fBno: null,\r\n    fDate1: b ? this.sDate.toISOString() : null,\r\n    fDate2: b ? this.eDate.toISOString() : null,\r\n    fType: \"invoice-first\"\r\n  };\r\n};\r\n\r\nQueryFilterD.prototype.isAllEmpty = function() {\r\n  var order = this.uiElems.sBfOrder.selected;\r\n  var bno = this.uiElems.sBfBillNo.selected;\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var d1 = this.uiElems.iStartDate.val();\r\n  var d2 = this.uiElems.iEndDate.val();\r\n\r\n  return order.length === 0 && bno.length === 0 && this.selectedVeh.length === 0 && this.selectedDest.length === 0 &&\r\n    isEmpty(name) && isEmpty(d1) && isEmpty(d2);\r\n};\r\n\r\nQueryFilterD.prototype.updateOptions = function(bills, reset) {\r\n  var order = this.uiElems.sBfOrder.selected;\r\n  var billNo = this.uiElems.sBfBillNo.selected;\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var nOptions = { orderList: [], vehList: [], destList: [], billNoList: [] };\r\n  var visibleBills = [];\r\n  if (reset) {\r\n    if (this.action === \"CUSTOMER\") {\r\n      nOptions = this.options;\r\n    } else {\r\n      nOptions = this.options_2;\r\n    }\r\n    visibleBills = bills;\r\n    bills.forEach(function (bill) {\r\n      if (bill.ship_to && nOptions.destList.indexOf(bill.ship_to) < 0) {\r\n        nOptions.destList.push(bill.ship_to);\r\n      }\r\n    });\r\n    nOptions.destList = sort_pinyin(nOptions.destList);\r\n  }\r\n  else {\r\n    var vehs = this.selectedVeh;\r\n    var ds = this.selectedDest;\r\n    var act = this.action;\r\n\r\n    bills.forEach(function (bill) {\r\n      var b1 = !order.length || (order.indexOf(bill.order_no) >= 0);\r\n      var b2 = vehs.length === 0 || (vehs.indexOf(bill.veh_ves_name) >= 0);\r\n      var b3 = ds.length === 0 || (ds.indexOf(bill.ship_to) >= 0);\r\n      var b4 = !name || name === bill.billing_name;\r\n      var b6 = !billNo.length || (billNo.indexOf(bill.bill_no) >= 0);\r\n\r\n      if (b2 && b3 && b4) {\r\n        if (act === 'CUSTOMER') {\r\n          if ((bill.inv_settle_flag & 1) !== 1) {\r\n            if (nOptions.orderList.indexOf(bill.order_no) < 0) {\r\n              nOptions.orderList.push(bill.order_no);\r\n            }\r\n            if (nOptions.billNoList.indexOf(bill.bill_no) < 0) {\r\n              nOptions.billNoList.push(bill.bill_no);\r\n            }\r\n          }\r\n        } else {\r\n          if ((bill.inv_settle_flag & 2) !== 2) {\r\n            if (nOptions.orderList.indexOf(bill.order_no) < 0) {\r\n              nOptions.orderList.push(bill.order_no);\r\n            }\r\n            if (nOptions.billNoList.indexOf(bill.bill_no) < 0) {\r\n              nOptions.billNoList.push(bill.bill_no);\r\n            }\r\n          }\r\n        }\r\n\r\n        if (b1 && b6) {\r\n          if (bill.veh_ves_name && nOptions.vehList.indexOf(bill.veh_ves_name) < 0) {\r\n            nOptions.vehList.push(bill.veh_ves_name);\r\n          }\r\n          if (bill.ship_to && nOptions.destList.indexOf(bill.ship_to) < 0) {\r\n            nOptions.destList.push(bill.ship_to);\r\n          }\r\n          visibleBills.push(bill);\r\n        }\r\n      }\r\n    });\r\n\r\n    nOptions.destList = sort_pinyin(nOptions.destList);\r\n    nOptions.orderList.sort();\r\n    nOptions.billNoList = sort_pinyin(nOptions.billNoList);\r\n    nOptions.vehList = sort_pinyin(nOptions.vehList);\r\n  }\r\n\r\n  if (this.currSelected === 2) {\r\n    this.uiElems.sBfBillNo.rebuild(nOptions.billNoList.sort(), billNo);\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, false);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, false);\r\n    this.uiElems.sBfDest.select2('val', this.selectedDest);\r\n  }\r\n  else if (this.currSelected === 3) {\r\n    this.uiElems.sBfOrder.rebuild(nOptions.orderList.sort(), order);\r\n    this.uiElems.sBfBillNo.rebuild(nOptions.billNoList.sort(), billNo);\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, false);\r\n    this.uiElems.sBfDest.select2('val', this.selectedDest);\r\n  }\r\n  else if (this.currSelected === 4) {\r\n    this.uiElems.sBfOrder.rebuild(nOptions.orderList.sort(), order);\r\n    this.uiElems.sBfBillNo.rebuild(nOptions.billNoList.sort(), billNo);\r\n\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, false);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n  }\r\n  else if (this.currSelected === 6) {\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, false);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, false);\r\n    this.uiElems.sBfDest.select2('val', this.selectedDest);\r\n    this.uiElems.sBfOrder.rebuild(nOptions.orderList.sort(), order);\r\n  }\r\n  else {\r\n    this.uiElems.sBfBillNo.rebuild(nOptions.billNoList.sort(), billNo);\r\n    this.uiElems.sBfOrder.rebuild(nOptions.orderList.sort(), order);\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, false);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, false);\r\n    this.uiElems.sBfDest.select2('val', this.selectedDest);\r\n  }\r\n\r\n  return visibleBills;\r\n};\r\n\r\nQueryFilterD.prototype.reset = function(action) {\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n\r\n  if (action === \"CUSTOMER\") {\r\n    initSelect(this.uiElems.sBfBillName, this.options.nameList, true, name);\r\n    initSelect(this.uiElems.sBfVehicle, this.options.vehList, false);\r\n    initSelect(this.uiElems.sBfDest, this.options.destList, false);\r\n  } else if (action === \"COLLECTION\") {\r\n    initSelect(this.uiElems.sBfBillName, this.options_2.nameList, true, name);\r\n    initSelect(this.uiElems.sBfVehicle, this.options_2.vehList, false);\r\n    initSelect(this.uiElems.sBfDest, this.options_2.destList, false);\r\n  }\r\n\r\n  this.action = action;\r\n  this.uiElems.sBfBillName.select2(\"val\", name);\r\n  this.uiElems.sBfVehicle.select2(\"val\", this.selectedVeh);\r\n  this.uiElems.sBfDest.select2(\"val\", this.selectedDest);\r\n};"]}