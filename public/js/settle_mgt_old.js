$(function(){"use strict";function e(){var e=[];return"CUSTOMER"===x?L.forEach(function(t){t.inv_settle_flag&=~C,t.price=-1,e.push({bid:t._id,inv_no:t.inv_no})}):L.forEach(function(t){t.inv_settle_flag&=~N,t.collection_price=-1,e.push({bid:t._id,inv_no:t.inv_no,settle_flag:t.inv_settle_flag})}),e}function t(){y.length?(setHtmlElementDisabled(b,!1),setHtmlElementDisabled(E,!1)):(setHtmlElementDisabled(b,!0),setHtmlElementDisabled(E,!0)),L.length?(1===L.length?setHtmlElementDisabled(g,!1):setHtmlElementDisabled(g,!0),setHtmlElementDisabled(S,!1),setHtmlElementDisabled(O,!1)):(setHtmlElementDisabled(S,!0),setHtmlElementDisabled(O,!0),setHtmlElementDisabled(g,!0))}function i(e){var t="";return t=e>0?'<code style="color:green">'+getStrValue(e)+"</code>":e<0?'<code style="color:blue">不需要结算</code>':'<code style="color:red">0</code>'}function l(e,t){e.find("td").eq(1).html(d(t)),e.find("td").eq(7).html(i("CUSTOMER"===x?t.price:t.collection_price))}function s(e){function t(){var t={bid:e._id,inv_no:e.inv_no,price:0},s=!1,n=-1;"COLLECTION"===x?(n=a(e.bill_no+"_"+e.order),(n>=0||n===-1)&&e.collection_price!=n&&(e.collection_price=n,t.price=n,s=!0)):e.veh_ves_name&&(i=e.inv_no,n=a(i),(n>=0||n===-1)&&e.price!=n&&(e.price=n,t.price=n,s=!0)),s&&ajaxRequestHandle("/price_input","POST",{data:[t],act:x},"no_message",function(){for(var t=m.find("tr").length,i=0;i<t;++i){var s=getRowChildren(m,i),n=getTableCellChildren(s,3).text(),o=getTableCellChildren(s,2).text(),a=getTableCellChildren(s,13).text();if(e.bill_no===n&&getOrder(e.order_no,e.order_item_no)===o&&e.inv_no===a){l(s,e);break}}})}var i="",s='<div class="row form-horizontal"><div class="col-md-10">',n='<div class="form-group"><label for="{0}" class="control-label col-sm-4">{1}</label><div class="input-group col-sm-8"><input id="{2}" type="text" name="{3}" class="form-control" value="{4}"><span style="font-size: 11px">始发: {5}, 目的地: {6}</span></div></div>';"COLLECTION"===x?(i=e.bill_no+"_"+e.order,s+=n.format(i,"代收代付价格",i,i,getStrValue(e.collection_price,"",""))):e.veh_ves_name&&(i=e.inv_no,s+=n.format(i,e.veh_ves_name,i,i,getStrValue(e.price),e.ship_from,e.ship_to)),s+="</div>",bootbox.dialog({message:s,title:"单行价格输入",buttons:{cancel:{label:"取消",className:"btn-default"},main:{label:"确定",className:"btn-primary",callback:t}}})}function n(e){bootbox.dialog({message:'<div class="row form-horizontal"><div class="col-md-10"><div class="form-group"><label for="collection_00001" class="control-label col-sm-4">批量输入代收代付价格</label><div class="input-group col-sm-8"><input id="collection_00001" type="text" name="collection_00001" class="form-control"></div></div></div></div>',title:"批量价格输入",buttons:{cancel:{label:"取消",className:"btn-default"},main:{label:"确定",className:"btn-primary",callback:function(){var t=a("collection_00001");if(t>=0||t===-1){var i=[];e.forEach(function(e){e.collection_price=t,i.push({bid:e._id,inv_no:e.inv_no,price:t})}),ajaxRequestHandle("/price_input","POST",{data:i,act:x},"no_message",function(){m.find("tr").each(function(e){l($(this),y[e])})})}}}}})}function o(e){function t(){var t="",s=[];for(var n in i)i.hasOwnProperty(n)&&i[n].forEach(function(i){var l=i.split("-");t=n.replace(/[\s\(\)#]+/g,"")+"__"+i.replace(/[\s\(\)#]+/g,"999");var o=a(t);(o>=0||o===-1)&&$.each(e,function(e,t){t.billing_name===n&&t.veh_ves_name===l[0]&&t.ship_to===l[1]&&(t.price=o,s.indexOf(e)<0&&s.push(e))})});if(s.length){var o=[];s.forEach(function(t){o.push({bid:e[t]._id,inv_no:e[t].inv_no,price:e[t].price})}),ajaxRequestHandle("/price_input","POST",{data:o,act:x},"no_message",function(){m.find("tr").each(function(e){l($(this),y[e])})})}}var i={};e.forEach(function(e){if(isExist(i[e.billing_name])||(i[e.billing_name]=[]),e.veh_ves_name&&e.ship_to){var t=e.veh_ves_name+"-"+e.ship_to;i[e.billing_name].indexOf(t)<0&&i[e.billing_name].push(t)}});var s='<div class="row form-horizontal">',n='<div class="form-group"><label for="{0}" class="control-label col-sm-4">{1}</label><div class="input-group col-sm-8"><input id="{2}" type="text" name="{3}" class="form-control"><span style="font-size: 11px">目的地: {4}</span></div></div>',o="";for(var r in i)if(i.hasOwnProperty(r)&&i[r].length){var c='<div class="col-md-10"><label>'+r+"</label>";i[r].forEach(function(e){var t=e.split("-");o=r.replace(/[\s\(\)#]+/g,"")+"__"+e.replace(/[\s\(\)#]+/g,"999"),c+=n.format(o,t[0],o,o,t[1])}),s+=c+"</div>"}s+="</div>",bootbox.dialog({message:s,title:"批量输入价格",buttons:{cancel:{label:"取消",className:"btn-default",callback:function(){}},main:{label:"确定",className:"btn-primary",callback:t}}})}function a(e){var t="#"+e,i=$(t).val();if(i){var l=parseFloatHTML($(t).val());return isNaN(l)||0==l?0:l}return 0}function r(){m.empty(),L=[],y=[];var e=[];D.forEach(function(t){"CUSTOMER"===x?k?t.price===-1&&(e.push(u(t)),y.push(t)):(t.inv_settle_flag&C)!=C&&t.price>=0&&(e.push(u(t)),y.push(t)):"COLLECTION"===x&&(k?t.collection_price===-1&&(e.push(u(t)),y.push(t)):(t.inv_settle_flag&N)!=N&&t.collection_price>=0&&(e.push(u(t)),y.push(t)))}),m.append(e.join("\n")),$("#select-all").prop("checked",!1),t(),m.find("tr").on("click",function(){c($(this),!0)}),$(".select-bill").on("click",function(e){e.stopImmediatePropagation(),c($(this).closest("tr"),!1)})}function c(e,i){for(var l=y[e.index()],s=!1,n=0;n<L.length;++n)if(sameBill(L[n],l)){L.remove(n),s=!0;break}s?e.removeClass("invoice-highlighted"):(L.push(l),e.addClass("invoice-highlighted")),i&&e.find('input[type="checkbox"]').prop("checked",!s),$("#select-all").prop("checked",L.length===m.find("tr").length),t()}function d(e){var t="";if(isEmpty(e.inv_settle_flag)||0===e.inv_settle_flag)t=e.price===-1&&e.collection_price===-1?getStrByStatus("客户,代收不需结算",e.status):e.price===-1?getStrByStatus("客户不需结算",e.status):e.collection_price===-1?getStrByStatus("代收不需结算",e.status):getStrByStatus("未结算",e.status);else{var i=[];(e.inv_settle_flag&C)===C&&i.push("客户"),(e.inv_settle_flag&N)===N&&i.push("代收付"),t=getStrByStatus(i.join(",")+"已结算",e.status)}return t}function u(e){var t='<tr><td align="center"><input class="select-bill" type="checkbox"></td>',l=i("CUSTOMER"===x?e.price:e.collection_price),s=e.ship_customer?e.billing_name+"/"+e.ship_customer:e.billing_name,n="";return e.width<3e3&&e.len<13500?n="正常":e.width>=3e3&&e.width<3300||e.len>=13500&&e.len<16500?n="超长宽":(e.width>=3300||e.len>=16500)&&(n="特长宽"),t+="<td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td></tr>",t.format(d(e),getOrder(e.order_no,e.order_item_no),e.bill_no,s,e.veh_ves_name,e.ship_to,l,e.send_num>0?e.send_num:"",getStrValue(e.send_weight),e.ship_warehouse?e.ship_warehouse:"",date2Str(e.inv_ship_date),e.inv_shipper?e.inv_shipper:"",e.inv_no,n)}function h(e,t){if(e){$("body").css({cursor:"wait"});var i=T.getQueryParams();$.get("/get_invoices_bill",i,function(e){var t=jQuery.parseJSON(e);B=[],t.ok&&(B=sortByKey(t.bills,"inv_ship_date","DSC")),D=T.updateOptions(B,!1),f(),$("body").css({cursor:"default"})})}else t&&(B=[]),D=T.updateOptions(B,t),f()}function f(){m.empty(),L=[],y=[];var e=0,t=0,i=0,l=0;"CUSTOMER"===x?D.forEach(function(s){k?s.price===-1&&(e+=s.send_num,t+=s.send_weight,++i):(s.inv_settle_flag&C)!=C&&s.price>=0&&(e+=s.send_num,t+=s.send_weight,++i,l+=s.price*s.send_weight)}):"COLLECTION"===x&&D.forEach(function(s){k?s.collection_price===-1&&(e+=s.send_num,t+=s.send_weight,++i):(s.inv_settle_flag&N)!=N&&s.collection_price>=0&&(e+=s.send_num,t+=s.send_weight,++i,l+=s.collection_price*s.send_weight)}),$("#lb-total-amount").text(getStrValue(l)),$("#lb-total-weight").text(getStrValue(t)),$("#lb-total-num").text(getStrValue(e)),$("#curr-bills-number").text(i)}var m=$("#table-tbody"),p=$("#customer-btn"),_=$("#collection-btn"),v=$("#filter"),b=$("#search-export"),g=$("#single-price-input"),E=$("#batch-price-input"),S=$("#settle-bill"),O=$("#non-settle-bill"),B=[],D=[],L=[],y=[],x="CUSTOMER",C=1,N=2,T=new QueryFilterD(local_data,local_data_2,x,h);$("#first-th").html('<input id="select-all" type="checkbox" data-toggle="tooltip" data-placement="bottom" title="选择所有记录" />'),t(),elementEventRegister(p,"click",function(){"CUSTOMER"!=x&&(x="CUSTOMER",p.removeClass("btn-default"),p.addClass("btn-primary"),_.removeClass("btn-primary"),_.addClass("btn-default"),T.reset(x),f())}),elementEventRegister(_,"click",function(){"COLLECTION"!=x&&(x="COLLECTION",_.removeClass("btn-default"),_.addClass("btn-primary"),p.removeClass("btn-primary"),p.addClass("btn-default"),T.reset(x),f())}),elementEventRegister(g,"click",function(){1===L.length?s(L[0]):L.length>1?bootbox.alert("您选择了多行，请使用批量输入！"):bootbox.alert("请先选定某一行才能输入价格")}),elementEventRegister(E,"click",function(){L.length?"COLLECTION"===x?n(L):o(L):"COLLECTION"===x?n(y):o(y)}),elementEventRegister($("#select-all"),"click",function(){if(y.length>0){var e=$(".select-bill");L.length===y.length?(e.prop("checked",!1),L=[],m.find("tr").removeClass("invoice-highlighted")):(e.prop("checked",!0),L=y.slice(0),m.find("tr").addClass("invoice-highlighted")),t()}}),elementEventRegister(S,"click",function(){if(L.length){for(var e=[],t=[],i=0;i<L.length;++i){var l=L[i];if(e.indexOf(l.billing_name)<0&&(e.push(l.billing_name),e.length>1))return void bootbox.alert("您选择的提单中存在多个开单名称, 一次只能结算一个开单名称的提单");if(t.indexOf(l.ship_to)<0&&t.push(l.ship_to),"COLLECTION"===x){if(l.collection_price===-1)return void bootbox.alert("您选择的提单:"+l.bill_no+"_"+l.order+" 已经确定为不需要结算!");if(0===l.collection_price)return void bootbox.alert("您选择的提单:"+l.bill_no+"_"+l.order+" 还没有完全输入价格,不能结算")}else{if(l.price===-1)return void bootbox.alert("您选择的提单:"+l.bill_no+"_"+l.order+" 已经确定为不需要结算!");if(0===l.price)return void bootbox.alert("您选择的提单:"+l.bill_no+"_"+l.order+" 还没有完全输入价格,不能结算")}}var s=[],n=0;L.forEach(function(e){"COLLECTION"===x?(n+=e.collection_price*e.send_weight,e.inv_settle_flag|=N,e.settle_flag|=N):(n+=e.price*e.send_weight,e.inv_settle_flag|=C),s.push({bid:e._id,inv_no:e.inv_no,num:e.send_num,weight:e.send_weight,settle_flag:e.inv_settle_flag})});var o=L[0].ship_customer?L[0].billing_name+"/"+L[0].ship_customer:L[0].billing_name;setHtmlElementDisabled(S,!0),ajaxRequestHandle("/settle_bill","POST",{settleObj:s,price:n,settle_type:x,billName:o,shipTo:t.join(",")},"结算",function(){r(),setHtmlElementDisabled(S,!1)})}else bootbox.alert("请先选择您要结算的提单")}),elementEventRegister(O,"click",function(){if(L.length){var t=!1,i=!1;if(L.forEach(function(e){"CUSTOMER"===x?(e.price>0&&(t=!0),e.collection_price<0&&(i=!0)):(e.collection_price>0&&(t=!0),e.price<0&&(i=!0))}),i)"11111111"!==local_user.privilege?bootbox.alert("点击此不需要结算后，存在客户和代收代付都不需要结算的情况，你并没有相应权限，请联系管理员！"):bootbox.confirm("点击此不需要结算后，存在客户和代收代付都不需要结算的情况，确定不需要结算？",function(){var i=[];t?bootbox.confirm("您选择的提单中已经输入过价格, 不结算后这些价格都会清除为0, 确认吗?",function(t){t&&(i=e(),ajaxRequestHandle("/collection_not_require_settle","POST",{nonSettleObj:i,settle_type:x},"不需结算",function(){r()}))}):(i=e(),ajaxRequestHandle("/collection_not_require_settle","POST",{nonSettleObj:i,settle_type:x},"不需结算",function(){r()}))});else{var l=[];t?bootbox.confirm("您选择的提单中已经输入过价格, 不结算后这些价格都会清除为0, 确认吗?",function(t){t&&(l=e(),ajaxRequestHandle("/collection_not_require_settle","POST",{nonSettleObj:l,settle_type:x},"不需结算",function(){r()}))}):(l=e(),ajaxRequestHandle("/collection_not_require_settle","POST",{nonSettleObj:l,settle_type:x},"不需结算",function(){r()}))}}else bootbox.alert("请先选择您不打算进行结算的提单")}),elementEventRegister($("#update-bill"),"click",function(){ajaxRequestHandle("/initial_settle_flag","POST",{},"初始化数据",function(){})});var k=!1,V=$("#show-hide-non-settle");V.iCheck("uncheck"),V.on("ifChecked",function(){k=!0,f()}),V.on("ifUnchecked",function(){k=!1,f()}),elementEventRegister(b,"click",function(){saveToExcel(D,"data")}),elementEventRegister(v,"click",function(){$("#filter-ui").toggle()}),elementEventRegister($("#show-data"),"click",function(){r()})});var QueryFilterD=function(e,t,i,l){this.currSelected=0;var s=this;this.uiElems={sBfOrder:new FilterElementD($("#bf-order-no"),[],(!1),(!0),function(){s.currSelected=2,l(!1,s.isAllEmpty())}),sBfBillName:$("#bf-bill-name"),sBfDest:$("#bf-destination"),sBfVehicle:$("#bf-vehicle"),startDateGrp:$("#start-date-grp"),endDateGrp:$("#end-date-grp"),iStartDate:$("#start-date"),iEndDate:$("#end-date"),sBfBillNo:new FilterElementD($("#bf-bill-no"),[],(!1),(!0),function(){s.currSelected=6,l(!1,s.isAllEmpty())})},this.options=e,this.options_2=t,this.action=i,this.selectedVeh=[],this.selectedDest=[],this.sDate=null,this.eDate=null,"CUSTOMER"===i?(initSelect(this.uiElems.sBfBillName,e.nameList,!0),initSelect(this.uiElems.sBfVehicle,e.vehList,!1),initSelect(this.uiElems.sBfDest,e.destList,!1)):"COLLECTION"===i&&(initSelect(this.uiElems.sBfBillName,t.nameList,!0),initSelect(this.uiElems.sBfVehicle,t.vehList,!1),initSelect(this.uiElems.sBfDest,t.destList,!1)),this.uiElems.sBfBillName.select2(),this.uiElems.sBfVehicle.select2(),this.uiElems.sBfDest.select2(),this.uiElems.iStartDate.val(""),this.uiElems.iEndDate.val(""),this._selectFliterFunc=function(e,t){this.currSelected=e,this.isAllEmpty()?t(!1,!0):t(!0,!1)},this._dateFilterFunc=function(e,t,i){var l=this.uiElems.iStartDate.val(),s=this.uiElems.iEndDate.val(),n=!1;e&&t?n=!isEmpty(l)&&!isEmpty(s):e?n=isEmpty(this.uiElems.iStartDate.val()):t&&(n=isEmpty(this.uiElems.iEndDate.val())),n&&(this.currSelected=5,i(!0,!1))},s.uiElems.sBfBillName.on("change",function(){s._selectFliterFunc(1,l)}),s.uiElems.sBfVehicle.on("change",function(e){s.selectedVeh=e.val,s._selectFliterFunc(3,l)}),s.uiElems.sBfDest.on("change",function(e){s.selectedDest=e.val,s._selectFliterFunc(4,l)}),s.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(e){e.preventDefault(),e.stopImmediatePropagation(),s.sDate=e.date.startOf("day"),s.uiElems.endDateGrp.data("DateTimePicker").setMinDate(e.date),s._dateFilterFunc(!0,!0,l)}),s.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(e){e.preventDefault(),e.stopImmediatePropagation(),s.eDate=e.date.endOf("day"),s.uiElems.startDateGrp.data("DateTimePicker").setMaxDate(e.date),s._dateFilterFunc(!0,!0,l)}),s.uiElems.iStartDate.on("change",function(e){e.stopImmediatePropagation(),s._dateFilterFunc(!0,!1,l)}),s.uiElems.iEndDate.on("change",function(e){e.stopImmediatePropagation(),s._dateFilterFunc(!1,!0,l)})};QueryFilterD.prototype.getQueryParams=function(){var e=this.uiElems.sBfBillName.val(),t=this.uiElems.iStartDate.val(),i=this.uiElems.iEndDate.val(),l=!isEmpty(t)&&!isEmpty(i);return{fName:e?[e]:null,fVeh:this.selectedVeh,fDest:this.selectedDest,fOrder:null,fBno:null,fDate1:l?this.sDate.toISOString():null,fDate2:l?this.eDate.toISOString():null,fType:"invoice-first"}},QueryFilterD.prototype.isAllEmpty=function(){var e=this.uiElems.sBfOrder.selected,t=this.uiElems.sBfBillNo.selected,i=getSelectValue(this.uiElems.sBfBillName),l=this.uiElems.iStartDate.val(),s=this.uiElems.iEndDate.val();return 0===e.length&&0===t.length&&0===this.selectedVeh.length&&0===this.selectedDest.length&&isEmpty(i)&&isEmpty(l)&&isEmpty(s)},QueryFilterD.prototype.updateOptions=function(e,t){var i=this.uiElems.sBfOrder.selected,l=this.uiElems.sBfBillNo.selected,s=getSelectValue(this.uiElems.sBfBillName),n={orderList:[],vehList:[],destList:[],billNoList:[]},o=[];if(t)n="CUSTOMER"===this.action?this.options:this.options_2,o=e,e.forEach(function(e){e.ship_to&&n.destList.indexOf(e.ship_to)<0&&n.destList.push(e.ship_to)}),n.destList=sort_pinyin(n.destList);else{var a=this.selectedVeh,r=this.selectedDest,c=this.action;e.forEach(function(e){var t=!i.length||i.indexOf(e.order_no)>=0,d=0===a.length||a.indexOf(e.veh_ves_name)>=0,u=0===r.length||r.indexOf(e.ship_to)>=0,h=!s||s===e.billing_name,f=!l.length||l.indexOf(e.bill_no)>=0;d&&u&&h&&("CUSTOMER"===c?1!==(1&e.inv_settle_flag)&&(n.orderList.indexOf(e.order_no)<0&&n.orderList.push(e.order_no),n.billNoList.indexOf(e.bill_no)<0&&n.billNoList.push(e.bill_no)):2!==(2&e.inv_settle_flag)&&(n.orderList.indexOf(e.order_no)<0&&n.orderList.push(e.order_no),n.billNoList.indexOf(e.bill_no)<0&&n.billNoList.push(e.bill_no)),t&&f&&(e.veh_ves_name&&n.vehList.indexOf(e.veh_ves_name)<0&&n.vehList.push(e.veh_ves_name),e.ship_to&&n.destList.indexOf(e.ship_to)<0&&n.destList.push(e.ship_to),o.push(e)))}),n.destList=sort_pinyin(n.destList),n.orderList.sort(),n.billNoList=sort_pinyin(n.billNoList),n.vehList=sort_pinyin(n.vehList)}return 2===this.currSelected?(this.uiElems.sBfBillNo.rebuild(n.billNoList.sort(),l),initSelect(this.uiElems.sBfVehicle,n.vehList,!1),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),initSelect(this.uiElems.sBfDest,n.destList,!1),this.uiElems.sBfDest.select2("val",this.selectedDest)):3===this.currSelected?(this.uiElems.sBfOrder.rebuild(n.orderList.sort(),i),this.uiElems.sBfBillNo.rebuild(n.billNoList.sort(),l),initSelect(this.uiElems.sBfDest,n.destList,!1),this.uiElems.sBfDest.select2("val",this.selectedDest)):4===this.currSelected?(this.uiElems.sBfOrder.rebuild(n.orderList.sort(),i),this.uiElems.sBfBillNo.rebuild(n.billNoList.sort(),l),initSelect(this.uiElems.sBfVehicle,n.vehList,!1),this.uiElems.sBfVehicle.select2("val",this.selectedVeh)):6===this.currSelected?(initSelect(this.uiElems.sBfVehicle,n.vehList,!1),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),initSelect(this.uiElems.sBfDest,n.destList,!1),this.uiElems.sBfDest.select2("val",this.selectedDest),this.uiElems.sBfOrder.rebuild(n.orderList.sort(),i)):(this.uiElems.sBfBillNo.rebuild(n.billNoList.sort(),l),this.uiElems.sBfOrder.rebuild(n.orderList.sort(),i),initSelect(this.uiElems.sBfVehicle,n.vehList,!1),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),initSelect(this.uiElems.sBfDest,n.destList,!1),this.uiElems.sBfDest.select2("val",this.selectedDest)),o},QueryFilterD.prototype.reset=function(e){var t=getSelectValue(this.uiElems.sBfBillName);"CUSTOMER"===e?(initSelect(this.uiElems.sBfBillName,this.options.nameList,!0,t),initSelect(this.uiElems.sBfVehicle,this.options.vehList,!1),initSelect(this.uiElems.sBfDest,this.options.destList,!1)):"COLLECTION"===e&&(initSelect(this.uiElems.sBfBillName,this.options_2.nameList,!0,t),initSelect(this.uiElems.sBfVehicle,this.options_2.vehList,!1),initSelect(this.uiElems.sBfDest,this.options_2.destList,!1)),this.action=e,this.uiElems.sBfBillName.select2("val",t),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),this.uiElems.sBfDest.select2("val",this.selectedDest)};
//# sourceMappingURL=settle_mgt_old.js.map
