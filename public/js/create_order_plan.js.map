{"version":3,"sources":["create_order_plan.js"],"names":["$","X","rABS","FileReader","prototype","readAsBinaryString","use_worker","Worker","isXlsx","iOrderNo","iOrderWeight","sCustomerName","iCustomerCode","sDestination","sTransportMode","iConsignee","iDsClient","iContractNo","iCustomerSaleman","iReceivingCharge","iConsigner","inputTbody","iInputDate","allOrders","select2","en_array","cn_array","订单号","订单","订单量","客户代码","流向","发货目的地","客户名称","下游客户","运输方式","南钢业务员","客户业务员","业务员","订单状态","合同号","运价","接单价","收货人","on","e","stopPropagation","preventDefault","target","files","length","nlApp","setTitle","showPleaseWait","i","filename","reader","ext","name","split","pop","toLowerCase","XLSX","XLS","onload","data","result","excelWorker","process_wb","wb","read","type","btoa","fixdata","readAsArrayBuffer","readExcel","XW","msg","norABS","noxfer","cb","worker","onmessage","t","console","error","d","xx","o","l","w","byteLength","String","fromCharCode","apply","Uint16Array","slice","ab2str","replace","log","JSON","parse","val","s","b","ArrayBuffer","v","charCodeAt","s2ab","postMessage","arr","Uint8Array","workbook","isCorrectHeader","SSF","load_table","SheetNames","forEach","sheetName","line","csv","utils","sheet_to_csv","Sheets","make_csv","lines","$0","$1","$2","match","found","head","db_header","pasteLine","indexOf","map","column","idx","key","resetTable","bootbox","alert","hidePleaseWait","items","iLen","hLen","allCommas","trim","json","k","order","year","parseInt","substr","month","push","orderNo","orderWeight","leftWeight","customerName","isEmpty","entryTime","Date","customerCode","destination","transportMode","consignee","dsClient","contractNo","salesman","receivingCharge","consigner","initInputUIValues","unselected","empty","html","weight","str","format","getStrValue","makeTableBodyTr","setElementValue","stopImmediatePropagation","tr","this","closest","remove","index","ForceNumericOnly","elementEventRegister","me","order_no","get","q","jQuery","parseJSON","exist","ajaxRequestHandle","inputDate","isOk"],"mappings":"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","file":"create_order_plan.js","sourcesContent":["$(function () {\r\n  \"use strict\";\r\n\r\n  var rABS = typeof FileReader !== \"undefined\" && typeof FileReader.prototype !== \"undefined\" && typeof FileReader.prototype.readAsBinaryString !== \"undefined\";\r\n  var use_worker = typeof Worker !== 'undefined';\r\n  var isXlsx = true;\r\n  var X; // XLS or XLSX pointer\r\n\r\n  var iOrderNo       = $('#order-no');\r\n  var iOrderWeight   = $('#order-weight');\r\n  var sCustomerName  = $('#customer-name');\r\n  var iCustomerCode  = $('#customer-code');\r\n  var sDestination   = $('#destination');\r\n  var sTransportMode = $('#transport-mode');\r\n  var iConsignee     = $('#consignee');\r\n  var iDsClient      = $('#ds-client');\r\n  var iContractNo    = $('#contract-no');\r\n  var iCustomerSaleman = $('#customer-saleman');\r\n  var iReceivingCharge = $('#receiving-charge');\r\n  var iConsigner     = $('#consigner');\r\n  var inputTbody     = $('#input-plan-content');\r\n  var iInputDate     = $('#order-input-time');\r\n\r\n  var allOrders = [];\r\n\r\n  //iInputDate.datetimepicker(getDateTimePickerOptions());\r\n  sCustomerName.select2();\r\n  sDestination.select2();\r\n\r\n  var en_array = ['order_no', 'order_weight', 'customer_code', 'destination', 'customer_name', 'ds_client', 'transport_mode',\r\n    'customer_saleman', 'consigner', 'status', 'contract_no', 'receiving_charge', 'consignee'];\r\n\r\n  var cn_array = {\r\n    '订单号': 0, '订单': 0,\r\n    '订单量': 1,\r\n    '客户代码': 2,\r\n    '流向': 3, '发货目的地': 3,\r\n    '客户名称': 4,\r\n    '下游客户': 5,\r\n    '运输方式': 6,\r\n    '南钢业务员': 7, '客户业务员': 7,\r\n    '业务员': 8,\r\n    '订单状态': 9,\r\n    '合同号': 10,\r\n    '运价': 11, '接单价': 11,\r\n    '收货人': 12\r\n  };\r\n\r\n  $(\"#import-file\").on('change', function(e) {\r\n    e.stopPropagation();\r\n    e.preventDefault();\r\n    if (e.target.files.length > 0) {\r\n      nlApp.setTitle('读取文件,请稍等...');\r\n      nlApp.showPleaseWait();\r\n      readExcel(e.target.files);\r\n    }\r\n  });\r\n\r\n  function readExcel(files) {\r\n    allOrders = [];\r\n\r\n    for (var i = 0; i < files.length; ++i) {\r\n      filename = files[i];\r\n      var reader = new FileReader();\r\n      var ext = filename.name.split('.').pop().toLowerCase();\r\n      isXlsx = (ext === 'xlsx');\r\n      X = (isXlsx) ? XLSX : XLS;\r\n\r\n      reader.onload = function (e) {\r\n        var data = e.target.result;\r\n        if (use_worker) {\r\n          excelWorker(data, process_wb);\r\n        } else {\r\n          var wb = (rABS) ? X.read(data, {type: 'binary'}) : X.read(btoa(fixdata(data)), {type: 'base64'});\r\n          process_wb(wb);\r\n        }\r\n      };\r\n\r\n      if (rABS) {\r\n        reader.readAsBinaryString(filename);\r\n      } else {\r\n        reader.readAsArrayBuffer(filename);\r\n      }\r\n    }\r\n  }\r\n\r\n  var XW = [ {\r\n    msg: 'xls',\r\n    rABS: '../js/plugins/sheetJS/XLS/xlsworker2.js',\r\n    norABS: '../js/plugins/sheetJS/XLS/xlsworker1.js',\r\n    noxfer: '../js/plugins/sheetJS/XLS/xlsworker.js'\r\n  },\r\n    {\r\n      msg: 'xlsx',\r\n      rABS: '../js/plugins/sheetJS/XLSX/xlsxworker2.js',\r\n      norABS: '../js/plugins/sheetJS/XLSX/xlsxworker1.js',\r\n      noxfer: '../js/plugins/sheetJS/XLSX/xlsxworker.js'\r\n    }\r\n  ];\r\n\r\n  function excelWorker(data, cb) {\r\n    var worker;\r\n    if (use_worker) {\r\n      if (isXlsx) {\r\n        worker = new Worker(rABS ? XW[1].rABS : XW[1].norABS);\r\n      } else {\r\n        worker = new Worker(rABS ? XW[0].rABS : XW[0].norABS);\r\n      }\r\n      worker.onmessage = function (e) {\r\n        switch (e.data.t) {\r\n          case 'ready': break;\r\n          case 'e': console.error(e.data.d); break;\r\n          default: var xx = ab2str(e.data).replace(/\\n/g,\"\\\\n\").replace(/\\r/g,\"\\\\r\"); console.log(\"done\"); cb(JSON.parse(xx)); break;\r\n        }\r\n      };\r\n\r\n      if (rABS) {\r\n        var val = s2ab(data);\r\n        worker.postMessage(val[1], [val[1]]);\r\n      } else {\r\n        worker.postMessage(data, [data]);\r\n      }\r\n    } else {\r\n      worker = isXlsx ? new Worker(XW[1].noxfer) : new Worker(XW[0].noxfer);\r\n      worker.onmessage = function(e) {\r\n        switch(e.data.t) {\r\n          case 'ready': break;\r\n          case 'e': console.error(e.data.d); break;\r\n          case 'xlsx': cb(JSON.parse(e.data.d)); break;\r\n          case 'xls':  cb(JSON.parse(e.data.d)); break;\r\n        }\r\n      };\r\n\r\n      var arr = rABS ? data : btoa(fixdata(data));\r\n      worker.postMessage({d:arr,b:rABS});\r\n    }\r\n  }\r\n\r\n  function fixdata(data) {\r\n    var o = \"\", l = 0, w = 10240;\r\n    for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w,l*w+w)));\r\n    o+=String.fromCharCode.apply(null, new Uint8Array(data.slice(l*w)));\r\n    return o;\r\n  }\r\n\r\n  function ab2str(data) {\r\n    var o = \"\", l = 0, w = 10240;\r\n    for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(data.slice(l*w,l*w+w)));\r\n    o+=String.fromCharCode.apply(null, new Uint16Array(data.slice(l*w)));\r\n    return o;\r\n  }\r\n\r\n  function s2ab(s) {\r\n    var b = new ArrayBuffer(s.length*2), v = new Uint16Array(b);\r\n    for (var i=0; i != s.length; ++i) v[i] = s.charCodeAt(i);\r\n    return [v, b];\r\n  }\r\n\r\n  function to_csv(workbook) {\r\n    var isCorrectHeader = true;\r\n    workbook.SheetNames.forEach(function (sheetName) {\r\n      var csv = (isXlsx ? X.utils.sheet_to_csv(workbook.Sheets[sheetName]) : X.utils.make_csv(workbook.Sheets[sheetName]));\r\n      if (csv.length > 0) {\r\n        csv = csv.replace(/([^\"]+)|(\"[^\"]+\")/g, function($0, $1, $2) {\r\n          if ($2) {\r\n            return $2.replace(/[\\s+\"\"]/g, '').replace(/,/g, \"`\");\r\n          } else {\r\n            return $1;\r\n          }\r\n        });\r\n        var lines = csv.match(/[^\\r\\n]+/g);\r\n        var found = false;\r\n        var head = [], db_header = [];\r\n        for (var i = 0; i < lines.length; i++) {\r\n          if (!found) {\r\n            if (i > 20) {\r\n              isCorrectHeader = false;\r\n              console.log(\"No Header found!\");\r\n              break;\r\n            }\r\n\r\n            if (find_header(lines[i])) {\r\n              found = true;\r\n              head = lines[i].split(',');\r\n              db_header = get_header(head);\r\n            }\r\n          } else {\r\n            pasteLine(lines[i], head, db_header);\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    return isCorrectHeader;\r\n  }\r\n\r\n  function process_wb(wb) {\r\n    if (!isXlsx && typeof Worker !== 'undefined') {\r\n      XLS.SSF.load_table(wb.SSF);\r\n    }\r\n\r\n    var ok = to_csv(wb);\r\n    if (!ok) {\r\n      bootbox.alert('不正确的Excel数据文件或文件无数据...');\r\n    } else {\r\n      resetTable();\r\n    }\r\n\r\n    nlApp.hidePleaseWait();\r\n  }\r\n\r\n  var filename;\r\n\r\n  function find_header(line) {\r\n    return ((line.indexOf('订单号') >= 0) &&\r\n      ((line.indexOf('订单量') >= 0 && line.indexOf('客户名称') >= 0 && line.indexOf('订单') >= 0) ||\r\n        (line.indexOf('客户代码') >= 0)) );\r\n  }\r\n\r\n  function get_header(head) {\r\n    return head.map(function (column) {\r\n      var idx = -1;\r\n      for (var key in cn_array) {\r\n        if (column === key) {\r\n          idx = cn_array[key];\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (idx > -1) {\r\n        return en_array[idx];\r\n      } else {\r\n        return column;\r\n      }\r\n    });\r\n  }\r\n\r\n  function pasteLine(line, head, db_header) {\r\n    var items = line.split(',');\r\n\r\n    var iLen = items.length;\r\n    var hLen = head.length;\r\n\r\n    var allCommas = true;\r\n    for (var i = 0; i < iLen; i++) {\r\n      items[i] = $.trim(items[i]).replace(/`/g, \",\");\r\n      if (items[i].length) {\r\n        allCommas = false;\r\n      }\r\n    }\r\n\r\n    if (allCommas) return;\r\n\r\n    var json = {};\r\n    if (iLen <= hLen) {\r\n      for (var k = 0; k < iLen && head[k]; ++k) {\r\n        json[db_header[k]] = items[k];\r\n      }\r\n\r\n      for (k = iLen; k < hLen && head[k]; ++k) {\r\n        json[db_header[k]] = \"\";\r\n      }\r\n    } else {\r\n      for (i = 0; i < hLen && head[i]; ++i) {\r\n        json[db_header[i]] = items[i];\r\n      }\r\n    }\r\n\r\n    var order = json['order_no'];\r\n    var year = parseInt('20' + order.substr(3, 2));\r\n    var month = parseInt(order.substr(5, 2));\r\n\r\n    allOrders.push({\r\n      orderNo: json['order_no'],\r\n      orderWeight : json['order_weight'],\r\n      leftWeight: json['order_weight'],\r\n      customerName : isEmpty(json['customer_name']) ? '' : json['customer_name'],\r\n      entryTime : new Date(year, month),\r\n      customerCode : isEmpty(json['customer_code']) ? '' : json['customer_code'],\r\n      destination : isEmpty(json['destination']) ? '' : json['destination'],\r\n      transportMode : isEmpty(json['transport_mode']) ? '' : json['transport_mode'],\r\n      consignee : isEmpty(json['consignee']) ? '' : json['consignee'],\r\n      dsClient : isEmpty(json['ds_client']) ? '' : json['ds_client'],\r\n      contractNo : isEmpty(json['contract_no']) ? '' : json['contract_no'],\r\n      salesman : isEmpty(json['customer_saleman']) ? '' : json['customer_saleman'],\r\n      receivingCharge : isEmpty(json['receiving_charge']) ? '' : json['receiving_charge'],\r\n      consigner : isEmpty(json['consigner']) ? '' : json['consigner']\r\n    });\r\n  }\r\n\r\n  /////////////////////////////////////////////////////////////////\r\n\r\n  function initInputUIValues() {\r\n    iOrderNo.val('');\r\n    iOrderWeight.val('');\r\n    sCustomerName.select2('val', '');\r\n    iCustomerCode.val('');\r\n    sDestination.select2('val', '');\r\n    sTransportMode.val('船运');\r\n    iConsignee.val('');\r\n    iDsClient.val('');\r\n    iContractNo.val('');\r\n    iCustomerSaleman.val('');\r\n    iReceivingCharge.val('');\r\n    iConsigner.val('');\r\n    unselected(sCustomerName);\r\n    unselected(sDestination);\r\n    inputTbody.empty();\r\n    allOrders = [];\r\n    iInputDate.val('');\r\n  }\r\n\r\n  initInputUIValues();\r\n\r\n  iOrderWeight.ForceNumericOnly();\r\n  iReceivingCharge.ForceNumericOnly();\r\n\r\n  elementEventRegister(iOrderNo, \"blur\", function () {\r\n    var me = $(this);\r\n    var order_no = me.val();\r\n    if (order_no.length != 11) {\r\n      bootbox.alert('当前输入的订单号的长度是' + order_no.length + '位，长度必须为11位');\r\n    } else {\r\n      try {\r\n        var year = parseInt('20' + order_no.substr(3, 2));\r\n        var month = parseInt(order_no.substr(5, 2));\r\n        iInputDate.val(year + '-' + month);\r\n      } catch (e) {\r\n        bootbox.alert('订单号格式不对，不能读取日期');\r\n        return;\r\n      }\r\n\r\n      $.get('/order_plan_exist', {q: order_no}, function (data) {\r\n        var obj = jQuery.parseJSON(data);\r\n        if (obj.exist) {\r\n          bootbox.alert('此订单号已经存在: ' + order_no);\r\n          me.val('');\r\n        }\r\n      })\r\n    }\r\n  });\r\n\r\n  elementEventRegister($('#ui_input_save'), \"click\", function (e) {\r\n    e.stopPropagation();\r\n    e.preventDefault();\r\n    if (allOrders.length) {\r\n      ajaxRequestHandle('/create_order_plan', 'POST', allOrders, '数据保存', function() {\r\n        initInputUIValues();\r\n        $('#import-file').val('');\r\n      });\r\n    } else {\r\n      bootbox.alert(\"没有数据, 请输入或导入!\");\r\n    }\r\n  });\r\n\r\n  elementEventRegister($('#add-one'), 'click', function() {\r\n    var orderNo = iOrderNo.val();\r\n    var orderWeight = iOrderWeight.val();\r\n    var customerName = sCustomerName.val();\r\n    var inputDate = iInputDate.val();//.data(\"DateTimePicker\").getDate();\r\n    if (isEmpty(orderNo)) {\r\n      bootbox.alert('请输入订单号');\r\n    } else if (orderNo.length != 11) {\r\n      bootbox.alert('订单号的长度必须是11位, 当前输入长度为：' + orderNo.length);\r\n    } else if (isEmpty(orderWeight)) {\r\n      bootbox.alert('请输入订单量');\r\n    } else if (isEmpty(customerName)) {\r\n      bootbox.alert('请输入客户名称');\r\n    } else if (isEmpty(inputDate)) {\r\n      bootbox.alert('请输入录单时间');\r\n    } else {\r\n      var isOk = true;\r\n      for (var i = 0; i < allOrders.length; ++i) {\r\n        if (allOrders[i].orderNo === orderNo) {\r\n          bootbox.alert('不唯一, 订单号相同');\r\n          isOk = false;\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (isOk) {\r\n        allOrders.push({\r\n          orderNo: orderNo,\r\n          orderWeight : orderWeight,\r\n          leftWeight: orderWeight,\r\n          customerName : customerName,\r\n          entryTime : inputDate,\r\n          customerCode : isEmpty(iCustomerCode.val()) ? '' : iCustomerCode.val(),\r\n          destination : isEmpty(sDestination.val()) ? '' : sDestination.val(),\r\n          transportMode : isEmpty(sTransportMode.val()) ? '' : sTransportMode.val(),\r\n          consignee : isEmpty(iConsignee.val()) ? '' : iConsignee.val(),\r\n          dsClient : isEmpty(iDsClient.val()) ? '' : iDsClient.val(),\r\n          contractNo : isEmpty(iContractNo.val()) ? '' : iContractNo.val(),\r\n          salesman : isEmpty(iCustomerSaleman.val()) ? '' : iCustomerSaleman.val(),\r\n          receivingCharge : isEmpty(iReceivingCharge.val()) ? '' : iReceivingCharge.val(),\r\n          consigner : isEmpty(iConsigner.val()) ? '' : iConsigner.val(),\r\n        });\r\n\r\n        resetTable();\r\n      }\r\n    }\r\n  });\r\n\r\n  function resetTable() {\r\n    var html = \"\";\r\n    var weight = 0;\r\n    allOrders.forEach(function(order) {\r\n      html += makeTableBodyTr(order);\r\n      weight += +order.orderWeight;\r\n    });\r\n    inputTbody.html(html);\r\n\r\n    setElementValue($('#total-weight'), getStrValue(weight));\r\n\r\n    $('.redlink').on('click', function (e) {\r\n      e.stopImmediatePropagation();\r\n      var tr = $(this).closest('tr');\r\n      allOrders.remove(tr.index());\r\n      tr.remove();\r\n    });\r\n  }\r\n\r\n  function makeTableBodyTr(order) {\r\n    var str = '<tr><td style=\"cursor:pointer\" class=\"td-icon\"><i title=\"删除\" class=\"fa fa-trash-o redlink\"></i></td>';\r\n    for (var i = 0; i < 13; ++i) {\r\n      str += \"<td>{\" + i + \"}</td>\";\r\n    }\r\n    str += \"</tr>\";\r\n\r\n    return str.format(order.orderNo, getStrValue(order.orderWeight), order.customerName,\r\n      order.customerCode ? order.customerCode : '',\r\n      order.destination ? order.destination : '',\r\n      order.transportMode,\r\n      order.consignee ? order.consignee : '',\r\n      order.dsClient ? order.dsClient : '',\r\n      order.salesman ? order.salesman : '',\r\n      order.consigner ? order.consigner : '',\r\n      order.contractNo ? order.contractNo : '',\r\n      getStrValue(order.receivingCharge),\r\n      order.entryTime);\r\n  }\r\n});"]}