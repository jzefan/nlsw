{"version":3,"sources":["bill_import_create.js"],"names":["$","X","table_excel","en_array","cn_array","提单号","移拨码单号","入库单号","订单项次号","订单编号-项次","订单编号","订单号-项次","订单号","牌号","标准全名","标准号","标准名","钢号","长度","长","宽度","宽","厚度","厚","尺寸","尺寸信息","单重","发运数","块数","数量(块)","数量（块）","支数","计划出货重量","发货重量","可发货重量","计划重量","重量（T）","重量(T)","重量","发货库别","发货仓库","仓库","始发库","销售部门","销售组别","客户名称","客户","客户信息","客户编号","现有货主","现在货主","合同号","合同","客户采购案号","收货地址","订单项次","项次","规格","产品型态","货物来源","rABS","FileReader","prototype","readAsBinaryString","use_worker","Worker","isXlsx","excel_show","excelInputData","choice","existSources","openButtonChangeHandler","e","stopPropagation","preventDefault","target","files","length","nlApp","setTitle","showPleaseWait","i","filename","reader","ext","name","split","pop","toLowerCase","XLSX","XLS","onload","data","result","excelWorker","process_wb","wb","read","type","btoa","fixdata","readAsArrayBuffer","readExcel","on","XW","msg","norABS","noxfer","cb","worker","onmessage","t","console","error","d","xx","o","l","w","byteLength","String","fromCharCode","apply","Uint16Array","slice","ab2str","replace","log","JSON","parse","val","s","b","ArrayBuffer","v","charCodeAt","s2ab","postMessage","arr","Uint8Array","fname","html_content","workbook","html","isCorrectHeader","SSF","load_table","SheetNames","forEach","sheetName","line","csv","utils","sheet_to_csv","Sheets","make_csv","lines","$0","$1","$2","match","found","head","db_header","departmentIdx","row","pasteLine","indexOf","map","column","idx","key","each","field","fnDestroy","setElementValue","dataTable","getDataTableParams","show","bootbox","alert","hidePleaseWait","items","iLen","hLen","trim","allCommas","json","k","push","css","validData","hasOrder","row_data","isExist","order_item_no","order","order_no","getOrder","parseInt","tmp","substring","sub","isNaN","findSameOrder","valid","bill_no","block_num","weight","total_weight","ship_warehouse","req","getAJAXRequest","done","ok","noUpdatedData","tbody","empty","bill","append","format","status","brand_no","billing_name","sales_dep","thickness","width","len","size_type","shipping_address","contract_no","date2Str","create_date","shipping_date","creater","shipper","modal","hide","backdrop","keyboard","response","fail","jqXHR","textStatus","dataDict","local_data","iBillNo","iOrderNo","iOrderItemNo","sBillingName","sSalesDep","sShipWarehouse","iBillThickness","iBillWidth","iBillLength","iBillWeight","checkForulma","iBillNum","iTotWeight","sBrand","sSizeType","iContractNo","iProduct","useForulma","allBills","inputTbody","initInputUIValues","select2","unselected","iCheck","companyName","updateBillWeight","res","parseFloatHTML","Math","pow","fixed","toFixedStr","getStrValue","company","cpy","warehouse","sort_pinyin","initSelect","ForceNumericOnly","elementEventRegister","this","setHtmlElementDisabled","ajaxRequestHandle","billNo","orderNo","orderItemNo","billName","totalWeight","isEmpty","isOk","block_len","product_type","str","makeTableBodyTr","stopImmediatePropagation","tr","closest","remove","index"],"mappings":"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","file":"bill_import_create.js","sourcesContent":["$(function () {\r\n  \"use strict\";\r\n\r\n  var en_array = ['bill_no', 'order', 'brand_no', 'block_len', 'width', 'thickness', 'size_type',\r\n    'weight', 'block_num', 'total_weight', 'warehouse', 'ship_warehouse', 'sales_dep', 'billing_name',\r\n    'contract_no', 'shipping_address', 'order_item_no', 'dimensions', 'product_type', 'sources'];\r\n\r\n  var cn_array = {\r\n    '提单号': 0, '移拨码单号': 0, '入库单号': 0,\r\n    '订单项次号': 1, '订单编号-项次': 1, '订单编号': 1, '订单号-项次': 1, '订单号':1,\r\n    '牌号': 2, '标准全名': 2, '标准号': 2, '标准名': 2, '钢号': 2,\r\n    '长度': 3, '长': 3,\r\n    '宽度': 4, '宽': 4,\r\n    '厚度': 5, '厚': 5,\r\n    '尺寸': 6, '尺寸信息': 6,\r\n    '单重': 7,\r\n    '发运数': 8, '块数': 8, '数量(块)': 8, '数量（块）': 8, '支数': 8,\r\n    '计划出货重量': 9, '发货重量': 9, '可发货重量': 9, '计划重量': 9, '重量（T）':9, '重量(T)': 9, '重量':9,\r\n    '发货库别': 11, '发货仓库': 11, '仓库': 11, '始发库': 11,\r\n    '销售部门': 12, '销售组别': 12,\r\n    '客户名称': 13, '客户': 13, '客户信息': 13, '客户编号': 13, '现有货主': 13, '现在货主': 13,\r\n    '合同号': 14, '合同': 14, '客户采购案号': 14,\r\n    '收货地址': 15,\r\n    '订单项次': 16, '项次':16,\r\n    '规格': 17,\r\n    '产品型态': 18,\r\n    '货物来源': 19\r\n  };\r\n\r\n  var rABS = typeof FileReader !== \"undefined\" && typeof FileReader.prototype !== \"undefined\" && typeof FileReader.prototype.readAsBinaryString !== \"undefined\";\r\n  var use_worker = typeof Worker !== 'undefined';\r\n  var isXlsx = true;\r\n  var X; // XLS or XLSX pointer\r\n  var table_excel; // dataTable used\r\n  var excel_show = $(\"#import_execl\");\r\n  var excelInputData = [];\r\n\r\n  var NORMAL       = 0;\r\n  var SWITCH_WARE  = 1;\r\n  var choice       = NORMAL;\r\n  var existSources = false; // 是否存在货物来源列\r\n\r\n  $(\"#execl_file\").on('change', function(e) {\r\n    choice = NORMAL;\r\n    openButtonChangeHandler(e);\r\n  });\r\n  $(\"#execl_file_1\").on('change', function(e) {\r\n    choice = SWITCH_WARE;\r\n    openButtonChangeHandler(e);\r\n  });\r\n\r\n  function openButtonChangeHandler(e) {\r\n    e.stopPropagation();\r\n    e.preventDefault();\r\n    if (e.target.files.length > 0) {\r\n      nlApp.setTitle('读取文件,请稍等...');\r\n      nlApp.showPleaseWait();\r\n      readExcel(e.target.files);\r\n    }\r\n  }\r\n\r\n  function readExcel(files) {\r\n    excelInputData = [];\r\n\r\n    for (var i = 0; i < files.length; ++i) {\r\n      filename = files[i];\r\n      var reader = new FileReader();\r\n      var ext = filename.name.split('.').pop().toLowerCase();\r\n      isXlsx = (ext === 'xlsx');\r\n      X = (isXlsx) ? XLSX : XLS;\r\n\r\n      reader.onload = function (e) {\r\n        var data = e.target.result;\r\n        if (use_worker) {\r\n          excelWorker(data, process_wb);\r\n        } else {\r\n          var wb = (rABS) ? X.read(data, {type: 'binary'}) : X.read(btoa(fixdata(data)), {type: 'base64'});\r\n          process_wb(wb);\r\n        }\r\n      };\r\n\r\n      if (rABS) {\r\n        reader.readAsBinaryString(filename);\r\n      } else {\r\n        reader.readAsArrayBuffer(filename);\r\n      }\r\n    }\r\n  }\r\n\r\n  var XW = [ {\r\n      msg: 'xls',\r\n      rABS: '../js/plugins/sheetJS/XLS/xlsworker2.js',\r\n      norABS: '../js/plugins/sheetJS/XLS/xlsworker1.js',\r\n      noxfer: '../js/plugins/sheetJS/XLS/xlsworker.js'\r\n    },\r\n    {\r\n      msg: 'xlsx',\r\n      rABS: '../js/plugins/sheetJS/XLSX/xlsxworker2.js',\r\n      norABS: '../js/plugins/sheetJS/XLSX/xlsxworker1.js',\r\n      noxfer: '../js/plugins/sheetJS/XLSX/xlsxworker.js'\r\n    }\r\n  ];\r\n\r\n\r\n  function excelWorker(data, cb) {\r\n    var worker;\r\n    if (use_worker) {\r\n      if (isXlsx) {\r\n        worker = new Worker(rABS ? XW[1].rABS : XW[1].norABS);\r\n      } else {\r\n        worker = new Worker(rABS ? XW[0].rABS : XW[0].norABS);\r\n      }\r\n      worker.onmessage = function (e) {\r\n        switch (e.data.t) {\r\n          case 'ready': break;\r\n          case 'e': console.error(e.data.d); break;\r\n          default: var xx = ab2str(e.data).replace(/\\n/g,\"\\\\n\").replace(/\\r/g,\"\\\\r\"); console.log(\"done\"); cb(JSON.parse(xx)); break;\r\n        }\r\n      };\r\n\r\n      if (rABS) {\r\n        var val = s2ab(data);\r\n        worker.postMessage(val[1], [val[1]]);\r\n      } else {\r\n        worker.postMessage(data, [data]);\r\n      }\r\n    } else {\r\n      worker = isXlsx ? new Worker(XW[1].noxfer) : new Worker(XW[0].noxfer);\r\n      worker.onmessage = function(e) {\r\n        switch(e.data.t) {\r\n          case 'ready': break;\r\n          case 'e': console.error(e.data.d); break;\r\n          case 'xlsx': cb(JSON.parse(e.data.d)); break;\r\n          case 'xls':  cb(JSON.parse(e.data.d)); break;\r\n        }\r\n      };\r\n\r\n      var arr = rABS ? data : btoa(fixdata(data));\r\n      worker.postMessage({d:arr,b:rABS});\r\n    }\r\n  }\r\n\r\n  function fixdata(data) {\r\n    var o = \"\", l = 0, w = 10240;\r\n    for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w,l*w+w)));\r\n    o+=String.fromCharCode.apply(null, new Uint8Array(data.slice(l*w)));\r\n    return o;\r\n  }\r\n\r\n  function ab2str(data) {\r\n    var o = \"\", l = 0, w = 10240;\r\n    for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(data.slice(l*w,l*w+w)));\r\n    o+=String.fromCharCode.apply(null, new Uint16Array(data.slice(l*w)));\r\n    return o;\r\n  }\r\n\r\n  function s2ab(s) {\r\n    var b = new ArrayBuffer(s.length*2), v = new Uint16Array(b);\r\n    for (var i=0; i != s.length; ++i) v[i] = s.charCodeAt(i);\r\n    return [v, b];\r\n  }\r\n\r\n  function to_csv(workbook) {\r\n    var html = '<thead><tr>';\r\n    var isCorrectHeader = true;\r\n    workbook.SheetNames.forEach(function (sheetName) {\r\n      var csv = (isXlsx ? X.utils.sheet_to_csv(workbook.Sheets[sheetName]) : X.utils.make_csv(workbook.Sheets[sheetName]));\r\n      if (csv.length > 0) {\r\n        csv = csv.replace(/([^\"]+)|(\"[^\"]+\")/g, function($0, $1, $2) {\r\n          if ($2) {\r\n            return $2.replace(/[\\s+\"\"]/g, '').replace(/,/g, \"`\");\r\n          } else {\r\n            return $1;\r\n          }\r\n        });\r\n        var lines = csv.match(/[^\\r\\n]+/g);\r\n        var found = false;\r\n        var head = [], db_header = [];\r\n        var departmentIdx = -1;\r\n        existSources = false;\r\n        for (var i = 0; i < lines.length; i++) {\r\n          if (!found) {\r\n            if (i > 20) {\r\n              isCorrectHeader = false;\r\n              console.log(\"No Header found!\");\r\n              break;\r\n            }\r\n            if (find_header(lines[i])) {\r\n              found = true;\r\n              head = lines[i].split(',');\r\n              db_header = get_header(head);\r\n              $.each(head, function (idx, field) {\r\n                if (field) {\r\n                  html += '<th>' + field + '</th>';\r\n                  if (field === '承运单位') {\r\n                    departmentIdx = idx;\r\n                  } else if (field === '货物来源') {\r\n                    existSources = true;\r\n                  }\r\n                }\r\n              });\r\n              html += '</tr></thead><tbody>';\r\n            }\r\n          } else {\r\n            var row = pasteLine(lines[i], head, db_header, departmentIdx);\r\n            if (row.length > 0) {\r\n              html += row;\r\n            }\r\n          }\r\n        }\r\n\r\n        if (found) {\r\n          html += '</tbody>';\r\n        }\r\n      }\r\n    });\r\n\r\n    return (isCorrectHeader? html : \"\");\r\n  }\r\n\r\n  function set_table_data(fname, html_content) {\r\n    if (html_content) {\r\n      excel_show.html(html_content);\r\n      if (table_excel) {\r\n        table_excel.fnDestroy();\r\n      }\r\n\r\n      setElementValue($('#excel-filename'), '打开的文件: ' + fname);\r\n\r\n      excel_show.html(html_content);\r\n      table_excel = excel_show.dataTable(getDataTableParams(false, \"300%\"));\r\n\r\n      $(table_excel).show();\r\n    } else {\r\n      bootbox.alert('不正确的Excel数据文件或文件无数据...');\r\n    }\r\n\r\n    nlApp.hidePleaseWait();\r\n  }\r\n\r\n  function process_wb(wb) {\r\n    if (!isXlsx && typeof Worker !== 'undefined') {\r\n      XLS.SSF.load_table(wb.SSF);\r\n    }\r\n\r\n    set_table_data(filename.name, to_csv(wb));\r\n  }\r\n\r\n  var filename;\r\n\r\n  function find_header(line) {\r\n    return ((line.indexOf('订单') >= 0) &&\r\n        ((line.indexOf('长') >= 0 && line.indexOf('宽') >= 0 && line.indexOf('厚') >= 0) ||\r\n         (line.indexOf('规格') >= 0)) );\r\n  }\r\n\r\n  function get_header(head) {\r\n    return head.map(function (column) {\r\n      var idx = -1;\r\n      for (var key in cn_array) {\r\n        if (column === key) {\r\n          idx = cn_array[key];\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (idx > -1) {\r\n        return en_array[idx];\r\n      } else {\r\n        return column;\r\n      }\r\n    });\r\n  }\r\n\r\n  function pasteLine(line, head, db_header, departmentIdx) {\r\n    var items = line.split(',');\r\n\r\n    var iLen = items.length;\r\n    var hLen = head.length;\r\n    if (departmentIdx >= 0 && departmentIdx < iLen && $.trim(items[departmentIdx]) != '南京鑫鸿图储运有限公司') {\r\n      return \"\"; // skip non-hongyuntu's record\r\n    }\r\n\r\n    var allCommas = true;\r\n    for (var i = 0; i < iLen; i++) {\r\n      items[i] = $.trim(items[i]).replace(/`/g, \",\");\r\n      if (items[i].length) {\r\n        allCommas = false;\r\n      }\r\n    }\r\n\r\n    if (allCommas) return \"\";\r\n\r\n    var json = {};\r\n    var result = '<tr>';\r\n    if (iLen <= hLen) {\r\n      for (var k = 0; k < iLen && head[k]; ++k) {\r\n        result += '<td>' + items[k] + '</td>';\r\n        json[db_header[k]] = items[k];\r\n      }\r\n\r\n      for (k = iLen; k < hLen && head[k]; ++k) {\r\n        result += '<td></td>';\r\n        json[db_header[k]] = \"\";\r\n      }\r\n    } else {\r\n      for (i = 0; i < hLen && head[i]; ++i) {\r\n        result += '<td>' + items[i] + '</td>';\r\n        json[db_header[i]] = items[i];\r\n      }\r\n    }\r\n    result += '</tr>';\r\n    excelInputData.push(json);\r\n\r\n    return result;\r\n  }\r\n\r\n  $('#excel_submit').on('click', function (e) {\r\n    e.stopPropagation();\r\n    e.preventDefault();\r\n    if (excelInputData.length === 0) {\r\n      bootbox.alert(\"无数据！请导入正确的Excel数据\");\r\n      return;\r\n    }\r\n\r\n    $(\"body\").css(\"cursor\", \"progress\");\r\n\r\n    var validData = [];\r\n    var hasOrder = true;\r\n    excelInputData.forEach(function(row_data) {\r\n      hasOrder = false;\r\n      if (isExist(row_data.order_item_no) && row_data.order.length === 11) {\r\n        row_data.order_no = row_data.order;\r\n        row_data.order = getOrder(row_data.order_no, row_data.order_item_no);\r\n        row_data.order_item_no = parseInt(row_data.order_item_no);\r\n        hasOrder = true;\r\n      } else {\r\n        var tmp = row_data.order.split(\"-\");\r\n        if (tmp.length === 2) {\r\n          row_data.order_no = tmp[0];\r\n          row_data.order_item_no = parseInt(tmp[1]);\r\n          row_data.order = getOrder(row_data.order_no, row_data.order_item_no);\r\n          hasOrder = true;\r\n        } else {\r\n          row_data.order_no = row_data.order.substring(0, 11);\r\n          row_data.order_item_no = 0;\r\n          var sub = row_data.order.substring(11);\r\n          if (sub) {\r\n            var v = parseInt(sub);\r\n            if (!isNaN(v)) {\r\n              row_data.order_item_no = v;\r\n              row_data.order = getOrder(row_data.order_no, row_data.order_item_no);\r\n              hasOrder = true;\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      if (hasOrder) {\r\n        if (choice === SWITCH_WARE) {\r\n          var findSameOrder = false;\r\n          for (var i = 0; i < validData.length; ++i) {\r\n            var valid = validData[i];\r\n            if (valid.bill_no === row_data.bill_no && valid.order === row_data.order) {\r\n              valid.block_num = (+valid.block_num) + (+row_data.block_num);\r\n              valid.weight = (+valid.weight) + (+row_data.block_num);\r\n              valid.total_weight = (+valid.total_weight) + (+row_data.total_weight);\r\n              findSameOrder = true;\r\n              break;\r\n            }\r\n          }\r\n\r\n          if (!findSameOrder) {\r\n            if (existSources) {\r\n              row_data.ship_warehouse = \"转外库\";\r\n            }\r\n            validData.push(row_data);\r\n          }\r\n        } else {\r\n          validData.push(row_data);\r\n        }\r\n      }\r\n    });\r\n\r\n    var req = getAJAXRequest('/create_bill', 'POST', validData);\r\n    req.done(function (data) {\r\n      $(\"body\").css(\"cursor\", \"auto\");\r\n\r\n      if (data.ok) {\r\n        if (data.noUpdatedData.length) {\r\n          var tbody = $('#part-imprt-tbody');\r\n          tbody.empty();\r\n          var str = '<tr><td style=\"text-align: center;\"><span class=\"label label-info\">{0}</span></td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td>{14}</td><td>{15}</td><td>{16}</td><td>{17}</td><td>{18}</td><td>{19}</td></tr>';\r\n          data.noUpdatedData.forEach(function(bill) {\r\n            tbody.append(str.format(bill.status, getOrder(bill.order_no, bill.order_item_no), bill.bill_no,\r\n              bill.brand_no ? bill.brand_no : '', bill.billing_name ? bill.billing_name : '',\r\n              bill.sales_dep ? bill.sales_dep : '', bill.thickness ? bill.thickness : '',\r\n              bill.width ? bill.width : '', bill.len ? bill.len : '', bill.size_type? bill.size_type : '',\r\n              bill.weight ? bill.weight : '',\r\n              bill.block_num ? bill.block_num : '',\r\n              bill.total_weight ? bill.total_weight : '',\r\n              bill.ship_warehouse ? bill.ship_warehouse : '',\r\n              bill.shipping_address ? bill.shipping_address : '',\r\n              bill.contract_no ? bill.contract_no : '',\r\n              date2Str(bill.create_date), date2Str(bill.shipping_date),\r\n              bill.creater ? bill.creater : '', bill.shipper ? bill.shipper : ''));\r\n          });\r\n          $('#part-import-btn-ok, #close-dialog').on('click', function() {\r\n            $('#part-import-dialog').modal('hide');\r\n            setElementValue($('#excel-filename'), '');\r\n            $(table_excel).hide();\r\n            excelInputData = [];\r\n            $(\"#execl_file\").val('');\r\n            $(\"#execl_file_1\").val('');\r\n          });\r\n\r\n          $('#part-import-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n        } else {\r\n          bootbox.alert(\"导入数据成功\", function () {\r\n            setElementValue($('#excel-filename'), '');\r\n            $(table_excel).hide();\r\n            excelInputData = [];\r\n            $(\"#execl_file\").val('');\r\n            $(\"#execl_file_1\").val('');\r\n          });\r\n        }\r\n      } else {\r\n        bootbox.alert(\"导入数据失败:\" + data.response);\r\n      }\r\n    });\r\n\r\n    req.fail(function (jqXHR, textStatus) {\r\n      bootbox.alert(\"导入数据失败: \" + textStatus);\r\n      $(\"body\").css(\"cursor\", \"auto\");\r\n    });\r\n  });\r\n\r\n  ///////////////////////////////////////////////////\r\n  // UI Input handle start\r\n  ///////////////////////////////////////////////////\r\n  var dataDict       = local_data;\r\n  var iBillNo        = $('#bill-no');\r\n  var iOrderNo       = $('#order-no');\r\n  var iOrderItemNo   = $('#order-item-no');\r\n  var sBillingName   = $('#billing_name');\r\n  var sSalesDep      = $('#sales_dep');\r\n  var sShipWarehouse = $('#ship_warehouse');\r\n  var iBillThickness = $('#bill-thickness');\r\n  var iBillWidth     = $('#bill-width');\r\n  var iBillLength    = $('#bill-length');\r\n  var iBillWeight    = $('#bill-weight');\r\n  var checkForulma   = $('#bill-forumla');\r\n  var iBillNum       = $('#bill-number');\r\n  var iTotWeight     = $('#bill-tot-weight');\r\n  var sBrand         = $('#brand_no');\r\n  var sSizeType      = $('#size_type');\r\n  var iContractNo    = $('#contract_no');\r\n  var iProduct       = $('#product_type');\r\n  var useForulma     = true;\r\n  var allBills = [];\r\n  var inputTbody = $('#input-bill-content');\r\n  \r\n  sBrand.select2();\r\n  sBrand.select2('val', '');\r\n\r\n  function initInputUIValues() {\r\n    iBillNo.val(\"\");\r\n    iOrderNo.val(\"\");\r\n    iOrderItemNo.val(\"\");\r\n    iBillThickness.val(\"\");\r\n    iBillWidth.val(\"\");\r\n    iBillLength.val(\"\");\r\n    iBillWeight.val(\"\");\r\n    iBillNum.val(\"\");\r\n    iTotWeight.val(\"\");\r\n    iContractNo.val(\"\");\r\n    iProduct.val(\"\");\r\n    sBillingName.select2('val', '');\r\n    unselected(sSalesDep);\r\n    unselected(sShipWarehouse);\r\n    sBrand.select2('val', '');\r\n    sSizeType.val(\"定尺\");\r\n    checkForulma.iCheck('check');\r\n    useForulma = true;\r\n    inputTbody.empty();\r\n    allBills = [];\r\n  }\r\n\r\n  var companyName = [];\r\n  dataDict.company.forEach(function(cpy) {\r\n    companyName.push(cpy.name);\r\n  });\r\n\r\n  dataDict.warehouse = sort_pinyin(dataDict.warehouse);\r\n  initSelect(sBillingName, sort_pinyin(companyName), false);\r\n  initSelect(sShipWarehouse, dataDict.warehouse, false);\r\n\r\n  sBillingName.select2();\r\n  sBillingName.select2('val', '');\r\n  sShipWarehouse.select2();\r\n\r\n  initInputUIValues();\r\n  iBillThickness.ForceNumericOnly();\r\n  iBillWidth.ForceNumericOnly();\r\n  iBillLength.ForceNumericOnly();\r\n  iBillWeight.ForceNumericOnly();\r\n  iBillNum.ForceNumericOnly();\r\n  iTotWeight.ForceNumericOnly();\r\n\r\n  elementEventRegister(iOrderNo, \"blur\", function () {\r\n    var me = $(this);\r\n    var order_no = me.val();\r\n    if (order_no.length != 11) {\r\n      bootbox.alert('当前输入的订单号的长度是' + order_no.length + '位，长度必须为11位');\r\n    }\r\n  });\r\n\r\n  elementEventRegister(iBillLength, \"keyup paste\", updateBillWeight);\r\n  elementEventRegister(iBillWidth, \"keyup paste\", updateBillWeight);\r\n  elementEventRegister(iBillThickness, \"keyup paste\", updateBillWeight);\r\n  elementEventRegister(iBillNum, \"keyup paste\", updateBillWeight);\r\n\r\n  function updateBillWeight() {\r\n    if (useForulma) {\r\n      var l = parseFloatHTML(iBillLength.val());\r\n      var w = parseFloatHTML(iBillWidth.val());\r\n      var t = parseFloatHTML(iBillThickness.val());\r\n      var res = l * w * t * 7.85 * Math.pow(10, -9);\r\n      if (res > 0) {\r\n        var fixed = toFixedStr(res, 3);\r\n        setElementValue(iBillWeight, fixed);\r\n        setElementValue(iTotWeight, getStrValue((+fixed) * parseFloatHTML(iBillNum.val())));\r\n      } else {\r\n        iBillWeight.val(\"\");\r\n        iTotWeight.val(\"\");\r\n      }\r\n    }\r\n  }\r\n\r\n  elementEventRegister(checkForulma, \"ifChecked\", function() {\r\n    useForulma = true;\r\n    setHtmlElementDisabled(iTotWeight, true);\r\n    setHtmlElementDisabled(iBillNum, false);\r\n    updateBillWeight();\r\n  });\r\n\r\n  elementEventRegister(checkForulma, \"ifUnchecked\", function() {\r\n    useForulma = false;\r\n    setHtmlElementDisabled(iTotWeight, false);\r\n    setHtmlElementDisabled(iBillNum, true);\r\n    iBillWeight.val(\"\");\r\n    iTotWeight.val(\"\");\r\n    iBillNum.val(\"\");\r\n  });\r\n\r\n  elementEventRegister($('#ui_input_save'), \"click\", function () {\r\n    if (allBills.length) {\r\n      ajaxRequestHandle('/create_bill', 'POST', allBills, '数据保存', function() {\r\n        initInputUIValues();\r\n      });\r\n    } else {\r\n      bootbox.alert(\"没有数据, 请输入\");\r\n    }\r\n  });\r\n\r\n  elementEventRegister($('#add-one'), 'click', function() {\r\n    var billNo = iBillNo.val();\r\n    var orderNo = iOrderNo.val();\r\n    var orderItemNo = iOrderItemNo.val();\r\n    var billName = sBillingName.val();\r\n    var totalWeight = iTotWeight.val();\r\n    if (isEmpty(billNo)) {\r\n      bootbox.alert('请输入提单号');\r\n    } else if (isEmpty(orderNo)) {\r\n      bootbox.alert('请输入订单号');\r\n    } else if (orderNo.length != 11) {\r\n      bootbox.alert('订单号的长度必须是11位, 当前输入长度为：' + orderNo.length);\r\n    } else if (isEmpty(orderItemNo)) {\r\n      bootbox.alert('请输入订单项次号');\r\n    } else if (isEmpty(billName)) {\r\n      bootbox.alert('请选择开单名称');\r\n    } else if (isEmpty(totalWeight) && totalWeight > 0) {\r\n      bootbox.alert('请输入总重量');\r\n    } else {\r\n      var isOk = true;\r\n      var o = getOrder(orderNo, orderItemNo);\r\n      for (var i = 0; i < allBills.length; ++i) {\r\n        if (allBills[i].order === o) {\r\n          bootbox.alert('不唯一, 订单号项次 + 提单号相同');\r\n          isOk = false;\r\n          break;\r\n        }\r\n      }\r\n      if (isOk) {\r\n        allBills.push({\r\n          order: getOrder(orderNo, orderItemNo),\r\n          bill_no : billNo,\r\n          order_no : orderNo,\r\n          order_item_no : orderItemNo,\r\n          brand_no : isEmpty(sBrand.val()) ? \"\" : sBrand.val(),\r\n          billing_name : billName,\r\n          sales_dep: isEmpty(sSalesDep.val()) ? \"\" : sSalesDep.val(),\r\n          block_len : isEmpty(iBillLength.val()) ? \"\" : iBillLength.val(),\r\n          width : isEmpty(iBillWidth.val()) ? \"\" : iBillWidth.val(),\r\n          thickness : isEmpty(iBillThickness.val()) ? \"\" : iBillThickness.val(),\r\n          size_type : sSizeType.val(),\r\n          weight : isEmpty(iBillWeight.val()) ? \"\" : iBillWeight.val(),\r\n          block_num : isEmpty(iBillNum.val()) ? \"\" : iBillNum.val(),\r\n          total_weight: totalWeight,\r\n          ship_warehouse : isEmpty(sShipWarehouse.val()) ? \"\" : sShipWarehouse.val(),\r\n          contract_no : isEmpty(iContractNo.val()) ? \"\" : iContractNo.val(),\r\n          product_type: isEmpty(iProduct.val()) ? \"\" : iProduct.val()\r\n        });\r\n\r\n        var html = \"\";\r\n        allBills.forEach(function(bill) {\r\n          html += makeTableBodyTr(bill);\r\n        });\r\n        inputTbody.html(html);\r\n        $('.redlink').on('click', function (e) {\r\n          e.stopImmediatePropagation();\r\n          var tr = $(this).closest('tr');\r\n          allBills.remove(tr.index());\r\n          tr.remove();\r\n        });\r\n      }\r\n    }\r\n  });\r\n\r\n  function makeTableBodyTr(bill) {\r\n    var str = '<tr><td style=\"cursor:pointer\" class=\"td-icon\"><i title=\"删除\" class=\"fa fa-trash-o redlink\"></i></td>';\r\n    for (var i = 0; i < 14; ++i) {\r\n      str += \"<td>{\" + i + \"}</td>\";\r\n    }\r\n    str += \"</tr>\";\r\n\r\n    return str.format(bill.bill_no, getOrder(bill.order_no, bill.order_item_no), bill.billing_name,\r\n      getStrValue(bill.thickness), getStrValue(bill.width), getStrValue(bill.block_len), bill.size_type,\r\n      bill.block_num, getStrValue(bill.total_weight),\r\n      bill.brand_no ? bill.brand_no : '',\r\n      bill.sales_dep ? bill.sales_dep : '',\r\n      bill.ship_warehouse ? bill.ship_warehouse : '',\r\n      bill.contract_no ? bill.contract_no : '',\r\n      bill.product_type ? bill.product_type : '');\r\n  }\r\n});\r\n"]}