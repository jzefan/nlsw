{"version":3,"sources":["settle_vessel_old.js"],"names":["$","filterData","needUpdateDbData","emptyDbData","qFilter","settledState","showHtmlElement","btnSettle","btnSettleCancel","btnPay","btnPayCancel","btnPrintDetail","obj","getQueryParams","get","data","result","jQuery","parseJSON","dbRecords","ok","sortByKey","invs","curr_records","updateOptions","resetTableRow","settleVessel","settle","state","date","username","selected_records","length","selectedInnerNo","allSelectedWNo","i","len","rec","vessel_price","bootbox","alert","waybill_no","receipt","vessel_settle_state","push","wnoListFromInner","selectedInvFromInner","k","klen","innerNo","inv","getInvoiceByInnerNo","vehObj","getVehiclesInfo","price","indexOf","ajaxRequestHandle","allSelectedInvNo","allInvNoFromInner","allInnerNo","forEach","vessel_settle_date","vessel_settler","inner_settle","iis","inner_waybill_no","vo","key","hasOwnProperty","settleVesselPay","pay","allPayWNo","allPayInvNo","forPay","pay_date","buildTableTr","bill","send_num","send_weight","str","block_num","format","bill_no","getOrder","order_no","order_item_no","ship_warehouse","getStrValue","thickness","width","weight","total_weight","printDiv","elem","w","window","open","document","write","html","print","close","ino","wno","substring","n","updateDelayData","msg","partInd","modal","wnoList","waybillNo","isExist","unship_date","unshipData","delay_day","advance_charge_mode","advance_charge","remark","numOfRow","tableBody","find","allReceiptOk","getRowChildren","prop","switchElementClass","ckReceiptIcon","tr","eq","text","td_wno","getTableCellChildren","date2Str","td","iElem","show","hide","enableButtons","setHtmlElementDisabled","btnExport","singlePriceInput","btnUnshipDelay","batchPriceInput","btnShowDetail","buildPriceDialog","forVessel","priceData","getPriceValue","inner","bills","vehicles","veh","veh_price","updatePriceStateColumnText","str_1","id","vehicle_vessel_name","ship_from","ship_to","tmp","disabled","name","dialog","message","title","buttons","cancel","label","className","main","callback","forPrice","color","pText","getInvVesselPriceText","css","priceText","getStrByStatus","buildPriceBatchInputDialog","priceObj","priceObj2","allVehName","vvName","replace","p","allVehNameWithVessel","vessel","p2","allInv","record","veh_name","veh_html","jqId","value","parseFloatHTML","val","isNaN","makeInvVehInfo","invoice","allVehicles","apply","num","veh_ship_from","isEmpty","innset","created","found","allInvVehicles","vehInfo","getParameterText","mode","charge_value","checked","ckReceipt","chargeText","makeTableTrHtml","isVessel","number","allNotNeed","ship_name","ship_customer","vehName","getVehicleName","paramText","trHtml","totalAmount","totalWeight","append","local_data","vehPersonMap","ship_date","s","hint","ptext","tp","receiptOk","notNeed","empty","res","addClass","removeClass","on","selectRow","this","selectInnerRow","closest","e","stopImmediatePropagation","me","nextUntil","slideToggle","switchNotNeedSettle","popover","trigger","placement","needUpdateCheckBox","idx","remove","needUpdateCheckbox","hasClass","l","wlist","settleNotNeeded","oc","nc","notNeeded","wayNoList","bveh","Date","tip","tooltip","btnFilter","printBody","sAdvanceMode","iAdvanceNum","unshipDate","iDelayDay","checkReceipt","receiptRemark","dayChanged","receiptChecked","QueryFilterD","eventHandler","elementEventRegister","is","confirm","local_user_name","q","allBills","b","ib","_id","bill_id","backdrop","keyboard","trStr","totWeight","totPrice","check","datetimepicker","getDateTimePickerOptions","getDate","day","diff","parseInt","setDate","moment","add","setMinDate","iCheck","allNo","tableToExcel","toggle","options","uiElems","sBfBillName","sBfDest","sBfVehicle","sBfVehContact","startDateGrp","endDateGrp","iStartDate","iEndDate","rSettled","rNoSettled","rSettledPay","rSettledNotNeeded","initSelect","nameList","vehList","destList","contactNameList","select2","allowClear","selectedVeh","currSelected","sDate","eDate","_selectFliterFunc","which","filter","_dateFilterFunc","isStart","isEnd","d1","d2","prototype","getSelectValue","dest","fName","fVeh","fDest","fSettledState","fDate1","toISOString","fDate2","self","preventDefault","startOf","endOf","setMaxDate","isAllEmpty","records","reset","vehicle","vehicleContactName","nOptions","clearContactName","m","vName","vList","dList","allVehList","pList","b2","b3","b4","sort_pinyin","nList","nv","cname","contactName","updateOptions1","visibleRecs","unselected"],"mappings":"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","file":"settle_vessel_old.js","sourcesContent":["/**\r\n * Created by ezefjia on 12/4/2014.\r\n */\r\n\r\n$(function () {\r\n  \"use strict\";\r\n\r\n  var tableBody        = $('#table-tbody');\r\n  var btnFilter        = $('#filter');\r\n  var btnExport        = $('#search-export');\r\n  var singlePriceInput = $('#single-price-input');\r\n  var batchPriceInput  = $('#batch-price-input');\r\n  var btnSettle        = $('#settle-bill');\r\n  var btnSettleCancel  = $('#settle-bill-cancel');\r\n  var btnPay           = $('#settle-pay');\r\n  var btnPayCancel     = $('#settle-pay-cancel');\r\n  var btnShowDetail    = $('#show-detail');\r\n  var btnPrintDetail   = $('#settle-print-detail');\r\n  var btnUnshipDelay   = $('#delay-info');\r\n  var ckReceiptIcon    = $('#receipt-icon');\r\n  var printBody        = $('#print-detail-tbody');\r\n  var totalAmount = 0;\r\n  var totalWeight = 0;\r\n  var allReceiptOk = true;\r\n\r\n  var sAdvanceMode  = $('#advance_mode');\r\n  var iAdvanceNum   = $('#advance_num');\r\n  var unshipDate    = $('#unship-date-grp');\r\n  var iDelayDay     = $('#delay-day');\r\n  var checkReceipt  = $('#sdd_receipt');\r\n  var receiptRemark = $('#delay-remark');\r\n  var dayChanged = false;\r\n  var receiptChecked = false;\r\n\r\n  var dbRecords =    [];\r\n  var curr_records = []; // 存放查询得到的所有记录\r\n  var selected_records = [];\r\n  var selectedInnerNo =  [];\r\n  var allInvVehicles =   [];\r\n\r\n  $('#first-th').html('<input id=\"select-all\" type=\"checkbox\" data-toggle=\"tooltip\" title=\"选择所有记录\" />&nbsp;<label id=\"all-not-need\" class=\"fa fa-star-o\" data-toggle=\"tooltip\" title=\"点击可设置不需要结算和需要结算\" style=\"cursor:pointer; color:red; font-size:18px;\" ></label>');\r\n\r\n  var qFilter = new QueryFilterD(local_data);\r\n  qFilter.eventHandler(filterData);\r\n\r\n  showHtmlElement(btnSettle, true);\r\n  showHtmlElement(btnSettleCancel, false);\r\n  showHtmlElement(btnPay, false);\r\n  showHtmlElement(btnPayCancel, false);\r\n  showHtmlElement(btnPrintDetail, false);\r\n  enableButtons();\r\n\r\n  function filterData(needUpdateDbData, emptyDbData) {\r\n    if (qFilter.settledState === '未结算') {\r\n      showHtmlElement(btnSettle, true);\r\n      showHtmlElement(btnSettleCancel, false);\r\n      showHtmlElement(btnPay, false);\r\n      showHtmlElement(btnPayCancel, false);\r\n      showHtmlElement(btnPrintDetail, false);\r\n    } else if (qFilter.settledState === '已结算') {\r\n      showHtmlElement(btnSettle, false);\r\n      showHtmlElement(btnSettleCancel, true);\r\n      showHtmlElement(btnPay, true);\r\n      showHtmlElement(btnPrintDetail, true);\r\n      showHtmlElement(btnPayCancel, false);\r\n    } else if (qFilter.settledState === '已付款') {\r\n      showHtmlElement(btnSettle, false);\r\n      showHtmlElement(btnSettleCancel, false);\r\n      showHtmlElement(btnPay, false);\r\n      showHtmlElement(btnPayCancel, true);\r\n      showHtmlElement(btnPrintDetail, false);\r\n    } else if (qFilter.settledState === '不需要结算') {\r\n      showHtmlElement(btnSettle, false);\r\n      showHtmlElement(btnSettleCancel, false);\r\n      showHtmlElement(btnPay, false);\r\n      showHtmlElement(btnPayCancel, false);\r\n      showHtmlElement(btnPrintDetail, false);\r\n    }\r\n\r\n    if (needUpdateDbData) {\r\n      var obj = qFilter.getQueryParams();\r\n      $.get('/get_invoice_settle_vellel', obj, function (data) {\r\n        var result = jQuery.parseJSON(data);\r\n        dbRecords = [];\r\n        if (result.ok) {\r\n          dbRecords = sortByKey(result.invs, \"ship_date\", \"DSC\");\r\n          curr_records = sortByKey(result.invs, \"ship_date\", \"DSC\");\r\n        } else {\r\n          curr_records = [];\r\n        }\r\n        //curr_records = qFilter.updateOptions(dbRecords, false);\r\n        qFilter.updateOptions(curr_records, false);\r\n        resetTableRow();\r\n      });\r\n    } else {\r\n      if (emptyDbData) {\r\n        dbRecords = [];\r\n      }\r\n      curr_records = qFilter.updateOptions(dbRecords, emptyDbData);\r\n      resetTableRow();\r\n    }\r\n  }\r\n\r\n  elementEventRegister(singlePriceInput, 'click', function() {\r\n    if (selected_records.length === 1) {\r\n      buildPriceDialog(selected_records[0], true);\r\n    } else {\r\n      var inv = getInvoiceByInnerNo(selectedInnerNo[0]);\r\n      buildPriceDialog(inv, false, selectedInnerNo[0]);\r\n    }\r\n  });\r\n\r\n  elementEventRegister(batchPriceInput, 'click', buildPriceBatchInputDialog);\r\n\r\n  elementEventRegister($('#select-all'), 'click', function() {\r\n    var checked = $(this).is(\":checked\");\r\n    if (curr_records.length) {\r\n      selected_records = [];\r\n      selectedInnerNo = [];\r\n\r\n      if (checked) {\r\n        var numOfRow = tableBody.find(\"tr\").length;\r\n        for (var i = 0; i < numOfRow; ++i) {\r\n          var tr = getRowChildren(tableBody, i);\r\n          var wno = getTableCellChildren(tr, 2).text();\r\n          if (wno.length > 17) {\r\n            selectedInnerNo.push(wno);\r\n          } else {\r\n            for (var k = 0; k < curr_records.length; ++k) {\r\n              if (wno === curr_records[k].waybill_no) {\r\n                selected_records.push(curr_records[k]);\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        $('.tr_header').addClass('invoice-highlighted');\r\n      } else {\r\n        $('.tr_header').removeClass('invoice-highlighted');\r\n      }\r\n\r\n      $('.select-inv').prop(\"checked\", checked);\r\n      $('.select-sub-inv').prop(\"checked\", checked);\r\n      enableButtons();\r\n    }\r\n  });\r\n\r\n  $('#all-not-need').on('click', function() {\r\n    if (curr_records.length) {\r\n      if (qFilter.settledState === '未结算') {\r\n        var me = $(this);\r\n        var wnoList = [];\r\n        var numOfRow = tableBody.find(\"tr\").length;\r\n        for (var i = 0; i < numOfRow; ++i) {\r\n          var tr = getRowChildren(tableBody, i);\r\n          wnoList.push(getTableCellChildren(tr, 2).text());\r\n        }\r\n        bootbox.confirm(\"您确定要批量不结算操作\", function(result) {\r\n          if (result) {\r\n            switchNotNeedSettle(me, wnoList);\r\n          }\r\n        })\r\n      } else {\r\n        bootbox.alert(\"在已结算状态下不能进行此操作\");\r\n      }\r\n    }\r\n  });\r\n\r\n  elementEventRegister(btnSettle, 'click', function() { settleVessel(true, '已结算', new Date(), local_user_name); });\r\n  elementEventRegister(btnSettleCancel, 'click', function() { settleVessel(false, '未结算', '', '')  });\r\n  elementEventRegister(btnPay, 'click', function() { settleVesselPay(true, '已付款', new Date()); });\r\n  elementEventRegister(btnPayCancel, 'click', function() { settleVesselPay(false, '已结算', '')  });\r\n\r\n  function settleVessel(settle, state, date, username) {\r\n    if (selected_records.length || selectedInnerNo.length) {\r\n      var allSelectedWNo = [];\r\n      for (var i = 0, len = selected_records.length; i < len; ++i) {\r\n        var rec = selected_records[i];\r\n        if (settle) {\r\n          if (rec.vessel_price < 0) {\r\n            bootbox.alert('您选择的运单: ' + rec.waybill_no + ' 已设置为不需要结算, 请先取消不结算,再来结算');\r\n            return;\r\n          }\r\n          else if (rec.vessel_price === 0) {\r\n            bootbox.alert('您选择的运单: ' + rec.waybill_no + ' 还未输入价格, 不能继续结算');\r\n            return;\r\n          }\r\n          else if (rec.receipt != 1) {\r\n            bootbox.alert('您选择的运单: ' + rec.waybill_no + ' 还未收到回执, 不能继续结算');\r\n            return;\r\n          }\r\n          else if (rec.vessel_settle_state === '未结算') {\r\n            allSelectedWNo.push(rec.waybill_no);\r\n          }\r\n        }\r\n        else {\r\n          if (rec.vessel_price < 0) {\r\n            bootbox.alert('您选择的运单: ' + rec.waybill_no + ' 已设置为不需要结算, 不能取消');\r\n            return;\r\n          }\r\n          else if (rec.vessel_settle_state === '已结算') {\r\n            allSelectedWNo.push(rec.waybill_no);\r\n          }\r\n        }\r\n      }\r\n\r\n      var wnoListFromInner = [];\r\n      var selectedInvFromInner = [];\r\n      for (var k = 0, klen = selectedInnerNo.length; k < klen; ++k) {\r\n        var innerNo = selectedInnerNo[k];\r\n        var inv = getInvoiceByInnerNo(innerNo);\r\n        if (inv) {\r\n          var vehObj = getVehiclesInfo(inv, false);\r\n          if (settle) {\r\n            if (vehObj[innerNo].receipt != 1) {\r\n              bootbox.alert('您选择的内部运单: ' + innerNo + ' 还未收到回执, 不能继续结算');\r\n              return;\r\n            }\r\n            else {\r\n              if (vehObj[innerNo].price < 0) {\r\n                bootbox.alert('您选择的内部运单: ' + innerNo + ' 已设置为不需要结算, 请先取消不结算,再来结算');\r\n                return;\r\n              }\r\n              else if (vehObj[innerNo].price === 0) {\r\n                bootbox.alert('您选择的内部运单: ' + innerNo + ' 还未输入价格, 不能继续结算');\r\n                return;\r\n              }\r\n            }\r\n          }\r\n          else {\r\n            if (vehObj[innerNo].price < 0) {\r\n              bootbox.alert('您选择的内部运单: ' + innerNo + ' 已设置为不需要结算, 不能取消结算');\r\n              return;\r\n            }\r\n          }\r\n\r\n          if (wnoListFromInner.indexOf(inv.waybill_no) < 0) {\r\n            wnoListFromInner.push(inv.waybill_no);\r\n          }\r\n\r\n          selectedInvFromInner.push(inv);\r\n        }\r\n      }\r\n\r\n      ajaxRequestHandle('/settle_vessel', 'POST',\r\n        { allSelectedInvNo: allSelectedWNo, allInvNoFromInner: wnoListFromInner, allInnerNo: selectedInnerNo, settle: settle}, '车船结算', function () {\r\n\r\n          selected_records.forEach(function (inv) {\r\n            if (allSelectedWNo.indexOf(inv.waybill_no) >= 0) {\r\n              inv.vessel_settle_state = state;\r\n              inv.vessel_settle_date = date;\r\n              inv.vessel_settler = username;\r\n            }\r\n          });\r\n\r\n          selectedInvFromInner.forEach(function (inv) {\r\n            inv.inner_settle.forEach(function (iis) {\r\n              if (selectedInnerNo.indexOf(iis.inner_waybill_no) >= 0) {\r\n                iis.state = state;\r\n                iis.date = date;\r\n              }\r\n            });\r\n\r\n            var vo = getVehiclesInfo(inv, false);\r\n            for (var key in vo) {\r\n              if (vo.hasOwnProperty(key) && selectedInnerNo.indexOf(key) >= 0) {\r\n                vo[key].state = state;\r\n                vo[key].date = date;\r\n              }\r\n            }\r\n          });\r\n\r\n          resetTableRow();\r\n        });\r\n    } else {\r\n      bootbox.alert(\"请先选择您要结算或结算取消的行\");\r\n    }\r\n  }\r\n\r\n  function settleVesselPay(pay, state, date) {\r\n    if (selected_records.length || selectedInnerNo.length) {\r\n      var allPayWNo = [];\r\n      for (var i = 0, len = selected_records.length; i < len; ++i) {\r\n        var rec = selected_records[i];\r\n        allPayWNo.push(rec.waybill_no);\r\n      }\r\n\r\n      var wnoListFromInner = [];\r\n      var selectedInvFromInner = [];\r\n      for (var k = 0, klen = selectedInnerNo.length; k < klen; ++k) {\r\n        var innerNo = selectedInnerNo[k];\r\n        var inv = getInvoiceByInnerNo(innerNo);\r\n        if (inv) {\r\n          if (wnoListFromInner.indexOf(inv.waybill_no) < 0) {\r\n            wnoListFromInner.push(inv.waybill_no);\r\n          }\r\n\r\n          selectedInvFromInner.push(inv);\r\n        }\r\n      }\r\n\r\n      ajaxRequestHandle('/settle_vessel_pay', 'POST',\r\n        { allPayInvNo: allPayWNo, allInvNoFromInner: wnoListFromInner, allInnerNo: selectedInnerNo, forPay: pay}, '车船结算付款', function () {\r\n\r\n          selected_records.forEach(function (inv) {\r\n            if (allPayWNo.indexOf(inv.waybill_no) >= 0) {\r\n              inv.vessel_settle_state = state;\r\n              inv.pay_date = date;\r\n            }\r\n          });\r\n\r\n          selectedInvFromInner.forEach(function (inv) {\r\n            inv.inner_settle.forEach(function (iis) {\r\n              if (selectedInnerNo.indexOf(iis.inner_waybill_no) >= 0) {\r\n                iis.state = state;\r\n                iis.pay_date = date;\r\n              }\r\n            });\r\n\r\n            var vo = getVehiclesInfo(inv, false);\r\n            for (var key in vo) {\r\n              if (vo.hasOwnProperty(key) && selectedInnerNo.indexOf(key) >= 0) {\r\n                vo[key].state = state;\r\n                vo[key].pay_date = date;\r\n              }\r\n            }\r\n          });\r\n\r\n          resetTableRow();\r\n        });\r\n    }\r\n  }\r\n\r\n  elementEventRegister(btnShowDetail, 'click', function() {\r\n    if (selected_records.length > 0) {\r\n      var inv = selected_records[0];\r\n      var isVessel = false;\r\n      inv.bills.forEach(function (bill) {\r\n        if (bill.vehicles.length) {\r\n          isVessel = true;\r\n        }\r\n      });\r\n\r\n      $.get('/get_waybill', { q: inv.waybill_no }, function (data) {\r\n        var obj = jQuery.parseJSON(data); // bills: bills, invoices: invoices\r\n        var allBills = obj.bills;\r\n        var html = \"\";\r\n        allBills.forEach(function (b) {\r\n          for (var i = 0; i < inv.bills.length; ++i) {\r\n            var ib = inv.bills[i];\r\n            if (b._id == ib.bill_id) {\r\n              html += buildTableTr(b, ib.num, ib.weight);\r\n              if (ib.vehicles.length) {\r\n                var str = \"\";\r\n                ib.vehicles.forEach(function (veh) {\r\n                  str = \"{0}, <code>{1}</code><code>{2}</code><br />\".format(veh.veh_name, veh.send_num, getStrValue(veh.send_weight));\r\n                });\r\n                html += \"<td>\" + str + \"</td></tr>\";\r\n              } else {\r\n                html += \"<td></td></tr>\";\r\n              }\r\n              break;\r\n            }\r\n          }\r\n        });\r\n\r\n        $('#tb-detail-tbody').html(html);\r\n\r\n        showHtmlElement($('#tb-detail th:last-child, #tb-detail td:last-child'), isVessel);\r\n        $('#settle-detail-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n      });\r\n    }\r\n  });\r\n\r\n  function buildTableTr(bill, send_num, send_weight) {\r\n    var str = '<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td>';\r\n    if (bill.block_num > 0) {\r\n      return str.format(bill.bill_no, getOrder(bill.order_no, bill.order_item_no), bill.ship_warehouse? bill.ship_warehouse : \"\",\r\n        getStrValue(bill.thickness), getStrValue(bill.width), getStrValue(bill.len),\r\n        getStrValue(bill.weight), bill.block_num, getStrValue(bill.total_weight), send_num, getStrValue(bill.weight * send_num))\r\n    } else {\r\n      return str.format(bill.bill_no, getOrder(bill.order_no, bill.order_item_no), bill.ship_warehouse? bill.ship_warehouse : \"\",\r\n        getStrValue(bill.thickness), getStrValue(bill.width), getStrValue(bill.len),\r\n        \"\", \"\", getStrValue(bill.total_weight), send_num, getStrValue(send_weight))\r\n    }\r\n  }\r\n\r\n  btnPrintDetail.on('click', function() {\r\n    if (selected_records.length || selectedInnerNo.length) {\r\n      printBody.empty();\r\n      var trStr = '<tr><td style=\"border:1px solid black;padding:5px;\">{0}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{1}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{2}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{3}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{4}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{5}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{6}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{7}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{8}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{9}</td></tr>';\r\n      var totWeight = 0, totPrice = 0;\r\n      var numOfRow = tableBody.find(\"tr\").length;\r\n      for (var i = 0; i < numOfRow; ++i) {\r\n        var tr = getRowChildren(tableBody, i);\r\n        var check = getTableCellChildren(tr, 0).find(\"input\");\r\n        if (check.is(\":checked\")) {\r\n          var w = getTableCellChildren(tr, 10).text();\r\n          var p = getTableCellChildren(tr, 7).text();\r\n          printBody.append(trStr.format(getTableCellChildren(tr, 3).text(),\r\n            getTableCellChildren(tr, 4).text(),\r\n            getTableCellChildren(tr, 5).text(),\r\n            getTableCellChildren(tr, 6).text(),\r\n            w, getTableCellChildren(tr, 8).text(), p,\r\n            getTableCellChildren(tr, 11).text(),\r\n            getTableCellChildren(tr, 14).text(),\r\n            getTableCellChildren(tr, 15).text() ));\r\n          totWeight += (+w);\r\n          totPrice += (+p);\r\n        }\r\n      }\r\n\r\n      $('#print-total-weight').text(getStrValue(totWeight));\r\n      $('#print-total-number').text(getStrValue(totPrice));\r\n      $('#settle-print-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n    } else {\r\n      bootbox.alert('请选择你要打印的清单列表');\r\n    }\r\n  });\r\n\r\n  $('#print-to').on('click', function() {\r\n    printDiv($('#print-div'));\r\n  });\r\n\r\n  $('#print-and-pay').on('click', function() {\r\n    if (printDiv($('#print-div'))) {\r\n      settleVesselPay(true, '已付款', new Date());\r\n    }\r\n  });\r\n\r\n  function printDiv(elem) {\r\n    var w = window.open();\r\n    if (!w) {\r\n      bootbox.alert('请允许弹出窗口!');\r\n      return false;\r\n    } else {\r\n      w.document.write(elem.html());\r\n      w.print();\r\n      w.close();\r\n      return true;\r\n    }\r\n  }\r\n\r\n  function getInvoiceByInnerNo(ino) {\r\n    var inv = null;\r\n    var wno = ino.substring(0, 17);\r\n    for (var n = 0; n < curr_records.length; ++n) {\r\n      if (wno === curr_records[n].waybill_no) {\r\n        inv = curr_records[n];\r\n        break;\r\n      }\r\n    }\r\n\r\n    return inv;\r\n  }\r\n\r\n  unshipDate.datetimepicker(getDateTimePickerOptions()).on('dp.change', function() {\r\n    if (!dayChanged) {\r\n      var date = unshipDate.data(\"DateTimePicker\").getDate();\r\n      if (date) {\r\n        var inv = (selected_records.length === 1) ? selected_records[0] : getInvoiceByInnerNo(selectedInnerNo[0]);\r\n        if (inv) {\r\n          var day = date.diff(inv.ship_date, 'days') - 7;\r\n          if (day > 0) {\r\n            iDelayDay.val(day);\r\n          } else {\r\n            iDelayDay.val('0');\r\n          }\r\n        }\r\n      }\r\n    } else {\r\n      dayChanged = false;\r\n    }\r\n  });\r\n\r\n  iDelayDay.on('keyup paste', function() {\r\n    var day = parseInt(this.value);\r\n    if (day > 0) {\r\n      var inv = (selected_records.length === 1) ? selected_records[0] : getInvoiceByInnerNo(selectedInnerNo[0]);\r\n      if (inv) {\r\n        dayChanged = true;\r\n        unshipDate.data(\"DateTimePicker\").setDate(moment(inv.ship_date).add(day + 7, 'days'));\r\n      }\r\n    }\r\n  });\r\n\r\n  elementEventRegister(checkReceipt, 'ifChecked', function() { receiptChecked = true; });\r\n  elementEventRegister(checkReceipt, 'ifUnchecked', function() { receiptChecked = false; });\r\n\r\n  elementEventRegister(btnUnshipDelay, 'click', function() {\r\n    var inv = (selected_records.length === 1) ? selected_records[0] :getInvoiceByInnerNo(selectedInnerNo[0]);\r\n    if (selected_records.length === 1) {\r\n      sAdvanceMode.val(inv.advance_charge_mode);\r\n      iAdvanceNum.val(inv.advance_charge);\r\n      iDelayDay.val(inv.delay_day);\r\n      unshipDate.data(\"DateTimePicker\").setMinDate(moment(inv.ship_date));\r\n      unshipDate.data(\"DateTimePicker\").setDate( inv.unship_date ? moment(inv.unship_date) : null );\r\n      checkReceipt.iCheck((inv.receipt === 1) ? 'check' : 'uncheck');\r\n      receiptRemark.val(inv.remark ? inv.remark : '');\r\n    }\r\n    else {\r\n      var innerNo = selectedInnerNo[0];\r\n      var vehObj = getVehiclesInfo(inv, false);\r\n      if (vehObj && vehObj[innerNo]) {\r\n        var tmp = vehObj[innerNo];\r\n        sAdvanceMode.val(tmp.advance_charge_mode);\r\n        iAdvanceNum.val(tmp.advance_charge);\r\n        iDelayDay.val(tmp.delay_day);\r\n        unshipDate.data(\"DateTimePicker\").setMinDate(moment(inv.ship_date));\r\n        unshipDate.data(\"DateTimePicker\").setDate(tmp.unship_date ? moment(tmp.unship_date) : null);\r\n        checkReceipt.iCheck((tmp.receipt === 1) ? 'check' : 'uncheck');\r\n        receiptRemark.val(tmp.remark ? tmp.remark : '');\r\n      }\r\n    }\r\n\r\n    showHtmlElement($('#delay_receipt'), true);\r\n    $('#settle-delay-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n  });\r\n\r\n  $('#batch-charge-ctrl').on('click', function() {\r\n    sAdvanceMode.val('现金');\r\n    iAdvanceNum.val('0');\r\n    showHtmlElement($('#delay_receipt'), false);\r\n    $('#settle-delay-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n  });\r\n\r\n  $('#batch-receipt-ctrl').on('click', function() {\r\n    var allNo = [];\r\n    var numOfRow = tableBody.find(\"tr\").length;\r\n    for (var i = 0; i < numOfRow; ++i) {\r\n      var tr = getRowChildren(tableBody, i);\r\n      allNo.push(getTableCellChildren(tr, 2).text());\r\n    }\r\n\r\n    var obj = { receipt: (allReceiptOk ? 0 : 1) }; // false -> true\r\n    updateDelayData({ unshipData: obj, wnoList: allNo, partInd: 2 });\r\n  });\r\n\r\n  $('#settle-delay-btn-ok').on('click', function() {\r\n    var obj = {\r\n      advance_charge_mode: sAdvanceMode.val(),\r\n      advance_charge: iAdvanceNum.val()\r\n    };\r\n\r\n    if ($('#delay_receipt').css('display') == 'none') {\r\n      var allNo = [];\r\n      var numOfRow = tableBody.find(\"tr\").length;\r\n      for (var i = 0; i < numOfRow; ++i) {\r\n        var tr = getRowChildren(tableBody, i);\r\n        allNo.push(getTableCellChildren(tr, 2).text());\r\n      }\r\n\r\n      updateDelayData({ unshipData: obj, wnoList: allNo, partInd: 1 });\r\n    }\r\n    else {\r\n      obj.unship_date = unshipDate.data(\"DateTimePicker\").getDate();\r\n      obj.delay_day = iDelayDay.val();\r\n      obj.receipt = (receiptChecked ? 1 : 0);\r\n      obj.remark = receiptRemark.val();\r\n      var wno = (selected_records.length === 1) ? selected_records[0].waybill_no : selectedInnerNo[0];\r\n\r\n      updateDelayData({ unshipData: obj, wnoList: [ wno ], partInd: 0 });\r\n    }\r\n  });\r\n\r\n  function updateDelayData(data) {\r\n    var msg = 'no_message';\r\n    if (data.partInd === 0) {\r\n      msg = '车船结算滞留信息输入';\r\n    }\r\n    ajaxRequestHandle('/settle_vessel_delay_info', 'POST', data, msg, function () {\r\n      if (data.partInd === 0 || data.partInd === 1) {\r\n        $('#settle-delay-dialog').modal('hide');\r\n      }\r\n\r\n      data.wnoList.forEach(function(wno) {\r\n        var waybillNo = wno;\r\n        if (wno.length > 17) {\r\n          waybillNo = wno.substring(0, 17);\r\n        }\r\n\r\n        for (var i = 0; i < curr_records.length; ++i) {\r\n          if (waybillNo === curr_records[i].waybill_no) {\r\n            var inv = curr_records[i];\r\n            if (wno.length > 17) {\r\n              var vehObj = getVehiclesInfo(inv, false);\r\n              if (vehObj && isExist(vehObj[wno])) {\r\n                if (data.partInd === 0) {\r\n                  vehObj[wno].unship_date = data.unshipData.unship_date;\r\n                  vehObj[wno].delay_day = data.unshipData.delay_day;\r\n                  vehObj[wno].advance_charge_mode = data.unshipData.advance_charge_mode;\r\n                  vehObj[wno].advance_charge = data.unshipData.advance_charge;\r\n                  vehObj[wno].receipt = data.unshipData.receipt;\r\n                  vehObj[wno].remark = data.unshipData.remark;\r\n                } else if (data.partInd === 1) {\r\n                  vehObj[wno].advance_charge_mode = data.unshipData.advance_charge_mode;\r\n                  vehObj[wno].advance_charge = data.unshipData.advance_charge;\r\n                } else if (data.partInd === 2) {\r\n                  vehObj[wno].receipt = data.unshipData.receipt;\r\n                } else if (data.partInd === 3) {\r\n                  vehObj[wno].remark = data.unshipData.remark;\r\n                }\r\n              }\r\n            } else {\r\n              if (data.partInd === 0) {\r\n                inv.unship_date = data.unshipData.unship_date;\r\n                inv.delay_day = data.unshipData.delay_day;\r\n                inv.advance_charge_mode = data.unshipData.advance_charge_mode;\r\n                inv.advance_charge = data.unshipData.advance_charge;\r\n                inv.receipt = data.unshipData.receipt;\r\n                inv.remark = data.unshipData.remark;\r\n              } else if (data.partInd === 1) {\r\n                inv.advance_charge_mode = data.unshipData.advance_charge_mode;\r\n                inv.advance_charge = data.unshipData.advance_charge;\r\n              } else if (data.partInd === 2) {\r\n                inv.receipt = data.unshipData.receipt;\r\n              } else if (data.partInd === 3) {\r\n                inv.remark = data.unshipData.remark;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      });\r\n\r\n      var numOfRow = tableBody.find(\"tr\").length;\r\n      if (data.partInd === 2) {\r\n        allReceiptOk = !allReceiptOk;\r\n        for (var i = 0; i < numOfRow; ++i) {\r\n          getRowChildren(tableBody, i).find(\"td:last\").find('input').prop('checked', allReceiptOk);\r\n        }\r\n        switchElementClass(ckReceiptIcon, 'fa-check-square-o', 'fa-square-o');\r\n      } else {\r\n        for (var k = 0; k < numOfRow; ++k) {\r\n          var tr = getRowChildren(tableBody, k);\r\n          if (data.partInd === 1) {\r\n            tr.find(\"td\").eq(15).text(data.unshipData.advance_charge_mode + \":\" + data.unshipData.advance_charge);\r\n          } else if (data.partInd === 0) {\r\n            var td_wno = getTableCellChildren(tr, 2).text();\r\n            if (td_wno === data.wnoList[0]) {\r\n              tr.find(\"td\").eq(13).text(date2Str(data.unshipData.unship_date));\r\n              tr.find(\"td\").eq(14).text(data.unshipData.delay_day);\r\n              tr.find(\"td\").eq(15).text(data.unshipData.advance_charge_mode + \":\" + data.unshipData.advance_charge);\r\n              var td = tr.find(\"td:last\");\r\n              td.find('input').prop('checked', data.unshipData.receipt === 1);\r\n              var iElem = td.find('i');\r\n              if (data.unshipData.remark) {\r\n                iElem.show();\r\n                iElem.prop(\"title\", data.unshipData.remark);\r\n              } else {\r\n                iElem.hide();\r\n              }\r\n              break;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  /// Function list\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  function enableButtons() {\r\n    setHtmlElementDisabled(btnExport, curr_records.length === 0);\r\n\r\n    if (selected_records.length || selectedInnerNo.length) {\r\n      var len = selected_records.length + selectedInnerNo.length;\r\n      if (len === 1) {\r\n        setHtmlElementDisabled(singlePriceInput, false);\r\n        setHtmlElementDisabled(btnUnshipDelay, false);\r\n      } else {\r\n        setHtmlElementDisabled(singlePriceInput, true);\r\n        setHtmlElementDisabled(btnUnshipDelay, true);\r\n      }\r\n\r\n      setHtmlElementDisabled(batchPriceInput, len < 2);\r\n      setHtmlElementDisabled(btnShowDetail, selected_records.length !== 1);\r\n      setHtmlElementDisabled(btnSettle, false);\r\n      setHtmlElementDisabled(btnSettleCancel, false);\r\n      setHtmlElementDisabled(btnPrintDetail, false);\r\n      setHtmlElementDisabled(btnPay, false);\r\n      setHtmlElementDisabled(btnPayCancel, false);\r\n    } else {\r\n      setHtmlElementDisabled(singlePriceInput, true);\r\n      setHtmlElementDisabled(batchPriceInput, true);\r\n      setHtmlElementDisabled(btnShowDetail, true);\r\n      setHtmlElementDisabled(btnUnshipDelay, true);\r\n      setHtmlElementDisabled(btnSettle, true);\r\n      setHtmlElementDisabled(btnSettleCancel, true);\r\n      setHtmlElementDisabled(btnPrintDetail, true);\r\n      setHtmlElementDisabled(btnPay, true);\r\n      setHtmlElementDisabled(btnPayCancel, true);\r\n    }\r\n  }\r\n\r\n  function buildPriceDialog(inv, forVessel, innerNo) {\r\n    var vehObj = getVehiclesInfo(inv, false);\r\n    var msg = '<div class=\"row form-horizontal\"><div class=\"col-md-10\">';\r\n    var str = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">{1}</label><div class=\"input-group col-sm-8\"><input id=\"{2}\" type=\"text\" name=\"{3}\" class=\"form-control\" value=\"{4}\"><span style=\"font-size: 11px\">始发: {5}, 目的地: {6}</span></div></div>';\r\n    var str_1 = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">{1}</label><div class=\"input-group col-sm-8\"><input id=\"{2}\" type=\"text\" name=\"{3}\" class=\"form-control\" value=\"{4}\" {5}><span style=\"font-size: 11px\">始发: {6}, 发运重量: {7} 吨</span></div></div>';\r\n\r\n    if (forVessel) {\r\n      var id = inv.waybill_no;\r\n      msg += str.format(id, inv.vehicle_vessel_name, id, id, getStrValue(inv.vessel_price), inv.ship_from ? inv.ship_from : '', inv.ship_to);\r\n    }\r\n    else {\r\n      var html = '<div><label>目的地为' + inv.vehicle_vessel_name + '的车辆价格</label>';\r\n      if (vehObj && vehObj[innerNo]) {\r\n        var tmp = vehObj[innerNo];\r\n        var disabled = (tmp.price < 0) ? \"disabled\" : \"\";\r\n        html += str_1.format(innerNo, tmp.name, innerNo, innerNo, getStrValue(tmp.price), disabled, tmp.ship_from ? tmp.ship_from : '', getStrValue(tmp.weight));\r\n      }\r\n      msg += html + '</div>';\r\n    }\r\n\r\n    msg += '</div>';\r\n\r\n    bootbox.dialog({\r\n      message: msg,\r\n      title: \"单行价格输入\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\" },\r\n        main:   { label: \"确定\", className: \"btn-primary\", callback: ok }\r\n      }\r\n    });\r\n\r\n    function ok() {\r\n      var priceData = [];\r\n      if (forVessel) {\r\n        var price = getPriceValue(inv.waybill_no); // id = inv.waybill_no\r\n        if (price >= 0 || price === -1) {\r\n          inv.vessel_price = price;\r\n          priceData.push({ wno: inv.waybill_no, price: price, inner: 0 });\r\n        }\r\n      }\r\n      else {\r\n        inv.bills.forEach(function (bill) {\r\n          bill.vehicles.forEach(function (veh) {\r\n            if (veh.inner_waybill_no === innerNo) {\r\n              var price = getPriceValue(veh.inner_waybill_no); // id = inv.waybill_no\r\n              if (price >= 0 || price === -1) {\r\n                veh.veh_price = price;\r\n                vehObj[innerNo].price = price;\r\n                priceData.push({ wno: veh.inner_waybill_no, price: price, inner: 1 });\r\n              }\r\n            }\r\n          });\r\n        });\r\n      }\r\n\r\n      ajaxRequestHandle('/settle_vessel_price', 'POST',\r\n        { wnoList: [ inv.waybill_no ], priceData: priceData }, 'no_message', function () {\r\n        updatePriceStateColumnText(inv, true);\r\n      });\r\n    }\r\n  }\r\n\r\n  function updatePriceStateColumnText(inv, forPrice) {\r\n    var tr, td;\r\n    var color = (inv.vessel_price < 0) ? \"darkgray\" : \"red\";\r\n    var vehObj = getVehiclesInfo(inv, false);\r\n    var pText = getInvVesselPriceText(vehObj, inv);\r\n    var numOfRow = tableBody.find(\"tr\").length;\r\n    for (var i = 0; i < numOfRow; ++i) {\r\n      tr = getRowChildren(tableBody, i);\r\n      var wno = getTableCellChildren(tr, 2).text();\r\n      if (inv.waybill_no === wno) {\r\n        if (forPrice) {\r\n          tr.find(\"td\").eq(0).find(\"label\").css('color', color);\r\n          tr.find(\"td\").eq(7).html(pText.priceText);\r\n          if (inv.vessel_price < 0) {\r\n            tr.find(\"td\").eq(8).text('无');\r\n          } else {\r\n            tr.find(\"td\").eq(8).text(getStrValue(inv.vessel_price));\r\n          }\r\n        }\r\n        tr.find(\"td\").eq(1).html(getStrByStatus(inv.vessel_settle_state, inv.vessel_settle_state));\r\n        tr.find(\"td\").eq(12).text(date2Str(inv.vessel_settle_date));\r\n      }\r\n      else if (vehObj && isExist(vehObj[wno])) {\r\n        var tmp = vehObj[wno];\r\n        if (forPrice) {\r\n          if (tmp.price < 0) {\r\n            tr.find(\"td\").eq(0).find(\"label\").css('color', \"darkgray\");\r\n            tr.find(\"td\").eq(7).text('无');\r\n            tr.find(\"td\").eq(8).text('无');\r\n          } else {\r\n            tr.find(\"td\").eq(0).find(\"label\").css('color', \"red\");\r\n            tr.find(\"td\").eq(7).text(getStrValue(tmp.price * tmp.weight));\r\n            tr.find(\"td\").eq(8).text(getStrValue(tmp.price));\r\n          }\r\n        }\r\n\r\n        tr.find(\"td\").eq(1).html(getStrByStatus(tmp.state, tmp.state));\r\n        tr.find(\"td\").eq(12).text(date2Str(tmp.date));\r\n      }\r\n    }\r\n  }\r\n\r\n  function buildPriceBatchInputDialog() {\r\n    var allVehName = [];\r\n    var allVehNameWithVessel = [];\r\n    selected_records.forEach(function(record) {\r\n      if (allVehName.indexOf(record.vehicle_vessel_name) < 0) {\r\n        allVehName.push(record.vehicle_vessel_name);\r\n      }\r\n    });\r\n\r\n    selectedInnerNo.forEach(function(innerNo) {\r\n      var inv = getInvoiceByInnerNo(innerNo);\r\n      inv.bills.forEach(function(bill) {\r\n        bill.vehicles.forEach(function(veh) {\r\n          if (veh.inner_waybill_no === innerNo && allVehNameWithVessel.indexOf(veh.veh_name) < 0) {\r\n            allVehNameWithVessel.push(veh.veh_name);\r\n          }\r\n        })\r\n      })\r\n    });\r\n\r\n    var msg = '<div class=\"row form-horizontal\"><div class=\"col-md-10\">';\r\n    var str = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">{1}</label><div class=\"input-group col-sm-8\"><input id=\"{2}\" type=\"text\" name=\"{3}\" class=\"form-control\"></div></div>';\r\n    var id = \"\";\r\n    allVehName.forEach(function(vvName) {\r\n      id = vvName.replace(/[\\s\\(\\)#]+/g, \"999\") + \"999\";\r\n      msg += str.format(id, vvName, id, id);\r\n    });\r\n\r\n    if (allVehNameWithVessel.length) {\r\n      var veh_html = '<div class=\"col-md-12\"><label>目的地为(船)的车辆</label>';\r\n      allVehNameWithVessel.forEach(function(vessel) {\r\n        id = vessel.replace(/[\\s\\(\\)#]+/g, \"888\") + \"888\";\r\n        veh_html += str.format(id, vessel, id, id);\r\n      });\r\n      msg += veh_html + '</div>';\r\n    }\r\n    msg += '</div></div>';\r\n\r\n    bootbox.dialog({\r\n      message: msg,\r\n      title: \"批量输入价格\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\", callback: function() { }},\r\n        main:   { label: \"确定\", className: \"btn-primary\", callback: ok }\r\n      }\r\n    });\r\n\r\n    function ok() {\r\n      var id = \"\";\r\n      var priceObj = {};\r\n      var priceObj2 = {};\r\n      allVehName.forEach(function(vvName) {\r\n        id = vvName.replace(/[\\s\\(\\)#]+/g, \"999\") + \"999\";\r\n        var p = getPriceValue(id);\r\n        if (p > 0 || p === -1) {\r\n          priceObj[vvName] = p;\r\n        }\r\n      });\r\n\r\n      allVehNameWithVessel.forEach(function(vessel) {\r\n        id = vessel.replace(/[\\s\\(\\)#]+/g, \"888\") + \"888\";\r\n        var p2 = getPriceValue(id);\r\n        if (p2 > 0 || p2 === -1) {\r\n          priceObj2[vessel] = p2;\r\n        }\r\n      });\r\n\r\n      var allInv = [];\r\n      var wnoList = [];\r\n      var priceData = [];\r\n      selected_records.forEach(function(record) {\r\n        var price = priceObj[record.vehicle_vessel_name];\r\n        if (price > 0 || price === -1) {\r\n          record.vessel_price = price;\r\n          wnoList.push(record.waybill_no);\r\n          priceData.push({ wno: record.waybill_no, price: price, inner: 0 });\r\n          allInv.push(record);\r\n        }\r\n      });\r\n\r\n      selectedInnerNo.forEach(function(innerNo) {\r\n        var inv = getInvoiceByInnerNo(innerNo);\r\n        inv.bills.forEach(function(bill) {\r\n          bill.vehicles.forEach(function(veh) {\r\n            if (veh.inner_waybill_no === innerNo) {\r\n              var price = priceObj2[veh.veh_name];\r\n              if (price > 0 || price === -1) {\r\n                veh.veh_price = price;\r\n                if (wnoList.indexOf(inv.waybill_no) < 0) {\r\n                  wnoList.push(inv.waybill_no);\r\n                }\r\n\r\n                priceData.push({ wno: innerNo, price: price, inner: 1 });\r\n                var vehObj = getVehiclesInfo(inv, false);\r\n                if (vehObj) {\r\n                  vehObj[innerNo].price = price;\r\n                }\r\n\r\n                allInv.push(inv);\r\n              }\r\n            }\r\n          })\r\n        })\r\n      });\r\n\r\n      if (priceData.length) {\r\n        ajaxRequestHandle('/settle_vessel_price', 'POST', {wnoList: wnoList, priceData: priceData}, 'no_message', function () {\r\n          allInv.forEach(function(rec) {\r\n            updatePriceStateColumnText(rec, true);\r\n          });\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  function getPriceValue(id) {\r\n    var jqId = '#' + id;\r\n    var value = parseFloatHTML($(jqId).val());\r\n    if (isNaN(value) || value == 0) {\r\n      return 0;\r\n    } else {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  function makeInvVehInfo(invoice) {\r\n    var allVehicles = [];\r\n    invoice.bills.forEach(function(bill) {\r\n      allVehicles.push.apply(allVehicles, bill.vehicles);\r\n    });\r\n\r\n    var vehObj = {};\r\n    allVehicles.forEach(function(veh) {\r\n      if (isExist(vehObj[veh.inner_waybill_no])) {\r\n        vehObj[veh.inner_waybill_no].num += veh.send_num;\r\n        vehObj[veh.inner_waybill_no].weight += veh.send_weight;\r\n      } else {\r\n        vehObj[veh.inner_waybill_no] = {\r\n          name: veh.veh_name,\r\n          num: veh.send_num,\r\n          weight: veh.send_weight,\r\n          price: isExist(veh.veh_price) ? veh.veh_price : 0,\r\n          ship_from: veh.veh_ship_from,\r\n          state: '未结算', date: null,\r\n          unship_date: null, delay_day: 0, advance_charge_mode: '现金', advance_charge: 0, receipt: 0, remark: '',\r\n          pay_date: null\r\n        };\r\n      }\r\n    });\r\n\r\n    if (isExist(invoice.inner_settle) && !isEmpty(invoice.inner_settle)) {\r\n      invoice.inner_settle.forEach(function(innset) {\r\n        vehObj[innset.inner_waybill_no].state = innset.state;\r\n        vehObj[innset.inner_waybill_no].date = innset.date;\r\n        vehObj[innset.inner_waybill_no].unship_date = innset.unship_date;\r\n        vehObj[innset.inner_waybill_no].delay_day = innset.delay_day;\r\n        vehObj[innset.inner_waybill_no].advance_charge_mode = innset.advance_charge_mode;\r\n        vehObj[innset.inner_waybill_no].advance_charge = innset.advance_charge;\r\n        vehObj[innset.inner_waybill_no].receipt = innset.receipt;\r\n        vehObj[innset.inner_waybill_no].remark = innset.remark;\r\n        vehObj[innset.inner_waybill_no].pay_date = innset.pay_date;\r\n      })\r\n    }\r\n\r\n    return vehObj;\r\n  }\r\n\r\n  function getVehiclesInfo(invoice, created) {\r\n    var vehObj;\r\n    var found = false;\r\n    for (var k = 0, len = allInvVehicles.length; k < len; ++k) {\r\n      if (invoice.waybill_no === allInvVehicles[k].wno) {\r\n        vehObj = allInvVehicles[k].vehInfo;\r\n        found = true;\r\n        break;\r\n      }\r\n    }\r\n    if (!found && created) {\r\n      vehObj = makeInvVehInfo(invoice);\r\n      allInvVehicles.push({ wno: invoice.waybill_no, vehInfo: vehObj });\r\n    }\r\n\r\n    return vehObj;\r\n  }\r\n\r\n  function getParameterText(state, receipt, mode, charge_value, remark) {\r\n    var color = (state === '不需要结算') ? \"gray\" : \"red\";\r\n    var show = remark ? \"\" : \"display:none\";\r\n    var checked = (receipt === 1) ? \"checked\" : \"\";\r\n    var ckReceipt = '<input class=\"select-receipt\" type=\"checkbox\" disabled ' + checked + '>&nbsp;<i class=\"fa fa-info-circle\" style=\"color:red; cursor:pointer; ' + show + '\" data-toggle=\"tooltip\" title=\"' + remark + '\"></i>';\r\n\r\n    return { state: getStrByStatus(state, state),\r\n      color: color, ckReceipt: ckReceipt, chargeText: mode + \": \" + (typeof charge_value === 'number' ? charge_value : '0') };\r\n  }\r\n\r\n  function makeTableTrHtml(inv) {\r\n    var isVessel = false;\r\n    var vehObj = null;\r\n    var number = 0;\r\n    inv.bills.forEach(function(bill) {\r\n      number += bill.num;\r\n      if (!isVessel && bill.vehicles.length) {\r\n        isVessel = true;\r\n        vehObj = getVehiclesInfo(inv, true);\r\n      }\r\n    });\r\n\r\n    var allReceiptOk = true;\r\n    var allNotNeed = true;\r\n    var name = inv.ship_name + (inv.ship_customer ? \"/\" + inv.ship_customer : \"\");\r\n\r\n    var vehName = qFilter.getVehicleName();\r\n    if ((!vehName || vehName === inv.vehicle_vessel_name) && qFilter.settledState === inv.vessel_settle_state) {\r\n      allReceiptOk = (inv.receipt === 1);\r\n      allNotNeed = (inv.vessel_price < 0);\r\n      var paramText = getParameterText(inv.vessel_settle_state, inv.receipt, inv.advance_charge_mode, inv.advance_charge, inv.remark);\r\n\r\n      var trHtml = '<tr class=\"tr_header\"><td nowrap><input class=\"select-inv\" type=\"checkbox\">&nbsp;<label class=\"fa fa-star-o not-need-settle\" data-toggle=\"tooltip\" title=\"点击可设置不需要结算和需要结算\" style=\"cursor:pointer; color:' + paramText.color + '; font-size:18px;\"></label>';\r\n      if (isVessel) {\r\n        trHtml += '&nbsp;<span data-toggle=\"tooltip\" title=\"点击展开和收缩\" style=\"cursor:pointer;font-size: 16px;\" class=\"fa fa-minus-square-o expand\"></span>';\r\n      }\r\n      trHtml += '</td><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td nowrap>{14}</td><td style=\"text-align: center\">{15}</td></tr>';\r\n\r\n      var pText = getInvVesselPriceText(vehObj, inv);\r\n      totalAmount += pText.price;\r\n      totalWeight += inv.total_weight;\r\n      tableBody.append(\r\n        trHtml.format(\r\n          paramText.state,\r\n          inv.waybill_no,\r\n          inv.vehicle_vessel_name + '/' + local_data.vehPersonMap[inv.vehicle_vessel_name],\r\n          name,\r\n          inv.ship_from,\r\n          inv.ship_to,\r\n          pText.priceText,\r\n          inv.vessel_price < 0 ? '无': getStrValue(inv.vessel_price),\r\n          number,\r\n          getStrValue(inv.total_weight),\r\n          date2Str(inv.ship_date),\r\n          date2Str(inv.vessel_settle_date),\r\n          date2Str(inv.unship_date, true),\r\n          inv.delay_day,\r\n          paramText.chargeText,\r\n          paramText.ckReceipt));\r\n    }\r\n\r\n    if (isVessel) {\r\n      var s = '<tr class=\"vessel_sub_item\" style=\"background: #e0e4f0;\"><td nowrap><input class=\"select-sub-inv\" type=\"checkbox\">&nbsp;<label class=\"fa fa-star-o not-need-settle\" data-toggle=\"tooltip\" title=\"点击可设置不需要结算和需要结算\" style=\"cursor:pointer; color:{16}; font-size:18px;\"></label></td>' +\r\n        '<td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td nowrap>{14}</td><td style=\"text-align: center\">{15}</td></tr>';\r\n\r\n      for (var key in vehObj) {\r\n        if (vehObj.hasOwnProperty(key) && ((!vehName || vehName === vehObj[key].name) && qFilter.settledState === vehObj[key].state)) {\r\n          var tmp = vehObj[key];\r\n          var hint = '无', ptext = '无';\r\n\r\n          //totalAmount += tmp.num;\r\n          totalWeight += tmp.weight;\r\n\r\n          if (tmp.price >= 0) {\r\n            var tp = tmp.price * tmp.weight;\r\n            hint = getStrValue(tmp.price);\r\n            ptext = getStrValue(tp);\r\n            totalAmount += tp;\r\n          }\r\n\r\n          allReceiptOk = allReceiptOk && (tmp.receipt === 1);\r\n          allNotNeed = allNotNeed && (tmp.price < 0);\r\n          paramText = getParameterText(tmp.state, tmp.receipt, tmp.advance_charge_mode, tmp.advance_charge, tmp.remark);\r\n\r\n          tableBody.append(\r\n            s.format(\r\n              paramText.state,\r\n              key,\r\n              tmp.name + '/' + local_data.vehPersonMap[tmp.name],\r\n              name,\r\n              tmp.ship_from ? tmp.ship_from : '',\r\n              inv.vehicle_vessel_name,\r\n              ptext,\r\n              hint,\r\n              tmp.num,\r\n              getStrValue(tmp.weight),\r\n              date2Str(inv.ship_date),\r\n              date2Str(tmp.date),\r\n              date2Str(tmp.unship_date, true),\r\n              tmp.delay_day,\r\n              paramText.chargeText,\r\n              paramText.ckReceipt,\r\n              paramText.color));\r\n        }\r\n      }\r\n    }\r\n\r\n    return { receiptOk: allReceiptOk, notNeed: allNotNeed };\r\n  }\r\n\r\n  function resetTableRow() {\r\n    tableBody.empty();\r\n    selected_records = [];\r\n    selectedInnerNo = [];\r\n    totalAmount = 0;\r\n    totalWeight = 0;\r\n\r\n    var allNotNeed = true;\r\n    curr_records.forEach(function (inv) {\r\n      var res = makeTableTrHtml(inv);\r\n      if (!res.receiptOk) {\r\n        allReceiptOk = false;\r\n      }\r\n      if (!res.notNeed) {\r\n        allNotNeed = false;\r\n      }\r\n    });\r\n\r\n    if (allReceiptOk) {\r\n      ckReceiptIcon.addClass('fa-check-square-o');\r\n      ckReceiptIcon.removeClass('fa-square-o');\r\n    } else {\r\n      ckReceiptIcon.removeClass('fa-check-square-o');\r\n      ckReceiptIcon.addClass('fa-square-o');\r\n    }\r\n\r\n    if (allNotNeed) {\r\n      $('#all-not-need').css('color', 'gray');\r\n    } else {\r\n      $('#all-not-need').css('color', 'red');\r\n    }\r\n\r\n    $('#lb-total-weight').text(getStrValue(totalWeight));\r\n    $('#lb-total-amount').text(getStrValue(totalAmount));\r\n    $('#curr-number').text(tableBody.find(\"tr\").length);\r\n    $('#select-all').prop(\"checked\", false);\r\n\r\n    enableButtons();\r\n\r\n    $('.tr_header').on('click', function () { selectRow($(this), true); });\r\n    $('.vessel_sub_item').on('click', function() { selectInnerRow($(this), true); });\r\n\r\n    $('.select-inv').on('click', function() { selectRow($(this).closest('tr'), false); });\r\n    $('.select-sub-inv').on('click', function() { selectInnerRow($(this).closest('tr'), false); });\r\n\r\n    $('.expand').on('click', function(e) {\r\n      e.stopImmediatePropagation();\r\n      var me = $(this);\r\n      var tr = me.closest('tr');\r\n      switchElementClass(me, 'fa-plus-square-o', 'fa-minus-square-o');\r\n      tr.nextUntil('tr.tr_header').slideToggle(100, function(){ });\r\n    });\r\n\r\n    $('.not-need-settle').on('click', function (e) {\r\n      e.stopImmediatePropagation();\r\n      if (qFilter.settledState === '未结算') {\r\n        var me = $(this);\r\n        var tr = me.closest('tr');\r\n        var wno = getTableCellChildren(tr, 2).text();\r\n        switchNotNeedSettle(me, [ wno ]);\r\n      } else {\r\n        bootbox.alert('已结算,不能再进行\"不需要结算操作\"');\r\n      }\r\n    });\r\n\r\n    $('[data-toggle=\"popover\"]').popover({ trigger: \"hover\", html: true, placement: \"bottom\" });\r\n  }\r\n\r\n  function selectInnerRow(me, needUpdateCheckBox) {\r\n    var innerNo = getTableCellChildren(me, 2).text();\r\n    var idx = selectedInnerNo.indexOf(innerNo);\r\n    if (idx < 0) {\r\n      selectedInnerNo.push(innerNo);\r\n//      me.addClass('invoice-highlighted');\r\n    } else {\r\n      selectedInnerNo.remove(idx);\r\n//      me.removeClass('invoice-highlighted');\r\n    }\r\n\r\n    if (needUpdateCheckBox) {\r\n      me.find('td:first').find('input[type=\"checkbox\"]').prop(\"checked\", (idx < 0));\r\n    }\r\n\r\n    $('#select-all').prop(\"checked\", (selected_records.length + selectedInnerNo.length) === tableBody.find(\"tr\").length);\r\n    enableButtons();\r\n  }\r\n\r\n  function selectRow(me, needUpdateCheckbox) {\r\n    if (me.hasClass(\"tr_header\")) {\r\n      var wno = getTableCellChildren(me, 2).text();\r\n      var found = false;\r\n      for (var i = 0; i < selected_records.length; ++i) {\r\n        if (wno === selected_records[i].waybill_no) {\r\n          selected_records.remove(i);\r\n          found = true;\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (found) {\r\n        me.removeClass('invoice-highlighted');\r\n      } else {\r\n        for (var k = 0, l = curr_records.length; k < l; ++k) {\r\n          if (wno === curr_records[k].waybill_no) {\r\n            selected_records.push(curr_records[k]);\r\n            break;\r\n          }\r\n        }\r\n        me.addClass('invoice-highlighted');\r\n      }\r\n\r\n      if (needUpdateCheckbox) {\r\n        me.find('td:first').find('input[type=\"checkbox\"]').prop(\"checked\", !found);\r\n      }\r\n\r\n      $('#select-all').prop(\"checked\", (selected_records.length + selectedInnerNo.length) === tableBody.find(\"tr\").length);\r\n      enableButtons();\r\n    }\r\n  }\r\n\r\n  function switchNotNeedSettle(me, wlist) {\r\n    var color = me.css('color');\r\n    if (color === 'rgb(255, 0, 0)') {\r\n      me.css('color', 'gray');\r\n      settleNotNeeded(wlist, true);\r\n    } else {\r\n      me.css('color', 'red');\r\n      settleNotNeeded(wlist, false);\r\n    }\r\n  }\r\n\r\n  function switchElementClass(elem, oc, nc) {\r\n    if (elem.hasClass(oc)) {\r\n      elem.addClass(nc);\r\n      elem.removeClass(oc);\r\n    }\r\n    else if (elem.hasClass(nc)) {\r\n      elem.addClass(oc);\r\n      elem.removeClass(nc);\r\n    }\r\n  }\r\n\r\n  function settleNotNeeded(wlist, notNeeded) {\r\n    ajaxRequestHandle('/settle_vessel_not_needed', 'POST', { wayNoList: wlist, notNeeded: notNeeded }, 'no_message', function () {\r\n      wlist.forEach(function (wno) {\r\n        var waybillNo = wno;\r\n        if (wno.length > 17) {\r\n          waybillNo = wno.substring(0, 17);\r\n        }\r\n        for (var i = 0; i < curr_records.length; ++i) {\r\n          if (waybillNo === curr_records[i].waybill_no) {\r\n            var inv = curr_records[i];\r\n            if (wno.length > 17) {\r\n              inv.bills.forEach(function (bill) {\r\n                bill.vehicles.forEach(function (bveh) {\r\n                  if (wno === bveh.inner_waybill_no) {\r\n                    bveh.veh_price = notNeeded ? -1 : 0;\r\n                  }\r\n                })\r\n              });\r\n\r\n              var vehObj = getVehiclesInfo(inv, false);\r\n              if (vehObj && isExist(vehObj[wno])) {\r\n                if (notNeeded) {\r\n                  vehObj[wno].price = -1;\r\n                  vehObj[wno].date = new Date();\r\n                  vehObj[wno].state = '不需要结算';\r\n                } else {\r\n                  vehObj[wno].price = 0;\r\n                  vehObj[wno].date = null;\r\n                  vehObj[wno].state = '未结算';\r\n                }\r\n              }\r\n\r\n              inv.inner_settle.forEach(function(inner) {\r\n                if (inner.inner_waybill_no === wno) {\r\n                  if (notNeeded) {\r\n                    inner.date = new Date();\r\n                    inner.state = '不需要结算';\r\n                  } else {\r\n                    inner.date = null;\r\n                    inner.state = '未结算';\r\n                  }\r\n                }\r\n              })\r\n            } else {\r\n              if (notNeeded) {\r\n                inv.vessel_price = -1;\r\n                inv.vessel_settle_state = '不需要结算';\r\n                inv.vessel_settle_date = new Date();\r\n              } else {\r\n                inv.vessel_price = 0;\r\n                inv.vessel_settle_state = '未结算';\r\n                inv.vessel_settle_date = null;\r\n              }\r\n            }\r\n\r\n            updatePriceStateColumnText(inv, true);\r\n            break;\r\n          }\r\n        }\r\n      })\r\n    });\r\n  }\r\n\r\n  function getInvVesselPriceText(vehObj, inv) {\r\n    var tip = \"\";\r\n    if (inv.vessel_price > 0) {\r\n      tip += '车船号:{0}, 发运重量:{1}, 单价:{2}, 目的地:{3}'.format(inv.vehicle_vessel_name, getStrValue(inv.total_weight), getStrValue(inv.vessel_price), inv.ship_to);\r\n    }\r\n\r\n    if (vehObj) {\r\n      var i = 1;\r\n      for (var key in vehObj) {\r\n        if (vehObj.hasOwnProperty(key)) {\r\n          tip += '\\r第{0}车: {1}, 发运重量:{2}, 单价:{3}, 目的地:{4}'.format(i, vehObj[key].name, getStrValue(vehObj[key].weight),\r\n              vehObj[key].price < 0 ? '无' : getStrValue(vehObj[key].price), inv.vehicle_vessel_name);\r\n          ++i\r\n        }\r\n      }\r\n    }\r\n\r\n    if (inv.vessel_price < 0) {\r\n      return { priceText: '<code style=\"color: darkgray\">无</code>', tooltip: tip, price: 0 };\r\n    } else {\r\n      var p = inv.vessel_price * inv.total_weight;\r\n      return {\r\n        priceText: '<code style=\"color: blue\">' + getStrValue(p) + '</code>',\r\n        tooltip: tip,\r\n        price: p\r\n      };\r\n    }\r\n  }\r\n\r\n  // Export function\r\n  elementEventRegister(btnExport, 'click', function() {  tableToExcel($('#table-content').html(), \"data\"); });\r\n  elementEventRegister(btnFilter, 'click', function() { $('#filter-ui').toggle() });\r\n});\r\n\r\n/////////////////////////////////////////\r\n//////// CLASS DEFINE////////////////////\r\n/////////////////////////////////////////\r\nvar QueryFilterD = function(options) {\r\n  this.uiElems = {\r\n    sBfBillName : $('#bf-bill-name'),\r\n    sBfDest : $('#bf-destination'),\r\n    sBfVehicle : $('#bf-vehicle'),\r\n    sBfVehContact: $('#bf-vehicle-contact'),\r\n    startDateGrp : $('#start-date-grp'),\r\n    endDateGrp : $('#end-date-grp'),\r\n    iStartDate : $('#start-date'),\r\n    iEndDate : $('#end-date'),\r\n    rSettled: $('#vessel-settled'),\r\n    rNoSettled: $('#no-vessel-settled'),\r\n    rSettledPay: $('#vessel-pay'),\r\n    rSettledNotNeeded: $('#vessel-no-need-settled')\r\n  };\r\n\r\n  this.options = options;\r\n  initSelect(this.uiElems.sBfBillName, options.nameList, true);\r\n  initSelect(this.uiElems.sBfVehicle, options.vehList, true);\r\n  initSelect(this.uiElems.sBfDest, options.destList, true);\r\n  initSelect(this.uiElems.sBfVehContact, options.contactNameList, true);\r\n  this.uiElems.rNoSettled.iCheck('check');//.prop('checked', false);\r\n  this.uiElems.iStartDate.val(\"\");\r\n  this.uiElems.iEndDate.val(\"\");\r\n\r\n  this.uiElems.sBfVehicle.select2({allowClear:true});\r\n  this.selectedVeh;\r\n\r\n  this.currSelected = 0;\r\n  this.settledState = '未结算';\r\n  this.sDate = null;\r\n  this.eDate = null;\r\n\r\n  this._selectFliterFunc = function(which, filter) {\r\n    this.currSelected = which;\r\n    filter(true, false);\r\n    //if (this.isAllEmpty()) {\r\n    //  filter(false, true);       // return to initial state\r\n    //}\r\n    //else {\r\n    //  filter(true, false);\r\n    //}\r\n  };\r\n\r\n  this._dateFilterFunc = function(isStart, isEnd, filter) {\r\n    var d1 = this.uiElems.iStartDate.val();\r\n    var d2 = this.uiElems.iEndDate.val();\r\n    var b = false;\r\n    if (isStart && isEnd) {\r\n      b = !isEmpty(d1) && !isEmpty(d2);\r\n    } else if (isStart) {\r\n      b = isEmpty(this.uiElems.iStartDate.val());\r\n    } else if (isEnd) {\r\n      b = isEmpty(this.uiElems.iEndDate.val());\r\n    }\r\n\r\n    if (b) {\r\n      this.currSelected = 5;\r\n      filter(true, false);\r\n    }\r\n  }\r\n};\r\n\r\nQueryFilterD.prototype.getQueryParams = function() {\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var d1 = this.uiElems.iStartDate.val();\r\n  var d2 = this.uiElems.iEndDate.val();\r\n  var b = !isEmpty(d1) && !isEmpty(d2);\r\n\r\n  return {\r\n    fName: name ? name : null,\r\n    fVeh: this.selectedVeh ?  this.selectedVeh : null,\r\n    fDest: dest ? dest : null,\r\n    fSettledState: this.settledState,\r\n    fDate1: b ? this.sDate.toISOString() : null,\r\n    fDate2: b ? this.eDate.toISOString(): null\r\n  };\r\n};\r\n\r\nQueryFilterD.prototype.getVehicleName = function() {\r\n  return this.selectedVeh;\r\n};\r\n\r\nQueryFilterD.prototype.eventHandler = function(filter) {\r\n  var self = this;\r\n  self.uiElems.sBfBillName.on('change', function() {\r\n    self._selectFliterFunc(1, filter);\r\n  });\r\n  self.uiElems.rNoSettled.on('ifChecked', function() {\r\n    self.settledState = '未结算';\r\n    self._selectFliterFunc(2, filter);\r\n  });\r\n  self.uiElems.rSettled.on('ifChecked', function() {\r\n    self.settledState = '已结算';\r\n    self._selectFliterFunc(2, filter);\r\n  });\r\n  self.uiElems.rSettledPay.on('ifChecked', function() {\r\n    self.settledState = '已付款';\r\n    self._selectFliterFunc(2, filter);\r\n  });\r\n  self.uiElems.rSettledNotNeeded.on('ifChecked', function() {\r\n    self.settledState = '不需要结算';\r\n    self._selectFliterFunc(2, filter);\r\n  });\r\n  self.uiElems.sBfVehicle.on('change', function(e) {\r\n    self.selectedVeh = e.val;\r\n    if (self.selectedVeh === '无-取消选择') self.selectedVeh = '';\r\n\r\n    self._selectFliterFunc(3, filter);\r\n  });\r\n  self.uiElems.sBfVehContact.on('change', function() {\r\n    self.currSelected = 6;\r\n    filter(false, false);\r\n  });\r\n  self.uiElems.sBfDest.on('change', function() {\r\n    self._selectFliterFunc(4, filter);\r\n  });\r\n\r\n  self.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.sDate = e.date.startOf('day');\r\n    self.uiElems.endDateGrp.data(\"DateTimePicker\").setMinDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.eDate = e.date.endOf('day');\r\n    self.uiElems.startDateGrp.data(\"DateTimePicker\").setMaxDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.iStartDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(true, false, filter);\r\n  });\r\n  self.uiElems.iEndDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(false, true, filter);\r\n  });\r\n};\r\n\r\nQueryFilterD.prototype.isAllEmpty = function() {\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var d1 = this.uiElems.iStartDate.val();\r\n  var d2 = this.uiElems.iEndDate.val();\r\n  return isEmpty(this.selectedVeh) && isEmpty(dest) && isEmpty(name) && isEmpty(d1) && isEmpty(d2);\r\n};\r\n\r\nQueryFilterD.prototype.updateOptions = function(records, reset) {\r\n  var vehicle = this.selectedVeh;\r\n  var vehicleContactName = getSelectValue(this.uiElems.sBfVehContact);\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var visibleRecs = [];\r\n  var nOptions = {name: [], vehList: [], destList: [], contactNameList: [] };\r\n  if (records.length === 0) {\r\n    nOptions = this.options;\r\n  }\r\n\r\n\r\n  var clearContactName = false;\r\n  if (this.currSelected === 6 && !vehicleContactName) {\r\n    vehicle = '';\r\n    this.selectedVeh = '';\r\n    clearContactName = true;\r\n  }\r\n\r\n  if (!vehicle && this.currSelected === 3) {\r\n    vehicleContactName = null;\r\n  }\r\n\r\n  if (records.length === 0) {\r\n    nOptions = this.options;\r\n  } else {\r\n    var vName = [], vList = [], dList = [], k, m;\r\n    var allVehList = [];\r\n    if (vehicleContactName) {\r\n      var pList = this.options.vehPersonMap;\r\n      for (var key in pList) {\r\n        if (pList[key] === vehicleContactName) {\r\n          allVehList.push(key);\r\n        }\r\n      }\r\n    }\r\n\r\n    records.forEach(function (rec) {\r\n      if (vName.indexOf(rec.ship_name) < 0) {\r\n        vName.push(rec.ship_name);\r\n      }\r\n\r\n      var b2 = false;\r\n      if (clearContactName) {\r\n        b2 = false;\r\n      } else if (allVehList.length) {\r\n        if (allVehList.indexOf(rec.vehicle_vessel_name) >= 0) {\r\n          b2 = true;\r\n        } else {\r\n          for (k = 0; k < rec.bills.length; ++k) {\r\n            for (m = 0; m < rec.bills[k].vehicles.length && !b2; ++m) {\r\n              if (allVehList.indexOf(rec.bills[k].vehicles[m].veh_name) >= 0) {\r\n                b2 = true;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n      else if (vehicle) {\r\n        if (vehicle === rec.vehicle_vessel_name) {\r\n          b2 = true;\r\n        } else {\r\n          for (k = 0; k < rec.bills.length; ++k) {\r\n            for (m = 0; m < rec.bills[k].vehicles.length && !b2; ++m) {\r\n              if (rec.bills[k].vehicles[m].veh_name === vehicle) {\r\n                b2 = true;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      } else {\r\n        b2 = true;\r\n      }\r\n\r\n      var b3 = !dest || dest === rec.ship_to;\r\n      var b4 = !name || name === rec.ship_name;\r\n      if (b2 && b3 && b4) {\r\n        if (rec.ship_to && dList.indexOf(rec.ship_to) < 0) {\r\n          dList.push(rec.ship_to);\r\n        }\r\n\r\n        if (allVehList.length === 0) {\r\n          if (rec.vehicle_vessel_name && vList.indexOf(rec.vehicle_vessel_name) < 0) {\r\n            vList.push(rec.vehicle_vessel_name);\r\n          }\r\n\r\n          for (k = 0; k < rec.bills.length; ++k) {\r\n            for (m = 0; m < rec.bills[k].vehicles.length; ++m) {\r\n              if (vList.indexOf(rec.bills[k].vehicles[m].veh_name) < 0) {\r\n                vList.push(rec.bills[k].vehicles[m].veh_name);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    nOptions.vehList = sort_pinyin(allVehList.length ? allVehList : vList);\r\n    nOptions.destList = sort_pinyin(dList);\r\n    nOptions.name = sort_pinyin(vName);\r\n\r\n    if (this.currSelected === 6) {\r\n      if (this.isAllEmpty() && !vehicleContactName) {\r\n        nOptions.vehList = this.options.vehList;\r\n        nOptions.destList = this.options.destList;\r\n      }\r\n    } else if (nOptions.vehList.length) {\r\n      var nList = this.options.vehPersonMap;\r\n      nOptions.vehList.forEach(function (nv) {\r\n        var cname = nList[nv];\r\n        if (cname && nOptions.contactNameList.indexOf(cname) < 0) {\r\n          nOptions.contactNameList.push(cname);\r\n        }\r\n      });\r\n\r\n      nOptions.contactNameList = sort_pinyin(nOptions.contactNameList);\r\n    }\r\n  }\r\n\r\n  var contactName = (vehicle) ? this.options.vehPersonMap[vehicle] : null;\r\n  initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n  this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n  initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n  initSelect(this.uiElems.sBfVehContact, nOptions.contactNameList, true, contactName);\r\n  initSelect(this.uiElems.sBfBillName, nOptions.name, true, name);\r\n\r\n  //if (this.currSelected === 2) {\r\n  //  initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n  //  this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n  //  initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n  //  initSelect(this.uiElems.sBfVehContact, nOptions.contactNameList, true, contactName);\r\n  //}\r\n  //else if (this.currSelected === 3) {\r\n  //  initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n  //  if (contactName) {\r\n  //    this.uiElems.sBfVehContact.val(contactName);\r\n  //  } else {\r\n  //    unselected(this.uiElems.sBfVehContact);\r\n  //  }\r\n  //}\r\n  //else if (this.currSelected === 6) {\r\n  //  initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n  //  this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n  //  initSelect(this.uiElems.sBfDest, nOptions.destList, true);\r\n  //  if (!vehicleContactName) {\r\n  //    initSelect(this.uiElems.sBfVehContact, this.options.contactNameList, true);\r\n  //  }\r\n  //}\r\n  //else if (this.currSelected === 4) {\r\n  //  initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n  //  this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n  //  initSelect(this.uiElems.sBfVehContact, nOptions.contactNameList, true, contactName);\r\n  //}\r\n  //else {\r\n  //  initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n  //  this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n  //  initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n  //  initSelect(this.uiElems.sBfVehContact, nOptions.contactNameList, true, contactName);\r\n  //}\r\n  //\r\n  //return visibleRecs;\r\n};\r\n\r\nQueryFilterD.prototype.updateOptions1 = function(records, reset) {\r\n  var vehicle = this.selectedVeh;\r\n  var vehicleContactName = getSelectValue(this.uiElems.sBfVehContact);\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var nOptions = { vehList: [], destList: [], contactNameList: [] };\r\n  var visibleRecs = [];\r\n\r\n  var clearContactName = false;\r\n  if (this.currSelected === 6 && !vehicleContactName) {\r\n    vehicle = '';\r\n    this.selectedVeh = '';\r\n    clearContactName = true;\r\n  }\r\n\r\n  if (!vehicle && this.currSelected === 3) {\r\n    vehicleContactName = null;\r\n  }\r\n\r\n  if (reset) {\r\n    nOptions = this.options;\r\n    visibleRecs = records;\r\n    records.forEach(function (bill) {\r\n      if (bill.ship_to && nOptions.destList.indexOf(bill.ship_to) < 0) {\r\n        nOptions.destList.push(bill.ship_to);\r\n      }\r\n    });\r\n  } else {\r\n    var vList = [], dList = [], k, m;\r\n    var allVehList = [];\r\n    if (vehicleContactName) {\r\n      var pList = this.options.vehPersonMap;\r\n      for (var key in pList) {\r\n        if (pList[key] === vehicleContactName) {\r\n          allVehList.push(key);\r\n        }\r\n      }\r\n    }\r\n\r\n    records.forEach(function (rec) {\r\n      var b2 = false;\r\n      if (clearContactName) {\r\n        b2 = false;\r\n      } else if (allVehList.length) {\r\n        if (allVehList.indexOf(rec.vehicle_vessel_name) >= 0) {\r\n          b2 = true;\r\n        } else {\r\n          for (k = 0; k < rec.bills.length; ++k) {\r\n            for (m = 0; m < rec.bills[k].vehicles.length && !b2; ++m) {\r\n              if (allVehList.indexOf(rec.bills[k].vehicles[m].veh_name) >= 0) {\r\n                b2 = true;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n      else if (vehicle) {\r\n        if (vehicle === rec.vehicle_vessel_name) {\r\n          b2 = true;\r\n        } else {\r\n          for (k = 0; k < rec.bills.length; ++k) {\r\n            for (m = 0; m < rec.bills[k].vehicles.length && !b2; ++m) {\r\n              if (rec.bills[k].vehicles[m].veh_name === vehicle) {\r\n                b2 = true;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      } else {\r\n        b2 = true;\r\n      }\r\n\r\n      var b3 = !dest || dest === rec.ship_to;\r\n      var b4 = !name || name === rec.ship_name;\r\n      if (b2 && b3 && b4) {\r\n        visibleRecs.push(rec);\r\n        if (rec.ship_to && dList.indexOf(rec.ship_to) < 0) {\r\n          dList.push(rec.ship_to);\r\n        }\r\n\r\n        if (allVehList.length === 0) {\r\n          if (rec.vehicle_vessel_name && vList.indexOf(rec.vehicle_vessel_name) < 0) {\r\n            vList.push(rec.vehicle_vessel_name);\r\n          }\r\n\r\n          for (k = 0; k < rec.bills.length; ++k) {\r\n            for (m = 0; m < rec.bills[k].vehicles.length; ++m) {\r\n              if (vList.indexOf(rec.bills[k].vehicles[m].veh_name) < 0) {\r\n                vList.push(rec.bills[k].vehicles[m].veh_name);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    nOptions.vehList = sort_pinyin(allVehList.length ? allVehList : vList);\r\n    nOptions.destList = sort_pinyin(dList);\r\n\r\n    if (this.currSelected === 6) {\r\n      if (this.isAllEmpty() && !vehicleContactName) {\r\n        nOptions.vehList = this.options.vehList;\r\n        nOptions.destList = this.options.destList;\r\n      }\r\n    } else if (nOptions.vehList.length) {\r\n      var nList = this.options.vehPersonMap;\r\n      nOptions.vehList.forEach(function (nv) {\r\n        var cname = nList[nv];\r\n        if (cname && nOptions.contactNameList.indexOf(cname) < 0) {\r\n          nOptions.contactNameList.push(cname);\r\n        }\r\n      });\r\n\r\n      nOptions.contactNameList = sort_pinyin(nOptions.contactNameList);\r\n    }\r\n  }\r\n\r\n  var contactName = (vehicle) ? this.options.vehPersonMap[vehicle] : null;\r\n\r\n  if (this.currSelected === 2) {\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n    initSelect(this.uiElems.sBfVehContact, nOptions.contactNameList, true, contactName);\r\n  }\r\n  else if (this.currSelected === 3) {\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n    if (contactName) {\r\n      this.uiElems.sBfVehContact.val(contactName);\r\n    } else {\r\n      unselected(this.uiElems.sBfVehContact);\r\n    }\r\n  }\r\n  else if (this.currSelected === 6) {\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, true);\r\n    if (!vehicleContactName) {\r\n      initSelect(this.uiElems.sBfVehContact, this.options.contactNameList, true);\r\n    }\r\n  }\r\n  else if (this.currSelected === 4) {\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfVehContact, nOptions.contactNameList, true, contactName);\r\n  }\r\n  else {\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n    initSelect(this.uiElems.sBfVehContact, nOptions.contactNameList, true, contactName);\r\n  }\r\n\r\n  return visibleRecs;\r\n};\r\n"]}