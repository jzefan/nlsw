$(function(){var a,d,l,P,t,i={settledWDS:"结算吨数(代收)",notSettledWDS:"未结算吨数(代收)",notNeedWDS:"不需结算吨数(代收)",settledWZT:"结算吨数(自提)",notSettledWZT:"未结算吨数(自提)",notNeedWZT:"不需结算吨数(自提)",totalWeight:"总吨数",totalPrice:"总金额"},V=$("#table-tbody"),o=$("#start-date-grp"),n=$("#end-date-grp"),e=$("#year-grp"),r=$("#month-grp"),_=[],s=[],c=[],h=$("#stat-btn-ok"),C=$("#show-statistics-report"),m=local_action,u=!0,v=$("#detail-tbody");if("CUSTOMER"===m){var f=new FilterElementD($("#bill-name"),sort_pinyin(local_data),!1,!0,null);P=null}else P={},local_data.forEach(function(t){P[t.month]={drayage:t.drayage,forklift:t.forklift}});function g(t){var e=$(t.target).attr("id");"month-grp"===e?(d=t.date.startOf("month"),l=moment(d).add(1,"months"),setHtmlElementDisabled(h,!1)):"start-date-grp"===e?(n.data("DateTimePicker").setMinDate(t.date),(d=t.date.startOf("month"))&&l&&d.isBefore(l)&&setHtmlElementDisabled(h,!1)):"end-date-grp"===e?(o.data("DateTimePicker").setMaxDate(t.date),l=t.date.startOf("month").add(1,"months"),d&&l&&d.isBefore(l)&&setHtmlElementDisabled(h,!1)):(d=t.date.startOf("year"),l=moment(d).add(1,"years"),setHtmlElementDisabled(h,!1))}function p(){for(var t=l.diff(d,"months"),e=[],o=moment(d),n=0;n<t;++n)e.push(o.format("YYYY-MM")),o.add(1,"months");return e}function S(t){var e=_.length;if(0<e){V.empty();var o,n='<tr><td>{0}</td><td>{1}</td><td style="color:blue">{2}</td><td>{3}</td><td style="color:blue">{4}</td><td>{5}</td><td>{6}</td><td style="color:blue">{7}</td><td>{8}</td><td style="color:blue">{9}</td><td>{10}</td><td>{11}</td><td align="right"><code>{12}</code></td></tr>',a=0,d=0,l=0,i=0,r=0,s=0,c=0,h=0,m=0,u=0,v=0,f=0,g=0;if(t)for(g=0;g<e;++g)a+=(o=_[g]).settledWDS,d+=o.notSettledWDS,m+=o.settledPDS,u+=o.notSettledPDS,l+=o.notNeedWDS,i+=o.settledWZT,r+=o.notSettledWZT,v+=o.settledPZT,f+=o.notSettledPZT,s+=o.notNeedWZT,c+=o.totalWeight,h+=o.totalPrice,V.append(n.format(o.name,0<o.settledWDS?o.settledWDS:"",0<o.settledPDS?o.settledPDS:"",0<o.notSettledWDS?o.notSettledWDS:"",0<o.notSettledPDS?o.notSettledPDS:"",0<o.notNeedWDS?o.notNeedWDS:"",0<o.settledWZT?o.settledWZT:"",0<o.settledPZT?o.settledPZT:"",0<o.notSettledWZT?o.notSettledWZT:"",0<o.notSettledPZT?o.notSettledPZT:"",0<o.notNeedWZT?o.notNeedWZT:"",o.totalWeight,o.totalPrice));else for(g=0;g<e;++g)a+=(o=_[g]).settledWDS,d+=o.notSettledWDS,m+=o.settledPDS,u+=o.notSettledPDS,l+=o.notNeedWDS,i+=o.settledWZT,r+=o.notSettledWZT,v+=o.settledPZT,f+=o.notSettledPZT,s+=o.notNeedWZT,c+=o.totalWeight,h+=o.totalPrice,V.append(n.format(o.name,o.settledWDS,o.settledPDS,o.notSettledWDS,o.notSettledPDS,o.notNeedWDS,o.settledWZT,o.settledPZT,o.notSettledWZT,o.notSettledPZT,o.notNeedWZT,o.totalWeight,o.totalPrice));V.append(n.format("总计",getStrValue(a),getStrValue(m),getStrValue(d),getStrValue(u),getStrValue(l),getStrValue(i),getStrValue(v),getStrValue(r),getStrValue(f),getStrValue(s),getStrValue(c),getStrValue(h)))}}function w(){var e="<span style='font-size:11px;'>[[title]] :<b>[[value]]</b></span>",o=[],t={position:"bottom",valueText:"[[value]]",valueWidth:100,valueAlign:"left",equalWidths:!1,periodValueText:"[[value.sum]]"};if(1<s.length)c.forEach(function(t){o.push({type:"line",title:t,valueField:t,lineAlpha:0,fillAlphas:.7,balloonText:e})}),a=AmCharts.makeChart("stat-chartdiv",{type:"serial",dataProvider:s,marginTop:10,categoryField:"month",categoryAxis:{gridAlpha:.07,axisColor:"#DADADA",minorGridEnabled:!0,guides:[{lineColor:"#CC0000",inside:!0,value:10,toValue:20,fillColor:"#00CC00",fillAlpha:.2}]},valueAxes:[{stackType:"regular",gridAlpha:.07,title:"金额"}],graphs:o,legend:t,chartCursor:{}});else if(1===s.length){for(var n in i)i.hasOwnProperty(n)&&("totalPrice"===n?o.push({type:"line",title:i[n],valueField:n,lineThickness:2,bullet:"round",balloonText:e}):o.push({type:"column",title:i[n],valueField:n,fillAlphas:1,balloonText:e}));a=AmCharts.makeChart("stat-chartdiv",{type:"serial",dataProvider:_,categoryField:"name",rotate:!0,valueAxes:[{position:"top",title:"吨数/价格 "+d.format("YYYY-MM"),minorGridEnabled:!0}],graphs:o,legend:t,categoryAxis:{gridPosition:"start"},creditsPosition:"top-right"})}}function O(){a&&a.clear(),s=[],c=u?(_.forEach(function(t){s.push({month:t.month,"车总吨位":t.vhTotal,"自有车吨位":t.vhOwnWeight,"外挂车吨位":t.vhNonOwnWeight,"船总吨位":t.vsTotal,"自有船吨位":t.vsOwnWeight,"外挂船吨位":t.vsNonOwnWeight})}),["车总吨位","自有车吨位","外挂车吨位","船总吨位","自有船吨位","外挂船吨位"]):(_.forEach(function(t){s.push({month:t.month,"车总金额":t.vhRevenue,"自有车收金额":t.vhOwnIncome,"外挂车收金额":t.vhNonOwnIncome,"外挂车付金额":t.vhNonOwnDeposit,"船总金额":t.vsRevenue,"自有船收金额":t.vsOwnIncome,"外挂船收金额":t.vsNonOwnIncome,"外挂船付金额":t.vsNonOwnDeposit})}),["车总金额","自有车收金额","外挂车收金额","外挂车付金额","船总金额","自有船收金额","外挂船收金额","外挂船付金额"]);(a=new AmCharts.AmSerialChart).dataProvider=s,a.categoryField="month";var t=a.categoryAxis;t.gridAlpha=0,t.fillAlpha=1,t.fillColor="#FAFAFA",t.gridPosition="start";var e=new AmCharts.ValueAxis;e.dashLength=5,e.title="重量",e.axisAlpha=0,a.addValueAxis(e),c.forEach(function(t){var e=new AmCharts.AmGraph;e.title=t,e.valueField=t,e.balloonText="<span style='font-size:11px;'>[[title]] :<b>[[value]]</b></span>",e.type="column",e.lineAlpha=0,e.fillAlphas=1,a.addGraph(e)});var o=new AmCharts.ChartCursor;o.cursorAlpha=0,o.zoomable=!1,o.categoryBalloonEnabled=!1,a.addChartCursor(o),a.creditsPosition="top-right",a.legend={position:"bottom",valueText:"[[value]]",valueWidth:100,valueAlign:"left",equalWidths:!1,periodValueText:"[[value.sum]]"},a.write("stat-chartdiv")}function b(t,e,o){$("body").css({cursor:"wait"});var n=moment(o).startOf("month"),a=moment(n).add(1,"months"),d={fDate1:n.toISOString(),fDate2:a.toISOString(),fVehType:e};t?($("#summary-dialog-title").text("外挂"===e?"车船外挂统计:"+o:"车船自有统计:"+o),d.fSummary="YES",$.get("/get_vessel_alloc_detail",d,function(t){var e=jQuery.parseJSON(t);if(e.ok){var o=e.summary_data;for(var n in v.empty(),o)o.hasOwnProperty(n)&&v.append("<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td></tr>".format(n,getStrValue(o[n].weight),getStrValue(o[n].amount),o[n].contact));$("#stat-detail-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}else bootbox.alert("查询数据出错");$("body").css({cursor:"default"})})):($("#detail-title").text("外挂"===e?"车船外挂明细:"+o:"车船自有明细:"+o),d.fSummary="NO",$.get("/get_vessel_alloc_detail",d,function(t){var e=jQuery.parseJSON(t);if(e.ok){var o=e.vessel_detail,n=e.vehNameList;k.empty(),n.forEach(function(e){o.hasOwnProperty(e)&&o[e].forEach(function(t){k.append("<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td></tr>".format(e,t.name,t.ship_from,t.ship_to,getStrValue(t.price),getStrValue(t.single_price),t.send_num,getStrValue(t.send_weight),date2Str(t.ship_date),t.advance_mode+":"+getStrValue(t.advance_charge),t.delay_day))})}),$("#vessel-detail-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}else bootbox.alert("不能获取明细数据");$("body").css({cursor:"default"})}))}function y(t){if(d&&l){$("body").css({cursor:"wait"}),v.empty();var e={fName:t,fDate1:d.toISOString(),fDate2:l.toISOString(),fMonths:p()};$.get("/get_customer_detail",e,function(t){var e=jQuery.parseJSON(t);if(e.ok){e.detail_data.forEach(function(t){v.append("<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td>{14}</td><td>{15}</td></tr>".format(t.order,t.bill_no,t.name,t.veh_ves_name,t.ship_to,t.coll_price,t.price,t.tot_price,t.send_num,t.send_weight,date2Str(t.ship_date),t.inv_no,t.warehouse,t.spec,t.brand_no,t.contract_no))}),$("#price-detail-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}else bootbox.alert("获取明细出错");$("body").css({cursor:"default"})})}}if(C.iCheck("uncheck"),(t=getDateTimePickerOptions()).minViewMode="months",t.format="YYYY-MM",o.datetimepicker(t).on("dp.change",g),n.datetimepicker(t).on("dp.change",g),r.datetimepicker(t).on("dp.change",g),t.minViewMode="years",t.format="YYYY",e.datetimepicker(t).on("dp.change",g),C.on("ifUnchecked",function(){showHtmlElement($("#stat-chartdiv"),!1),showHtmlElement($("#stat-table"),!0),showHtmlElement($("#chart-option"),!1)}),C.on("ifChecked",function(){showHtmlElement($("#stat-chartdiv"),!0),showHtmlElement($("#stat-table"),!1),showHtmlElement($("#chart-option"),!0),a&&a.clear(),"VESSEL"===m?O():function(){if(0===s.length&&c.length){$("body").css({cursor:"wait"});var t={fName:f.selected,fDate1:d.toISOString(),fDate2:l.toISOString(),fMonths:p()};$.get("/get_customer_chart_data",t,function(t){var e=jQuery.parseJSON(t);e.ok&&(s=e.chart_data,w()),$("body").css({cursor:"default"})})}else w()}()}),$("#statistics-condition").on("click",function(){C.iCheck("uncheck"),l=d=null,$(".input-group.date").find("input").each(function(){this.value=""}),setHtmlElementDisabled(h,!0),$("#radio_month").iCheck("check"),$("#stat-condition-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}),h.on("click",function(){if($("#stat-condition-dialog").modal("hide"),nlApp.setTitle("数据分析, 请稍等..."),nlApp.showPleaseWait(),"CUSTOMER"===m){var t=$("#table-caption");t.text(d.format("YYYY-MM")+" 到 "+moment(l).subtract(1,"months").format("YYYY-MM")+" 月份数据"),showHtmlElement(t,!0),o={fName:f.selected,fDate1:d.toISOString(),fDate2:l.toISOString(),fMonths:p()},$.get("/get_statistics_data",o,function(t){var e=jQuery.parseJSON(t);_=[],c=[],e.ok&&(_=e.stat_data,c=e.names,S(!1)),C.iCheck("uncheck"),nlApp.hidePleaseWait()})}else"VESSEL"===m&&(e={fDate1:d.toISOString(),fDate2:l.toISOString(),fMonths:p()},$.get("/get_vessel_revenue_data",e,function(t){_=[];var e=jQuery.parseJSON(t);e.ok&&(_=e.stat_data),V.empty();var a='<tr><td rowspan="2" style="text-align:center;vertical-align:middle">{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td>{14}</td><td style="font-weight:bold;color:{15}">{16}</td></tr>',d='<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td style="font-weight:bold;color:{14}">{15}</td></tr>',l=0,i=0,r=0,s=0,c=0,h=0,m=0,u=0,v=0,f=0,g=0,p=0,S=0,w=0,O=0,b=0,$=0,y=0,N=0,k=0,D=0,x=0,W=0,T=0;if(_.forEach(function(t){t.vhTotal=toFixedNumber(t.vhTotal,3),t.vhRevenue=toFixedNumber(t.vhRevenue,3),t.vhOwnWeight=toFixedNumber(t.vhOwnWeight,3),t.vhOwnIncome=toFixedNumber(t.vhOwnIncome,3),t.vhOwnDeposit=toFixedNumber(t.vhOwnDeposit,3),t.vhOwnProfit=toFixedNumber(t.vhOwnIncome-t.vhOwnDeposit,3),t.vhNonOwnWeight=toFixedNumber(t.vhNonOwnWeight,3),t.vhNonOwnIncome=toFixedNumber(t.vhNonOwnIncome,3),t.vhNonOwnDeposit=toFixedNumber(t.vhNonOwnDeposit,3),t.vhFixedCost=toFixedNumber(t.vhFixedCost,3),t.vhProfit=toFixedNumber(t.vhNonOwnIncome-t.vhNonOwnDeposit,3),t.vsTotal=toFixedNumber(t.vsTotal,3),t.vsRevenue=toFixedNumber(t.vsRevenue,3),t.vsOwnWeight=toFixedNumber(t.vsOwnWeight,3),t.vsOwnIncome=toFixedNumber(t.vsOwnIncome,3),t.vsOwnDeposit=toFixedNumber(t.vsOwnDeposit,3),t.vsOwnProfit=toFixedNumber(t.vsOwnIncome-t.vsOwnDeposit,3),t.vsNonOwnWeight=toFixedNumber(t.vsNonOwnWeight,3),t.vsNonOwnIncome=toFixedNumber(t.vsNonOwnIncome,3),t.vsNonOwnDeposit=toFixedNumber(t.vsNonOwnDeposit,3),t.vsFixedCost=toFixedNumber(t.vsFixedCost,3),t.vsProfit=toFixedNumber(t.vsNonOwnIncome-t.vsNonOwnDeposit,3);var e=t.vsOwnProfit+t.vsProfit-t.vsFixedCost,o=t.vhOwnProfit+t.vhProfit-t.vhFixedCost;V.append(a.format(t.month,"船运",t.vsTotal,t.vsRevenue,t.vsOwnWeight,t.vsOwnIncome,t.vsOwnDeposit,t.vsOwnProfit,t.vsNonOwnWeight,t.vsNonOwnIncome,t.vsNonOwnDeposit,t.vsProfit,t.vsFixedCost,0,0,0<=e?"red":"green",getStrValue(e)));var n=P[t.month];n?(W+=n.drayage,T+=n.forklift,V.append(d.format("车运",t.vhTotal,t.vhRevenue,t.vhOwnWeight,t.vhOwnIncome,t.vhOwnDeposit,t.vhOwnProfit,t.vhNonOwnWeight,t.vhNonOwnIncome,t.vhNonOwnDeposit,t.vhProfit,t.vhFixedCost,getStrValue(n.drayage),getStrValue(n.forklift),0<=o?"red":"green",getStrValue(o+n.drayage+n.forklift)))):V.append(d.format("车运",t.vhTotal,t.vhRevenue,t.vhOwnWeight,t.vhOwnIncome,t.vhOwnDeposit,t.vhOwnProfit,t.vhNonOwnWeight,t.vhNonOwnIncome,t.vhNonOwnDeposit,t.vhProfit,t.vhFixedCost,0,0,0<=o?"red":"green",getStrValue(o))),l+=t.vhTotal,i+=t.vhRevenue,r+=t.vhOwnWeight,s+=t.vhOwnIncome,c+=t.vhOwnDeposit,h+=t.vhOwnProfit,m+=t.vhNonOwnWeight,u+=t.vhNonOwnIncome,v+=t.vhNonOwnDeposit,f+=t.vhProfit,g+=t.vhFixedCost,p+=t.vsTotal,S+=t.vsRevenue,w+=t.vsOwnWeight,O+=t.vsOwnIncome,b+=t.vsOwnDeposit,$+=t.vsOwnProfit,y+=t.vsNonOwnWeight,N+=t.vsNonOwnIncome,k+=t.vsNonOwnDeposit,D+=t.vsProfit,x+=t.vsFixedCost}),1<_.length){var o=h+f-g+W+T,n=$+D-x;V.append(a.format("总计","船运",getStrValue(p),getStrValue(S),getStrValue(w),getStrValue(O),getStrValue(b),getStrValue($),getStrValue(y),getStrValue(N),getStrValue(k),getStrValue(D),getStrValue(x),0,0,0<=n?"red":"green",getStrValue(n))),V.append(d.format("车运",getStrValue(l),getStrValue(i),getStrValue(r),getStrValue(s),getStrValue(c),getStrValue(h),getStrValue(m),getStrValue(u),getStrValue(v),getStrValue(f),getStrValue(g),getStrValue(W),getStrValue(T),0<=o?"red":"green",getStrValue(o)))}C.iCheck("uncheck"),nlApp.hidePleaseWait()}));var e,o}),"VESSEL"===m){var N,k=$("#vessel-detail-tbodys"),D=!1;function x(t,e){if(0===_.length)bootbox.alert("还没有数据,请设置查询日期");else if(D=t,N=e,1<_.length){var o=[];_.forEach(function(t){o.push(t.month)}),initSelect($("#detail-month"),o,!1),$("#choose-month-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}else b(D,e,_[0].month)}$("#deposit-detail").on("click",function(){x(!0,"外挂")}),$("#vessel-deposit-detail").on("click",function(){x(!1,"外挂")}),$("#own-detail").on("click",function(){x(!0,"自有")}),$("#vessel-own-detail").on("click",function(){x(!1,"自有")}),$("#choose-month-ok").on("click",function(){var t=$("#detail-month").val();t&&b(D,N,t)})}else $("#price-detail").on("click",function(){y(f.selected)}),$("#single-customer-detail").on("click",function(){0===_.length?bootbox.alert("还没有数据,请设置查询日期"):1<_.length?(initSelect($("#customer-list"),c,!1),$("#choose-customer-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")):y([_[0].name])}),$("#choose-customer-ok").on("click",function(){var t=$("#customer-list").val();t&&y([t])});elementEventRegister($("#export-detail"),"click",function(){tableToExcel($("#detail-table").html(),"data")}),elementEventRegister($("#export-vessel-detail"),"click",function(){tableToExcel($("#vessel-detail-table").html(),"data")}),$("#radio_month").on("ifChecked",function(){showHtmlElement($("#year-choose"),!1),showHtmlElement($("#non-year-choose"),!0),showHtmlElement($("#month-choose"),!1)}),$("#radio_single_year").on("ifChecked",function(){showHtmlElement($("#year-choose"),!0),showHtmlElement($("#non-year-choose"),!1),showHtmlElement($("#month-choose"),!1)}),$("#radio_single_month").on("ifChecked",function(){showHtmlElement($("#month-choose"),!0),showHtmlElement($("#year-choose"),!1),showHtmlElement($("#non-year-choose"),!1)}),$("#chart-weight").on("ifChecked",function(){u=!0,O()}),$("#chart-amount").on("ifChecked",function(){u=!1,O()}),$("#show-zero-space").on("ifChecked",function(){S(!0)}),$("#show-zero-space").on("ifUnchecked",function(){S(!1)}),elementEventRegister($("#search-export"),"click",function(){tableToExcel($("#stat-table").html(),"data")});var W,T,E=$("#nlContextMenu"),F=$("#show-customer-detail");$("body").on("contextmenu","table tbody tr",function(t){E.css({display:"block",left:t.pageX,top:t.pageY});var e=$(this).closest("tr"),o=e.index();return"CUSTOMER"===m?(T=getTableCellChildren(e,0).text(),F.text("显示"+T+"明细")):W=moment(d).add(o/2,"months").format("YYYY-MM"),!1}),E.on("click",function(){E.hide()}),$("section").on("click",function(){E.hide()}),F.on("click",function(){return T&&y([T]),!1}),$("#show-own-summary").on("click",function(){return W&&b(!0,"自有",W),!1}),$("#show-own-detail").on("click",function(){return W&&b(!1,"自有",W),!1}),$("#show-deposit-summary").on("click",function(){return W&&b(!0,"外挂",W),!1}),$("#show-deposit-detail").on("click",function(){return W&&b(!1,"外挂",W),!1})});
//# sourceMappingURL=report_stat.js.map
