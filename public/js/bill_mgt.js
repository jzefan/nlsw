function getTableHtml(t){var e,n,l,a=[];a.push("<thead><tr><th>提单号</th><th>订单号</th><th>牌号</th><th>厚度</th><th>宽度</th><th>长度</th><th>单重</th><th>发运数</th><th>发运重量</th><th>仓库</th><th>合同号</th></tr></thead>");return t.forEach(function(t){l=0<t.block_num?(e=getStrValue(t.wnum),n=getStrValue(t.weight),getStrValue(t.weight*t.wnum)):(e=getStrValue(t.wnum_danding),n="",getStrValue(t.wnum)),a.push("<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td></tr>".format(t.bill_no,getOrder(t.order_no,t.order_item_no),t.brand_no?t.brand_no:"",getStrValue(t.thickness),getStrValue(t.width),getStrValue(t.len),n,e,l,t.ship_warehouse?t.ship_warehouse:"",t.contract_no?t.contract_no:""))}),a.join("")}function getBillsByNo(t,e){var n=[];return 0<t.length&&(e.order_no?t.forEach(function(t){t.order_no==e.order_no&&n.push(t)}):e.item_no?t.forEach(function(t){t.order_item_no==e.item_no&&n.push(t)}):e.bill_no&&t.forEach(function(t){t.bill_no==e.bill_no&&n.push(t)})),n}function validFloatInput(t,e,n){t.data("new",e),t.ForceNumericOnly(),t.on("keyup paste",function(t){$(this).data("old",$(this).data("new")||"");var e=$(this).val();isNumeric(e)?(e<n&&(e=n),$(this).data("new",e),$(this).val(e)):($(this).val($(this).data("old")),$(this).data("new",$(this).val()))})}function validIntInput(e,n,l){e.ForceNumericOnly(),e.on("keyup paste",function(t){numberIntValider(e,n,l)})}function sameText(t,e){var n=isEmpty(t),l=isEmpty(e);return n||l?!(!n||!l):t==e}$(function(){"use strict";var c,h=$("#billing_name"),m=$("#contract_no"),u=$("#ship_warehouse"),e=$("#mod_order_no"),l=$("#order_item_no"),a=$("#bill_no"),_=$("#data_tbody"),b=0,o=[],i=[],f=$("#remove-some");$("#action-button").html('<input id="select-all" type="checkbox" data-toggle="tooltip" data-placement="bottom" title="选择所有记录" />');var t=$("#select-all"),g=!1;if(e.length){g=!0;var r=[],s={};select2Setup(e,{inputLength:5,placeholder:"查找订单号",url:"/get_bill"},function(t){s=t}),e.change(function(t){if(t.added){var e=t.added.text,n=s.orderItemNoMap[e].sort();l.empty(),a.empty(),n.forEach(function(t){l.append("<option>"+t+"</option>")}),unselected(l),1==(r=getBillsByNo(s.bills,{order_no:e,item_no:""})).length&&a.append("<option>"+r[0].bill_no+"</option>"),o=r,V()}}),l.change(function(){var t=this.value;if(0<t.length){a.empty();var e=getBillsByNo(r,{order_no:"",item_no:t});o=e,V(),e.forEach(function(t){a.append("<option>"+t.bill_no+"</option>")}),1<e.length&&unselected(a)}}),a.change(function(){var t=$("select#bill_no option:selected").text();if(t){var e=$("select#order_item_no option:selected").text();if(e)for(var n=0;n<r.length;++n){var l=r[n];if(l.bill_no==t&&l.order_item_no==e){(o=[]).push(l),V();break}}}})}else{var d=$("#del_order_no"),p=$("#del_bill_no"),n={};0<d.length&&(select2Setup(d,{inputLength:5,placeholder:"查找订单号",url:"/get_bill"},function(t){s=t,n={}}),d.change(function(t){t.added&&(p.empty(),o=getBillsByNo(s.bills,{order_no:t.added.text}),V())})),0<p.length&&(select2Setup(p,{inputLength:5,placeholder:"查找提单号",url:"/get_bill_by_bno"},function(t){n=t,s={}}),p.change(function(t){t.added&&(d.empty(),o=getBillsByNo(n.bills,{bill_no:t.added.text}),V())})),elementEventRegister(f,"click",function(){if(0<i.length){for(var t=0;t<i.length;++t)if("新建"!=i[t].status)return void bootbox.alert('选择的提单中存在状态是"'+i[t].status+'",不能删除!');bootbox.confirm("危险!您确定要全部删除? 删除后不能恢复!",function(t){t&&ajaxRequestHandle("/delete_bill","POST",i,"删除",function(){for(var t=[],e=0;e<o.length;++e){for(var n=!1,l=0;l<i.length;++l)if(sameBill(o[e],i[l])){i.remove(l),n=!0;break}n||t.push(o[e])}o=t,i=[],V(),d.val(""),p.val(""),setHtmlElementDisabled(f,!0)})})}})}elementEventRegister(t,"click",function(){0<o.length&&(t.prop("checked")?($(".select-bill").prop("checked",!0),i=o,setHtmlElementDisabled(f,!1)):($(".select-bill").prop("checked",!1),i=[],setHtmlElementDisabled(f,!0)))});var v=$("#mod-total-number"),k=$("#mod-total-weight");function y(){$("#h_order_no").text(c.order_no),$("#h_order_item_no").text(c.order_item_no),$("#mod_len").text(c.len),$("#mod_width").text(c.width),$("#mod_thickness").text(c.thickness);var t=c.block_num,e=c.left_num;t?($("#mod_num").text(t),$("#mod_ship_num").text(t-e)):($("#mod_num").text("无数据"),$("#mod_ship_num").text("无")),$("#status").text(c.status),$("#create_date").text(c.create_date),$("#shipping_date").text(c.shipping_date),$("#settle_date").text(c.settle_date),$("#mod-sale-dep").text(c.sales_dep),$("#mod-size-type").text(c.size_type);var n="已配发"==c.status||"已结算"==c.status;0<c.block_num?(showHtmlElement($("#mod-tot-num-grp"),!0),showHtmlElement($("#mod-tot-weight-grp"),!1),v.prop("disabled",n)):(showHtmlElement($("#mod-tot-num-grp"),!1),showHtmlElement($("#mod-tot-weight-grp"),!0),k.prop("disabled",n)),$("#brand_no").val(c.brand_no),h.val(c.billing_name),u.val(c.ship_warehouse),m.val(c.contract_no),v.val(c.block_num);var l=c.block_num-c.left_num;validIntInput(v,0==l?1:l,2e3),k.val(c.total_weight);var a=c.total_weight-c.left_num;validFloatInput(k,c.total_weight,a),$("#mod-bill-no").val(c.bill_no),$("#single-modify-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}elementEventRegister($("#single-modify"),"click",function(){c?y():bootbox.alert("请选择表中某一记录")}),elementEventRegister($("#single-modify-btn-ok"),"click",function(){var t=!1,e=h.val(),n=m.val(),l=u.val(),a=$("#mod-bill-no").val();sameText(a,c.bill_no)||(c.bill_no=a,t=!0),sameText(e,c.billing_name)||(c.billing_name=e,t=!0),sameText(n,c.contract_no)||(c.contract_no=n,t=!0),sameText(l,c.ship_warehouse)||(c.ship_warehouse=l,t=!0);var o=getElementValue($("#brand_no"));if(sameText(o,c.brand_no)||(c.brand_no=o,t=!0),0<c.block_num){var i=parseInt(v.val());if(c.block_num!=i){var r=c.block_num-c.left_num;c.block_num=i,c.left_num=i-r,c.total_weight=toFixedNumber(i*c.weight,3),c.left_num<=0&&(c.left_num=0,c.status="已配发"),t=!0}}else if(0<c.total_weight){var s=parseFloat(k.val());if(0<s&&s!=c.total_weight){var d=c.total_weight-c.left_num;c.total_weight=s,c.left_num=s-d,c.left_num<=0&&(c.left_num=0,c.status="已配发"),t=!0}}t?ajaxRequestHandle("/modify_bill/single","POST",c,"单行修改",function(){if(!isJqueryElementEmpty(_)){var t="",e="";f.length||g?(t+='<td><input class="select-bill" type="checkbox"></td>',e+='<td style="cursor:pointer" class="td-icon"><i title="删除" class="fa fa-trash-o redlink"></i></td>'):($("#action-button").hide(),$("#delete-button").hide()),_.find("tr").eq(b).html(t+N(c)+e)}$("#single-modify-dialog").modal("hide")}):$("#single-modify-dialog").modal("hide")}),elementEventRegister($("#batch-modify"),"click",function(){0<i.length?(E=[],unselected(w),x.val(""),$("#batch-modify-info").html(""),$("#batch-modify-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")):bootbox.alert("无数据可修改")});var w=$("#batch-modify-item"),x=$("#batch-modify-item-value"),E=[];elementEventRegister(w,"change",function(){x.val("")}),elementEventRegister(x,"keyup paste",function(t){t.stopImmediatePropagation();var e=$(this),n=$.trim(e.val()),l=w.find("option:selected"),a=l.text(),o=l.index();if(0<=o){E[o]={name:a,val:n};var i="";E.forEach(function(t){t.val&&("销售部门"==t.name||"尺寸"==t.name?i+='<span class="nl_label label-primary col-md-12">"'+t.name+'" 批量修改为:'+t.val+' <label class="nl_label label-warning"> 注:只有在销售部门为A6,A8,B6,B8,E6,E8和尺寸为定尺时,才使用公式计算重量</label></span>':i+='<span class="nl_label label-primary col-md-12">"'+t.name+'" 批量修改为:'+t.val+"</span>")}),$("#batch-modify-info").html(i),setHtmlElementDisabled($("#batch-modify-btn-ok"),isEmpty(i))}}),elementEventRegister($("#batch-modify-btn-ok"),"click",function(){var n=!1,l=!1;i.forEach(function(e){if(n=!1,E.forEach(function(t){"牌号"==t.name?e.brand_no=t.val:"开单名称"==t.name?(e.billing_name=t.val,l=!0):"发货仓库"==t.name?e.ship_warehouse=t.val:"提单号"==t.name?e.bill_no=t.val:"合同号"==t.name?e.contract_no=t.val:"销售部门"==t.name?e.sales_dep=t.val:"尺寸"==t.name?e.size_type=t.val:"长度"==t.name?(e.len=t.val,n=!0):"宽度"==t.name?(e.width=t.val,n=!0):"厚度"==t.name&&(e.thickness=t.val,n=!0)}),1==n&&0<e.block_num){var t=e.len*e.width*e.thickness*7.85*Math.pow(10,-9);e.weight=toFixedNumber(t,3),e.total_weight=toFixedNumber(e.block_num*e.weight,3)}}),ajaxRequestHandle("/modify_bill/batch","POST",{bills:i,nameChanged:l},"批量修改",function(){V(),$("#batch-modify-dialog").modal("hide")})}),$("#left-zero").on("click",function(){0<i.length?(i.forEach(function(t){t.total_weight-=t.left_num,t.left_num=0,t.status="已配发"}),ajaxRequestHandle("/modify_bill/batch","POST",{bills:i,nameChanged:!1},"剩余量清零修改",function(){V()})):bootbox.alert("请选择要清零的记录！")}),$("#general-search").on("click",function(){$("#general-search-content").toggle()}),$("#advance-search").on("click",function(){var t=new SearchHandlerD("bill");t.initial("/get_bills_by_condition"),t.okEventHandler(function(t){o=t.bills,V(),isExist(p)&&0<p.length?(p.select2("val",""),d.select2("val","")):(e.select2("val",""),l.val(""),a.val("")),$("#search_dialog").modal("hide")}),$("#search_dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}),$("#left-search").on("click",function(){$("#left-search-weight").val(""),$("#left-search-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}),$("#left-search-btn-ok").on("click",function(){var t=$("#left-search-weight").val();0<t&&$.get("/get_bills_by_condition",{search_left:1,left:parseFloat(t)},function(t){var e=JSON.parse(t);e.ok?(o=e.bills,V(),$("#left-search-dialog").modal("hide")):500<e.number?bootbox.alert("当前查询结果 = "+e.number+", 数量太多（超过500个），请进一步限定条件！"):bootbox.alert("找不到您要找的数据,请确认您的查询条件!")})});var S="sheet";elementEventRegister($("#search-export"),"click",function(){saveToExcel(o,S)});var H=$("#checkbox-shipping-bill");function V(){_.empty();var e="<tr>",n="</tr>";0<f.length||g?(e='<tr><td><input class="select-bill" type="checkbox"></td>',n='<td style="cursor:pointer" class="td-icon"><i title="删除" class="fa fa-trash-o redlink"></i></td></tr>'):($("#action-button").hide(),$("#delete-button").hide());var l=[];o.forEach(function(t){l.push(e+N(t)+n)}),_.append(l.join("\n"));var t=_.find("tr");tr_click(t,function(t,e){c=o[e],b=e}),t.dblclick(function(){c=o[$(this).index()],b=$(this).index(),0<$("#single-modify").length?y():0<$("#checkbox-shipping-bill").length&&function(){if(c.invoices.length){var t=c.invoices[0].inv_no;$.get("/get_waybill",{q:t},function(t){var n=jQuery.parseJSON(t),e=n.invoices[0];setElementValue($("#report-bill-name"),e.ship_name),setElementValue($("#report-ship-to"),e.ship_to),setElementValue($("#report-waybill-no"),e.waybill_no);var l=[];e.bills.forEach(function(e){n.bills.forEach(function(t){String(e.bill_id)===String(t._id)&&(l.push(t),0<t.block_num?t.wnum=e.num:(t.wnum_danding=e.num,t.wnum=e.weight))})}),$("#report-table").html(getTableHtml(l));var a=0;e.bills.forEach(function(t){a+=t.num}),setElementValue($("#report-total-weight"),toFixedStr(e.total_weight,3)),setElementValue($("#report-total-number"),a),$("#show-invoice-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")})}}()}),$(".td-icon").on("click",function(t){t.stopImmediatePropagation();var e,n,l=$(this).closest("tr"),a=l.index();e=o[a],n=function(){for(var t=0;t<i.length;++t)if(sameBill(i[t],o[a])){i.remove(t),setHtmlElementDisabled(f,0===i.length);break}l.remove(),o.remove(a)},"新建"!=e.status?bootbox.alert("提单状态是"+e.status+",不能删除!"):bootbox.confirm("危险!您确定要删除这条提单? 删除后不能恢复!",function(t){t&&ajaxRequestHandle("/delete_bill","POST",[e],"单行删除",n)})}),$(".select-bill").on("click",function(t){t.stopImmediatePropagation();var e=$(this).closest("tr"),n=e.index(),l=o[n];if($(this).is(":checked"))i.push(l),setHtmlElementDisabled(f,!1),e.addClass("selected-highlighted"),e.removeClass("invoice-highlighted");else{for(var a=0;a<i.length;++a)if(sameBill(i[a],l)){i.remove(a),setHtmlElementDisabled(f,0===i.length);break}e.removeClass("selected-highlighted")}})}function N(t){for(var e='<td style="text-align: center;">'+getStrByStatus(t.status,t.status)+"</td>",n=[],l=0;l<t.invoices.length;++l){var a=t.invoices[l].veh_ves_name;a&&n.indexOf(a)<0&&n.push(a)}0<n.length?e+="<td>"+n.join(",")+"</td>":e+="<td></td>";for(var o=0;o<22;++o)e+="<td>{"+o+"}</td>";var i="";return 0<t.block_num&&(i=getStrValue(t.weight)),e.format(getOrder(t.order_no,t.order_item_no),t.bill_no,t.brand_no?t.brand_no:"",t.billing_name,t.sales_dep?t.sales_dep:"",getStrValue(t.thickness),getStrValue(t.width),getStrValue(t.len),t.size_type,"",i,t.block_num,getStrValue(t.total_weight),t.ship_warehouse?t.ship_warehouse:"",t.shipping_address?t.shipping_address:"",t.contract_no?t.contract_no:"",date2Str(t.create_date),date2Str(t.shipping_date),date2Str(t.settle_date),t.creater?t.creater:"",t.shipper?t.shipper:"",t.settler?t.settler:"")}elementEventRegister(H,"ifChecked",function(){S="已配发";$.get("/get_bills_by_condition",{q:JSON.stringify({status:"已配发"}),isNeedAnalysis:!1},function(t){var e=JSON.parse(t);e.ok&&(o=e.bills,V())})}),elementEventRegister(H,"ifUnchecked",function(){o=[],_.empty()})});
//# sourceMappingURL=bill_mgt.js.map
