{"version":3,"sources":["ticket_money.js"],"names":["QueryFilterD","options","filter","this","currSelected","self","uiElems","sBfBillName","$","sBfSerialNumber","sBfDest","startDateGrp","endDateGrp","iStartDate","iEndDate","sDate","eDate","initSelect","nameList","serials","destList","val","_selectFliterFunc","which","isAllEmpty","_dateFilterFunc","isStart","isEnd","d1","d2","b","isEmpty","on","datetimepicker","getDateTimePickerOptions","e","preventDefault","stopImmediatePropagation","date","startOf","data","setMinDate","endOf","setMaxDate","tableBody","dbSettles","local_dbData","dbBills","curr_settles","selected_settles","visible_settles","action","btnCustomer","btnCollection","btnSettleDelete","btnTicketOk","btnTicketCancel","btnMoneyOk","btnMoneyCancel","btnFilter","btnExport","btnShowDetail","btnRealPrice","radioFlag","length","qFilter","getOptions","reset","updateOptions","resetTableRow","html","checkSelectAll","buildToggleButton","new_action","me","removeClass","addClass","resetFilterAndUI","flag","updateUI","selectedSettles","len","find","tr","getRowChildren","sn","getTableCellChildren","text","k","serial_number","remove","prop","enableButtons","setHtmlElementDisabled","numOfTicket","numOfMoney","i","status","buildTicketNoInputDialog","settle","msg","format","bootbox","dialog","message","title","buttons","cancel","label","className","main","callback","id","ticket_no","ticket_date","Date","ticket_person","local_user","userid","ajaxRequestHandle","empty","html_text","tn","tw","tp","forEach","settle_type","push","row","status_str","getStrByStatus","str","s","isExist","real_price","price","getStrValue","billing_name","ship_number","ship_weight","settle_date","moment","settler","makeTableBodyTr","append","join","selectRow","closest","popover","trigger","placement","idx","index","selected","alert","confirm","result","allSelected","needUpdateCheckbox","found","makeBillTableBodyTr","bill","settle_bill","statusStr","statusText","settle_flag","customerPrice","vehPrice","vessel","priceText","priceInfoObj","getInvoicePriceInfo","tip","totalCustomerPrice","totalVehPrice","order","bill_no","collection_price","total_weight","thickness","width","size_type","brand_no","sales_dep","ship_warehouse","contract_no","shipTo","invoices","inv","inv_no","veh_ves_name","ship_to","guige","getOrder","order_no","order_item_no","num","weight","date2Str","shipping_date","dbData","settles","nOptions","indexOf","sort","sort_pinyin","elementEventRegister","is","curr","allSettles","return_money_date","return_person","css","cursor","get","fSerial","jQuery","parseJSON","ok","bills","allBills","settle_bills","abill","String","bill_id","_id","tbody","modal","backdrop","keyboard","p","sno","tableToExcel","toggle","prototype","serial","getSelectValue","dest","name","visible","dateNotEmpty","b1","b3","b4","sd","isAfter","isBefore"],"mappings":"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","file":"ticket_money.js","sourcesContent":["/**\r\n * Created by ezefjia on 11/19/2014.\r\n */\r\n\r\n$(function () {\r\n  \"use strict\";\r\n\r\n  var tableBody       = $('#table-tbody');\r\n\r\n  // initialize\r\n  var dbSettles = local_dbData;\r\n  var dbBills = [];\r\n  var curr_settles = [];\r\n  var selected_settles = [];\r\n  var visible_settles = dbSettles;\r\n  var action = \"CUSTOMER\";\r\n  var CUSTOMER_SETTLE_FLAG   = 1; // 0001\r\n  var COLLECTION_SETTLE_FLAG = 2; // 0010\r\n\r\n  var btnCustomer     = $('#customer-btn');\r\n  var btnCollection   = $('#collection-btn');\r\n  var btnSettleDelete = $('#settle-delete');\r\n  var btnTicketOk     = $('#settle-ticket');\r\n  var btnTicketCancel = $('#settle-ticket-cancel');\r\n  var btnMoneyOk      = $('#settle-money');\r\n  var btnMoneyCancel  = $('#settle-money-cancel');\r\n  var btnFilter       = $('#filter');\r\n  var btnExport       = $('#search-export');\r\n  var btnShowDetail   = $('#show-detail');\r\n  var btnRealPrice    = $('#real-price-input');\r\n\r\n  var radioFlag = 0; // 0: settle, 1: ticket, 2: money\r\n  if (btnMoneyOk.length) {\r\n    radioFlag = 1;\r\n  }\r\n\r\n  var qFilter = new QueryFilterD(getOptions(local_dbData), filterData);\r\n\r\n  $('#first-th').html('<input id=\"select-all\" type=\"checkbox\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"选择所有记录\" />');\r\n  var checkSelectAll = $('#select-all');\r\n\r\n  resetTableRow();\r\n\r\n  elementEventRegister(checkSelectAll, 'click', function() {\r\n    if ($(this).is(\":checked\")) {\r\n      $('.select-item').prop(\"checked\", true);\r\n      selected_settles = curr_settles;\r\n      tableBody.find(\"tr\").addClass('invoice-highlighted');\r\n    } else {\r\n      $('.select-item').prop(\"checked\", false);\r\n      selected_settles = [];\r\n      tableBody.find(\"tr\").removeClass('invoice-highlighted');\r\n    }\r\n    enableButtons();\r\n  });\r\n\r\n  elementEventRegister(btnCustomer, 'click', function() {\r\n    buildToggleButton(\"CUSTOMER\", $(this));\r\n  });\r\n\r\n  elementEventRegister(btnCollection, 'click', function() {\r\n    buildToggleButton(\"COLLECTION\", $(this));\r\n  });\r\n\r\n  function buildToggleButton(new_action, me) {\r\n    if (action != new_action) {\r\n      if (action === \"CUSTOMER\") {\r\n        btnCustomer.removeClass(\"btn-primary\");\r\n        btnCustomer.addClass(\"btn-default\");\r\n      } else if (action === \"COLLECTION\") {\r\n        btnCollection.removeClass(\"btn-primary\");\r\n        btnCollection.addClass(\"btn-default\");\r\n      }\r\n      me.removeClass(\"btn-default\");\r\n      me.addClass(\"btn-primary\");\r\n      action = new_action;\r\n      qFilter.reset(getOptions(local_dbData));\r\n\r\n      resetTableRow();\r\n    }\r\n  }\r\n\r\n  elementEventRegister(btnTicketOk, 'click', buildTicketNoInputDialog);\r\n\r\n  elementEventRegister(btnTicketCancel, 'click', function() {\r\n    bootbox.confirm(\"您是否真的要取消所选择的已开票数据?\", function(result) {\r\n      if (result) {\r\n        var settles = [];\r\n        selected_settles.forEach(function(settle) {\r\n          if (settle.status === '已开票') {\r\n            settle.status = '已结算';\r\n            settle.ticket_no = \"\";\r\n            settle.ticket_date = null;\r\n            settle.ticket_person = \"\";\r\n            settles.push(settle);\r\n          }\r\n        });\r\n\r\n        ajaxRequestHandle('/settle_ticket', 'POST', settles, '开票取消', function () {\r\n          updateUI(settles);\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  elementEventRegister(btnSettleDelete, 'click', function() {\r\n    for (var i = 0; i < selected_settles.length; ++i) {\r\n      if (selected_settles[i].status != '已结算') {\r\n        bootbox.alert(\"选择的结算纪录中存在状态[\" + selected_settles[i].status + \"], 不能删除!\");\r\n        return;\r\n      }\r\n    }\r\n\r\n    bootbox.confirm(\"您是否真的要删除选择的结算数据?\", function(result) {\r\n      if (result) {\r\n        ajaxRequestHandle('/delete_settle', 'POST', {allSelected: selected_settles, which: action }, 'no_message', function() {\r\n          var len = dbSettles.length;\r\n          while (len--) {\r\n            var curr = dbSettles[len];\r\n            for (var k = 0; k < selected_settles.length; ++k) {\r\n              if (selected_settles[k].serial_number === curr.serial_number) {\r\n                dbSettles.remove(len);\r\n                selected_settles.remove(k);\r\n                break;\r\n              }\r\n            }\r\n          }\r\n\r\n          resetTableRow();\r\n          bootbox.alert(\"删除成功!\");\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  elementEventRegister(btnMoneyOk, 'click', function() {\r\n    var allSettles = [];\r\n    selected_settles.forEach(function(data) {\r\n      if (data.settle_type != \"车船结算\") {\r\n        data.status = '已回款';\r\n        data.return_money_date = new Date();\r\n        data.return_person = local_user.userid;\r\n        allSettles.push(data);\r\n      }\r\n    });\r\n\r\n    ajaxRequestHandle('/settle_money', 'POST', allSettles, '回款', function () {\r\n      updateUI(allSettles);\r\n    });\r\n  });\r\n\r\n  elementEventRegister(btnMoneyCancel, 'click', function() {\r\n    bootbox.confirm(\"取消回款: 您是否真的要取消所选择的已回款数据?\", function(result) {\r\n      if (result) {\r\n        var settles = [];\r\n        selected_settles.forEach(function(settle) {\r\n          if (settle.status === '已回款') {\r\n            settle.status = '已开票';\r\n            settle.return_person = \"\";\r\n            settle.return_money_date = null;\r\n            settles.push(settle);\r\n          }\r\n        });\r\n\r\n        ajaxRequestHandle('/settle_ticket', 'POST', settles, '回款取消', function () {\r\n          updateUI(settles);\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  elementEventRegister(btnShowDetail, 'click', function() {\r\n    var settle = selected_settles[0];\r\n    $('body').css({'cursor':'wait'});\r\n    $.get('/get_settle_bill', { fSerial: settle.serial_number }, function (data) {\r\n      var result = jQuery.parseJSON(data);\r\n      if (result.ok) {\r\n        dbBills = result.bills;\r\n        var html = '';\r\n        var allBills = result.settle_bills;//settle.bills;\r\n        dbBills.forEach(function(bill) {\r\n          allBills.forEach(function(abill) {\r\n            if (String(abill.bill_id) === String(bill._id)) {\r\n              html += makeBillTableBodyTr(bill, settle.settle_type, abill);\r\n            }\r\n          })\r\n        });\r\n\r\n        var tbody = $('#settle-bill-tbody');\r\n        tbody.empty();\r\n        tbody.append(html);\r\n        $('[data-toggle=\"popover\"]').popover({ trigger: \"hover\", html: true, placement: \"bottom\" });\r\n        $('#settle-detail-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n      } else {\r\n        dbBills = [];\r\n      }\r\n      $('body').css({'cursor':'default'});\r\n    });\r\n  });\r\n\r\n  elementEventRegister($('#settle-radio'), 'ifChecked', function() { resetFilterAndUI(0); });\r\n  elementEventRegister($('#ticket-radio'), 'ifChecked', function() { resetFilterAndUI(1); });\r\n  elementEventRegister($('#money-radio'), 'ifChecked', function() { resetFilterAndUI(2); });\r\n\r\n  elementEventRegister(btnRealPrice, 'click', buildRealPriceInputDialog);\r\n\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  /// function list\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  function resetFilterAndUI(flag) {\r\n    radioFlag = flag;\r\n    qFilter.reset(getOptions(local_dbData));\r\n    resetTableRow();\r\n  }\r\n\r\n  function updateUI(selectedSettles) {\r\n    var len = tableBody.find(\"tr\").length;\r\n    while (len--) {\r\n      var tr = getRowChildren(tableBody, len);\r\n      var sn = getTableCellChildren(tr, 2).text();\r\n      for (var k = 0; k < selectedSettles.length; ++k) {\r\n        if (selectedSettles[k].serial_number === sn) {\r\n          tr.remove();\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    checkSelectAll.prop(\"checked\", selectedSettles.length === tableBody.find(\"tr\").length);\r\n    enableButtons();\r\n  }\r\n\r\n  function enableButtons() {\r\n    if (curr_settles.length) {\r\n      setHtmlElementDisabled(btnExport, false);\r\n      setHtmlElementDisabled(btnFilter, false);\r\n    } else {\r\n      setHtmlElementDisabled(btnExport, true);\r\n      setHtmlElementDisabled(btnFilter, true);\r\n    }\r\n\r\n    if (selected_settles.length) {\r\n      setHtmlElementDisabled(btnShowDetail, selected_settles.length != 1);\r\n      setHtmlElementDisabled(btnRealPrice, selected_settles.length != 1);\r\n\r\n      if (btnMoneyOk.length) {\r\n        var numOfTicket = 0;\r\n        var numOfMoney = 0;\r\n        for (var i = 0; i < selected_settles.length; ++i) {\r\n          if (selected_settles[i].status === '已开票') {\r\n            ++numOfTicket;\r\n          } else if (selected_settles[i].status === '已回款') {\r\n            ++numOfMoney;\r\n          }\r\n        }\r\n        setHtmlElementDisabled(btnMoneyOk, numOfTicket === 0);\r\n        setHtmlElementDisabled(btnMoneyCancel, numOfMoney === 0 );\r\n      } else {\r\n        setHtmlElementDisabled(btnSettleDelete, false);\r\n        for (var k = 0; k < selected_settles.length; ++k) {\r\n          if (selected_settles[k].status === '已开票') {\r\n            setHtmlElementDisabled(btnTicketCancel, false);\r\n            break;\r\n          }\r\n        }\r\n\r\n        if (selected_settles.length === 1) {\r\n          setHtmlElementDisabled(btnTicketOk, false);\r\n        }\r\n      }\r\n    } else {\r\n      setHtmlElementDisabled(btnShowDetail, true);\r\n      if (btnMoneyOk.length) {\r\n        setHtmlElementDisabled(btnMoneyOk, true);\r\n        setHtmlElementDisabled(btnMoneyCancel, true);\r\n        setHtmlElementDisabled(btnRealPrice, true);\r\n      } else {\r\n        setHtmlElementDisabled(btnTicketOk, true);\r\n        setHtmlElementDisabled(btnTicketCancel, true);\r\n        setHtmlElementDisabled(btnSettleDelete, true);\r\n      }\r\n    }\r\n  }\r\n\r\n  function buildTicketNoInputDialog() {\r\n    var settle = selected_settles[0];\r\n    var msg = '<div class=\"row form-horizontal\"><div class=\"col-md-10\">';\r\n    var str = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">开票号</label><div class=\"input-group col-sm-8\"><input id=\"{1}\" type=\"text\" name=\"{2}\" class=\"form-control\"></div></div>';\r\n    msg += str.format(settle.serial_number, settle.serial_number, settle.serial_number) + '</div></div>';\r\n\r\n    bootbox.dialog({\r\n      message: msg,\r\n      title: \"开票:请输入票号\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\" },\r\n        main: { label: \"确定\", className: \"btn-primary\",\r\n          callback: function () {\r\n            var id = '#' + settle.serial_number;\r\n            settle.ticket_no = $(id).val();\r\n            settle.ticket_date = new Date();\r\n            settle.ticket_person = local_user.userid;\r\n            settle.status = '已开票';\r\n            ajaxRequestHandle('/settle_ticket', 'POST', [ settle ], '开票', function () {\r\n              updateUI([settle]);\r\n            });\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  function buildRealPriceInputDialog() {\r\n    var settle = selected_settles[0];\r\n    var msg = '<div class=\"row form-horizontal\"><div class=\"col-md-10\">';\r\n    var str = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">实收价格</label><div class=\"input-group col-sm-8\"><input id=\"{1}\" type=\"text\" name=\"{2}\" class=\"form-control\"></div></div>';\r\n    msg += str.format(settle.serial_number, settle.serial_number, settle.serial_number) + '</div></div>';\r\n\r\n    bootbox.dialog({\r\n      message: msg,\r\n      title: \"请输入实收价格\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\" },\r\n        main: { label: \"确定\", className: \"btn-primary\",\r\n          callback: function () {\r\n            var id = '#' + settle.serial_number;\r\n            var p = $(id).val();\r\n            if (p > 0) {\r\n              settle.real_price = p;\r\n              ajaxRequestHandle('/settle_real_price', 'POST', { sno: settle.serial_number, price: p}, '实收价格', function () {\r\n                var len = tableBody.find(\"tr\").length;\r\n                for (var i = 0; i < len; ++i) {\r\n                  var tr = getRowChildren(tableBody, i);\r\n                  var sn = getTableCellChildren(tr, 2).text();\r\n                  if (sn === settle.serial_number) {\r\n                    var s = '';\r\n                    if (p != settle.price) {\r\n                      s = '<code style=\"color:red;font-weight:bold\">' + getStrValue(p) + '</code>';\r\n                    } else {\r\n                      s = '<code style=\"color:green\">' + getStrValue(settle.price) + '</code>';\r\n                    }\r\n                    getTableCellChildren(tr, 6).html(s);\r\n                    break;\r\n                  }\r\n                }\r\n              });\r\n            } else {\r\n              bootbox.alert(\"无效的价格\");\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  function resetTableRow() {\r\n    tableBody.empty();\r\n    curr_settles = [];\r\n    selected_settles = [];\r\n    var html_text = [];\r\n    var tn = 0, tw = 0, tp = 0;\r\n    visible_settles.forEach(function (settle) {\r\n      if (\r\n        ((radioFlag === 0 && settle.status === \"已结算\") ||\r\n          (radioFlag === 1 && settle.status === \"已开票\") ||\r\n          (radioFlag === 2 && settle.status === \"已回款\")) ) {\r\n\r\n        if (//btnMoneyOk.length ||\r\n          (action === \"CUSTOMER\" && settle.settle_type === \"客户结算\") ||\r\n          (action === \"COLLECTION\" && settle.settle_type === \"代收代付结算\")) {\r\n          html_text.push(makeTableBodyTr(settle));\r\n          curr_settles.push(settle);\r\n          tn += settle.ship_number;\r\n          tw += settle.ship_weight;\r\n          tp += settle.price;\r\n        }\r\n      }\r\n    });\r\n\r\n    tableBody.append(html_text.join('\\n'));\r\n\r\n    checkSelectAll.prop(\"checked\", false);\r\n    enableButtons();\r\n\r\n    tableBody.find('tr').on('click', function () {\r\n      selectRow($(this), true);\r\n    }).on('dblclick', function () {\r\n      buildTicketNoInputDialog();\r\n    });\r\n\r\n    $('.select-item').on('click', function(e) {\r\n      e.stopImmediatePropagation();\r\n      selectRow($(this).closest('tr'), false);\r\n    });\r\n\r\n    $('[data-toggle=\"popover\"]').popover({ trigger: \"hover\", html: true, placement: \"bottom\" });\r\n\r\n    $('.td-icon').on('click', function(e) { // delete button click\r\n      e.stopImmediatePropagation();\r\n      e.preventDefault();\r\n      var tr = $(this).closest('tr');\r\n      var idx = tr.index();\r\n      var selected = curr_settles[idx];\r\n      if (selected.status != '已结算') {\r\n        bootbox.alert(\"当前选择的结算纪录状态为\" + selected.status + \", 不能删除!\");\r\n      } else {\r\n        bootbox.confirm(\"您是否真的要删除此结算数据?\", function (result) {\r\n          if (result) {\r\n            ajaxRequestHandle('/delete_settle', 'POST', {allSelected: [ selected ], which: action }, 'no_message', function () {\r\n              for (var i = 0; i < selected_settles.length; ++i) {\r\n                if (selected_settles[i].serial_number === selected.serial_number) {\r\n                  selected_settles.remove(i);\r\n                  break;\r\n                }\r\n              }\r\n              for (i = 0; i < dbSettles.length; ++i) {\r\n                if (dbSettles[i].serial_number === selected.serial_number) {\r\n                  dbSettles.remove(i);\r\n                  break;\r\n                }\r\n              }\r\n\r\n              curr_settles.remove(idx);\r\n              tr.remove();\r\n\r\n              $('#curr-settle-num').text(curr_settles.length);\r\n              enableButtons();\r\n              bootbox.alert(\"删除成功!\");\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    $('#curr-settle-num').text(curr_settles.length);\r\n    $('#lb-total-num').text(tn);\r\n    $('#lb-total-weight').text(getStrValue(tw));\r\n    $('#lb-total-amount').text(getStrValue(tp));\r\n  }\r\n\r\n  function selectRow(me, needUpdateCheckbox) {\r\n    var b = curr_settles[me.index()];\r\n    var found = false;\r\n    for (var i = 0; i < selected_settles.length; ++i) {\r\n      if (selected_settles[i].serial_number === b.serial_number) {\r\n        selected_settles.remove(i);\r\n        found = true;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (found) {\r\n      me.removeClass('invoice-highlighted');\r\n    } else {\r\n      selected_settles.push(b);\r\n      me.addClass('invoice-highlighted');\r\n    }\r\n\r\n    if (needUpdateCheckbox) {\r\n      me.find('input[type=\"checkbox\"]').prop(\"checked\", !found);\r\n    }\r\n\r\n    checkSelectAll.prop(\"checked\", selected_settles.length === curr_settles.length);\r\n    enableButtons();\r\n  }\r\n\r\n  function makeTableBodyTr(row) {\r\n    var status_str = getStrByStatus(row.status, row.status);\r\n    var str = '<tr data-toggle=\"popover\" title=\"\" data-content=\"\"><td align=\"center\"><input type=\"checkbox\" class=\"select-item\" /></td>';\r\n\r\n    var s = '';\r\n    if (isExist(row.real_price) && row.real_price != 0 && row.real_price != row.price) {\r\n      s = '<code style=\"color:red;font-weight:bold\">' + getStrValue(row.real_price) + '</code>';\r\n    } else {\r\n      s = '<code style=\"color:green\">' + getStrValue(row.price) + '</code>';\r\n    }\r\n\r\n    str += '<td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td align=\"center\" style=\"cursor:pointer\" class=\"td-icon\"><i title=\"删除\" class=\"fa fa-trash-o redlink\"></i></td></tr>';\r\n    return str.format(status_str, row.serial_number, row.settle_type, row.billing_name,\r\n      getStrValue(row.price), s, row.ship_number, getStrValue(row.ship_weight),\r\n      isEmpty(row.settle_date) ? '' : moment(row.settle_date).format(\"YYYY-MM-DD\"),\r\n      row.settler ? row.settler : '',\r\n      isEmpty(row.ticket_date) ? '' : moment(row.ticket_date).format(\"YYYY-MM-DD\"),\r\n      row.ticket_no ? row.ticket_no : ''\r\n    );\r\n  }\r\n\r\n  function makeBillTableBodyTr(bill, settle_type, settle_bill) {\r\n    var statusStr = \"\";\r\n    if (bill.status === '已结算') {\r\n      var statusText = [];\r\n      if ((bill.settle_flag & CUSTOMER_SETTLE_FLAG) === CUSTOMER_SETTLE_FLAG) {\r\n        statusText.push(\"客户\");\r\n      }\r\n      if ((bill.settle_flag & COLLECTION_SETTLE_FLAG) === COLLECTION_SETTLE_FLAG) {\r\n        statusText.push(\"代收付\");\r\n      }\r\n      statusStr = getStrByStatus(statusText.join(',') + '已结算', bill.status);\r\n    } else {\r\n      statusStr = getStrByStatus(bill.status, bill.status);\r\n    }\r\n    var priceInfoObj = getInvoicePriceInfo(bill);\r\n    var tip = getBillTooltip(bill, priceInfoObj.totalCustomerPrice, priceInfoObj.totalVehPrice);\r\n    var vessel, priceText;\r\n    var shipTo = '';\r\n    for (var i = 0; i < bill.invoices.length; ++i) {\r\n      var inv = bill.invoices[i];\r\n      if (inv.inv_no === settle_bill.inv_no) {\r\n        if (settle_type === \"客户结算\") {\r\n          vessel = inv.veh_ves_name;\r\n          priceText = getStrValue(inv.price);\r\n        } else if (settle_type === \"代收代付结算\") {\r\n          vessel = \"\";\r\n          priceText = getStrValue(bill.collection_price);\r\n        }\r\n        shipTo = inv.ship_to;\r\n        break;\r\n      }\r\n    }\r\n\r\n    var guige = getStrValue(bill.thickness) + '*' + getStrValue(bill.width) + '*' + bill.len;\r\n\r\n    var trHtml = '<tr {0}><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td></tr>';\r\n    return trHtml.format(tip, statusStr, getOrder(bill.order_no, bill.order_item_no), bill.bill_no, guige,\r\n      bill.billing_name, vessel, shipTo, priceText, settle_bill.num, getStrValue(settle_bill.weight),\r\n      getStrValue(priceText * settle_bill.weight), date2Str(bill.shipping_date));\r\n  }\r\n\r\n  function getBillTooltip(bill, customerPrice, vehPrice) {\r\n    var t = bill.order + ' ' + bill.bill_no;\r\n    var tip = 'data-toggle=\"popover\" title=\"' + t + '\" data-content=\"客户价格: {0}<br />车船价格: {1}<br />代收代付价格: {2}<br />' +\r\n      '厚度: {3}<br />宽度: {4}<br />长度: {5}<br />尺寸: {6}<br />牌号: {7}<br />销售部门: {8}<br />发货仓库: {9}<br />合同号: {10}<br />\"';\r\n    return tip.format(getStrValue(customerPrice), getStrValue(vehPrice), getStrValue(bill.collection_price * bill.total_weight),\r\n      getStrValue(bill.thickness), getStrValue(bill.width),\r\n      getStrValue(bill.len), bill.size_type ? bill.size_type : '', bill.brand_no ? bill.brand_no : '',\r\n      bill.sales_dep ? bill.sales_dep : '', bill.ship_warehouse ? bill.ship_warehouse : '',\r\n      bill.contract_no ? bill.contract_no : '');\r\n  }\r\n\r\n  /////////////////////////////////////////////////////////////////////////////\r\n  // Export & Filter function\r\n  elementEventRegister(btnExport, 'click', function() {\r\n    if (selected_settles.length > 0) {\r\n      var settle = selected_settles[0];\r\n      $.get('/get_settle_bill', { fSerial: settle.serial_number }, function (data) {\r\n        var result = jQuery.parseJSON(data);\r\n        if (result.ok) {\r\n          dbBills = result.bills;\r\n          var html = '';\r\n          var allBills = result.settle_bills;//settle.bills;\r\n          dbBills.forEach(function (bill) {\r\n            allBills.forEach(function (abill) {\r\n              if (String(abill.bill_id) === String(bill._id)) {\r\n                html += makeBillTableBodyTr(bill, settle.settle_type, abill);\r\n              }\r\n            })\r\n          });\r\n\r\n          var tbody = $('#settle-bill-tbody');\r\n          tbody.empty();\r\n          tbody.append(html);\r\n          tableToExcel($('#table-content').html(), \"data\");\r\n        }\r\n      })\r\n    } else {\r\n      bootbox.alert('请选择要导出的结算记录');\r\n    }\r\n  });\r\n\r\n  elementEventRegister(btnFilter, 'click', function() { $('#filter-ui').toggle() });\r\n\r\n  function getOptions(dbData) {\r\n    var settles = dbData;\r\n    var nOptions = { serials: [], destList: [], nameList: [] };\r\n\r\n    if (btnMoneyOk.length) {\r\n      settles.forEach(function(settle) {\r\n        if ((radioFlag === 1 && settle.status === \"已开票\") || (radioFlag === 2 && settle.status === \"已回款\")) {\r\n          if (nOptions.nameList.indexOf(settle.billing_name) < 0) {\r\n            nOptions.nameList.push(settle.billing_name);\r\n          }\r\n          if (nOptions.serials.indexOf(settle.serial_number) < 0) {\r\n            nOptions.serials.push(settle.serial_number);\r\n          }\r\n          if (nOptions.destList.indexOf(settle.ship_to) < 0) {\r\n            nOptions.destList.push(settle.ship_to);\r\n          }\r\n        }\r\n      })\r\n    } else {\r\n      settles.forEach(function(settle) {\r\n        if (((radioFlag === 1 && settle.status === \"已开票\") ||\r\n             (radioFlag === 0 && settle.status === \"已结算\")) &&\r\n            ((action === 'CUSTOMER' && settle.settle_type === '客户结算') ||\r\n             (action === 'COLLECTION' && settle.settle_type === '代收代付结算'))) {\r\n\r\n          if (nOptions.nameList.indexOf(settle.billing_name) < 0) {\r\n            nOptions.nameList.push(settle.billing_name);\r\n          }\r\n          if (nOptions.serials.indexOf(settle.serial_number) < 0) {\r\n            nOptions.serials.push(settle.serial_number);\r\n          }\r\n          if (nOptions.destList.indexOf(settle.ship_to) < 0) {\r\n            nOptions.destList.push(settle.ship_to);\r\n          }\r\n        }\r\n      })\r\n    }\r\n\r\n    nOptions.serials.sort();\r\n    nOptions.destList = sort_pinyin(nOptions.destList);\r\n    nOptions.nameList = sort_pinyin(nOptions.nameList);\r\n    return nOptions;\r\n  }\r\n\r\n  function filterData(reset) {\r\n    visible_settles = qFilter.updateOptions(dbSettles, reset);\r\n    resetTableRow();\r\n  }\r\n});\r\n\r\n////////////////////////////////////////////////////////////////////////\r\nfunction QueryFilterD(options, filter) {\r\n  this.currSelected = 0;\r\n  var self = this;\r\n\r\n  this.uiElems = {\r\n    sBfBillName : $('#bf-bill-name'),\r\n    sBfSerialNumber: $('#bf-serial-number'),\r\n    sBfDest : $('#bf-destination'),\r\n    startDateGrp : $('#start-date-grp'),\r\n    endDateGrp : $('#end-date-grp'),\r\n    iStartDate : $('#start-date'),\r\n    iEndDate : $('#end-date')\r\n  };\r\n\r\n  this.options = options;\r\n  this.sDate = null;\r\n  this.eDate = null;\r\n\r\n  initSelect(this.uiElems.sBfBillName, options.nameList, true);\r\n  initSelect(this.uiElems.sBfSerialNumber, options.serials, true);\r\n  initSelect(this.uiElems.sBfDest, options.destList, true);\r\n\r\n  this.uiElems.iStartDate.val(\"\");\r\n  this.uiElems.iEndDate.val(\"\");\r\n\r\n  this._selectFliterFunc = function(which, filter) {\r\n    this.currSelected = which;\r\n    if (this.isAllEmpty()) {\r\n      filter(true);       // return to initial state\r\n    }\r\n    else {\r\n      filter(false);\r\n    }\r\n  };\r\n\r\n  this._dateFilterFunc = function(isStart, isEnd, filter) {\r\n    var d1 = this.uiElems.iStartDate.val();\r\n    var d2 = this.uiElems.iEndDate.val();\r\n    var b = false;\r\n    if (isStart && isEnd) {\r\n      b = !isEmpty(d1) && !isEmpty(d2);\r\n    } else if (isStart) {\r\n      b = isEmpty(this.uiElems.iStartDate.val());\r\n    } else if (isEnd) {\r\n      b = isEmpty(this.uiElems.iEndDate.val());\r\n    }\r\n\r\n    if (b) {\r\n      this.currSelected = 5;\r\n      filter(false);\r\n    }\r\n  };\r\n\r\n  self.uiElems.sBfBillName.on('change', function() { self._selectFliterFunc(1, filter); });\r\n  self.uiElems.sBfSerialNumber.on('change', function() { self._selectFliterFunc(2, filter); });\r\n  self.uiElems.sBfDest.on('change', function() { self._selectFliterFunc(4, filter); });\r\n\r\n  self.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.sDate = e.date.startOf('day');\r\n    self.uiElems.endDateGrp.data(\"DateTimePicker\").setMinDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.eDate = e.date.endOf('day');\r\n    self.uiElems.startDateGrp.data(\"DateTimePicker\").setMaxDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.iStartDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(true, false, filter);\r\n  });\r\n  self.uiElems.iEndDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(false, true, filter);\r\n  });\r\n}\r\n\r\nQueryFilterD.prototype.isAllEmpty = function() {\r\n  var serial = getSelectValue(this.uiElems.sBfSerialNumber);\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var d1 = this.uiElems.iStartDate.val();\r\n  var d2 = this.uiElems.iEndDate.val();\r\n  return isEmpty(serial) && isEmpty(dest) && isEmpty(name) && isEmpty(d1) && isEmpty(d2);\r\n};\r\n\r\nQueryFilterD.prototype.updateOptions = function(settles, reset) {\r\n  var serial = getSelectValue(this.uiElems.sBfSerialNumber);\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n\r\n  var nOptions = { serials: [], destList: [], nameList: [] };\r\n  var visible = [];\r\n  if (reset) {\r\n    initSelect(this.uiElems.sBfBillName, this.options.nameList, true);\r\n    initSelect(this.uiElems.sBfSerialNumber, this.options.serials, true);\r\n    initSelect(this.uiElems.sBfDest, this.options.destList, true);\r\n    visible = settles;\r\n  } else {\r\n    var d1 = this.uiElems.iStartDate.val();\r\n    var d2 = this.uiElems.iEndDate.val();\r\n    var dateNotEmpty = !isEmpty(d1) && !isEmpty(d2);\r\n\r\n    settles.forEach(function (settle) {\r\n      var b1 = !serial || serial === settle.serial_number;\r\n      var b3 = !dest || dest === settle.ship_to;\r\n      var b4 = !name || name === settle.billing_name;\r\n      var sd = moment(settle.settle_date);\r\n      if (b1 && b3 && b4 && (!dateNotEmpty || (sd.isAfter(d1, 'minute') && sd.isBefore(d2, 'minute')))) {\r\n        if (nOptions.serials.indexOf(settle.serial_number) < 0) {\r\n          nOptions.serials.push(settle.serial_number);\r\n        }\r\n        if (nOptions.destList.indexOf(settle.ship_to) < 0) {\r\n          nOptions.destList.push(settle.ship_to);\r\n        }\r\n        visible.push(settle);\r\n      }\r\n    });\r\n\r\n    nOptions.serials.sort();\r\n    nOptions.destList = sort_pinyin(nOptions.destList);\r\n    nOptions.nameList = sort_pinyin(nOptions.nameList);\r\n\r\n    if (this.currSelected === 2) {\r\n      initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n    }\r\n    else if (this.currSelected === 3) {\r\n      initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n      initSelect(this.uiElems.sBfSerialNumber, nOptions.serials, true, serial);\r\n    }\r\n    else if (this.currSelected === 4) {\r\n      initSelect(this.uiElems.sBfSerialNumber, nOptions.serials, true, serial);\r\n    }\r\n    else {\r\n      initSelect(this.uiElems.sBfSerialNumber, nOptions.serials, true, serial);\r\n      initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n    }\r\n  }\r\n\r\n  return visible;\r\n};\r\n\r\nQueryFilterD.prototype.reset = function(options) {\r\n  this.options = options;\r\n  initSelect(this.uiElems.sBfBillName, this.options.nameList, true);\r\n  initSelect(this.uiElems.sBfSerialNumber, this.options.serials, true);\r\n  initSelect(this.uiElems.sBfDest, this.options.destList, true);\r\n};\r\n"]}