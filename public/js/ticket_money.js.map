{"version":3,"sources":["ticket_money.js"],"names":["QueryFilterD","options","filter","this","currSelected","self","uiElems","sBfBillName","$","sBfSerialNumber","sBfDest","startDateGrp","endDateGrp","iStartDate","iEndDate","eDate","moment","sDate","subtract","initSelect","nameList","serials","destList","startGrp","datetimepicker","getDateTimePickerOptions","endGrp","data","setDate","_selectFliterFunc","which","isAllEmpty","_dateFilterFunc","isStart","isEnd","d1","val","d2","b","isEmpty","on","e","preventDefault","stopImmediatePropagation","date","startOf","setMinDate","endOf","setMaxDate","tableBody","dbSettles","local_dbData","dbBills","curr_settles","selected_settles","visible_settles","action","btnCustomer","btnCollection","btnSettleDelete","btnTicketOk","btnTicketCancel","btnMoneyOk","btnMoneyCancel","btnFilter","btnExport","btnShowDetail","btnRealPrice","radioFlag","length","qFilter","getOptions","reset","updateOptions","resetTableRow","html","checkSelectAll","buildToggleButton","new_action","me","removeClass","addClass","resetFilterAndUI","flag","updateUI","selectedSettles","len","find","tr","getRowChildren","sn","getTableCellChildren","text","k","serial_number","remove","prop","enableButtons","setHtmlElementDisabled","numOfTicket","numOfMoney","i","status","buildTicketNoInputDialog","settle","msg","format","bootbox","dialog","message","title","buttons","cancel","label","className","main","callback","id","ticket_no","ticket_date","Date","ticket_person","local_user","userid","ajaxRequestHandle","empty","html_text","tn","tw","tp","forEach","settle_type","push","row","status_str","getStrByStatus","str","s","isExist","real_price","price","getStrValue","billing_name","ship_number","ship_weight","settle_date","settler","makeTableBodyTr","append","join","selectRow","closest","popover","trigger","placement","idx","index","selected","alert","confirm","result","allSelected","needUpdateCheckbox","found","makeBillTableBodyTr","bill","settle_bill","statusStr","statusText","settle_flag","customerPrice","vehPrice","vessel","priceText","priceInfoObj","getInvoicePriceInfo","tip","totalCustomerPrice","totalVehPrice","order","bill_no","collection_price","total_weight","thickness","width","size_type","brand_no","sales_dep","ship_warehouse","contract_no","shipTo","invoices","inv","inv_no","veh_ves_name","ship_to","guige","getOrder","order_no","order_item_no","num","weight","date2Str","shipping_date","dbData","settles","nOptions","indexOf","sort","sort_pinyin","elementEventRegister","is","curr","allSettles","return_money_date","return_person","css","cursor","get","fSerial","jQuery","parseJSON","ok","bills","allBills","settle_bills","abill","String","bill_id","_id","tbody","modal","backdrop","keyboard","p","sno","tableToExcel","toggle","prototype","serial","getSelectValue","dest","name","visible","dateNotEmpty","b1","b3","b4","sd","isAfter","isBefore"],"mappings":"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","file":"ticket_money.js","sourcesContent":["/**\r\n * Created by ezefjia on 11/19/2014.\r\n */\r\n\r\n$(function () {\r\n  \"use strict\";\r\n\r\n  var tableBody       = $('#table-tbody');\r\n\r\n  // initialize\r\n  var dbSettles = local_dbData;\r\n  var dbBills = [];\r\n  var curr_settles = [];\r\n  var selected_settles = [];\r\n  var visible_settles = dbSettles;\r\n  var action = \"CUSTOMER\";\r\n  var CUSTOMER_SETTLE_FLAG   = 1; // 0001\r\n  var COLLECTION_SETTLE_FLAG = 2; // 0010\r\n\r\n  var btnCustomer     = $('#customer-btn');\r\n  var btnCollection   = $('#collection-btn');\r\n  var btnSettleDelete = $('#settle-delete');\r\n  var btnTicketOk     = $('#settle-ticket');\r\n  var btnTicketCancel = $('#settle-ticket-cancel');\r\n  var btnMoneyOk      = $('#settle-money');\r\n  var btnMoneyCancel  = $('#settle-money-cancel');\r\n  var btnFilter       = $('#filter');\r\n  var btnExport       = $('#search-export');\r\n  var btnShowDetail   = $('#show-detail');\r\n  var btnRealPrice    = $('#real-price-input');\r\n\r\n  var radioFlag = 0; // 0: settle, 1: ticket, 2: money\r\n  if (btnMoneyOk.length) {\r\n    radioFlag = 1;\r\n  }\r\n\r\n  var qFilter = new QueryFilterD(getOptions(local_dbData), filterData);\r\n\r\n  $('#first-th').html('<input id=\"select-all\" type=\"checkbox\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"选择所有记录\" />');\r\n  var checkSelectAll = $('#select-all');\r\n\r\n  resetTableRow();\r\n\r\n  elementEventRegister(checkSelectAll, 'click', function() {\r\n    if ($(this).is(\":checked\")) {\r\n      $('.select-item').prop(\"checked\", true);\r\n      selected_settles = curr_settles;\r\n      tableBody.find(\"tr\").addClass('invoice-highlighted');\r\n    } else {\r\n      $('.select-item').prop(\"checked\", false);\r\n      selected_settles = [];\r\n      tableBody.find(\"tr\").removeClass('invoice-highlighted');\r\n    }\r\n    enableButtons();\r\n  });\r\n\r\n  elementEventRegister(btnCustomer, 'click', function() {\r\n    buildToggleButton(\"CUSTOMER\", $(this));\r\n  });\r\n\r\n  elementEventRegister(btnCollection, 'click', function() {\r\n    buildToggleButton(\"COLLECTION\", $(this));\r\n  });\r\n\r\n  function buildToggleButton(new_action, me) {\r\n    if (action != new_action) {\r\n      if (action === \"CUSTOMER\") {\r\n        btnCustomer.removeClass(\"btn-primary\");\r\n        btnCustomer.addClass(\"btn-default\");\r\n      } else if (action === \"COLLECTION\") {\r\n        btnCollection.removeClass(\"btn-primary\");\r\n        btnCollection.addClass(\"btn-default\");\r\n      }\r\n      me.removeClass(\"btn-default\");\r\n      me.addClass(\"btn-primary\");\r\n      action = new_action;\r\n      qFilter.reset(getOptions(local_dbData));\r\n\r\n      resetTableRow();\r\n    }\r\n  }\r\n\r\n  elementEventRegister(btnTicketOk, 'click', buildTicketNoInputDialog);\r\n\r\n  elementEventRegister(btnTicketCancel, 'click', function() {\r\n    bootbox.confirm(\"您是否真的要取消所选择的已开票数据?\", function(result) {\r\n      if (result) {\r\n        var settles = [];\r\n        selected_settles.forEach(function(settle) {\r\n          if (settle.status === '已开票') {\r\n            settle.status = '已结算';\r\n            settle.ticket_no = \"\";\r\n            settle.ticket_date = null;\r\n            settle.ticket_person = \"\";\r\n            settles.push(settle);\r\n          }\r\n        });\r\n\r\n        ajaxRequestHandle('/settle_ticket', 'POST', settles, '开票取消', function () {\r\n          updateUI(settles);\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  elementEventRegister(btnSettleDelete, 'click', function() {\r\n    for (var i = 0; i < selected_settles.length; ++i) {\r\n      if (selected_settles[i].status != '已结算') {\r\n        bootbox.alert(\"选择的结算纪录中存在状态[\" + selected_settles[i].status + \"], 不能删除!\");\r\n        return;\r\n      }\r\n    }\r\n\r\n    bootbox.confirm(\"您是否真的要删除选择的结算数据?\", function(result) {\r\n      if (result) {\r\n        ajaxRequestHandle('/delete_settle', 'POST', {allSelected: selected_settles, which: action }, 'no_message', function() {\r\n          var len = dbSettles.length;\r\n          while (len--) {\r\n            var curr = dbSettles[len];\r\n            for (var k = 0; k < selected_settles.length; ++k) {\r\n              if (selected_settles[k].serial_number === curr.serial_number) {\r\n                dbSettles.remove(len);\r\n                selected_settles.remove(k);\r\n                break;\r\n              }\r\n            }\r\n          }\r\n\r\n          resetTableRow();\r\n          bootbox.alert(\"删除成功!\");\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  elementEventRegister(btnMoneyOk, 'click', function() {\r\n    var allSettles = [];\r\n    selected_settles.forEach(function(data) {\r\n      if (data.settle_type != \"车船结算\") {\r\n        data.status = '已回款';\r\n        data.return_money_date = new Date();\r\n        data.return_person = local_user.userid;\r\n        allSettles.push(data);\r\n      }\r\n    });\r\n\r\n    ajaxRequestHandle('/settle_money', 'POST', allSettles, '回款', function () {\r\n      updateUI(allSettles);\r\n    });\r\n  });\r\n\r\n  elementEventRegister(btnMoneyCancel, 'click', function() {\r\n    bootbox.confirm(\"取消回款: 您是否真的要取消所选择的已回款数据?\", function(result) {\r\n      if (result) {\r\n        var settles = [];\r\n        selected_settles.forEach(function(settle) {\r\n          if (settle.status === '已回款') {\r\n            settle.status = '已开票';\r\n            settle.return_person = \"\";\r\n            settle.return_money_date = null;\r\n            settles.push(settle);\r\n          }\r\n        });\r\n\r\n        ajaxRequestHandle('/settle_ticket', 'POST', settles, '回款取消', function () {\r\n          updateUI(settles);\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  elementEventRegister(btnShowDetail, 'click', function() {\r\n    var settle = selected_settles[0];\r\n    $('body').css({'cursor':'wait'});\r\n    $.get('/get_settle_bill', { fSerial: settle.serial_number }, function (data) {\r\n      var result = jQuery.parseJSON(data);\r\n      if (result.ok) {\r\n        dbBills = result.bills;\r\n        var html = '';\r\n        var allBills = result.settle_bills;//settle.bills;\r\n        dbBills.forEach(function(bill) {\r\n          allBills.forEach(function(abill) {\r\n            if (String(abill.bill_id) === String(bill._id)) {\r\n              html += makeBillTableBodyTr(bill, settle.settle_type, abill);\r\n            }\r\n          })\r\n        });\r\n\r\n        var tbody = $('#settle-bill-tbody');\r\n        tbody.empty();\r\n        tbody.append(html);\r\n        $('[data-toggle=\"popover\"]').popover({ trigger: \"hover\", html: true, placement: \"bottom\" });\r\n        $('#settle-detail-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n      } else {\r\n        dbBills = [];\r\n      }\r\n      $('body').css({'cursor':'default'});\r\n    });\r\n  });\r\n\r\n  elementEventRegister($('#settle-radio'), 'ifChecked', function() { resetFilterAndUI(0); });\r\n  elementEventRegister($('#ticket-radio'), 'ifChecked', function() { resetFilterAndUI(1); });\r\n  elementEventRegister($('#money-radio'), 'ifChecked', function() { resetFilterAndUI(2); });\r\n\r\n  elementEventRegister(btnRealPrice, 'click', buildRealPriceInputDialog);\r\n\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  /// function list\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  function resetFilterAndUI(flag) {\r\n    radioFlag = flag;\r\n    qFilter.reset(getOptions(local_dbData));\r\n    resetTableRow();\r\n  }\r\n\r\n  function updateUI(selectedSettles) {\r\n    var len = tableBody.find(\"tr\").length;\r\n    while (len--) {\r\n      var tr = getRowChildren(tableBody, len);\r\n      var sn = getTableCellChildren(tr, 2).text();\r\n      for (var k = 0; k < selectedSettles.length; ++k) {\r\n        if (selectedSettles[k].serial_number === sn) {\r\n          tr.remove();\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    checkSelectAll.prop(\"checked\", selectedSettles.length === tableBody.find(\"tr\").length);\r\n    enableButtons();\r\n  }\r\n\r\n  function enableButtons() {\r\n    if (curr_settles.length) {\r\n      setHtmlElementDisabled(btnExport, false);\r\n      setHtmlElementDisabled(btnFilter, false);\r\n    } else {\r\n      setHtmlElementDisabled(btnExport, true);\r\n      setHtmlElementDisabled(btnFilter, true);\r\n    }\r\n\r\n    if (selected_settles.length) {\r\n      setHtmlElementDisabled(btnShowDetail, selected_settles.length != 1);\r\n      setHtmlElementDisabled(btnRealPrice, selected_settles.length != 1);\r\n\r\n      if (btnMoneyOk.length) {\r\n        var numOfTicket = 0;\r\n        var numOfMoney = 0;\r\n        for (var i = 0; i < selected_settles.length; ++i) {\r\n          if (selected_settles[i].status === '已开票') {\r\n            ++numOfTicket;\r\n          } else if (selected_settles[i].status === '已回款') {\r\n            ++numOfMoney;\r\n          }\r\n        }\r\n        setHtmlElementDisabled(btnMoneyOk, numOfTicket === 0);\r\n        setHtmlElementDisabled(btnMoneyCancel, numOfMoney === 0 );\r\n      } else {\r\n        setHtmlElementDisabled(btnSettleDelete, false);\r\n        for (var k = 0; k < selected_settles.length; ++k) {\r\n          if (selected_settles[k].status === '已开票') {\r\n            setHtmlElementDisabled(btnTicketCancel, false);\r\n            break;\r\n          }\r\n        }\r\n\r\n        if (selected_settles.length === 1) {\r\n          setHtmlElementDisabled(btnTicketOk, false);\r\n        }\r\n      }\r\n    } else {\r\n      setHtmlElementDisabled(btnShowDetail, true);\r\n      if (btnMoneyOk.length) {\r\n        setHtmlElementDisabled(btnMoneyOk, true);\r\n        setHtmlElementDisabled(btnMoneyCancel, true);\r\n        setHtmlElementDisabled(btnRealPrice, true);\r\n      } else {\r\n        setHtmlElementDisabled(btnTicketOk, true);\r\n        setHtmlElementDisabled(btnTicketCancel, true);\r\n        setHtmlElementDisabled(btnSettleDelete, true);\r\n      }\r\n    }\r\n  }\r\n\r\n  function buildTicketNoInputDialog() {\r\n    var settle = selected_settles[0];\r\n    var msg = '<div class=\"row form-horizontal\"><div class=\"col-md-10\">';\r\n    var str = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">开票号</label><div class=\"input-group col-sm-8\"><input id=\"{1}\" type=\"text\" name=\"{2}\" class=\"form-control\"></div></div>';\r\n    msg += str.format(settle.serial_number, settle.serial_number, settle.serial_number) + '</div></div>';\r\n\r\n    bootbox.dialog({\r\n      message: msg,\r\n      title: \"开票:请输入票号\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\" },\r\n        main: { label: \"确定\", className: \"btn-primary\",\r\n          callback: function () {\r\n            var id = '#' + settle.serial_number;\r\n            settle.ticket_no = $(id).val();\r\n            settle.ticket_date = new Date();\r\n            settle.ticket_person = local_user.userid;\r\n            settle.status = '已开票';\r\n            ajaxRequestHandle('/settle_ticket', 'POST', [ settle ], '开票', function () {\r\n              updateUI([settle]);\r\n            });\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  function buildRealPriceInputDialog() {\r\n    var settle = selected_settles[0];\r\n    var msg = '<div class=\"row form-horizontal\"><div class=\"col-md-10\">';\r\n    var str = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">实收价格</label><div class=\"input-group col-sm-8\"><input id=\"{1}\" type=\"text\" name=\"{2}\" class=\"form-control\"></div></div>';\r\n    msg += str.format(settle.serial_number, settle.serial_number, settle.serial_number) + '</div></div>';\r\n\r\n    bootbox.dialog({\r\n      message: msg,\r\n      title: \"请输入实收价格\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\" },\r\n        main: { label: \"确定\", className: \"btn-primary\",\r\n          callback: function () {\r\n            var id = '#' + settle.serial_number;\r\n            var p = $(id).val();\r\n            if (p > 0) {\r\n              settle.real_price = p;\r\n              ajaxRequestHandle('/settle_real_price', 'POST', { sno: settle.serial_number, price: p}, '实收价格', function () {\r\n                var len = tableBody.find(\"tr\").length;\r\n                for (var i = 0; i < len; ++i) {\r\n                  var tr = getRowChildren(tableBody, i);\r\n                  var sn = getTableCellChildren(tr, 2).text();\r\n                  if (sn === settle.serial_number) {\r\n                    var s = '';\r\n                    if (p != settle.price) {\r\n                      s = '<code style=\"color:red;font-weight:bold\">' + getStrValue(p) + '</code>';\r\n                    } else {\r\n                      s = '<code style=\"color:green\">' + getStrValue(settle.price) + '</code>';\r\n                    }\r\n                    getTableCellChildren(tr, 6).html(s);\r\n                    break;\r\n                  }\r\n                }\r\n              });\r\n            } else {\r\n              bootbox.alert(\"无效的价格\");\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  function resetTableRow() {\r\n    tableBody.empty();\r\n    curr_settles = [];\r\n    selected_settles = [];\r\n    var html_text = [];\r\n    var tn = 0, tw = 0, tp = 0;\r\n    visible_settles.forEach(function (settle) {\r\n      if (\r\n        ((radioFlag === 0 && settle.status === \"已结算\") ||\r\n          (radioFlag === 1 && settle.status === \"已开票\") ||\r\n          (radioFlag === 2 && settle.status === \"已回款\")) ) {\r\n\r\n        if (//btnMoneyOk.length ||\r\n          (action === \"CUSTOMER\" && settle.settle_type === \"客户结算\") ||\r\n          (action === \"COLLECTION\" && settle.settle_type === \"代收代付结算\")) {\r\n          html_text.push(makeTableBodyTr(settle));\r\n          curr_settles.push(settle);\r\n          tn += settle.ship_number;\r\n          tw += settle.ship_weight;\r\n          tp += settle.price;\r\n        }\r\n      }\r\n    });\r\n\r\n    tableBody.append(html_text.join('\\n'));\r\n\r\n    checkSelectAll.prop(\"checked\", false);\r\n    enableButtons();\r\n\r\n    tableBody.find('tr').on('click', function () {\r\n      selectRow($(this), true);\r\n    }).on('dblclick', function () {\r\n      buildTicketNoInputDialog();\r\n    });\r\n\r\n    $('.select-item').on('click', function(e) {\r\n      e.stopImmediatePropagation();\r\n      selectRow($(this).closest('tr'), false);\r\n    });\r\n\r\n    $('[data-toggle=\"popover\"]').popover({ trigger: \"hover\", html: true, placement: \"bottom\" });\r\n\r\n    $('.td-icon').on('click', function(e) { // delete button click\r\n      e.stopImmediatePropagation();\r\n      e.preventDefault();\r\n      var tr = $(this).closest('tr');\r\n      var idx = tr.index();\r\n      var selected = curr_settles[idx];\r\n      if (selected.status != '已结算') {\r\n        bootbox.alert(\"当前选择的结算纪录状态为\" + selected.status + \", 不能删除!\");\r\n      } else {\r\n        bootbox.confirm(\"您是否真的要删除此结算数据?\", function (result) {\r\n          if (result) {\r\n            ajaxRequestHandle('/delete_settle', 'POST', {allSelected: [ selected ], which: action }, 'no_message', function () {\r\n              for (var i = 0; i < selected_settles.length; ++i) {\r\n                if (selected_settles[i].serial_number === selected.serial_number) {\r\n                  selected_settles.remove(i);\r\n                  break;\r\n                }\r\n              }\r\n              for (i = 0; i < dbSettles.length; ++i) {\r\n                if (dbSettles[i].serial_number === selected.serial_number) {\r\n                  dbSettles.remove(i);\r\n                  break;\r\n                }\r\n              }\r\n\r\n              curr_settles.remove(idx);\r\n              tr.remove();\r\n\r\n              $('#curr-settle-num').text(curr_settles.length);\r\n              enableButtons();\r\n              bootbox.alert(\"删除成功!\");\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    $('#curr-settle-num').text(curr_settles.length);\r\n    $('#lb-total-num').text(tn);\r\n    $('#lb-total-weight').text(getStrValue(tw));\r\n    $('#lb-total-amount').text(getStrValue(tp));\r\n  }\r\n\r\n  function selectRow(me, needUpdateCheckbox) {\r\n    var b = curr_settles[me.index()];\r\n    var found = false;\r\n    for (var i = 0; i < selected_settles.length; ++i) {\r\n      if (selected_settles[i].serial_number === b.serial_number) {\r\n        selected_settles.remove(i);\r\n        found = true;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (found) {\r\n      me.removeClass('invoice-highlighted');\r\n    } else {\r\n      selected_settles.push(b);\r\n      me.addClass('invoice-highlighted');\r\n    }\r\n\r\n    if (needUpdateCheckbox) {\r\n      me.find('input[type=\"checkbox\"]').prop(\"checked\", !found);\r\n    }\r\n\r\n    checkSelectAll.prop(\"checked\", selected_settles.length === curr_settles.length);\r\n    enableButtons();\r\n  }\r\n\r\n  function makeTableBodyTr(row) {\r\n    var status_str = getStrByStatus(row.status, row.status);\r\n    var str = '<tr data-toggle=\"popover\" title=\"\" data-content=\"\"><td align=\"center\"><input type=\"checkbox\" class=\"select-item\" /></td>';\r\n\r\n    var s = '';\r\n    if (isExist(row.real_price) && row.real_price != 0 && row.real_price != row.price) {\r\n      s = '<code style=\"color:red;font-weight:bold\">' + getStrValue(row.real_price) + '</code>';\r\n    } else {\r\n      s = '<code style=\"color:green\">' + getStrValue(row.price) + '</code>';\r\n    }\r\n\r\n    str += '<td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td align=\"center\" style=\"cursor:pointer\" class=\"td-icon\"><i title=\"删除\" class=\"fa fa-trash-o redlink\"></i></td></tr>';\r\n    return str.format(status_str, row.serial_number, row.settle_type, row.billing_name,\r\n      getStrValue(row.price), s, row.ship_number, getStrValue(row.ship_weight),\r\n      isEmpty(row.settle_date) ? '' : moment(row.settle_date).format(\"YYYY-MM-DD\"),\r\n      row.settler ? row.settler : '',\r\n      isEmpty(row.ticket_date) ? '' : moment(row.ticket_date).format(\"YYYY-MM-DD\"),\r\n      row.ticket_no ? row.ticket_no : ''\r\n    );\r\n  }\r\n\r\n  function makeBillTableBodyTr(bill, settle_type, settle_bill) {\r\n    var statusStr = \"\";\r\n    if (bill.status === '已结算') {\r\n      var statusText = [];\r\n      if ((bill.settle_flag & CUSTOMER_SETTLE_FLAG) === CUSTOMER_SETTLE_FLAG) {\r\n        statusText.push(\"客户\");\r\n      }\r\n      if ((bill.settle_flag & COLLECTION_SETTLE_FLAG) === COLLECTION_SETTLE_FLAG) {\r\n        statusText.push(\"代收付\");\r\n      }\r\n      statusStr = getStrByStatus(statusText.join(',') + '已结算', bill.status);\r\n    } else {\r\n      statusStr = getStrByStatus(bill.status, bill.status);\r\n    }\r\n    var priceInfoObj = getInvoicePriceInfo(bill);\r\n    var tip = getBillTooltip(bill, priceInfoObj.totalCustomerPrice, priceInfoObj.totalVehPrice);\r\n    var vessel, priceText;\r\n    var shipTo = '';\r\n    for (var i = 0; i < bill.invoices.length; ++i) {\r\n      var inv = bill.invoices[i];\r\n      if (inv.inv_no === settle_bill.inv_no) {\r\n        if (settle_type === \"客户结算\") {\r\n          vessel = inv.veh_ves_name;\r\n          priceText = getStrValue(inv.price);\r\n        } else if (settle_type === \"代收代付结算\") {\r\n          vessel = \"\";\r\n          priceText = getStrValue(bill.collection_price);\r\n        }\r\n        shipTo = inv.ship_to;\r\n        break;\r\n      }\r\n    }\r\n\r\n    var guige = getStrValue(bill.thickness) + '*' + getStrValue(bill.width) + '*' + bill.len;\r\n\r\n    var trHtml = '<tr {0}><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td></tr>';\r\n    return trHtml.format(tip, statusStr, getOrder(bill.order_no, bill.order_item_no), bill.bill_no, guige,\r\n      bill.billing_name, vessel, shipTo, priceText, settle_bill.num, getStrValue(settle_bill.weight),\r\n      getStrValue(priceText * settle_bill.weight), date2Str(bill.shipping_date));\r\n  }\r\n\r\n  function getBillTooltip(bill, customerPrice, vehPrice) {\r\n    var t = bill.order + ' ' + bill.bill_no;\r\n    var tip = 'data-toggle=\"popover\" title=\"' + t + '\" data-content=\"客户价格: {0}<br />车船价格: {1}<br />代收代付价格: {2}<br />' +\r\n      '厚度: {3}<br />宽度: {4}<br />长度: {5}<br />尺寸: {6}<br />牌号: {7}<br />销售部门: {8}<br />发货仓库: {9}<br />合同号: {10}<br />\"';\r\n    return tip.format(getStrValue(customerPrice), getStrValue(vehPrice), getStrValue(bill.collection_price * bill.total_weight),\r\n      getStrValue(bill.thickness), getStrValue(bill.width),\r\n      getStrValue(bill.len), bill.size_type ? bill.size_type : '', bill.brand_no ? bill.brand_no : '',\r\n      bill.sales_dep ? bill.sales_dep : '', bill.ship_warehouse ? bill.ship_warehouse : '',\r\n      bill.contract_no ? bill.contract_no : '');\r\n  }\r\n\r\n  /////////////////////////////////////////////////////////////////////////////\r\n  // Export & Filter function\r\n  elementEventRegister(btnExport, 'click', function() {\r\n    if (selected_settles.length > 0) {\r\n      var settle = selected_settles[0];\r\n      $.get('/get_settle_bill', { fSerial: settle.serial_number }, function (data) {\r\n        var result = jQuery.parseJSON(data);\r\n        if (result.ok) {\r\n          dbBills = result.bills;\r\n          var html = '';\r\n          var allBills = result.settle_bills;//settle.bills;\r\n          dbBills.forEach(function (bill) {\r\n            allBills.forEach(function (abill) {\r\n              if (String(abill.bill_id) === String(bill._id)) {\r\n                html += makeBillTableBodyTr(bill, settle.settle_type, abill);\r\n              }\r\n            })\r\n          });\r\n\r\n          var tbody = $('#settle-bill-tbody');\r\n          tbody.empty();\r\n          tbody.append(html);\r\n          tableToExcel($('#table-content').html(), \"data\");\r\n        }\r\n      })\r\n    } else {\r\n      bootbox.alert('请选择要导出的结算记录');\r\n    }\r\n  });\r\n\r\n  elementEventRegister(btnFilter, 'click', function() { $('#filter-ui').toggle() });\r\n\r\n  function getOptions(dbData) {\r\n    var settles = dbData;\r\n    var nOptions = { serials: [], destList: [], nameList: [] };\r\n\r\n    if (btnMoneyOk.length) {\r\n      settles.forEach(function(settle) {\r\n        if ((radioFlag === 1 && settle.status === \"已开票\") || (radioFlag === 2 && settle.status === \"已回款\")) {\r\n          if (nOptions.nameList.indexOf(settle.billing_name) < 0) {\r\n            nOptions.nameList.push(settle.billing_name);\r\n          }\r\n          if (nOptions.serials.indexOf(settle.serial_number) < 0) {\r\n            nOptions.serials.push(settle.serial_number);\r\n          }\r\n          if (nOptions.destList.indexOf(settle.ship_to) < 0) {\r\n            nOptions.destList.push(settle.ship_to);\r\n          }\r\n        }\r\n      })\r\n    } else {\r\n      settles.forEach(function(settle) {\r\n        if (((radioFlag === 1 && settle.status === \"已开票\") ||\r\n             (radioFlag === 0 && settle.status === \"已结算\")) &&\r\n            ((action === 'CUSTOMER' && settle.settle_type === '客户结算') ||\r\n             (action === 'COLLECTION' && settle.settle_type === '代收代付结算'))) {\r\n\r\n          if (nOptions.nameList.indexOf(settle.billing_name) < 0) {\r\n            nOptions.nameList.push(settle.billing_name);\r\n          }\r\n          if (nOptions.serials.indexOf(settle.serial_number) < 0) {\r\n            nOptions.serials.push(settle.serial_number);\r\n          }\r\n          if (nOptions.destList.indexOf(settle.ship_to) < 0) {\r\n            nOptions.destList.push(settle.ship_to);\r\n          }\r\n        }\r\n      })\r\n    }\r\n\r\n    nOptions.serials.sort();\r\n    nOptions.destList = sort_pinyin(nOptions.destList);\r\n    nOptions.nameList = sort_pinyin(nOptions.nameList);\r\n    return nOptions;\r\n  }\r\n\r\n  function filterData(reset) {\r\n    visible_settles = qFilter.updateOptions(dbSettles, reset);\r\n    resetTableRow();\r\n  }\r\n});\r\n\r\n////////////////////////////////////////////////////////////////////////\r\nfunction QueryFilterD(options, filter) {\r\n  this.currSelected = 0;\r\n  var self = this;\r\n\r\n  this.uiElems = {\r\n    sBfBillName : $('#bf-bill-name'),\r\n    sBfSerialNumber: $('#bf-serial-number'),\r\n    sBfDest : $('#bf-destination'),\r\n    startDateGrp : $('#start-date-grp'),\r\n    endDateGrp : $('#end-date-grp'),\r\n    iStartDate : $('#start-date'),\r\n    iEndDate : $('#end-date')\r\n  };\r\n\r\n  this.options = options;\r\n  this.eDate = moment();\r\n  this.sDate = moment().subtract(3, 'months');\r\n\r\n  initSelect(this.uiElems.sBfBillName, options.nameList, true);\r\n  initSelect(this.uiElems.sBfSerialNumber, options.serials, true);\r\n  initSelect(this.uiElems.sBfDest, options.destList, true);\r\n\r\n  //this.uiElems.iStartDate.val(\"\");\r\n  //this.uiElems.iEndDate.val(\"\");\r\n  var startGrp = self.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions());\r\n  var endGrp = self.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions());\r\n  this.uiElems.endDateGrp.data(\"DateTimePicker\").setDate(this.eDate);\r\n  this.uiElems.startDateGrp.data(\"DateTimePicker\").setDate(this.sDate);\r\n\r\n  this._selectFliterFunc = function(which, filter) {\r\n    this.currSelected = which;\r\n    if (this.isAllEmpty()) {\r\n      filter(true);       // return to initial state\r\n    }\r\n    else {\r\n      filter(false);\r\n    }\r\n  };\r\n\r\n  this._dateFilterFunc = function(isStart, isEnd, filter) {\r\n    var d1 = this.uiElems.iStartDate.val();\r\n    var d2 = this.uiElems.iEndDate.val();\r\n    var b = false;\r\n    if (isStart && isEnd) {\r\n      b = !isEmpty(d1) && !isEmpty(d2);\r\n    } else if (isStart) {\r\n      b = isEmpty(this.uiElems.iStartDate.val());\r\n    } else if (isEnd) {\r\n      b = isEmpty(this.uiElems.iEndDate.val());\r\n    }\r\n\r\n    if (b) {\r\n      this.currSelected = 5;\r\n      filter(false);\r\n    }\r\n  };\r\n\r\n  self.uiElems.sBfBillName.on('change', function() { self._selectFliterFunc(1, filter); });\r\n  self.uiElems.sBfSerialNumber.on('change', function() { self._selectFliterFunc(2, filter); });\r\n  self.uiElems.sBfDest.on('change', function() { self._selectFliterFunc(4, filter); });\r\n\r\n  startGrp.on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.sDate = e.date.startOf('day');\r\n    self.uiElems.endDateGrp.data(\"DateTimePicker\").setMinDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  endGrp.on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.eDate = e.date.endOf('day');\r\n    self.uiElems.startDateGrp.data(\"DateTimePicker\").setMaxDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.iStartDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(true, false, filter);\r\n  });\r\n  self.uiElems.iEndDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(false, true, filter);\r\n  });\r\n}\r\n\r\nQueryFilterD.prototype.isAllEmpty = function() {\r\n  var serial = getSelectValue(this.uiElems.sBfSerialNumber);\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var d1 = this.uiElems.iStartDate.val();\r\n  var d2 = this.uiElems.iEndDate.val();\r\n  return isEmpty(serial) && isEmpty(dest) && isEmpty(name) && isEmpty(d1) && isEmpty(d2);\r\n};\r\n\r\nQueryFilterD.prototype.updateOptions = function(settles, reset) {\r\n  var serial = getSelectValue(this.uiElems.sBfSerialNumber);\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n\r\n  var nOptions = { serials: [], destList: [], nameList: [] };\r\n  var visible = [];\r\n  if (reset) {\r\n    initSelect(this.uiElems.sBfBillName, this.options.nameList, true);\r\n    initSelect(this.uiElems.sBfSerialNumber, this.options.serials, true);\r\n    initSelect(this.uiElems.sBfDest, this.options.destList, true);\r\n    visible = settles;\r\n  } else {\r\n    var d1 = this.uiElems.iStartDate.val();\r\n    var d2 = this.uiElems.iEndDate.val();\r\n    var dateNotEmpty = !isEmpty(d1) && !isEmpty(d2);\r\n\r\n    settles.forEach(function (settle) {\r\n      var b1 = !serial || serial === settle.serial_number;\r\n      var b3 = !dest || dest === settle.ship_to;\r\n      var b4 = !name || name === settle.billing_name;\r\n      var sd = moment(settle.settle_date);\r\n      if (b1 && b3 && b4 && (!dateNotEmpty || (sd.isAfter(d1, 'minute') && sd.isBefore(d2, 'minute')))) {\r\n        if (nOptions.serials.indexOf(settle.serial_number) < 0) {\r\n          nOptions.serials.push(settle.serial_number);\r\n        }\r\n        if (nOptions.destList.indexOf(settle.ship_to) < 0) {\r\n          nOptions.destList.push(settle.ship_to);\r\n        }\r\n        visible.push(settle);\r\n      }\r\n    });\r\n\r\n    nOptions.serials.sort();\r\n    nOptions.destList = sort_pinyin(nOptions.destList);\r\n    nOptions.nameList = sort_pinyin(nOptions.nameList);\r\n\r\n    if (this.currSelected === 2) {\r\n      initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n    }\r\n    else if (this.currSelected === 3) {\r\n      initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n      initSelect(this.uiElems.sBfSerialNumber, nOptions.serials, true, serial);\r\n    }\r\n    else if (this.currSelected === 4) {\r\n      initSelect(this.uiElems.sBfSerialNumber, nOptions.serials, true, serial);\r\n    }\r\n    else {\r\n      initSelect(this.uiElems.sBfSerialNumber, nOptions.serials, true, serial);\r\n      initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n    }\r\n  }\r\n\r\n  return visible;\r\n};\r\n\r\nQueryFilterD.prototype.reset = function(options) {\r\n  this.options = options;\r\n  initSelect(this.uiElems.sBfBillName, this.options.nameList, true);\r\n  initSelect(this.uiElems.sBfSerialNumber, this.options.serials, true);\r\n  initSelect(this.uiElems.sBfDest, this.options.destList, true);\r\n};\r\n"]}