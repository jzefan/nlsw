$(function(){"use strict";var s=$("#table-plan-content"),r=$("#table-tbody"),t=$("#filter"),e=$("#search-export"),n=$("#plan-update"),i=$("#plan-delete"),a=$("#plan-end"),l=$("#undo-plan-end"),o=$("#m_destination"),d=local_data.plans,c=[],m=0,h=new PlanQueryFilterD(local_data.customer_name,function(t,e){if(t){$("body").css({cursor:"wait"});var n=h.getQueryParams();$.get("/search_plans",n,function(t){var e=jQuery.parseJSON(t);d=[],e.ok?(d=e.plans,$("#lb-total-weight").text(getStrValue(e.totalWeight)),$("#lb-sent-weight").text(getStrValue(e.totalWeight-e.leftWeight)),$("#lb-left-weight").text(getStrValue(e.leftWeight))):($("#lb-total-weight").text("0.00"),$("#lb-sent-weight").text("0.00"),$("#lb-left-weight").text("0.00")),$("body").css({cursor:"default"})})}else e&&(d=[],$("#lb-total-weight").text("0.00"),$("#lb-sent-weight").text("0.00"),$("#lb-left-weight").text("0.00"))});function a(n){c.forEach(function(t){for(var e=0;e<d.length;++e)if(t.order_no===d[e].order_no){getRowChildren(r,e).find("td").eq(16).html(n);break}}),s.trigger("update")}function u(){d.length?setHtmlElementDisabled(e,!1):setHtmlElementDisabled(e,!0),c.length?(1===c.length?setHtmlElementDisabled(n,!1):setHtmlElementDisabled(n,!0),setHtmlElementDisabled(i,!1),setHtmlElementDisabled(a,!1),setHtmlElementDisabled(l,!1)):(setHtmlElementDisabled(n,!0),setHtmlElementDisabled(i,!0),setHtmlElementDisabled(a,!0),setHtmlElementDisabled(l,!0))}function g(){r.empty(),c=[];var e=[];d.forEach(function(t){e.push(E(t,'<tr><td align="center"><input class="select-order" type="checkbox"></td><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td>{14}</td><td style="text-align: center">{15}</td></tr>'))}),r.append(e.join("\n")),$("#select-all").prop("checked",!1),u(),r.find("tr").on("click",function(){f($(this),!0)}),$(".select-order").on("click",function(t){t.stopImmediatePropagation(),f($(this).closest("tr"),!1)}),s.trigger("update")}function f(t,e){m=t.index();for(var n=d[t.index()],i=!1,a=0;a<c.length;++a)if(c[a].order_no===n.order_no){c.remove(a),i=!0;break}i?t.removeClass("invoice-highlighted"):(c.push(n),t.addClass("invoice-highlighted")),e&&t.find('input[type="checkbox"]').prop("checked",!i),$("#select-all").prop("checked",c.length===r.find("tr").length),u(),_()}function _(){var e=0,n=0;c.forEach(function(t){e+=t.order_weight,n+=t.left_weight}),$("#lb-total-weight").text(getStrValue(e)),$("#lb-sent-weight").text(getStrValue(e-n)),$("#lb-left-weight").text(getStrValue(n))}function p(t){return 0===t?"生效":"结案"}function E(t,e){var n=t.left_weight,i="";return i=1e-5<n?'<code style="color:blue">'+getStrValue(n)+"</code>":'<code style="color:green">0.00</code>',e.format(t.order_no,getStrValue(t.order_weight),getStrValue(t.order_weight-n),i,t.customer_name,t.customer_code?t.customer_code:"",t.destination?t.destination:"",t.transport_mode,t.consignee?t.consignee:"",t.ds_client?t.ds_client:"",t.customer_saleman?t.customer_saleman:"",t.consigner?t.consigner:"",t.contract_no?t.contract_no:"",getStrValue(t.receiving_charge),date2Str(t.entry_time,!0),p(t.status))}o.select2(),initSelect(o,local_data.destination,!1,""),$("#m_entry_time_grp").datetimepicker(getDateTimePickerOptions()),$.extend($.tablesorter.defaults,{theme:"blue"}),s.tablesorter({widgets:["stickyHeaders"]}),$("#first-th").html('<input id="select-all" type="checkbox" data-toggle="tooltip" data-placement="bottom" title="选择所有记录" />'),u(),g(),elementEventRegister(n,"click",function(){var t;t=c[0],$("#h_order_no").text(t.order_no),$("#h_order_weight").text(t.order_weight),$("#h_left_weight").text(t.left_weight),$("#h_customer_name").text(t.customer_name),$("#h_customer_code").text(t.customer_code),$("#h_destination").text(t.destination),$("#h_transport_mode").text(t.transport_mode),$("#h_consignee").text(t.consignee),$("#h_ds_client").text(t.ds_client),$("#h_salesman").text(t.customer_saleman),$("#h_consigner").text(t.consigner),$("#h_contract_no").text(t.contract_no),$("#h_charge").text(t.receiving_charge),$("#h_entry_time").text(date2Str(t.entry_time,!0)),$("#h_status").text(p(t.status)),$("#m_order_weight").val(t.order_weight),$("#m_destination").select2("val",t.destination),$("#m_transport_mode").val(t.transport_mode),$("#m_consignee").val(t.consignee),$("#m_ds_client").val(t.ds_client),$("#m_salesman").val(t.customer_saleman),$("#m_consigner").val(t.consigner),$("#m_contract_no").val(t.contract_no),$("#m_charge").val(t.receiving_charge),$("#m_entry_time_grp").data("DateTimePicker").setDate(date2Str(t.entry_time,!0)),$("#plan-modify-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}),elementEventRegister(i,"click",function(){for(var t=0;t<c.length;++t)if(1e-5<c[t].order_weight-c[t].left_weight)return void bootbox.alert("订单已经开始配发，不能删除！"+c.order_no);bootbox.confirm("危险!您确定要删除? 删除后不能恢复!",function(t){t&&ajaxRequestHandle("/plan/delete","POST",c,"删除",function(){c.forEach(function(t){for(var e=0;e<d.length;++e)if(t.order_no===d[e].order_no){d.splice(e,1);break}}),g()})})}),elementEventRegister(a,"click",function(){var e=[];c.forEach(function(t){e.push(t.order_no)}),ajaxRequestHandle("/plan/status_close","POST",e,"订单终结",function(){a("结案")})}),elementEventRegister(l,"click",function(){var e=[];c.forEach(function(t){e.push(t.order_no)}),ajaxRequestHandle("/plan/status_unclose","POST",e,"取消订单终结",function(){a("生效")})}),elementEventRegister($("#select-all"),"click",function(){if(0<d.length){var t=$(".select-order");c.length===d.length?(t.prop("checked",!1),c=[],r.find("tr").removeClass("invoice-highlighted")):(t.prop("checked",!0),c=d.slice(0),r.find("tr").addClass("invoice-highlighted")),u(),_()}}),elementEventRegister($("#update-plan-ok"),"click",function(){var e=c[0],n={orderNo:e.order_no,orderWeight:$("#m_order_weight").val(),destination:$("#m_destination").val(),transportMode:$("#m_transport_mode").val(),consignee:$("#m_consignee").val(),dsClient:$("#m_ds_client").val(),salesman:$("#m_salesman").val(),consigner:$("#m_consigner").val(),contractNo:$("#m_contract_no").val(),charge:$("#m_charge").val(),entryTime:$("#m_entry_time_grp").data("DateTimePicker").getDate()},i=+n.orderWeight,a=i-e.order_weight+e.left_weight;ajaxRequestHandle("/plan/update","POST",n,"订单更新",function(){var t=getRowChildren(r,m);t.find("td").eq(2).html(getStrValue(n.orderWeight)),t.find("td").eq(3).html(getStrValue(n.orderWeight-a)),t.find("td").eq(4).html(getStrValue(a)),t.find("td").eq(7).html(n.destination),t.find("td").eq(8).html(n.transportMode),t.find("td").eq(9).html(n.consignee?n.consignee:""),t.find("td").eq(10).html(n.dsClient?n.dsClient:""),t.find("td").eq(11).html(n.salesman?n.salesman:""),t.find("td").eq(12).html(n.consigner?n.consigner:""),t.find("td").eq(13).html(n.contractNo?n.contractNo:""),t.find("td").eq(14).html(getStrValue(n.charge)),t.find("td").eq(15).html(date2Str(n.entryTime)),e.status=0===a?2:a===i?0:1,t.find("td").eq(16).html(p(e.status)),e.order_weight=n.orderWeight,e.left_weight=a,e.destination=n.destination,e.transport_mode=n.transportMode,e.consignee=n.consignee,e.ds_client=n.dsClient,e.customer_saleman=n.salesman,e.consigner=n.consigner,e.contract_no=n.contractNo,e.receiving_charge=n.charge,e.entry_time=n.entryTime,$("#plan-modify-dialog").modal("hide"),s.trigger("update")})}),elementEventRegister(e,"click",function(){var e=["<thead><tr><th>订单号</th><th>订单量</th><th>已发量</th><th>未发量</th><th>客户名称</th><th>客户代码</th><th>发运目的地</th><th>运输方式</th><th>收货人</th><th>下游客户</th><th>客户业务员</th><th>业务员</th><th>合同号</th><th>接单价</th><th>录单时间</th><th>订单状态</th></tr></thead><tbody>"];d.forEach(function(t){e.push(E(t,"<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td>{14}</td><td>{15}</td></tr>"))}),e.push("</tbody>"),tableToExcel(e.join("\n"),"data")});var v=!1;elementEventRegister(t,"click",function(){$("#filter-ui").toggle(),v=!v}),elementEventRegister($("#show-data"),"click",function(){g()})});var PlanQueryFilterD=function(t,e){this.currSelected=0;var n=this;this.uiElems={sBfOrder:$("#order-no"),sBfCustomerName:$("#customer-name"),sBfTransportMode:$("#transport-mode"),sBfStatus:$("#status"),startDateGrp:$("#start-date-grp"),endDateGrp:$("#end-date-grp"),iStartDate:$("#start-date"),iEndDate:$("#end-date")},this.options=t,this.uiElems.sBfCustomerName.select2(),initSelect(this.uiElems.sBfCustomerName,t,!0,""),this.uiElems.sBfOrder.on("blur",function(){n._selectFliterFunc(1,e)}),this.uiElems.sBfCustomerName.on("change",function(){n._selectFliterFunc(1,e)}),this.uiElems.sBfTransportMode.on("change",function(){n._selectFliterFunc(1,e)}),this.uiElems.sBfStatus.on("change",function(){n._selectFliterFunc(1,e)}),unselected(this.uiElems.sBfCustomerName),unselected(this.uiElems.sBfTransportMode),unselected(this.uiElems.sBfStatus),this.eDate=moment(),this.sDate=moment().subtract(1,"months");var i=n.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()),a=n.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions());this.uiElems.endDateGrp.data("DateTimePicker").setDate(this.eDate),this.uiElems.startDateGrp.data("DateTimePicker").setDate(this.sDate),this._selectFliterFunc=function(t,e){this.currSelected=t,this.isAllEmpty()?e(!1,!0):e(!0,!1)},this._dateFilterFunc=function(t,e,n){var i=this.uiElems.iStartDate.val(),a=this.uiElems.iEndDate.val(),s=!1;t&&e?s=!isEmpty(i)&&!isEmpty(a):t?s=isEmpty(this.uiElems.iStartDate.val()):e&&(s=isEmpty(this.uiElems.iEndDate.val())),s&&n(!0,!(this.currSelected=5))},i.on("dp.change",function(t){t.preventDefault(),t.stopImmediatePropagation(),n.sDate=t.date.startOf("day"),n.uiElems.endDateGrp.data("DateTimePicker").setMinDate(t.date),n._dateFilterFunc(!0,!0,e)}),a.on("dp.change",function(t){t.preventDefault(),t.stopImmediatePropagation(),n.eDate=t.date.endOf("day"),n.uiElems.startDateGrp.data("DateTimePicker").setMaxDate(t.date),n._dateFilterFunc(!0,!0,e)}),n.uiElems.iStartDate.on("change",function(t){t.stopImmediatePropagation(),n._dateFilterFunc(!0,!1,e)}),n.uiElems.iEndDate.on("change",function(t){t.stopImmediatePropagation(),n._dateFilterFunc(!1,!0,e)})};PlanQueryFilterD.prototype.getQueryParams=function(){var t=this.uiElems.sBfOrder.val(),e=this.uiElems.sBfCustomerName.val(),n=this.uiElems.sBfTransportMode.val(),i=this.uiElems.sBfStatus.val(),a=this.uiElems.iStartDate.val(),s=this.uiElems.iEndDate.val(),r=!isEmpty(a)&&!isEmpty(s);return{fOrder:isEmpty(t)?null:t,fName:isEmpty(e)?null:e,fTransportMode:isEmpty(n)?null:n,fStatus:isEmpty(i)?null:i,fDate1:r?this.sDate.toISOString():null,fDate2:r?this.eDate.toISOString():null}},PlanQueryFilterD.prototype.isAllEmpty=function(){var t=this.uiElems.sBfOrder.val(),e=getSelectValue(this.uiElems.sBfCustomerName),n=this.uiElems.sBfTransportMode.val(),i=this.uiElems.sBfStatus.val(),a=this.uiElems.iStartDate.val(),s=this.uiElems.iEndDate.val();return isEmpty(t)&&isEmpty(n)&&isEmpty(i)&&isEmpty(e)&&isEmpty(a)&&isEmpty(s)},PlanQueryFilterD.prototype.reset=function(){this.uiElems.sBfCustomerName.select2("val",""),this.uiElems.sBfOrder.val(""),this.uiElems.sBfTransportMode.val(""),this.uiElems.sBfStatus.val(""),this.uiElems.iStartDate.val(""),this.uiElems.iEndDate.val("")};
//# sourceMappingURL=plan_list.js.map
