{"version":3,"sources":["inv_utils.js"],"names":["ShipBillD","ono","this","no","left_num","allBills","prototype","getOptionWithTip","shipName","format","getTip","name","tips","forEach","b","billing_name","push","tip","join","getOptions","opts","result","bill_no","keys","Object","sort","i","length","key","left","getBillTips","billNo","find","bill","found","sameBill","index","findOne","bno","order","k","getOrder","order_no","order_item_no","add","selected","select_number","setTip","prev_select_num","prev_wnum_danding","wnum","wnum_danding","vehicles","save","saveToContinue","block_num","selectedWithWaybillNum","idx","openToNew","num","ino","bills","len","inner_waybill_no","hasSelected","getAllSelected","weight","allVehSendNum","bveh","send_num","bill_id","_id","slice","clearVehicle","wid","substring","waybillHandler","billsInfo","queryWaybillData","vehicleComplete","iwno","vname","vfrom","toFixedNumber","veh_name","veh_ship_from","send_weight","init","setName","reset","resetWithQueryData","qData","selectedIdx","invoices","ship_name","item","saveInvoice","data","$","isEmptyObject","waybill_no","vehicle_vessel_name","ship_customer","ship_from","ship_to","ship_date","total_weight","username","shipper","state","addBill","findCreate","addBillAndTableRow","insert","res","addBillAndTableRow_1","updatedBill","addAndInsertTable","orderNo","innerWNo","billtips","addAndInsertTable_1","sOrder","sBill","innerWNO","val","selectedBills","prop","billTip","search","option","deleteTableRow","isVesselForUpdate","nwData","updateUI","updateShipNum","delta","Math","abs","created","getBill","tr","getTableCellChildren","text","split","handleVehicleComplete","vehName","vehShipFrom","clearVehicles","hasSelectedBills","getSelectedBills","Array","apply","showSelectedBill","show","afterShow","danding","hasMixedBill","compare","invoice","count","idx0","idx1","String","insertSelectOptions","element","empty","allDisabled","items","a","append","opt","unselected","setQueryData","getWaybill","wno","invs","getBillsFromInvoice","waybill","sortObject","obj","reduce","select_num","getStrValue","getMaxInnerWaybillNo","maxId","inv","inv_no","veh","max","parseInt","inputEventRegister","el","func","on","one","select","value","e","stopImmediatePropagation","ForceNumericOnly"],"mappings":"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","file":"inv_utils.js","sourcesContent":["/**\r\n * Created by ezefjia on 2016/7/29.\r\n */\r\n\r\nvar ShipBillD = function(ono) {\r\n  this.no = ono;\r\n  this.left_num = 0;\r\n  this.allBills = [];\r\n};\r\n\r\nShipBillD.prototype.getOptionWithTip = function(shipName) {\r\n  return '<option {0} value=\"{1}\" data-toggle=\"tooltip\" title=\"{2}\" data-html=\"true\">{3}</option>'.format(\r\n    this.left_num > 0 ? '' : 'disabled', this.no, this.getTip(shipName), this.no);\r\n};\r\n\r\nShipBillD.prototype.getTip = function(name) {\r\n  var tips = [];\r\n  this.allBills.forEach(function (b) {\r\n    if (b.billing_name === name) {\r\n      tips.push(b.tip);\r\n    }\r\n  });\r\n  return tips.join('\\n');\r\n};\r\nShipBillD.prototype.getOptions = function(name) {\r\n  var opts = [];\r\n  var result = {};\r\n  this.allBills.forEach(function (b) {\r\n    if (b.billing_name === name) {\r\n      if (b.bill_no in result) {\r\n        result[b.bill_no].push(b);\r\n      } else {\r\n        result[b.bill_no] = [ b ];\r\n      }\r\n    }\r\n  });\r\n  var keys = Object.keys(result);\r\n  keys.sort();\r\n  for (var i = 0; i < keys.length; ++i) {\r\n    var key = keys[i];\r\n    var tip = [];\r\n    var left = 0;\r\n    result[key].forEach(function (b) {\r\n      tip.push(b.tip);\r\n      left += b.left_num;\r\n    });\r\n    var tips = 'data-toggle=\"tooltip\" title=\"{0}\" data-html=\"true\"'.format(tip.join('\\n'));\r\n    if (left > 0) {\r\n      opts.push('<option value=\"' + key + '\" ' + tips + '>' + key + '</option>');\r\n    }\r\n  }\r\n  return opts;\r\n};\r\nShipBillD.prototype.getBillTips = function(name, billNo) {\r\n  var left = 0;\r\n  var tips = [];\r\n  this.allBills.forEach(function (b) {\r\n    if (b.billing_name == name && b.bill_no == billNo) {\r\n      left += b.left_num;\r\n      tips.push(b.tip);\r\n    }\r\n  });\r\n  return { left_num: left, tip: tips.join('\\n') };\r\n};\r\nShipBillD.prototype.find = function (bill) {\r\n  var result = { found: false};\r\n  for (var i = 0; i < this.allBills.length; ++i) {\r\n    if (sameBill(bill, this.allBills[i])) {\r\n      result.found = true;\r\n      result.bill  = this.allBills[i];\r\n      result.index = i;\r\n      break;\r\n    }\r\n  }\r\n\r\n  return result;\r\n};\r\n\r\nShipBillD.prototype.findOne = function(bno, order) {\r\n  for (var k = 0; k < this.allBills.length; ++k) {\r\n    var b = this.allBills[k];\r\n    if (order === getOrder(b.order_no, b.order_item_no) && bno === b.bill_no) {\r\n      return b;\r\n    }\r\n  }\r\n\r\n  return false;\r\n};\r\n\r\nShipBillD.prototype.add = function (bill) {\r\n  bill.selected = false;\r\n  bill.select_number = 0;\r\n  bill.left = 0;\r\n  if (bill.left_num >= 0) {\r\n    this.left_num += bill.left_num;\r\n    bill.left = bill.left_num;  // left保存left_num, left_num是随着用户设置发运数动态的改变\r\n  }\r\n  setTip(bill, 0);\r\n  bill.prev_select_num   = 0;\r\n  bill.prev_wnum_danding = 0; // 单定的发运块数\r\n  bill.wnum         = 0;  // 运单读入时的发运数 (来自数据库)\r\n  bill.wnum_danding = 0;\r\n  bill.vehicles = [];\r\n  this.allBills.push(bill);\r\n};\r\n\r\nShipBillD.prototype.save = function () {\r\n  this.allBills.forEach(function (b) {\r\n    if (b.selected) {\r\n      b.selected      = false;\r\n      b.select_number = 0;\r\n      b.left          = b.left_num;\r\n    }\r\n  })\r\n};\r\n\r\nShipBillD.prototype.saveToContinue = function() {\r\n  this.allBills.forEach(function(bill) {\r\n    if (bill.selected) {\r\n      bill.prev_select_num = (bill.prev_select_num > 0) ? (bill.prev_select_num + bill.select_number) : bill.select_number;\r\n      bill.select_number = 0;\r\n      bill.left = bill.left_num;\r\n      if (bill.block_num === 0) {\r\n        bill.prev_wnum_danding = (bill.prev_wnum_danding > 0) ? (bill.prev_wnum_danding + bill.wnum_danding) : bill.wnum_danding;\r\n        bill.wnum_danding = 0; // 当前界面下单定的发运块数\r\n      }\r\n    }\r\n  })\r\n};\r\n\r\nShipBillD.prototype.selectedWithWaybillNum = function (idx, openToNew, num) {\r\n  var bill = this.allBills[idx];\r\n  bill.openToNew = openToNew;\r\n  if (num > 0) {\r\n    bill.selected = true;\r\n    if (openToNew) {\r\n      bill.prev_select_num = num;\r\n      bill.select_number = 0;\r\n    } else {\r\n      bill.select_number = num;\r\n      if (bill.left_num >= 0) {\r\n        this.left_num -= bill.left_num;\r\n        bill.left_num = bill.left;\r\n        bill.left = bill.left_num + num;\r\n        this.left_num += bill.left_num;\r\n      }\r\n    }\r\n    setTip(bill, num);\r\n  }\r\n};\r\n\r\nShipBillD.prototype.selected = function(bno, ino) {\r\n  var bills = [];\r\n  for (var i = 0, len = this.allBills.length; i < len; ++i) {\r\n    if (this.allBills[i].left_num > 0 && this.allBills[i].bill_no === bno) {\r\n      this.allBills[i].selected = true;\r\n      this.allBills[i].inner_waybill_no = ino;\r\n      bills.push(this.allBills[i]);\r\n    }\r\n  }\r\n\r\n  return bills;\r\n};\r\n\r\nShipBillD.prototype.hasSelected = function() {\r\n  for (var k = 0; k < this.allBills.length; ++k) {\r\n    var bill = this.allBills[k];\r\n    if (bill.selected && bill.select_number > 0) {\r\n      if (bill.block_num > 0 || bill.wnum_danding > 0) {\r\n        return true;\r\n      }\r\n    }\r\n  }\r\n\r\n  return false;\r\n};\r\n\r\nShipBillD.prototype.getAllSelected = function() {\r\n  var bills = [];\r\n  this.allBills.forEach(function(bill) {\r\n    if (bill.selected) { // && (bill.select_number > 0 || bill.prev_select_num > 0)) {\r\n      var num = (bill.prev_select_num > 0) ? (bill.prev_select_num + bill.select_number) : bill.select_number;\r\n      var weight = 0;\r\n\r\n      var allVehSendNum = 0;\r\n      bill.vehicles.forEach(function(bveh) { allVehSendNum += bveh.send_num });\r\n\r\n      if (bill.block_num > 0) {\r\n        if (allVehSendNum > 0) {\r\n          num = allVehSendNum;\r\n        }\r\n      } else {\r\n        weight = num;\r\n        num = (bill.prev_wnum_danding > 0) ? (bill.prev_wnum_danding + bill.wnum_danding) : bill.wnum_danding;\r\n        if (allVehSendNum > 0) {\r\n          num = allVehSendNum;\r\n        }\r\n      }\r\n\r\n      if (num > 0 || weight > 0) {\r\n        bills.push({\r\n          bill_id: bill._id,\r\n          num: num,\r\n          weight: weight,\r\n          vehicles: bill.vehicles.slice(0)\r\n        })\r\n      }\r\n    }\r\n  });\r\n\r\n  return bills;\r\n};\r\n\r\nShipBillD.prototype.clearVehicle = function(wid) {\r\n  this.allBills.forEach(function (bill) {\r\n    if (bill.selected && bill.inner_waybill_no) {\r\n      var wno = bill.inner_waybill_no.substring(0, 17);\r\n      if (wno === wid) {\r\n        bill.vehicles = [];\r\n        bill.inner_waybill_no = \"\";\r\n      }\r\n    }\r\n  })\r\n};\r\n\r\nShipBillD.prototype.vehicleComplete = function(iwno, vname, vfrom) {\r\n  this.allBills.forEach(function (bill) {\r\n    if (bill.selected && bill.inner_waybill_no === iwno && bill.select_number > 0) {\r\n      var num = 0, weight = 0;\r\n      if (bill.block_num > 0) {\r\n        num    = bill.select_number;\r\n        weight = toFixedNumber(bill.select_number * bill.weight, 3);\r\n      } else {\r\n        num    = bill.wnum_danding;\r\n        weight = toFixedNumber(bill.select_number, 3);\r\n      }\r\n\r\n      bill.vehicles.push({\r\n        inner_waybill_no: iwno,\r\n        veh_name:         vname,\r\n        veh_ship_from:    vfrom,\r\n        send_num:         num,\r\n        send_weight:      weight\r\n      });\r\n\r\n      if (typeof bill.prev_select_num === 'undefined') {\r\n        bill.prev_select_num = bill.select_number;\r\n      } else {\r\n        bill.prev_select_num += bill.select_number;\r\n      }\r\n\r\n      if (typeof bill.prev_wnum_danding === 'undefined') {\r\n        bill.prev_wnum_danding = bill.wnum_danding > 0 ? bill.wnum_danding : 0;\r\n      } else {\r\n        bill.prev_wnum_danding += bill.wnum_danding > 0 ? bill.wnum_danding : 0;\r\n      }\r\n\r\n      bill.select_number = 0;\r\n      bill.wnum_danding  = 0;\r\n      bill.left = bill.left_num;\r\n      bill.inner_waybill_no = ''; // clear it for new inner waybill created\r\n    }\r\n  })\r\n};\r\n\r\nvar waybillHandler = {\r\n  billsInfo: [],\r\n  queryWaybillData: {},\r\n  shipName: '',\r\n  openToNew: false,\r\n\r\n  init: function(name) { this.shipName = name },\r\n\r\n  setName: function(name) { this.shipName = name },\r\n\r\n  reset: function(name) {\r\n    this.billsInfo = [];\r\n    this.shipName = name;\r\n    this.openToNew = false;\r\n  },\r\n  resetWithQueryData: function(qData, selectedIdx) {\r\n    var selected = null;\r\n    \r\n    this.billsInfo        = [];\r\n    this.openToNew        = false;\r\n    this.queryWaybillData = qData;\r\n    if (selectedIdx >= 0 && selectedIdx < qData.invoices.length) {\r\n      selected = qData.invoices[selectedIdx];\r\n      this.shipName = selected.ship_name;\r\n    }\r\n    \r\n    return selected;    \r\n  },\r\n\r\n  save: function() { this.billsInfo.forEach(function(item) { item.save() }) },\r\n\r\n  saveInvoice: function(data) {\r\n    if (!$.isEmptyObject(this.queryWaybillData) && typeof(this.queryWaybillData.invoices) !== 'undefined') {\r\n      for (var i = 0, len = this.queryWaybillData.invoices.length; i < len; ++i) {\r\n        if (this.queryWaybillData.invoices[i].waybill_no === data.waybill_no) {\r\n          this.queryWaybillData.invoices[i].vehicle_vessel_name = data.vehicle_vessel_name;\r\n          this.queryWaybillData.invoices[i].ship_name           = data.ship_name;\r\n          this.queryWaybillData.invoices[i].ship_customer       = data.ship_customer;\r\n          this.queryWaybillData.invoices[i].ship_from           = data.ship_from;\r\n          this.queryWaybillData.invoices[i].ship_to             = data.ship_to;\r\n          this.queryWaybillData.invoices[i].ship_date           = data.ship_date;\r\n          this.queryWaybillData.invoices[i].bills               = data.bills;\r\n          this.queryWaybillData.invoices[i].total_weight        = data.total_weight;\r\n          this.queryWaybillData.invoices[i].username            = data.username;\r\n          this.queryWaybillData.invoices[i].shipper             = data.shipper;\r\n          this.queryWaybillData.invoices[i].state               = data.state;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    this.billsInfo.forEach(function(item) { item.saveToContinue() });\r\n  },\r\n\r\n  addBill: function(bill) {\r\n    var result = this.findCreate(bill.order_no, true);\r\n    if (!result.found || !result.data.find(bill).found) {\r\n      result.data.add(bill);\r\n    }\r\n  },\r\n\r\n  addBillAndTableRow: function(bill, num, insert) {\r\n    var result = this.findCreate(bill.order_no, true);\r\n    var res = result.data.find(bill);\r\n    if (result.found && res.found) {\r\n      result.data.selectedWithWaybillNum(res.index, this.openToNew, num);\r\n      res.bill.vehicles          = bill.vehicles.slice(0);\r\n      res.bill.wnum_danding      = bill.wnum_danding;\r\n      res.bill.prev_wnum_danding = bill.prev_wnum_danding;\r\n      insert(res.bill, result.data.getTip(this.shipName));\r\n    } else {\r\n      bill.openToNew = this.openToNew;\r\n      bill.selected  = true;\r\n\r\n      if (this.openToNew) {\r\n        bill.prev_select_num = num;\r\n        bill.select_number   = 0;\r\n      } else {\r\n        bill.select_number = num;\r\n      }\r\n\r\n      if (bill.left_num >= 0 && !this.openToNew) {\r\n        bill.left = bill.left_num + (+num);\r\n        this.left_num += bill.left;\r\n      }\r\n\r\n      setTip(bill, num);\r\n      result.data.allBills.push(bill);\r\n      insert(bill, result.data.getTip(this.shipName));\r\n    }\r\n  },\r\n\r\n  addBillAndTableRow_1: function(bill, num) {\r\n    var result = this.findCreate(bill.order_no, true);\r\n    var res = result.data.find(bill);\r\n    if (result.found && res.found) {\r\n      if (num > 0) {\r\n        res.bill.selected        = true;\r\n        res.bill.prev_select_num = num;\r\n        res.bill.select_number   = 0;\r\n        res.bill.vehicles          = bill.vehicles.slice(0);\r\n        res.bill.wnum_danding      = bill.wnum_danding;\r\n        res.bill.prev_wnum_danding = bill.prev_wnum_danding;\r\n        setTip(res.bill, num);\r\n      }\r\n\r\n      return {updatedBill: res.bill, tips: result.data.getTip(this.shipName) };\r\n    } else {\r\n      bill.openToNew = this.openToNew;\r\n      bill.selected  = true;\r\n      if (this.openToNew) {\r\n        bill.prev_select_num = num;\r\n        bill.select_number   = 0;\r\n      } else {\r\n        bill.select_number = num;\r\n      }\r\n\r\n      if (bill.left_num >= 0 && !this.openToNew) {\r\n        bill.left = bill.left_num + (+num);\r\n        this.left_num += bill.left;\r\n      }\r\n      setTip(bill, num);\r\n      result.data.allBills.push(bill);\r\n      return {updatedBill: bill, tips: result.data.getTip(this.shipName) };\r\n    }\r\n  },\r\n\r\n  addAndInsertTable: function(orderNo, billNo, innerWNo) {\r\n    var result = this.findCreate(orderNo, false);\r\n    if (result.found) {\r\n      return {\r\n        bills:    result.data.selected(billNo, innerWNo),\r\n        tip:      result.data.getTip(this.shipName),\r\n        billtips: result.data.getBillTips(this.shipName, billNo)\r\n      }\r\n    } else {\r\n      return null;\r\n    }\r\n  },\r\n\r\n  addAndInsertTable_1: function(sOrder, sBill, innerWNO, insert) {\r\n    var orderNo = sOrder.val();\r\n    var result = this.findCreate(orderNo, false);\r\n    if (!result.found) {\r\n      return false;\r\n    }\r\n    var billNo = sBill.val();\r\n    var selectedBills = result.data.selected(billNo, innerWNO);\r\n    if (selectedBills.length > 0) {\r\n      insert(selectedBills);\r\n      sOrder.find(':selected').prop(\"title\", result.data.getTip(this.shipName));\r\n      var billTip = result.data.getBillTips(this.shipName, billNo);\r\n      var search = 'option[value=\"{0}\"]'.format(billNo);\r\n      var option = sBill.find(search);\r\n      option.prop(\"title\", billTip.tip);\r\n      option.prop(\"disabled\", billTip.left_num == 0);\r\n    }\r\n    return selectedBills.length > 0;\r\n  },\r\n\r\n  deleteTableRow: function(b, isVesselForUpdate, nwData, updateUI) {\r\n    var result = this.findCreate(b.order_no, false);\r\n    if (result.found) {\r\n      if (typeof b.prev_select_num === 'undefined') {\r\n        b.prev_select_num = 0;\r\n      }\r\n\r\n      if (isVesselForUpdate) {\r\n        if (b.block_num > 0) {\r\n          b.select_number      -= nwData.num;\r\n          b.left_num           += nwData.num;\r\n          result.data.left_num += nwData.num;\r\n        } else {\r\n          b.select_number      -= nwData.weight;\r\n          b.wnum_danding       -= nwData.num;\r\n          b.left_num           += nwData.weight;\r\n          result.data.left_num += nwData.weight;\r\n        }\r\n\r\n        setTip(b, (b.select_number + b.prev_select_num > 0) ? (b.select_number + b.prev_select_num > 0) : 0);\r\n\r\n      } else {\r\n        b.select_number = 0;\r\n        if (b.left >= 0) {\r\n          b.left_num = b.left;\r\n          result.data.left_num += b.left;\r\n        } else {\r\n          b.left_num = 0;\r\n        }\r\n\r\n        setTip(b, (b.prev_select_num > 0) ? b.prev_select_num : 0);\r\n      }\r\n\r\n      updateUI(result.data.getBillTips(this.shipName, b.bill_no), result.data.getTip(this.shipName));\r\n    }\r\n  },\r\n\r\n  updateShipNum: function(b, delta, updateUI) {\r\n    var result = this.findCreate(b.order_no, false);\r\n    if (result.found) {\r\n      if (b.left_num >= 0) {\r\n        b.left_num           -= delta;\r\n        b.select_number      += delta;\r\n        result.data.left_num -= delta;\r\n        if (b.block_num === 0) {\r\n          if (Math.abs(b.left_num) < 0.00001) {\r\n            b.left_num = 0;\r\n          }\r\n          if (Math.abs(b.select_number) < 0.00001) {\r\n            b.select_number = 0;\r\n          }\r\n        }\r\n\r\n        setTip(b, (b.prev_select_num > 0 || b.openToNew) ? b.select_number + b.prev_select_num : b.select_number);\r\n      }\r\n\r\n      updateUI(result.data.getBillTips(this.shipName, b.bill_no), result.data.getTip(this.shipName));\r\n    }\r\n  },\r\n\r\n  findCreate: function(no, created) {\r\n    var result = { found: false };\r\n    for (var i = 0; i < this.billsInfo.length; ++i) {\r\n      if (this.billsInfo[i].no === no) {\r\n        result.found = true;\r\n        result.data  = this.billsInfo[i];\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (!result.found && created) {\r\n      this.billsInfo.push(new ShipBillD(no));\r\n      result.data = this.billsInfo[this.billsInfo.length - 1];\r\n    }\r\n\r\n    return result;\r\n  },\r\n\r\n  getBill: function(tr) {\r\n    var bno   = getTableCellChildren(tr, 1).text();\r\n    var order = getTableCellChildren(tr, 2).text();\r\n    var res = order.split('-');\r\n    for (var i = 0; i < this.billsInfo.length; ++i) {\r\n      if (this.billsInfo[i].no === res[0]) {\r\n        var b =  this.billsInfo[i].findOne(bno, order);\r\n        if (b) return b;\r\n      }\r\n    }\r\n    return null;\r\n  },\r\n\r\n  handleVehicleComplete: function(innerWNo, vehName, vehShipFrom) {\r\n    this.billsInfo.forEach(function(item) { item.vehicleComplete(innerWNo, vehName, vehShipFrom) });\r\n  },\r\n\r\n  clearVehicles: function(wid) { this.billsInfo.forEach(function (item) { item.clearVehicle(wid) }) },\r\n\r\n  hasSelectedBills: function() {\r\n    for (var i = 0; i < this.billsInfo.length; ++i) {\r\n      if (this.billsInfo[i].hasSelected()) { return true }\r\n    }\r\n\r\n    return false;\r\n  },\r\n\r\n  getSelectedBills: function() {\r\n    var selectedBills = [];\r\n    this.billsInfo.forEach(function(item) {\r\n      Array.prototype.push.apply(selectedBills, item.getAllSelected());\r\n    });\r\n\r\n    return selectedBills;\r\n  },\r\n\r\n  showSelectedBill: function (wid, show, afterShow) {\r\n    var found = false;\r\n    this.billsInfo.forEach(function (item) {\r\n      item.allBills.forEach(function (bill) {\r\n        if (bill.selected) {// && (bill.select_number > 0 || bill.prev_select_num > 0)) {\r\n          var danding = (bill.prev_wnum_danding > 0) ? bill.prev_wnum_danding + bill.wnum_danding : bill.wnum_danding;\r\n          var num = (bill.prev_select_num > 0) ? bill.prev_select_num + bill.select_number : bill.select_number;\r\n          if (bill.block_num > 0) {\r\n            if (num > 0) {\r\n              show(bill, bill.block_num, num, num * bill.weight);\r\n              bill.inner_waybill_no = wid;\r\n              bill.prev_select_num = 0;\r\n              bill.select_number = num;\r\n              found = true;\r\n            }\r\n          } else {\r\n            if (num > 0 && danding > 0) {\r\n              show(bill, bill.total_weight, danding, num);\r\n              bill.inner_waybill_no = wid;\r\n              bill.prev_wnum_danding = 0;\r\n              bill.wnum_danding = danding;\r\n              bill.prev_select_num = 0;\r\n              bill.select_number = num;\r\n              found = true;\r\n            }\r\n          }\r\n        }\r\n      })\r\n    });\r\n\r\n    if (found) { afterShow() }\r\n  },\r\n\r\n  hasMixedBill: function() { // 有单定和定尺结合的提单\r\n    var result = 0;\r\n    for (var i = 0; i < this.billsInfo.length; ++i) {\r\n      var item = this.billsInfo[i];\r\n      for (var k = 0; k < item.allBills.length; ++k) {\r\n        var bill = item.allBills[k];\r\n        if (bill.selected) {\r\n          if (bill.block_num > 0) {\r\n            result = (result === 2) ? 3 : 1;\r\n          } else if (result === 1) {\r\n            result = 3; // 混合\r\n          } else {\r\n            result = 2; // 单定 - 只有重量\r\n          }\r\n        }\r\n\r\n        if (result === 3) {\r\n          return 3;\r\n        }\r\n      }\r\n    }\r\n\r\n    return result;\r\n  },\r\n\r\n  compare: function(invoice) {\r\n    var count = 0;\r\n    for (var idx0 = 0; idx0 < this.billsInfo.length; ++idx0) {\r\n      var item = this.billsInfo[idx0];\r\n      for (var idx1 = 0; idx1 < item.allBills.length; ++idx1) {\r\n        var bill = item.allBills[idx1];\r\n        if (bill.selected) {\r\n          ++count;\r\n          var found = false;\r\n          for (var i = 0; i < invoice.bills.length; ++i) {\r\n            var b = invoice.bills[i];\r\n            if (String(bill._id) === String(b.bill_id)) {\r\n              found = bill.block_num > 0 ? bill.select_number == b.num : (bill.select_number == b.weight && bill.wnum_danding == b.num);\r\n              break;\r\n            }\r\n          }\r\n          if (!found) {\r\n            return false; // 找不到相同的id, 则返回false表示不相同\r\n          }\r\n        }\r\n      }\r\n    }\r\n    // 所有的id都能找到, 但是如果数量不一样,则同样不相同\r\n    return (count == invoice.bills.length);\r\n  },\r\n\r\n  insertSelectOptions: function(element, name) {\r\n    element.empty();\r\n    if (!name) {\r\n      name = this.shipName;\r\n    }\r\n    var allDisabled = [];\r\n    var items = [];\r\n    this.billsInfo.forEach(function(item) {\r\n      for (var i = 0; i < item.allBills.length; ++i) {\r\n        if (name === item.allBills[i].billing_name) {\r\n          if (item.left_num > 0) {\r\n            items.push(item);\r\n          } else {\r\n            allDisabled.push(item.getOptionWithTip(name));\r\n          }\r\n          break;\r\n        }\r\n      }\r\n    });\r\n\r\n    items.sort(function(a, b) { return (a.no > b.no) ? 1 : (a.no < b.no ? -1 : 0) });\r\n    items.forEach(function(item) { element.append(item.getOptionWithTip(name)) });\r\n    allDisabled.forEach(function(opt) { element.append(opt) });\r\n    unselected(element);\r\n  },\r\n\r\n  setQueryData: function(data) { this.queryWaybillData = data; },\r\n\r\n  getWaybill: function(wno) {\r\n    var invs = this.queryWaybillData.invoices;\r\n    for (var i = 0; i < invs.length; ++i) {\r\n      if (wno == invs[i].waybill_no) {\r\n        return invs[i];\r\n      }\r\n    }\r\n    return null;\r\n  },\r\n\r\n  getBillsFromInvoice: function(waybill) {\r\n    var bills = [];\r\n    var len = waybill.bills.length;\r\n\r\n    this.queryWaybillData.bills.forEach(function(bill) {\r\n      for (var i = 0; i < len; ++i) {\r\n        if (String(waybill.bills[i].bill_id) === String(bill._id)) {\r\n          if (bill.block_num > 0) {\r\n            bill.wnum = waybill.bills[i].num;\r\n          } else {\r\n            bill.wnum = waybill.bills[i].weight;\r\n            bill.prev_wnum_danding = 0; // waybill.bills[i].num\r\n            bill.wnum_danding = waybill.bills[i].num;\r\n          }\r\n\r\n          bill.vehicles = waybill.bills[i].vehicles.slice(0);\r\n          bills.push(bill);\r\n          break;\r\n        }\r\n      }\r\n    });\r\n\r\n    return bills;\r\n  }\r\n};\r\n\r\nfunction sortObject(obj) {\r\n  return Object.keys(obj).sort().reduce(function (result, key) {\r\n    result[key] = obj[key];\r\n    return result;\r\n  }, {});\r\n}\r\n\r\nfunction sameBill(a, b) {\r\n  return b.order_no === a.order_no && b.order_item_no === a.order_item_no && b.bill_no === a.bill_no;\r\n}\r\n\r\nfunction setTip(bill, select_num) {\r\n  if (bill.block_num > 0) {\r\n    bill.tip = '订单项次号:{0}, 提单号:{1}, 实际块数:{2}, 可用块数:{3}, 当前运单已用块数:{4}'.format(bill.order_item_no, bill.bill_no, bill.block_num, bill.left_num, select_num);\r\n  } else {\r\n    bill.tip = '订单项次号:{0}, 提单号:{1}, 实际重量:{2}, 剩余重量:{3}, 当前运单已用重量:{4}'.format(bill.order_item_no, bill.bill_no, getStrValue(bill.total_weight), getStrValue(bill.left_num), getStrValue(select_num));\r\n  }\r\n}\r\n\r\nfunction getMaxInnerWaybillNo(bills, waybill_no) {\r\n  var maxId = 0;\r\n  bills.forEach(function (bill) {\r\n    bill.invoices.forEach(function (inv) {\r\n      if (inv.inv_no === waybill_no) {\r\n        inv.vehicles.forEach(function (veh) {\r\n          maxId = Math.max(maxId, parseInt(veh.inner_waybill_no.substring(17)));\r\n        })\r\n      }\r\n    })\r\n  });\r\n  return ++maxId;\r\n}\r\n\r\nfunction inputEventRegister(el, func) {\r\n  if (el.length > 0) {\r\n    el.on('focus', function () {\r\n      $(this).one('mouseup', function () {\r\n        $(this).select();\r\n        return false;\r\n      }).select();\r\n      $(this).data(\"old\", this.value || \"\");\r\n    });\r\n    el.on('keyup paste', function (e) {\r\n      e.stopImmediatePropagation();\r\n      func($(this));\r\n    });\r\n    el.ForceNumericOnly();\r\n  }\r\n}"]}