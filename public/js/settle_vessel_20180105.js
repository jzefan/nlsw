$(function(){"use strict";function e(e,t){if("未结算"===le.settledState?(showHtmlElement(V,!0),showHtmlElement(H,!1),showHtmlElement(T,!1),showHtmlElement(B,!1),showHtmlElement(N,!1),showHtmlElement(z,!1)):"已结算"===le.settledState?(showHtmlElement(V,!1),showHtmlElement(H,!0),showHtmlElement(T,!0),showHtmlElement(N,!0),showHtmlElement(B,!1),showHtmlElement(z,!0)):"已付款"===le.settledState?(showHtmlElement(V,!1),showHtmlElement(H,!1),showHtmlElement(T,!1),showHtmlElement(B,!0),showHtmlElement(N,!1),showHtmlElement(z,!1)):"不需要结算"===le.settledState&&(showHtmlElement(V,!1),showHtmlElement(H,!1),showHtmlElement(T,!1),showHtmlElement(B,!1),showHtmlElement(N,!1),showHtmlElement(z,!1)),e){var l=le.getQueryParams();$.get("/get_invoice_settle_vellel",l,function(e){var t=jQuery.parseJSON(e);X=[],t.ok&&(X=sortByKey(t.invs,"ship_date","DSC")),Y=le.updateOptions(X,!1),_()})}else t&&(X=[]),Y=le.updateOptions(X,t),_()}function t(e,t,l,i){if(Z.length||ee.length){for(var a=[],n=0,r=Z.length;n<r;++n){var o=Z[n];if(e){if(o.vessel_price<0)return void bootbox.alert("您选择的运单: "+o.waybill_no+" 已设置为不需要结算, 请先取消不结算,再来结算");if(0===o.vessel_price)return void bootbox.alert("您选择的运单: "+o.waybill_no+" 还未输入价格, 不能继续结算");if(1!=o.receipt)return void bootbox.alert("您选择的运单: "+o.waybill_no+" 还未收到回执, 不能继续结算");"未结算"===o.vessel_settle_state&&a.push(o.waybill_no)}else{if(o.vessel_price<0)return void bootbox.alert("您选择的运单: "+o.waybill_no+" 已设置为不需要结算, 不能取消");"已结算"===o.vessel_settle_state&&a.push(o.waybill_no)}}for(var c=[],d=[],h=0,p=ee.length;h<p;++h){var f=ee[h],m=s(f);if(m){var v=u(m,!1);if(e){if(1!=v[f].receipt)return void bootbox.alert("您选择的内部运单: "+f+" 还未收到回执, 不能继续结算");if(v[f].price<0)return void bootbox.alert("您选择的内部运单: "+f+" 已设置为不需要结算, 请先取消不结算,再来结算");if(0===v[f].price)return void bootbox.alert("您选择的内部运单: "+f+" 还未输入价格, 不能继续结算")}else if(v[f].price<0)return void bootbox.alert("您选择的内部运单: "+f+" 已设置为不需要结算, 不能取消结算");c.indexOf(m.waybill_no)<0&&c.push(m.waybill_no),d.push(m)}}ajaxRequestHandle("/settle_vessel","POST",{allSelectedInvNo:a,allInvNoFromInner:c,allInnerNo:ee,settle:e},"车船结算",function(){Z.forEach(function(e){a.indexOf(e.waybill_no)>=0&&(e.vessel_settle_state=t,e.vessel_settle_date=l,e.vessel_settler=i)}),d.forEach(function(e){e.inner_settle.forEach(function(e){ee.indexOf(e.inner_waybill_no)>=0&&(e.state=t,e.date=l)});var i=u(e,!1);for(var a in i)i.hasOwnProperty(a)&&ee.indexOf(a)>=0&&(i[a].state=t,i[a].date=l)}),_()})}else bootbox.alert("请先选择您要结算或结算取消的行")}function l(e,t,l){if(Z.length||ee.length){for(var i=[],a=0,n=Z.length;a<n;++a){var r=Z[a];i.push(r.waybill_no)}for(var o=[],c=[],d=0,h=ee.length;d<h;++d){var p=ee[d],f=s(p);f&&(o.indexOf(f.waybill_no)<0&&o.push(f.waybill_no),c.push(f))}ajaxRequestHandle("/settle_vessel_pay","POST",{allPayInvNo:i,allInvNoFromInner:o,allInnerNo:ee,forPay:e},"车船结算付款",function(){Z.forEach(function(e){i.indexOf(e.waybill_no)>=0&&(e.vessel_settle_state=t,e.pay_date=l)}),c.forEach(function(e){e.inner_settle.forEach(function(e){ee.indexOf(e.inner_waybill_no)>=0&&(e.state=t,e.pay_date=l)});var i=u(e,!1);for(var a in i)i.hasOwnProperty(a)&&ee.indexOf(a)>=0&&(i[a].state=t,i[a].pay_date=l)}),_()})}}function i(e,t,l){var i="<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td>";return e.block_num>0?i.format(e.bill_no,getOrder(e.order_no,e.order_item_no),e.ship_warehouse?e.ship_warehouse:"",getStrValue(e.thickness),getStrValue(e.width),getStrValue(e.len),getStrValue(e.weight),e.block_num,getStrValue(e.total_weight),t,getStrValue(e.weight*t)):i.format(e.bill_no,getOrder(e.order_no,e.order_item_no),e.ship_warehouse?e.ship_warehouse:"",getStrValue(e.thickness),getStrValue(e.width),getStrValue(e.len),"","",getStrValue(e.total_weight),t,getStrValue(l))}function a(e){var t=window.open();return t?(t.document.write(e.html()),t.print(),t.close(),!0):(bootbox.alert("请允许弹出窗口!"),!1)}function s(e){for(var t=null,l=e.substring(0,17),i=0;i<Y.length;++i)if(l===Y[i].waybill_no){t=Y[i];break}return t}function n(e){var t="no_message";0===e.partInd&&(t="车船结算滞留信息输入"),ajaxRequestHandle("/settle_vessel_delay_info","POST",e,t,function(){0!==e.partInd&&1!==e.partInd||$("#settle-delay-dialog").modal("hide"),e.wnoList.forEach(function(t){var l=t;t.length>17&&(l=t.substring(0,17));for(var i=0;i<Y.length;++i)if(l===Y[i].waybill_no){var a=Y[i];if(t.length>17){var s=u(a,!1);s&&isExist(s[t])&&(0===e.partInd?(s[t].unship_date=e.unshipData.unship_date,s[t].delay_day=e.unshipData.delay_day,s[t].charge_cash=e.unshipData.charge_cash,s[t].charge_oil=e.unshipData.charge_oil,s[t].receipt=e.unshipData.receipt,s[t].remark=e.unshipData.remark):1===e.partInd?(s[t].charge_cash=e.unshipData.charge_cash,s[t].charge_oil=e.unshipData.charge_oil):2===e.partInd?s[t].receipt=e.unshipData.receipt:3===e.partInd&&(s[t].remark=e.unshipData.remark))}else 0===e.partInd?(a.unship_date=e.unshipData.unship_date,a.delay_day=e.unshipData.delay_day,a.charge_cash=e.unshipData.charge_cash,a.charge_oil=e.unshipData.charge_oil,a.receipt=e.unshipData.receipt,a.remark=e.unshipData.remark):1===e.partInd?(a.charge_cash=e.unshipData.charge_cash,a.charge_oil=e.unshipData.charge_oil):2===e.partInd?a.receipt=e.unshipData.receipt:3===e.partInd&&(a.remark=e.unshipData.remark)}});var t=k.find("tr").length;if(2===e.partInd){Q=!Q;for(var l=0;l<t;++l)getRowChildren(k,l).find("td:last").find("input").prop("checked",Q);y(q,"fa-check-square-o","fa-square-o")}else for(var i=0;i<t;++i){var a=getRowChildren(k,i);if(1===e.partInd)e.unshipData.charge_cash>0&&e.unshipData.charge_oil>0?a.find("td").eq(15).text("现金:"+e.unshipData.charge_cash+",油:"+e.unshipData.charge_oil):e.unshipData.charge_cash>0?a.find("td").eq(15).text("现金:"+e.unshipData.charge_cash):e.unshipData.charge_oil>0?a.find("td").eq(15).text("油:"+e.unshipData.charge_oil):a.find("td").eq(15).text("无");else if(0===e.partInd){var s=getTableCellChildren(a,2).text();if(s===e.wnoList[0]){a.find("td").eq(13).text(date2Str(e.unshipData.unship_date)),a.find("td").eq(14).text(e.unshipData.delay_day),e.unshipData.charge_cash>0&&e.unshipData.charge_oil>0?a.find("td").eq(15).text("现金:"+e.unshipData.charge_cash+",油:"+e.unshipData.charge_oil):e.unshipData.charge_cash>0?a.find("td").eq(15).text("现金:"+e.unshipData.charge_cash):e.unshipData.charge_oil>0?a.find("td").eq(15).text("油:"+e.unshipData.charge_oil):a.find("td").eq(15).text("无");var n=a.find("td:last");n.find("input").prop("checked",1===e.unshipData.receipt);var r=n.find("i");e.unshipData.remark?(r.show(),r.prop("title",e.unshipData.remark)):r.hide();break}}}})}function r(){if(setHtmlElementDisabled(x,0===Y.length),Z.length||ee.length){var e=Z.length+ee.length;1===e?(setHtmlElementDisabled(S,!1),setHtmlElementDisabled(L,!1)):(setHtmlElementDisabled(S,!0),setHtmlElementDisabled(L,!0)),setHtmlElementDisabled(C,e<2),setHtmlElementDisabled(O,1!==Z.length),setHtmlElementDisabled(V,!1),setHtmlElementDisabled(H,!1),setHtmlElementDisabled(N,!1),setHtmlElementDisabled(T,!1),setHtmlElementDisabled(B,!1)}else setHtmlElementDisabled(S,!0),setHtmlElementDisabled(C,!0),setHtmlElementDisabled(O,!0),setHtmlElementDisabled(L,!0),setHtmlElementDisabled(V,!0),setHtmlElementDisabled(H,!0),setHtmlElementDisabled(N,!0),setHtmlElementDisabled(T,!0),setHtmlElementDisabled(B,!0)}function o(e,t,l){function i(){var i=[];if(t){var s=h(e.waybill_no);(s>=0||s===-1)&&(e.vessel_price=s,i.push({wno:e.waybill_no,price:s,inner:0}))}else e.bills.forEach(function(e){e.vehicles.forEach(function(e){if(e.inner_waybill_no===l){var t=h(e.inner_waybill_no);(t>=0||t===-1)&&(e.veh_price=t,a[l].price=t,i.push({wno:e.inner_waybill_no,price:t,inner:1}))}})});ajaxRequestHandle("/settle_vessel_price","POST",{wnoList:[e.waybill_no],priceData:i},"no_message",function(){c(e,!0)})}var a=u(e,!1),s='<div class="row form-horizontal"><div class="col-md-10">',n='<div class="form-group"><label for="{0}" class="control-label col-sm-4">{1}</label><div class="input-group col-sm-8"><input id="{2}" type="text" name="{3}" class="form-control" value="{4}"><span style="font-size: 11px">始发: {5}, 目的地: {6}</span></div></div>',r='<div class="form-group"><label for="{0}" class="control-label col-sm-4">{1}</label><div class="input-group col-sm-8"><input id="{2}" type="text" name="{3}" class="form-control" value="{4}" {5}><span style="font-size: 11px">始发: {6}, 发运重量: {7} 吨</span></div></div>';if(t){var o=e.waybill_no;s+=n.format(o,e.vehicle_vessel_name,o,o,getStrValue(e.vessel_price),e.ship_from?e.ship_from:"",e.ship_to)}else{var d="<div><label>目的地为"+e.vehicle_vessel_name+"的车辆价格</label>";if(a&&a[l]){var p=a[l],f=p.price<0?"disabled":"";d+=r.format(l,p.name,l,l,getStrValue(p.price),f,p.ship_from?p.ship_from:"",getStrValue(p.weight))}s+=d+"</div>"}s+="</div>",bootbox.dialog({message:s,title:"单行价格输入",buttons:{cancel:{label:"取消",className:"btn-default"},main:{label:"确定",className:"btn-primary",callback:i}}})}function c(e,t){for(var l,i=e.vessel_price<0?"darkgray":"red",a=u(e,!1),s=w(a,e),n=k.find("tr").length,r=0;r<n;++r){l=getRowChildren(k,r);var o=getTableCellChildren(l,2).text();if(e.waybill_no===o)t&&(l.find("td").eq(0).find("label").css("color",i),l.find("td").eq(7).html(s.priceText),e.vessel_price<0?l.find("td").eq(8).text("无"):l.find("td").eq(8).text(getStrValue(e.vessel_price))),l.find("td").eq(1).html(getStrByStatus(e.vessel_settle_state,e.vessel_settle_state)),l.find("td").eq(12).text(date2Str(e.vessel_settle_date));else if(a&&isExist(a[o])){var c=a[o];t&&(c.price<0?(l.find("td").eq(0).find("label").css("color","darkgray"),l.find("td").eq(7).text("无"),l.find("td").eq(8).text("无")):(l.find("td").eq(0).find("label").css("color","red"),l.find("td").eq(7).text(getStrValue(c.price*c.weight)),l.find("td").eq(8).text(getStrValue(c.price)))),l.find("td").eq(1).html(getStrByStatus(c.state,c.state)),l.find("td").eq(12).text(date2Str(c.date))}}}function d(){function e(){var e="",i={},a={};t.forEach(function(t){e=t.replace(/[\s\(\)#]+/g,"999")+"999";var l=h(e);(l>0||l===-1)&&(i[t]=l)}),l.forEach(function(t){e=t.replace(/[\s\(\)#]+/g,"888")+"888";var l=h(e);(l>0||l===-1)&&(a[t]=l)});var n=[],r=[],o=[];Z.forEach(function(e){var t=i[e.vehicle_vessel_name];(t>0||t===-1)&&(e.vessel_price=t,r.push(e.waybill_no),o.push({wno:e.waybill_no,price:t,inner:0}),n.push(e))}),ee.forEach(function(e){var t=s(e);t.bills.forEach(function(l){l.vehicles.forEach(function(l){if(l.inner_waybill_no===e){var i=a[l.veh_name];if(i>0||i===-1){l.veh_price=i,r.indexOf(t.waybill_no)<0&&r.push(t.waybill_no),o.push({wno:e,price:i,inner:1});var s=u(t,!1);s&&(s[e].price=i),n.push(t)}}})})}),o.length&&ajaxRequestHandle("/settle_vessel_price","POST",{wnoList:r,priceData:o},"no_message",function(){n.forEach(function(e){c(e,!0)})})}var t=[],l=[];Z.forEach(function(e){t.indexOf(e.vehicle_vessel_name)<0&&t.push(e.vehicle_vessel_name)}),ee.forEach(function(e){var t=s(e);t.bills.forEach(function(t){t.vehicles.forEach(function(t){t.inner_waybill_no===e&&l.indexOf(t.veh_name)<0&&l.push(t.veh_name)})})});var i='<div class="row form-horizontal"><div class="col-md-10">',a='<div class="form-group"><label for="{0}" class="control-label col-sm-4">{1}</label><div class="input-group col-sm-8"><input id="{2}" type="text" name="{3}" class="form-control"></div></div>',n="";if(t.forEach(function(e){n=e.replace(/[\s\(\)#]+/g,"999")+"999",i+=a.format(n,e,n,n)}),l.length){var r='<div class="col-md-12"><label>目的地为(船)的车辆</label>';l.forEach(function(e){n=e.replace(/[\s\(\)#]+/g,"888")+"888",r+=a.format(n,e,n,n)}),i+=r+"</div>"}i+="</div></div>",bootbox.dialog({message:i,title:"批量输入价格",buttons:{cancel:{label:"取消",className:"btn-default",callback:function(){}},main:{label:"确定",className:"btn-primary",callback:e}}})}function h(e){var t="#"+e,l=parseFloatHTML($(t).val());return isNaN(l)||0==l?0:l}function p(e){var t=[];e.bills.forEach(function(e){t.push.apply(t,e.vehicles)});var l={};return t.forEach(function(e){isExist(l[e.inner_waybill_no])?(l[e.inner_waybill_no].num+=e.send_num,l[e.inner_waybill_no].weight+=e.send_weight):l[e.inner_waybill_no]={name:e.veh_name,num:e.send_num,weight:e.send_weight,price:isExist(e.veh_price)?e.veh_price:0,ship_from:e.veh_ship_from,state:"未结算",date:null,unship_date:null,delay_day:0,charge_cash:0,charge_oil:0,receipt:0,remark:"",pay_date:null}}),isExist(e.inner_settle)&&!isEmpty(e.inner_settle)&&e.inner_settle.forEach(function(e){l[e.inner_waybill_no].state=e.state,l[e.inner_waybill_no].date=e.date,l[e.inner_waybill_no].unship_date=e.unship_date,l[e.inner_waybill_no].delay_day=e.delay_day,l[e.inner_waybill_no].charge_cash=e.charge_cash,l[e.inner_waybill_no].charge_oil=e.charge_oil,l[e.inner_waybill_no].receipt=e.receipt,l[e.inner_waybill_no].remark=e.remark,l[e.inner_waybill_no].pay_date=e.pay_date}),l}function u(e,t){for(var l,i=!1,a=0,s=te.length;a<s;++a)if(e.waybill_no===te[a].wno){l=te[a].vehInfo,i=!0;break}return!i&&t&&(l=p(e),te.push({wno:e.waybill_no,vehInfo:l})),l}function f(e,t,l,i,a){var s="不需要结算"===e?"gray":"red",n=a?"":"display:none",r=1===t?"checked":"",o='<input class="select-receipt" type="checkbox" disabled '+r+'>&nbsp;<i class="fa fa-info-circle" style="color:red; cursor:pointer; '+n+'" data-toggle="tooltip" title="'+a+'"></i>',c="无";return l>0&&i>0?c="现金:"+l+",油:"+i:l>0?c="现金:"+l:i>0&&(c="油:"+i),{state:getStrByStatus(e,e),color:s,ckReceipt:o,chargeText:c}}function m(e){var t=!1,l=null,i=0;e.bills.forEach(function(a){i+=a.num,!t&&a.vehicles.length&&(t=!0,l=u(e,!0))});var a=!0,s=!0,n=e.ship_name+(e.ship_customer?"/"+e.ship_customer:""),r=le.getVehicleName();if((!r||r===e.vehicle_vessel_name)&&le.settledState===e.vessel_settle_state){a=1===e.receipt,s=e.vessel_price<0;var o=f(e.vessel_settle_state,e.receipt,e.charge_cash,e.charge_oil,e.remark),c='<tr class="tr_header"><td nowrap><input class="select-inv" type="checkbox">&nbsp;<label class="fa fa-star-o not-need-settle" data-toggle="tooltip" title="点击可设置不需要结算和需要结算" style="cursor:pointer; color:'+o.color+'; font-size:18px;"></label>';t&&(c+='&nbsp;<span data-toggle="tooltip" title="点击展开和收缩" style="cursor:pointer;font-size: 16px;" class="fa fa-minus-square-o expand"></span>'),c+='</td><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td nowrap>{14}</td><td style="text-align: center">{15}</td></tr>';var d=w(l,e);F+=d.price,I+=e.total_weight,e.charge_cash>0&&(R+=e.charge_cash),e.charge_oil>0&&(R+=e.charge_oil),k.append(c.format(o.state,e.waybill_no,e.vehicle_vessel_name+"/"+local_data.vehPersonMap[e.vehicle_vessel_name],n,e.ship_from,e.ship_to,d.priceText,e.vessel_price<0?"无":getStrValue(e.vessel_price),i,getStrValue(e.total_weight),date2Str(e.ship_date),date2Str(e.vessel_settle_date),date2Str(e.unship_date,!0),e.delay_day,o.chargeText,o.ckReceipt))}if(t){var h='<tr class="vessel_sub_item" style="background: #e0e4f0;"><td nowrap><input class="select-sub-inv" type="checkbox">&nbsp;<label class="fa fa-star-o not-need-settle" data-toggle="tooltip" title="点击可设置不需要结算和需要结算" style="cursor:pointer; color:{16}; font-size:18px;"></label></td><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td nowrap>{14}</td><td style="text-align: center">{15}</td></tr>';for(var p in l)if(l.hasOwnProperty(p)&&(!r||r===l[p].name)&&le.settledState===l[p].state){var m=l[p],_="无",v="无";if(I+=m.weight,m.price>=0){var g=m.price*m.weight;_=getStrValue(m.price),v=getStrValue(g),F+=g}m.charge_cash>0&&(R+=m.charge_cash),m.charge_oil>0&&(R+=m.charge_oil),a=a&&1===m.receipt,s=s&&m.price<0,o=f(m.state,m.receipt,m.charge_cash,m.charge_oil,m.remark),k.append(h.format(o.state,p,m.name+"/"+local_data.vehPersonMap[m.name],n,m.ship_from?m.ship_from:"",e.vehicle_vessel_name,v,_,m.num,getStrValue(m.weight),date2Str(e.ship_date),date2Str(m.date),date2Str(m.unship_date,!0),m.delay_day,o.chargeText,o.ckReceipt,o.color))}}return{receiptOk:a,notNeed:s}}function _(){k.empty(),Z=[],ee=[],F=0,I=0,R=0;var e=!0;Y.forEach(function(t){var l=m(t);l.receiptOk||(Q=!1),l.notNeed||(e=!1)}),Q?(q.addClass("fa-check-square-o"),q.removeClass("fa-square-o")):(q.removeClass("fa-check-square-o"),q.addClass("fa-square-o")),e?$("#all-not-need").css("color","gray"):$("#all-not-need").css("color","red"),$("#lb-total-weight").text(getStrValue(I)),$("#lb-total-amount").text(getStrValue(F)),$("#curr-number").text(k.find("tr").length),$("#lb-unpay-amount").text(getStrValue(F-R)),$("#select-all").prop("checked",!1),r(),$(".tr_header").on("click",function(){g($(this),!0)}),$(".vessel_sub_item").on("click",function(){v($(this),!0)}),$(".select-inv").on("click",function(){g($(this).closest("tr"),!1)}),$(".select-sub-inv").on("click",function(){v($(this).closest("tr"),!1)}),$(".expand").on("click",function(e){e.stopImmediatePropagation();var t=$(this),l=t.closest("tr");y(t,"fa-plus-square-o","fa-minus-square-o"),l.nextUntil("tr.tr_header").slideToggle(100,function(){})}),$(".not-need-settle").on("click",function(e){if(e.stopImmediatePropagation(),"未结算"===le.settledState){var t=$(this),l=t.closest("tr"),i=getTableCellChildren(l,2).text();b(t,[i])}else bootbox.alert('已结算,不能再进行"不需要结算操作"')}),$('[data-toggle="popover"]').popover({trigger:"hover",html:!0,placement:"bottom"})}function v(e,t){var l=getTableCellChildren(e,2).text(),i=ee.indexOf(l);i<0?ee.push(l):ee.remove(i),t&&e.find("td:first").find('input[type="checkbox"]').prop("checked",i<0),$("#select-all").prop("checked",Z.length+ee.length===k.find("tr").length),r()}function g(e,t){if(e.hasClass("tr_header")){for(var l=getTableCellChildren(e,2).text(),i=!1,a=0;a<Z.length;++a)if(l===Z[a].waybill_no){Z.remove(a),i=!0;break}if(i)e.removeClass("invoice-highlighted");else{for(var s=0,n=Y.length;s<n;++s)if(l===Y[s].waybill_no){Z.push(Y[s]);break}e.addClass("invoice-highlighted")}t&&e.find("td:first").find('input[type="checkbox"]').prop("checked",!i),$("#select-all").prop("checked",Z.length+ee.length===k.find("tr").length),r()}}function b(e,t){var l=e.css("color");"rgb(255, 0, 0)"===l?(e.css("color","gray"),E(t,!0)):(e.css("color","red"),E(t,!1))}function y(e,t,l){e.hasClass(t)?(e.addClass(l),e.removeClass(t)):e.hasClass(l)&&(e.addClass(t),e.removeClass(l))}function E(e,t){ajaxRequestHandle("/settle_vessel_not_needed","POST",{wayNoList:e,notNeeded:t},"no_message",function(){e.forEach(function(e){var l=e;e.length>17&&(l=e.substring(0,17));for(var i=0;i<Y.length;++i)if(l===Y[i].waybill_no){var a=Y[i];if(e.length>17){a.bills.forEach(function(l){l.vehicles.forEach(function(l){e===l.inner_waybill_no&&(l.veh_price=t?-1:0)})});var s=u(a,!1);s&&isExist(s[e])&&(t?(s[e].price=-1,s[e].date=new Date,s[e].state="不需要结算"):(s[e].price=0,s[e].date=null,s[e].state="未结算")),a.inner_settle.forEach(function(l){l.inner_waybill_no===e&&(t?(l.date=new Date,l.state="不需要结算"):(l.date=null,l.state="未结算"))})}else t?(a.vessel_price=-1,a.vessel_settle_state="不需要结算",a.vessel_settle_date=new Date):(a.vessel_price=0,a.vessel_settle_state="未结算",a.vessel_settle_date=null);c(a,!0);break}})})}function w(e,t){var l="";if(t.vessel_price>0&&(l+="车船号:{0}, 发运重量:{1}, 单价:{2}, 目的地:{3}".format(t.vehicle_vessel_name,getStrValue(t.total_weight),getStrValue(t.vessel_price),t.ship_to)),e){var i=1;for(var a in e)e.hasOwnProperty(a)&&(l+="\r第{0}车: {1}, 发运重量:{2}, 单价:{3}, 目的地:{4}".format(i,e[a].name,getStrValue(e[a].weight),e[a].price<0?"无":getStrValue(e[a].price),t.vehicle_vessel_name),++i)}if(t.vessel_price<0)return{priceText:'<code style="color: darkgray">无</code>',tooltip:l,price:0};var s=t.vessel_price*t.total_weight;return{priceText:'<code style="color: blue">'+getStrValue(s)+"</code>",tooltip:l,price:s}}var k=$("#table-tbody"),D=$("#filter"),x=$("#search-export"),S=$("#single-price-input"),C=$("#batch-price-input"),V=$("#settle-bill"),H=$("#settle-bill-cancel"),T=$("#settle-pay"),B=$("#settle-pay-cancel"),O=$("#show-detail"),N=$("#settle-print-detail"),L=$("#delay-info"),q=$("#receipt-icon"),P=$("#print-detail-tbody"),F=0,I=0,R=0,Q=!0,M=$("#charge-cash"),j=$("#charge-oil"),z=$("#unpay-block"),G=$("#unship-date-grp"),A=$("#delay-day"),J=$("#sdd_receipt"),U=$("#delay-remark"),K=!1,W=!1,X=[],Y=[],Z=[],ee=[],te=[];$("#first-th").html('<input id="select-all" type="checkbox" data-toggle="tooltip" title="选择所有记录" />&nbsp;<label id="all-not-need" class="fa fa-star-o" data-toggle="tooltip" title="点击可设置不需要结算和需要结算" style="cursor:pointer; color:red; font-size:18px;" ></label>');var le=new QueryFilterD(local_data);le.eventHandler(e),showHtmlElement(V,!0),showHtmlElement(H,!1),showHtmlElement(T,!1),showHtmlElement(B,!1),showHtmlElement(N,!1),showHtmlElement(z,!1),r(),elementEventRegister(S,"click",function(){if(1===Z.length)o(Z[0],!0);else{var e=s(ee[0]);o(e,!1,ee[0])}}),elementEventRegister(C,"click",d),elementEventRegister($("#select-all"),"click",function(){var e=$(this).is(":checked");if(Y.length){if(Z=[],ee=[],e){for(var t=k.find("tr").length,l=0;l<t;++l){var i=getRowChildren(k,l),a=getTableCellChildren(i,2).text();if(a.length>17)ee.push(a);else for(var s=0;s<Y.length;++s)if(a===Y[s].waybill_no){Z.push(Y[s]);break}}$(".tr_header").addClass("invoice-highlighted")}else $(".tr_header").removeClass("invoice-highlighted");$(".select-inv").prop("checked",e),$(".select-sub-inv").prop("checked",e),r()}}),$("#all-not-need").on("click",function(){if(Y.length)if("未结算"===le.settledState){for(var e=$(this),t=[],l=k.find("tr").length,i=0;i<l;++i){var a=getRowChildren(k,i);t.push(getTableCellChildren(a,2).text())}bootbox.confirm("您确定要批量不结算操作",function(l){l&&b(e,t)})}else bootbox.alert("在已结算状态下不能进行此操作")}),elementEventRegister(V,"click",function(){t(!0,"已结算",new Date,local_user_name)}),elementEventRegister(H,"click",function(){t(!1,"未结算","","")}),elementEventRegister(T,"click",function(){l(!0,"已付款",new Date)}),elementEventRegister(B,"click",function(){l(!1,"已结算","")}),elementEventRegister(O,"click",function(){if(Z.length>0){var e=Z[0],t=!1;e.bills.forEach(function(e){e.vehicles.length&&(t=!0)}),$.get("/get_waybill",{q:e.waybill_no},function(l){var a=jQuery.parseJSON(l),s=a.bills,n="";s.forEach(function(t){for(var l=0;l<e.bills.length;++l){var a=e.bills[l];if(String(t._id)===String(a.bill_id)){if(n+=i(t,a.num,a.weight),a.vehicles.length){var s="";a.vehicles.forEach(function(e){s="{0}, <code>{1}</code><code>{2}</code><br />".format(e.veh_name,e.send_num,getStrValue(e.send_weight))}),n+="<td>"+s+"</td></tr>"}else n+="<td></td></tr>";break}}}),$("#tb-detail-tbody").html(n),showHtmlElement($("#tb-detail th:last-child, #tb-detail td:last-child"),t),$("#settle-detail-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")})}}),N.on("click",function(){if(Z.length||ee.length){P.empty();for(var e='<tr><td style="border:1px solid black;padding:5px;">{0}</td><td style="border:1px solid black;padding:5px;">{1}</td><td style="border:1px solid black;padding:5px;">{2}</td><td style="border:1px solid black;padding:5px;">{3}</td><td style="border:1px solid black;padding:5px;">{4}</td><td style="border:1px solid black;padding:5px;">{5}</td><td style="border:1px solid black;padding:5px;">{6}</td><td style="border:1px solid black;padding:5px;">{7}</td><td style="border:1px solid black;padding:5px;">{8}</td><td style="border:1px solid black;padding:5px;">{9}</td></tr>',t=0,l=0,i=0,a=k.find("tr").length,s=0;s<a;++s){var n=getRowChildren(k,s),r=getTableCellChildren(n,0).find("input");if(r.is(":checked")){var o=getTableCellChildren(n,10).text(),c=getTableCellChildren(n,7).text();P.append(e.format(getTableCellChildren(n,3).text(),getTableCellChildren(n,4).text(),getTableCellChildren(n,5).text(),getTableCellChildren(n,6).text(),o,getTableCellChildren(n,8).text(),c,getTableCellChildren(n,11).text(),getTableCellChildren(n,14).text(),getTableCellChildren(n,15).text())),t+=+o,l+=+c;var d=getTableCellChildren(n,15).text();if("无"!=d){var h=d.split(":");if(3===h.length){i+=+h[2];var p=h[1].split(",")[0];i+=+p}else 2===h.length&&(i+=+h[1])}}}$("#print-total-weight").text(getStrValue(t)),$("#print-total-number").text(getStrValue(l)),$("#print-unpay-number").text(getStrValue(l-i)),$("#settle-print-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}else bootbox.alert("请选择你要打印的清单列表")}),$("#print-to").on("click",function(){a($("#print-div"))}),$("#print-and-pay").on("click",function(){a($("#print-div"))&&l(!0,"已付款",new Date)}),G.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(){if(K)K=!1;else{var e=G.data("DateTimePicker").getDate();if(e){var t=1===Z.length?Z[0]:s(ee[0]);if(t){var l=e.diff(t.ship_date,"days")-7;l>0?A.val(l):A.val("0")}}}}),A.on("keyup paste",function(){var e=parseInt(this.value);if(e>0){var t=1===Z.length?Z[0]:s(ee[0]);t&&(K=!0,G.data("DateTimePicker").setDate(moment(t.ship_date).add(e+7,"days")))}}),elementEventRegister(J,"ifChecked",function(){W=!0}),elementEventRegister(J,"ifUnchecked",function(){W=!1}),elementEventRegister(L,"click",function(){var e=1===Z.length?Z[0]:s(ee[0]);if(1===Z.length)M.val(e.charge_cash),j.val(e.charge_oil),A.val(e.delay_day),G.data("DateTimePicker").setMinDate(moment(e.ship_date)),G.data("DateTimePicker").setDate(e.unship_date?moment(e.unship_date):null),J.iCheck(1===e.receipt?"check":"uncheck"),U.val(e.remark?e.remark:"");else{var t=ee[0],l=u(e,!1);if(l&&l[t]){var i=l[t];M.val(i.charge_cash),j.val(i.charge_oil),A.val(i.delay_day),G.data("DateTimePicker").setMinDate(moment(e.ship_date)),G.data("DateTimePicker").setDate(i.unship_date?moment(i.unship_date):null),J.iCheck(1===i.receipt?"check":"uncheck"),U.val(i.remark?i.remark:"")}}showHtmlElement($("#delay_receipt"),!0),$("#settle-delay-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}),$("#batch-charge-ctrl").on("click",function(){M.val("0"),j.val("0"),showHtmlElement($("#delay_receipt"),!1),$("#settle-delay-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}),$("#batch-receipt-ctrl").on("click",function(){for(var e=[],t=k.find("tr").length,l=0;l<t;++l){var i=getRowChildren(k,l);e.push(getTableCellChildren(i,2).text())}var a={receipt:Q?0:1};n({unshipData:a,wnoList:e,partInd:2})}),$("#settle-delay-btn-ok").on("click",function(){var e={charge_cash:M.val(),charge_oil:j.val()};if("none"==$("#delay_receipt").css("display")){for(var t=[],l=k.find("tr").length,i=0;i<l;++i){var a=getRowChildren(k,i);t.push(getTableCellChildren(a,2).text())}n({unshipData:e,wnoList:t,partInd:1})}else{e.unship_date=G.data("DateTimePicker").getDate(),e.delay_day=A.val(),e.receipt=W?1:0,e.remark=U.val();var s=1===Z.length?Z[0].waybill_no:ee[0];n({unshipData:e,wnoList:[s],partInd:0})}}),elementEventRegister(x,"click",function(){tableToExcel($("#table-content").html(),"data")}),elementEventRegister(D,"click",function(){$("#filter-ui").toggle()})});var QueryFilterD=function(e){this.uiElems={sBfBillName:$("#bf-bill-name"),sBfDest:$("#bf-destination"),sBfVehicle:$("#bf-vehicle"),sBfVehContact:$("#bf-vehicle-contact"),startDateGrp:$("#start-date-grp"),endDateGrp:$("#end-date-grp"),iStartDate:$("#start-date"),iEndDate:$("#end-date"),rSettled:$("#vessel-settled"),rNoSettled:$("#no-vessel-settled"),rSettledPay:$("#vessel-pay"),rSettledNotNeeded:$("#vessel-no-need-settled")},this.options=e,initSelect(this.uiElems.sBfBillName,e.nameList,!0),initSelect(this.uiElems.sBfVehicle,e.vehList,!0),initSelect(this.uiElems.sBfDest,e.destList,!0),initSelect(this.uiElems.sBfVehContact,e.contactNameList,!0),this.uiElems.rNoSettled.iCheck("check"),this.uiElems.iStartDate.val(""),this.uiElems.iEndDate.val(""),this.uiElems.sBfVehicle.select2({allowClear:!0}),this.selectedVeh,this.currSelected=0,this.settledState="未结算",this.sDate=null,this.eDate=null,this._selectFliterFunc=function(e,t){this.currSelected=e,this.isAllEmpty()?t(!1,!0):t(!0,!1)},this._dateFilterFunc=function(e,t,l){var i=this.uiElems.iStartDate.val(),a=this.uiElems.iEndDate.val(),s=!1;e&&t?s=!isEmpty(i)&&!isEmpty(a):e?s=isEmpty(this.uiElems.iStartDate.val()):t&&(s=isEmpty(this.uiElems.iEndDate.val())),s&&(this.currSelected=5,l(!0,!1))}};QueryFilterD.prototype.getQueryParams=function(){var e=getSelectValue(this.uiElems.sBfBillName),t=getSelectValue(this.uiElems.sBfDest),l=this.uiElems.iStartDate.val(),i=this.uiElems.iEndDate.val(),a=!isEmpty(l)&&!isEmpty(i);return{fName:e?e:null,fVeh:this.selectedVeh?this.selectedVeh:null,fDest:t?t:null,fSettledState:this.settledState,fDate1:a?this.sDate.toISOString():null,fDate2:a?this.eDate.toISOString():null}},QueryFilterD.prototype.getVehicleName=function(){return this.selectedVeh},QueryFilterD.prototype.eventHandler=function(e){var t=this;t.uiElems.sBfBillName.on("change",function(){t._selectFliterFunc(1,e)}),t.uiElems.rNoSettled.on("ifChecked",function(){t.settledState="未结算",t._selectFliterFunc(2,e)}),t.uiElems.rSettled.on("ifChecked",function(){t.settledState="已结算",t._selectFliterFunc(2,e)}),t.uiElems.rSettledPay.on("ifChecked",function(){t.settledState="已付款",t._selectFliterFunc(2,e)}),t.uiElems.rSettledNotNeeded.on("ifChecked",function(){t.settledState="不需要结算",t._selectFliterFunc(2,e)}),t.uiElems.sBfVehicle.on("change",function(l){t.selectedVeh=l.val,"无-取消选择"===t.selectedVeh&&(t.selectedVeh=""),t._selectFliterFunc(3,e)}),t.uiElems.sBfVehContact.on("change",function(){t.currSelected=6,e(!1,!1)}),t.uiElems.sBfDest.on("change",function(){t._selectFliterFunc(4,e)}),t.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(l){l.preventDefault(),l.stopImmediatePropagation(),t.sDate=l.date.startOf("day"),t.uiElems.endDateGrp.data("DateTimePicker").setMinDate(l.date),t._dateFilterFunc(!0,!0,e)}),t.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(l){l.preventDefault(),l.stopImmediatePropagation(),t.eDate=l.date.endOf("day"),t.uiElems.startDateGrp.data("DateTimePicker").setMaxDate(l.date),t._dateFilterFunc(!0,!0,e)}),t.uiElems.iStartDate.on("change",function(l){l.stopImmediatePropagation(),t._dateFilterFunc(!0,!1,e)}),t.uiElems.iEndDate.on("change",function(l){l.stopImmediatePropagation(),t._dateFilterFunc(!1,!0,e)})},QueryFilterD.prototype.isAllEmpty=function(){var e=getSelectValue(this.uiElems.sBfDest),t=getSelectValue(this.uiElems.sBfBillName),l=this.uiElems.iStartDate.val(),i=this.uiElems.iEndDate.val();return isEmpty(this.selectedVeh)&&isEmpty(e)&&isEmpty(t)&&isEmpty(l)&&isEmpty(i)},QueryFilterD.prototype.updateOptions=function(e,t){var l=this.selectedVeh,i=getSelectValue(this.uiElems.sBfVehContact),a=getSelectValue(this.uiElems.sBfDest),s=getSelectValue(this.uiElems.sBfBillName),n={vehList:[],destList:[],contactNameList:[]},r=[],o=!1;if(6!==this.currSelected||i||(l="",this.selectedVeh="",o=!0),l||3!==this.currSelected||(i=null),t)n=this.options,r=e,e.forEach(function(e){e.ship_to&&n.destList.indexOf(e.ship_to)<0&&n.destList.push(e.ship_to)});else{var c,d,h=[],p=[],u=[];if(i){var f=this.options.vehPersonMap;for(var m in f)f[m]===i&&u.push(m)}if(e.forEach(function(e){var t=!1;if(o)t=!1;else if(u.length){if(u.indexOf(e.vehicle_vessel_name)>=0)t=!0;else for(c=0;c<e.bills.length;++c)for(d=0;d<e.bills[c].vehicles.length&&!t;++d)if(u.indexOf(e.bills[c].vehicles[d].veh_name)>=0){t=!0;break}}else if(l){if(l===e.vehicle_vessel_name)t=!0;else for(c=0;c<e.bills.length;++c)for(d=0;d<e.bills[c].vehicles.length&&!t;++d)if(e.bills[c].vehicles[d].veh_name===l){t=!0;break}}else t=!0;var i=!a||a===e.ship_to,n=!s||s===e.ship_name;if(t&&i&&n&&(r.push(e),e.ship_to&&p.indexOf(e.ship_to)<0&&p.push(e.ship_to),0===u.length))for(e.vehicle_vessel_name&&h.indexOf(e.vehicle_vessel_name)<0&&h.push(e.vehicle_vessel_name),c=0;c<e.bills.length;++c)for(d=0;d<e.bills[c].vehicles.length;++d)h.indexOf(e.bills[c].vehicles[d].veh_name)<0&&h.push(e.bills[c].vehicles[d].veh_name)}),n.vehList=sort_pinyin(u.length?u:h),n.destList=sort_pinyin(p),6===this.currSelected)this.isAllEmpty()&&!i&&(n.vehList=this.options.vehList,n.destList=this.options.destList);else if(n.vehList.length){var _=this.options.vehPersonMap;n.vehList.forEach(function(e){var t=_[e];t&&n.contactNameList.indexOf(t)<0&&n.contactNameList.push(t)}),n.contactNameList=sort_pinyin(n.contactNameList);
}}var v=l?this.options.vehPersonMap[l]:null;return 2===this.currSelected?(initSelect(this.uiElems.sBfVehicle,n.vehList,!0),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),initSelect(this.uiElems.sBfDest,n.destList,!0,a),initSelect(this.uiElems.sBfVehContact,n.contactNameList,!0,v)):3===this.currSelected?(initSelect(this.uiElems.sBfDest,n.destList,!0,a),v?this.uiElems.sBfVehContact.val(v):unselected(this.uiElems.sBfVehContact)):6===this.currSelected?(initSelect(this.uiElems.sBfVehicle,n.vehList,!0),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),initSelect(this.uiElems.sBfDest,n.destList,!0),i||initSelect(this.uiElems.sBfVehContact,this.options.contactNameList,!0)):4===this.currSelected?(initSelect(this.uiElems.sBfVehicle,n.vehList,!0),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),initSelect(this.uiElems.sBfVehContact,n.contactNameList,!0,v)):(initSelect(this.uiElems.sBfVehicle,n.vehList,!0),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),initSelect(this.uiElems.sBfDest,n.destList,!0,a),initSelect(this.uiElems.sBfVehContact,n.contactNameList,!0,v)),r};
//# sourceMappingURL=settle_vessel.js.map
