{"version":3,"sources":["shipping_charge.js"],"names":["$","tableBody","btnExport","btnShowDetail","btnPrintDetail","printBody","dbRecords","curr_records","selected_records","prices","undefined","qFilter","QueryFilterD","local_data","buildTableTr","bill","send_num","send_weight","str","block_num","format","bill_no","getOrder","order_no","order_item_no","ship_warehouse","getStrValue","thickness","width","len","weight","total_weight","customer_price","collection_price","eventHandler","needUpdateDbData","emptyDbData","get","getQueryParams","data","result","jQuery","parseJSON","ok","hint","msg","num","bootbox","alert","sortByKey","invs","updateOptions","resetTableRow","elementEventRegister","length","inv","isVessel","bills","forEach","vehicles","q","waybill_no","allBills","html","b","p","i","ib","String","_id","bill_id","veh","veh_price","veh_name","showHtmlElement","modal","backdrop","keyboard","on","empty","trStr","totWeight","totPrice","numOfRow","find","tr","getRowChildren","getTableCellChildren","is","w","text","append","window","open","document","write","print","close","makeTableTrHtml","number","state","receipt","mode","charge_value","remark","color","ckReceipt","name","ship_name","ship_customer","paramText","vessel_settle_state","advance_charge_mode","advance_charge","getStrByStatus","chargeText","trHtml","pText","vehObj","tip","vessel_price","vehicle_vessel_name","ship_to","key","hasOwnProperty","price","priceText","tooltip","getInvVesselPriceText","cust_price","net_income","date2Str","ship_date","shipper","me","hasClass","removeClass","wno","k","l","push","addClass","selectRow","this","popover","trigger","placement","tableToExcel","options","uiElems","sBfBillName","sBfDest","sBfVehicle","startDateGrp","endDateGrp","iStartDate","iEndDate","sBfShipper","initSelect","destination","users","val","select2","allowClear","currSelected","first","selectedVeh","selectedName","selectedDest","selectedUser","sDate","eDate","_selectFliterFunc","which","value","filter","_dateFilterFunc","isStart","isEnd","d1","d2","isEmpty","_initSelect","nOptions","prototype","fName","fVeh","fDest","fShipper","fDate1","toISOString","fDate2","getVehicleName","self","e","datetimepicker","getDateTimePickerOptions","preventDefault","stopImmediatePropagation","date","startOf","setMinDate","endOf","setMaxDate","isAllEmpty","getSelectValue","records","vehicle","dest","m","vName","vList","dList","rec","indexOf","b2","b3","b4","sort_pinyin"],"mappings":"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","file":"shipping_charge.js","sourcesContent":["/**\r\n * Created by jzefan on 2018/3/4.\r\n */\r\n\r\n$(function () {\r\n  \"use strict\";\r\n\r\n  var tableBody        = $('#table-tbody');\r\n  var btnExport        = $('#search-export');\r\n  var btnShowDetail    = $('#show-detail');\r\n  var btnPrintDetail   = $('#settle-print-detail');\r\n  var printBody        = $('#print-detail-tbody');\r\n  var totalAmount = 0;\r\n  var totalWeight = 0;\r\n\r\n  var dbRecords =    [];\r\n  var curr_records = []; // 存放查询得到的所有记录\r\n  var selected_records = [];\r\n  var prices = undefined;\r\n\r\n  var qFilter = new QueryFilterD(local_data);\r\n  qFilter.eventHandler(filterData);\r\n\r\n  function filterData(needUpdateDbData, emptyDbData) {\r\n    if (needUpdateDbData) {\r\n      $.get('/get_invoice_report', qFilter.getQueryParams(), function (data) {\r\n        var result = jQuery.parseJSON(data);\r\n        dbRecords = [];\r\n        if (result.ok) {\r\n          if (result.hint) {\r\n            var msg = '查询到的数据记录为：' + result.num + ', (全部显示会比较慢，请进一步缩小查询条件！)';\r\n            bootbox.alert(msg);\r\n            prices = undefined;\r\n          } else {\r\n            prices = result.prices;\r\n          }\r\n\r\n          dbRecords = sortByKey(result.invs, \"ship_date\", \"DSC\");\r\n          curr_records = sortByKey(result.invs, \"ship_date\", \"DSC\");\r\n        } else {\r\n          curr_records = [];\r\n        }\r\n\r\n        qFilter.updateOptions(curr_records);\r\n        resetTableRow();\r\n      });\r\n    } else {\r\n      if (emptyDbData) {\r\n        dbRecords = [];\r\n      }\r\n      curr_records = qFilter.updateOptions(dbRecords);\r\n      resetTableRow();\r\n    }\r\n  }\r\n\r\n  elementEventRegister(btnShowDetail, 'click', function() {\r\n    if (selected_records.length > 0) {\r\n      var inv = selected_records[0];\r\n      var isVessel = false;\r\n      inv.bills.forEach(function (bill) {\r\n        if (bill.vehicles.length) {\r\n          isVessel = true;\r\n        }\r\n      });\r\n\r\n      $.get('/get_waybill', { q: inv.waybill_no }, function (data) {\r\n        var obj = jQuery.parseJSON(data); // bills: bills, invoices: invoices\r\n        var allBills = obj.bills;\r\n        var html = \"\";\r\n        allBills.forEach(function (b) {\r\n          var p = 0;\r\n          if (b.customer_price > 0) {\r\n            p = b.collection_price > 0 ? b.collection_price + b.customer_price : b.customer_price;\r\n          } else {\r\n            p = b.collection_price > 0 ? b.collection_price : 0;\r\n          }\r\n\r\n          for (var i = 0; i < inv.bills.length; ++i) {\r\n            var ib = inv.bills[i];\r\n            if (String(b._id) === String(ib.bill_id)) {\r\n              html += buildTableTr(b, ib.num, ib.weight);\r\n\r\n              var w = 0;\r\n              var vp = 18; // 船只固定要18元;\r\n              if (ib.weight > 0) {\r\n                w = p * ib.weight;\r\n              } else {\r\n                if (ib.vehicles.length) {\r\n                  ib.vehicles.forEach(function (veh) {\r\n                    w += veh.send_weight;\r\n                    vp += veh.send_weight * veh.veh_price;\r\n                  });\r\n                } else if (b.block_num > 0) {\r\n                  w = ib.num * b.weight;\r\n                }\r\n              }\r\n\r\n              //customer_price += p * w;\r\n              //veh_price += vp;\r\n\r\n\r\n              if (ib.vehicles.length) {\r\n                var str = \"\";\r\n                ib.vehicles.forEach(function (veh) {\r\n                  str = \"{0}, <code>重量:{1}</code><code>单价:{2}</code><code>价格:{3}</code><br />\".format(veh.veh_name,\r\n                    getStrValue(veh.send_weight), getStrValue(veh.veh_price),\r\n                    veh.veh_price > 0 ? getStrValue(veh.veh_price * veh.send_weight) : 0);\r\n                });\r\n                html += \"<td>\" + str + \"</td></tr>\";\r\n              } else {\r\n                html += \"<td></td></tr>\";\r\n              }\r\n              break;\r\n            }\r\n          }\r\n        });\r\n\r\n        $('#tb-detail-tbody').html(html);\r\n\r\n        showHtmlElement($('#tb-detail th:last-child, #tb-detail td:last-child'), isVessel);\r\n        $('#settle-detail-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n      });\r\n    }\r\n  });\r\n\r\n  function buildTableTr(bill, send_num, send_weight) {\r\n    var str = '<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td>';\r\n    if (bill.block_num > 0) {\r\n      return str.format(bill.bill_no, getOrder(bill.order_no, bill.order_item_no), bill.ship_warehouse? bill.ship_warehouse : \"\",\r\n        getStrValue(bill.thickness), getStrValue(bill.width), getStrValue(bill.len),\r\n        getStrValue(bill.weight), bill.block_num, getStrValue(bill.total_weight), send_num, getStrValue(bill.weight * send_num),\r\n        bill.customer_price > 0 ? getStrValue(bill.customer_price) : 0,\r\n        bill.collection_price > 0 ? getStrValue(bill.collection_price) : 0)\r\n    } else {\r\n      return str.format(bill.bill_no, getOrder(bill.order_no, bill.order_item_no), bill.ship_warehouse? bill.ship_warehouse : \"\",\r\n        getStrValue(bill.thickness), getStrValue(bill.width), getStrValue(bill.len),\r\n        \"\", \"\", getStrValue(bill.total_weight), send_num, getStrValue(send_weight),\r\n        bill.customer_price > 0 ? getStrValue(bill.customer_price) : 0,\r\n        bill.collection_price > 0 ? getStrValue(bill.collection_price) : 0 )\r\n    }\r\n  }\r\n\r\n  btnPrintDetail.on('click', function() {\r\n    if (selected_records.length) {\r\n      printBody.empty();\r\n      var trStr = '<tr><td style=\"border:1px solid black;padding:5px;\">{0}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{1}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{2}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{3}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{4}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{5}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{6}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{7}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{8}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{9}</td></tr>';\r\n      var totWeight = 0, totPrice = 0;\r\n      var numOfRow = tableBody.find(\"tr\").length;\r\n      for (var i = 0; i < numOfRow; ++i) {\r\n        var tr = getRowChildren(tableBody, i);\r\n        var check = getTableCellChildren(tr, 0).find(\"input\");\r\n        if (check.is(\":checked\")) {\r\n          var w = getTableCellChildren(tr, 10).text();\r\n          var p = getTableCellChildren(tr, 7).text();\r\n          printBody.append(trStr.format(getTableCellChildren(tr, 3).text(),\r\n            getTableCellChildren(tr, 4).text(),\r\n            getTableCellChildren(tr, 5).text(),\r\n            getTableCellChildren(tr, 6).text(),\r\n            w, getTableCellChildren(tr, 8).text(), p,\r\n            getTableCellChildren(tr, 11).text(),\r\n            getTableCellChildren(tr, 14).text(),\r\n            getTableCellChildren(tr, 15).text() ));\r\n          totWeight += (+w);\r\n          totPrice += (+p);\r\n        }\r\n      }\r\n\r\n      $('#print-total-weight').text(getStrValue(totWeight));\r\n      $('#print-total-number').text(getStrValue(totPrice));\r\n      $('#settle-print-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n    } else {\r\n      bootbox.alert('请选择你要打印的清单列表');\r\n    }\r\n  });\r\n\r\n  $('#print-to').on('click', function() {\r\n    var w = window.open();\r\n    if (!w) {\r\n      bootbox.alert('请允许弹出窗口!');\r\n      return false;\r\n    } else {\r\n      w.document.write($('#print-div').html());\r\n      w.print();\r\n      w.close();\r\n      return true;\r\n    }\r\n  });\r\n\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  /// Function list\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  function makeInvVehInfo(invoice) {\r\n    var allVehicles = [];\r\n    invoice.bills.forEach(function(bill) {\r\n      allVehicles.push.apply(allVehicles, bill.vehicles);\r\n    });\r\n\r\n    var vehObj = {};\r\n    allVehicles.forEach(function(veh) {\r\n      if (isExist(vehObj[veh.inner_waybill_no])) {\r\n        vehObj[veh.inner_waybill_no].num += veh.send_num;\r\n        vehObj[veh.inner_waybill_no].weight += veh.send_weight;\r\n      } else {\r\n        vehObj[veh.inner_waybill_no] = {\r\n          name: veh.veh_name,\r\n          num: veh.send_num,\r\n          weight: veh.send_weight,\r\n          price: isExist(veh.veh_price) ? veh.veh_price : 0,\r\n          ship_from: veh.veh_ship_from,\r\n          state: '未结算', date: null,\r\n          unship_date: null, delay_day: 0, advance_charge_mode: '现金', advance_charge: 0, receipt: 0, remark: '',\r\n          pay_date: null\r\n        };\r\n      }\r\n    });\r\n\r\n    if (isExist(invoice.inner_settle) && !isEmpty(invoice.inner_settle)) {\r\n      invoice.inner_settle.forEach(function(innset) {\r\n        vehObj[innset.inner_waybill_no].state = innset.state;\r\n        vehObj[innset.inner_waybill_no].date = innset.date;\r\n        vehObj[innset.inner_waybill_no].unship_date = innset.unship_date;\r\n        vehObj[innset.inner_waybill_no].delay_day = innset.delay_day;\r\n        vehObj[innset.inner_waybill_no].advance_charge_mode = innset.advance_charge_mode;\r\n        vehObj[innset.inner_waybill_no].advance_charge = innset.advance_charge;\r\n        vehObj[innset.inner_waybill_no].receipt = innset.receipt;\r\n        vehObj[innset.inner_waybill_no].remark = innset.remark;\r\n        vehObj[innset.inner_waybill_no].pay_date = innset.pay_date;\r\n      })\r\n    }\r\n\r\n    return vehObj;\r\n  }\r\n\r\n  function getParameterText(state, receipt, mode, charge_value, remark) {\r\n    var color = (state === '不需要结算') ? \"gray\" : \"red\";\r\n    var show = remark ? \"\" : \"display:none\";\r\n    var checked = (receipt === 1) ? \"checked\" : \"\";\r\n    var ckReceipt = '<input class=\"select-receipt\" type=\"checkbox\" disabled ' + checked + '>&nbsp;<i class=\"fa fa-info-circle\" style=\"color:red; cursor:pointer; ' + show + '\" data-toggle=\"tooltip\" title=\"' + remark + '\"></i>';\r\n\r\n    return { state: getStrByStatus(state, state),\r\n      color: color, ckReceipt: ckReceipt, chargeText: mode + \": \" + (typeof charge_value === 'number' ? charge_value : '0') };\r\n  }\r\n\r\n  var allInvVehicles = [];\r\n  function makeTableTrHtml(inv) {\r\n    var isVessel = false;\r\n    var vehObj = null;\r\n    var number = 0;\r\n    inv.bills.forEach(function(bill) {\r\n      number += bill.num;\r\n      if (!isVessel && bill.vehicles.length) {\r\n        isVessel = true;\r\n\r\n        /*\r\n        var found = false;\r\n        for (var k = 0, len = allInvVehicles.length; k < len; ++k) {\r\n          if (inv.waybill_no === allInvVehicles[k].wno) {\r\n            vehObj = allInvVehicles[k].vehInfo;\r\n            break;\r\n            found = true;\r\n          }\r\n        }\r\n\r\n        if (!found) {\r\n          vehObj = makeInvVehInfo(inv);\r\n          allInvVehicles.push({ wno: inv.waybill_no, vehInfo: vehObj });\r\n        }\r\n        */\r\n      }\r\n    });\r\n\r\n    var name = inv.ship_name + (inv.ship_customer ? \"/\" + inv.ship_customer : \"\");\r\n    var paramText = getParameterText(inv.vessel_settle_state, inv.receipt, inv.advance_charge_mode, inv.advance_charge, inv.remark);\r\n\r\n    var trHtml = '<tr class=\"tr_header\"><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td></tr>';\r\n\r\n    var pText = getInvVesselPriceText(vehObj, inv);\r\n    totalAmount += pText.price;\r\n    totalWeight += inv.total_weight;\r\n\r\n    if (undefined != prices) {\r\n      var price = prices[inv.waybill_no];\r\n\r\n      tableBody.append(trHtml.format(\r\n        paramText.state,\r\n        name,\r\n        inv.vehicle_vessel_name,\r\n        inv.ship_to,\r\n        number,\r\n        getStrValue(inv.total_weight),\r\n        getStrValue(price.cust_price),\r\n        pText.priceText,\r\n        getStrValue(price.net_income),\r\n        date2Str(inv.ship_date),\r\n        inv.shipper,\r\n        inv.waybill_no));\r\n    } else {\r\n      tableBody.append(trHtml.format(\r\n        paramText.state,\r\n        name,\r\n        inv.vehicle_vessel_name,\r\n        inv.ship_to,\r\n        number,\r\n        getStrValue(inv.total_weight), '...', '...', '...',\r\n        date2Str(inv.ship_date),\r\n        inv.shipper,\r\n        inv.waybill_no));\r\n    }\r\n  }\r\n\r\n  function resetTableRow() {\r\n    tableBody.empty();\r\n    selected_records = [];\r\n    totalAmount = 0;\r\n    totalWeight = 0;\r\n    allInvVehicles = [];\r\n\r\n    curr_records.forEach(function (inv) {\r\n      makeTableTrHtml(inv);\r\n    });\r\n\r\n    //$('#lb-total-weight').text(getStrValue(totalWeight));\r\n    //$('#lb-total-amount').text(getStrValue(totalAmount));\r\n    //$('#curr-number').text(tableBody.find(\"tr\").length);\r\n\r\n    //enableButtons();\r\n\r\n    $('.tr_header').on('click', function () { selectRow($(this)); });\r\n    $('[data-toggle=\"popover\"]').popover({ trigger: \"hover\", html: true, placement: \"bottom\" });\r\n  }\r\n\r\n  function selectRow(me) {\r\n    if (me.hasClass(\"tr_header\")) {\r\n      tableBody.find('tr').removeClass('invoice-highlighted');\r\n      selected_records = [];\r\n      var wno = getTableCellChildren(me, 11).text();\r\n      for (var k = 0, l = curr_records.length; k < l; ++k) {\r\n        if (wno === curr_records[k].waybill_no) {\r\n          selected_records.push(curr_records[k]);\r\n          break;\r\n        }\r\n      }\r\n\r\n      me.addClass('invoice-highlighted');\r\n      //var found = false;\r\n      //for (var i = 0; i < selected_records.length; ++i) {\r\n      //  if (wno === selected_records[i].waybill_no) {\r\n      //    selected_records.remove(i);\r\n      //    found = true;\r\n      //    break;\r\n      //  }\r\n      //}\r\n      //\r\n      //if (found) {\r\n      //  me.removeClass('invoice-highlighted');\r\n      //} else {\r\n      //  for (var k = 0, l = curr_records.length; k < l; ++k) {\r\n      //    if (wno === curr_records[k].waybill_no) {\r\n      //      selected_records.push(curr_records[k]);\r\n      //      break;\r\n      //    }\r\n      //  }\r\n      //  me.addClass('invoice-highlighted');\r\n      //}\r\n    }\r\n  }\r\n\r\n  function getInvVesselPriceText(vehObj, inv) {\r\n    var tip = \"\";\r\n    if (inv.vessel_price > 0) {\r\n      tip += '车船号:{0}, 发运重量:{1}, 单价:{2}, 目的地:{3}'.format(inv.vehicle_vessel_name, getStrValue(inv.total_weight), getStrValue(inv.vessel_price), inv.ship_to);\r\n    }\r\n\r\n    if (vehObj) {\r\n      var i = 1;\r\n      for (var key in vehObj) {\r\n        if (vehObj.hasOwnProperty(key)) {\r\n          tip += '\\r第{0}车: {1}, 发运重量:{2}, 单价:{3}, 目的地:{4}'.format(i, vehObj[key].name, getStrValue(vehObj[key].weight),\r\n            vehObj[key].price < 0 ? '无' : getStrValue(vehObj[key].price), inv.vehicle_vessel_name);\r\n          ++i\r\n        }\r\n      }\r\n    }\r\n\r\n    if (inv.veh_price <= 0) { //vessel_price < 0) {\r\n      return { priceText: '<code style=\"color: darkgray\">无</code>', tooltip: tip, price: 0 };\r\n    } else {\r\n      var price = prices[inv.waybill_no];\r\n      return {\r\n        priceText: '<code style=\"color: blue\">' + getStrValue(price.veh_price) + '</code>',\r\n        tooltip: tip,\r\n        price: price.veh_price\r\n      };\r\n    }\r\n  }\r\n\r\n  elementEventRegister(btnExport, 'click', function() {  tableToExcel($('#table-content').html(), \"data\"); });\r\n\r\n});\r\n\r\n/////////////////////////////////////////\r\n//////// CLASS DEFINE ///////////////////\r\n/////////////////////////////////////////\r\nvar QueryFilterD = function(options) {\r\n  this.uiElems = {\r\n    sBfBillName : $('#bf-shipping-name'),\r\n    sBfDest : $('#bf-destination'),\r\n    sBfVehicle : $('#bf-vehicle'),\r\n    startDateGrp : $('#start-date-grp'),\r\n    endDateGrp : $('#end-date-grp'),\r\n    iStartDate : $('#start-date'),\r\n    iEndDate : $('#end-date'),\r\n    sBfShipper: $('#bf-shipper')\r\n  };\r\n\r\n  this.options = options;\r\n  initSelect(this.uiElems.sBfBillName, options.ship_name, true);\r\n  initSelect(this.uiElems.sBfVehicle, options.vehicles, true);\r\n  initSelect(this.uiElems.sBfDest, options.destination, true);\r\n  initSelect(this.uiElems.sBfShipper, options.users, true);\r\n  this.uiElems.iStartDate.val(\"\");\r\n  this.uiElems.iEndDate.val(\"\");\r\n\r\n  this.uiElems.sBfBillName.select2({allowClear:true});\r\n  this.uiElems.sBfVehicle.select2({allowClear:true});\r\n  this.uiElems.sBfDest.select2({allowClear:true});\r\n  this.uiElems.sBfShipper.select2({allowClear:true});\r\n\r\n  this.currSelected = 0;\r\n  this.first = -1;\r\n  this.selectedVeh = null;\r\n  this.selectedName = null;\r\n  this.selectedDest = null;\r\n  this.selectedUser = null;\r\n  this.sDate = null;\r\n  this.eDate = null;\r\n\r\n  this._selectFliterFunc = function(which, value, filter) {\r\n    if (this.first < 0) {\r\n      this.first = which;\r\n    }\r\n\r\n    if (value === '无-取消选择') {\r\n      if (this.first === which) {\r\n        this.first = -1;\r\n      }\r\n      switch (which) {\r\n        case 1:\r\n          this.selectedName = null; break;\r\n        case 3:\r\n          this.selectedVeh = null; break;\r\n        case 4:\r\n          this.selectedDest = null; break;\r\n        case 6:\r\n          this.selectedUser = null; break;\r\n      }\r\n    }\r\n\r\n    this.currSelected = which;\r\n    filter(true, false);\r\n  };\r\n\r\n  this._dateFilterFunc = function(isStart, isEnd, filter) {\r\n    var d1 = this.uiElems.iStartDate.val();\r\n    var d2 = this.uiElems.iEndDate.val();\r\n    var b = false;\r\n    if (isStart && isEnd) {\r\n      b = !isEmpty(d1) && !isEmpty(d2);\r\n    } else if (isStart) {\r\n      b = isEmpty(this.uiElems.iStartDate.val());\r\n    } else if (isEnd) {\r\n      b = isEmpty(this.uiElems.iEndDate.val());\r\n    }\r\n\r\n    if (b) {\r\n      this.currSelected = 5;\r\n      filter(true, false);\r\n    }\r\n  };\r\n\r\n  this._initSelect = function(nOptions) {\r\n    if (this.first !== 1 || this.currSelected !== 1) {\r\n      initSelect(this.uiElems.sBfBillName, nOptions.ship_name, true);\r\n      if (this.selectedName) {\r\n        this.uiElems.sBfBillName.select2('val', this.selectedName);\r\n      } else {\r\n        this.uiElems.sBfBillName.select2('val', '');\r\n      }\r\n    }\r\n\r\n    if (this.first !== 3 || this.currSelected !== 3) {\r\n      initSelect(this.uiElems.sBfVehicle, nOptions.vehicles, true);\r\n      if (this.selectedVeh) {\r\n        this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n      } else {\r\n        this.uiElems.sBfVehicle.select2('val', '');\r\n      }\r\n    }\r\n\r\n    if (this.first !== 4 || this.currSelected !== 4) {\r\n      initSelect(this.uiElems.sBfDest, nOptions.destination, true);\r\n      if (this.selectedDest) {\r\n        this.uiElems.sBfDest.select2('val', this.selectedDest);\r\n      } else {\r\n        this.uiElems.sBfDest.select2('val', '');\r\n      }\r\n    }\r\n    //if (this.first !== 6) {\r\n    //  initSelect(this.uiElems.sBfShipper, nOptions., true);\r\n    //  if (this.selectedDest) {\r\n    //    this.uiElems.sBfDest.select2('val', this.selectedDest);\r\n    //  } else {\r\n    //    this.uiElems.sBfDest.select2('val', '');\r\n    //  }\r\n    //}\r\n  }\r\n};\r\n\r\nQueryFilterD.prototype.getQueryParams = function() {\r\n  var d1 = this.uiElems.iStartDate.val();\r\n  var d2 = this.uiElems.iEndDate.val();\r\n  var b = !isEmpty(d1) && !isEmpty(d2);\r\n\r\n  return {\r\n    fName: this.selectedName,\r\n    fVeh: this.selectedVeh,\r\n    fDest: this.selectedDest,\r\n    fShipper: this.selectedUser,\r\n    fDate1: b ? this.sDate.toISOString() : null,\r\n    fDate2: b ? this.eDate.toISOString(): null\r\n  };\r\n};\r\n\r\nQueryFilterD.prototype.getVehicleName = function() {\r\n  return this.selectedVeh;\r\n};\r\n\r\nQueryFilterD.prototype.eventHandler = function(filter) {\r\n  var self = this;\r\n  self.uiElems.sBfBillName.on('change', function(e) {\r\n    self.selectedName = e.val;\r\n    self._selectFliterFunc(1, e.val, filter);\r\n  });\r\n  self.uiElems.sBfVehicle.on('change', function(e) {\r\n    self.selectedVeh = e.val;\r\n    self._selectFliterFunc(3, e.val, filter);\r\n  });\r\n\r\n  self.uiElems.sBfShipper.on('change', function(e) {\r\n    self.selectedUser = e.val;\r\n    self._selectFliterFunc(6, e.val, filter);\r\n  });\r\n  self.uiElems.sBfDest.on('change', function(e) {\r\n    self.selectedDest = e.val;\r\n    self._selectFliterFunc(4, e.val, filter);\r\n  });\r\n\r\n  self.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.sDate = e.date.startOf('day');\r\n    self.uiElems.endDateGrp.data(\"DateTimePicker\").setMinDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.eDate = e.date.endOf('day');\r\n    self.uiElems.startDateGrp.data(\"DateTimePicker\").setMaxDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.iStartDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(true, false, filter);\r\n  });\r\n  self.uiElems.iEndDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(false, true, filter);\r\n  });\r\n};\r\n\r\nQueryFilterD.prototype.isAllEmpty = function() {\r\n  var shipper = getSelectValue(this.uiElems.sBfShipper);\r\n  var d1 = this.uiElems.iStartDate.val();\r\n  var d2 = this.uiElems.iEndDate.val();\r\n  return isEmpty(this.selectedVeh) && isEmpty(this.selectedDest) && isEmpty(this.selectedName) &&\r\n      isEmpty(shipper) && isEmpty(d1) && isEmpty(d2);\r\n};\r\n\r\nQueryFilterD.prototype.updateOptions = function(records) {\r\n  var vehicle = this.selectedVeh;\r\n  var dest = this.selectedDest;\r\n  var name = this.selectedName;\r\n  var nOptions = {ship_name: [], vehicles: [], destination: [], users: this.options.users };\r\n\r\n  if (this.first < 0) {\r\n    nOptions = this.options;\r\n  } else {\r\n    var vName = [], vList = [], dList = [], k, m;\r\n\r\n    records.forEach(function (rec) {\r\n      if (vName.indexOf(rec.ship_name) < 0) {\r\n        vName.push(rec.ship_name);\r\n      }\r\n\r\n      var b2 = false;\r\n      if (vehicle) {\r\n        if (vehicle === rec.vehicle_vessel_name) {\r\n          b2 = true;\r\n        } else {\r\n          for (k = 0; k < rec.bills.length; ++k) {\r\n            for (m = 0; m < rec.bills[k].vehicles.length && !b2; ++m) {\r\n              if (rec.bills[k].vehicles[m].veh_name === vehicle) {\r\n                b2 = true;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      } else {\r\n        b2 = true;\r\n      }\r\n\r\n      var b3 = !dest || dest === rec.ship_to;\r\n      var b4 = !name || name === rec.ship_name;\r\n      if (b2 && b3 && b4) {\r\n        if (rec.ship_to && dList.indexOf(rec.ship_to) < 0) {\r\n          dList.push(rec.ship_to);\r\n        }\r\n\r\n        if (rec.vehicle_vessel_name && vList.indexOf(rec.vehicle_vessel_name) < 0) {\r\n          vList.push(rec.vehicle_vessel_name);\r\n        }\r\n\r\n        for (k = 0; k < rec.bills.length; ++k) {\r\n          for (m = 0; m < rec.bills[k].vehicles.length; ++m) {\r\n            if (vList.indexOf(rec.bills[k].vehicles[m].veh_name) < 0) {\r\n              vList.push(rec.bills[k].vehicles[m].veh_name);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    nOptions.vehicles = sort_pinyin(vList);\r\n    nOptions.destination = sort_pinyin(dList);\r\n    nOptions.ship_name = sort_pinyin(vName);\r\n  }\r\n\r\n  this._initSelect(nOptions);\r\n};\r\n"]}