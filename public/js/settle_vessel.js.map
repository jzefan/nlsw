{"version":3,"sources":["settle_vessel.js"],"names":["$","tableBody","btnFilter","btnExport","singlePriceInput","batchPriceInput","btnSettle","btnSettleCancel","btnPay","btnPayCancel","btnShowDetail","btnPrintDetail","btnUnshipDelay","ckReceiptIcon","printBody","totalAmount","totalWeight","prePayment","allReceiptOk","iChargeCash","iChargeOil","unpayBlock","unshipDate","iDelayDay","checkReceipt","receiptRemark","dayChanged","receiptChecked","dbRecords","curr_records","selected_records","selectedInnerNo","allInvVehicles","html","qFilter","QueryFilterD","local_data","filterData","needUpdateDbData","emptyDbData","settledState","showHtmlElement","obj","getQueryParams","get","data","result","jQuery","parseJSON","ok","sortByKey","invs","resetTableRow","settleVessel","settle","state","date","username","length","allSelectedWNo","i","len","rec","vessel_price","bootbox","alert","waybill_no","receipt","vessel_settle_state","push","wnoListFromInner","selectedInvFromInner","k","klen","innerNo","inv","getInvoiceByInnerNo","vehObj","getVehiclesInfo","price","indexOf","ajaxRequestHandle","allSelectedInvNo","allInvNoFromInner","allInnerNo","forEach","vessel_settle_date","vessel_settler","inner_settle","iis","inner_waybill_no","vo","key","hasOwnProperty","settleVesselPay","pay","allPayWNo","allPayInvNo","forPay","pay_date","buildTableTr","bill","send_num","send_weight","str","block_num","format","bill_no","getOrder","order_no","order_item_no","ship_warehouse","getStrValue","thickness","width","weight","total_weight","printDiv","elem","w","window","open","document","write","print","close","ino","wno","substring","n","updateDelayData","msg","partInd","modal","wnoList","waybillNo","isExist","unship_date","unshipData","delay_day","charge_cash","charge_oil","remark","numOfRow","find","getRowChildren","prop","switchElementClass","tr","eq","text","getTableCellChildren","date2Str","td","iElem","show","hide","enableButtons","setHtmlElementDisabled","buildPriceDialog","forVessel","id","vehicle_vessel_name","ship_from","ship_to","tmp","disabled","name","dialog","message","title","buttons","cancel","label","className","main","callback","priceData","getPriceValue","inner","bills","vehicles","veh","veh_price","updatePriceStateColumnText","forPrice","color","pText","getInvVesselPriceText","css","priceText","getStrByStatus","value","parseFloatHTML","val","isNaN","invoice","created","found","vehInfo","allVehicles","apply","num","veh_name","veh_ship_from","isEmpty","innset","makeInvVehInfo","getParameterText","cash","oil","ckReceipt","chargeText","empty","allNotNeed","res","isVessel","number","ship_name","ship_customer","vehName","getVehicleName","paramText","trHtml","append","vehPersonMap","ship_date","s","hint","ptext","tp","receiptOk","notNeed","makeTableTrHtml","addClass","removeClass","on","selectRow","this","selectInnerRow","closest","e","stopImmediatePropagation","me","nextUntil","slideToggle","switchNotNeedSettle","popover","trigger","placement","needUpdateCheckBox","idx","remove","needUpdateCheckbox","hasClass","l","wlist","settleNotNeeded","oc","nc","notNeeded","wayNoList","bveh","Date","tip","tooltip","p","eventHandler","elementEventRegister","allVehName","allVehNameWithVessel","record","vvName","replace","veh_html","vessel","priceObj","priceObj2","p2","allInv","checked","is","confirm","local_user_name","q","allBills","b","ib","String","_id","bill_id","backdrop","keyboard","trStr","totWeight","totPrice","payment","tdText","split","datetimepicker","getDateTimePickerOptions","getDate","day","diff","parseInt","setDate","moment","add","setMinDate","iCheck","allNo","tableToExcel","toggle","options","uiElems","sBfBillName","sBfDest","sBfVehicle","sBfVehContact","startDateGrp","endDateGrp","iStartDate","iEndDate","rSettled","rNoSettled","rSettledPay","rSettledNotNeeded","initSelect","nameList","vehList","destList","contactNameList","select2","allowClear","selectedVeh","currSelected","sDate","eDate","_selectFliterFunc","which","filter","isAllEmpty","_dateFilterFunc","isStart","isEnd","d1","d2","prototype","getSelectValue","dest","fName","fVeh","fDest","fSettledState","fDate1","toISOString","fDate2","self","preventDefault","startOf","endOf","setMaxDate","updateOptions","records","reset","vehicle","vehicleContactName","nOptions","visibleRecs","clearContactName","m","vList","dList","allVehList","pList","b2","b3","b4","sort_pinyin","nList","nv","cname","contactName","unselected"],"mappings":"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","file":"settle_vessel.js","sourcesContent":["/**\r\n * Created by ezefjia on 12/4/2014.\r\n */\r\n\r\n$(function () {\r\n  \"use strict\";\r\n\r\n  var tableBody        = $('#table-tbody');\r\n  var btnFilter        = $('#filter');\r\n  var btnExport        = $('#search-export');\r\n  var singlePriceInput = $('#single-price-input');\r\n  var batchPriceInput  = $('#batch-price-input');\r\n  var btnSettle        = $('#settle-bill');\r\n  var btnSettleCancel  = $('#settle-bill-cancel');\r\n  var btnPay           = $('#settle-pay');\r\n  var btnPayCancel     = $('#settle-pay-cancel');\r\n  var btnShowDetail    = $('#show-detail');\r\n  var btnPrintDetail   = $('#settle-print-detail');\r\n  var btnUnshipDelay   = $('#delay-info');\r\n  var ckReceiptIcon    = $('#receipt-icon');\r\n  var printBody        = $('#print-detail-tbody');\r\n  var totalAmount = 0;\r\n  var totalWeight = 0;\r\n  var prePayment  = 0;\r\n  var allReceiptOk = true;\r\n\r\n  var iChargeCash   = $('#charge-cash');\r\n  var iChargeOil    = $('#charge-oil');\r\n  var unpayBlock    = $('#unpay-block');\r\n  //var sAdvanceMode  = $('#advance_mode');\r\n  //var iAdvanceNum   = $('#advance_num');\r\n  var unshipDate    = $('#unship-date-grp');\r\n  var iDelayDay     = $('#delay-day');\r\n  var checkReceipt  = $('#sdd_receipt');\r\n  var receiptRemark = $('#delay-remark');\r\n  var dayChanged = false;\r\n  var receiptChecked = false;\r\n\r\n  var dbRecords =    [];\r\n  var curr_records = []; // 存放查询得到的所有记录\r\n  var selected_records = [];\r\n  var selectedInnerNo =  [];\r\n  var allInvVehicles =   [];\r\n\r\n  $('#first-th').html('<input id=\"select-all\" type=\"checkbox\" data-toggle=\"tooltip\" title=\"选择所有记录\" />&nbsp;<label id=\"all-not-need\" class=\"fa fa-star-o\" data-toggle=\"tooltip\" title=\"点击可设置不需要结算和需要结算\" style=\"cursor:pointer; color:red; font-size:18px;\" ></label>');\r\n\r\n  var qFilter = new QueryFilterD(local_data);\r\n  qFilter.eventHandler(filterData);\r\n\r\n  showHtmlElement(btnSettle, true);\r\n  showHtmlElement(btnSettleCancel, false);\r\n  showHtmlElement(btnPay, false);\r\n  showHtmlElement(btnPayCancel, false);\r\n  showHtmlElement(btnPrintDetail, false);\r\n  showHtmlElement(unpayBlock, false);\r\n  enableButtons();\r\n\r\n  function filterData(needUpdateDbData, emptyDbData) {\r\n    if (qFilter.settledState === '未结算') {\r\n      showHtmlElement(btnSettle, true);\r\n      showHtmlElement(btnSettleCancel, false);\r\n      showHtmlElement(btnPay, false);\r\n      showHtmlElement(btnPayCancel, false);\r\n      showHtmlElement(btnPrintDetail, false);\r\n      showHtmlElement(unpayBlock, false);\r\n    } else if (qFilter.settledState === '已结算') {\r\n      showHtmlElement(btnSettle, false);\r\n      showHtmlElement(btnSettleCancel, true);\r\n      showHtmlElement(btnPay, true);\r\n      showHtmlElement(btnPrintDetail, true);\r\n      showHtmlElement(btnPayCancel, false);\r\n      showHtmlElement(unpayBlock, true);\r\n    } else if (qFilter.settledState === '已付款') {\r\n      showHtmlElement(btnSettle, false);\r\n      showHtmlElement(btnSettleCancel, false);\r\n      showHtmlElement(btnPay, false);\r\n      showHtmlElement(btnPayCancel, true);\r\n      showHtmlElement(btnPrintDetail, false);\r\n      showHtmlElement(unpayBlock, false);\r\n    } else if (qFilter.settledState === '不需要结算') {\r\n      showHtmlElement(btnSettle, false);\r\n      showHtmlElement(btnSettleCancel, false);\r\n      showHtmlElement(btnPay, false);\r\n      showHtmlElement(btnPayCancel, false);\r\n      showHtmlElement(btnPrintDetail, false);\r\n      showHtmlElement(unpayBlock, false);\r\n    }\r\n\r\n    if (needUpdateDbData) {\r\n      var obj = qFilter.getQueryParams();\r\n      $.get('/get_invoice_settle_vellel', obj, function (data) {\r\n        var result = jQuery.parseJSON(data);\r\n        dbRecords = [];\r\n        if (result.ok) {\r\n          dbRecords = sortByKey(result.invs, \"ship_date\", \"DSC\")\r\n        }\r\n        curr_records = dbRecords;//qFilter.updateOptions(dbRecords, false);\r\n        resetTableRow();\r\n      });\r\n    } else {\r\n      if (emptyDbData) {\r\n        dbRecords = [];\r\n      }\r\n      curr_records = dbRecords; //qFilter.updateOptions(dbRecords, emptyDbData);\r\n      resetTableRow();\r\n    }\r\n  }\r\n\r\n  elementEventRegister($('#settle-search'), 'click', function() {\r\n    filterData(true, false);\r\n  });\r\n\r\n  elementEventRegister(singlePriceInput, 'click', function() {\r\n    if (selected_records.length === 1) {\r\n      buildPriceDialog(selected_records[0], true);\r\n    } else {\r\n      var inv = getInvoiceByInnerNo(selectedInnerNo[0]);\r\n      buildPriceDialog(inv, false, selectedInnerNo[0]);\r\n    }\r\n  });\r\n\r\n  elementEventRegister(batchPriceInput, 'click', buildPriceBatchInputDialog);\r\n\r\n  elementEventRegister($('#select-all'), 'click', function() {\r\n    var checked = $(this).is(\":checked\");\r\n    if (curr_records.length) {\r\n      selected_records = [];\r\n      selectedInnerNo = [];\r\n\r\n      if (checked) {\r\n        var numOfRow = tableBody.find(\"tr\").length;\r\n        for (var i = 0; i < numOfRow; ++i) {\r\n          var tr = getRowChildren(tableBody, i);\r\n          var wno = getTableCellChildren(tr, 2).text();\r\n          if (wno.length > 17) {\r\n            selectedInnerNo.push(wno);\r\n          } else {\r\n            for (var k = 0; k < curr_records.length; ++k) {\r\n              if (wno === curr_records[k].waybill_no) {\r\n                selected_records.push(curr_records[k]);\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        $('.tr_header').addClass('invoice-highlighted');\r\n      } else {\r\n        $('.tr_header').removeClass('invoice-highlighted');\r\n      }\r\n\r\n      $('.select-inv').prop(\"checked\", checked);\r\n      $('.select-sub-inv').prop(\"checked\", checked);\r\n      enableButtons();\r\n    }\r\n  });\r\n\r\n  $('#all-not-need').on('click', function() {\r\n    if (curr_records.length) {\r\n      if (qFilter.settledState === '未结算') {\r\n        var me = $(this);\r\n        var wnoList = [];\r\n        var numOfRow = tableBody.find(\"tr\").length;\r\n        for (var i = 0; i < numOfRow; ++i) {\r\n          var tr = getRowChildren(tableBody, i);\r\n          wnoList.push(getTableCellChildren(tr, 2).text());\r\n        }\r\n        bootbox.confirm(\"您确定要批量不结算操作\", function(result) {\r\n          if (result) {\r\n            switchNotNeedSettle(me, wnoList);\r\n          }\r\n        })\r\n      } else {\r\n        bootbox.alert(\"在已结算状态下不能进行此操作\");\r\n      }\r\n    }\r\n  });\r\n\r\n  elementEventRegister(btnSettle, 'click', function() { settleVessel(true, '已结算', new Date(), local_user_name); });\r\n  elementEventRegister(btnSettleCancel, 'click', function() { settleVessel(false, '未结算', '', '')  });\r\n  elementEventRegister(btnPay, 'click', function() { settleVesselPay(true, '已付款', new Date()); });\r\n  elementEventRegister(btnPayCancel, 'click', function() { settleVesselPay(false, '已结算', '')  });\r\n\r\n  function settleVessel(settle, state, date, username) {\r\n    if (selected_records.length || selectedInnerNo.length) {\r\n      var allSelectedWNo = [];\r\n      for (var i = 0, len = selected_records.length; i < len; ++i) {\r\n        var rec = selected_records[i];\r\n        if (settle) {\r\n          if (rec.vessel_price < 0) {\r\n            bootbox.alert('您选择的运单: ' + rec.waybill_no + ' 已设置为不需要结算, 请先取消不结算,再来结算');\r\n            return;\r\n          }\r\n          else if (rec.vessel_price === 0) {\r\n            bootbox.alert('您选择的运单: ' + rec.waybill_no + ' 还未输入价格, 不能继续结算');\r\n            return;\r\n          }\r\n          else if (rec.receipt != 1) {\r\n            bootbox.alert('您选择的运单: ' + rec.waybill_no + ' 还未收到回执, 不能继续结算');\r\n            return;\r\n          }\r\n          else if (rec.vessel_settle_state === '未结算') {\r\n            allSelectedWNo.push(rec.waybill_no);\r\n          }\r\n        }\r\n        else {\r\n          if (rec.vessel_price < 0) {\r\n            bootbox.alert('您选择的运单: ' + rec.waybill_no + ' 已设置为不需要结算, 不能取消');\r\n            return;\r\n          }\r\n          else if (rec.vessel_settle_state === '已结算') {\r\n            allSelectedWNo.push(rec.waybill_no);\r\n          }\r\n        }\r\n      }\r\n\r\n      var wnoListFromInner = [];\r\n      var selectedInvFromInner = [];\r\n      for (var k = 0, klen = selectedInnerNo.length; k < klen; ++k) {\r\n        var innerNo = selectedInnerNo[k];\r\n        var inv = getInvoiceByInnerNo(innerNo);\r\n        if (inv) {\r\n          var vehObj = getVehiclesInfo(inv, false);\r\n          if (settle) {\r\n            if (vehObj[innerNo].receipt != 1) {\r\n              bootbox.alert('您选择的内部运单: ' + innerNo + ' 还未收到回执, 不能继续结算');\r\n              return;\r\n            }\r\n            else {\r\n              if (vehObj[innerNo].price < 0) {\r\n                bootbox.alert('您选择的内部运单: ' + innerNo + ' 已设置为不需要结算, 请先取消不结算,再来结算');\r\n                return;\r\n              }\r\n              else if (vehObj[innerNo].price === 0) {\r\n                bootbox.alert('您选择的内部运单: ' + innerNo + ' 还未输入价格, 不能继续结算');\r\n                return;\r\n              }\r\n            }\r\n          }\r\n          else {\r\n            if (vehObj[innerNo].price < 0) {\r\n              bootbox.alert('您选择的内部运单: ' + innerNo + ' 已设置为不需要结算, 不能取消结算');\r\n              return;\r\n            }\r\n          }\r\n\r\n          if (wnoListFromInner.indexOf(inv.waybill_no) < 0) {\r\n            wnoListFromInner.push(inv.waybill_no);\r\n          }\r\n\r\n          selectedInvFromInner.push(inv);\r\n        }\r\n      }\r\n\r\n      ajaxRequestHandle('/settle_vessel', 'POST',\r\n        { allSelectedInvNo: allSelectedWNo, allInvNoFromInner: wnoListFromInner, allInnerNo: selectedInnerNo, settle: settle}, '车船结算', function () {\r\n\r\n          selected_records.forEach(function (inv) {\r\n            if (allSelectedWNo.indexOf(inv.waybill_no) >= 0) {\r\n              inv.vessel_settle_state = state;\r\n              inv.vessel_settle_date = date;\r\n              inv.vessel_settler = username;\r\n            }\r\n          });\r\n\r\n          selectedInvFromInner.forEach(function (inv) {\r\n            inv.inner_settle.forEach(function (iis) {\r\n              if (selectedInnerNo.indexOf(iis.inner_waybill_no) >= 0) {\r\n                iis.state = state;\r\n                iis.date = date;\r\n              }\r\n            });\r\n\r\n            var vo = getVehiclesInfo(inv, false);\r\n            for (var key in vo) {\r\n              if (vo.hasOwnProperty(key) && selectedInnerNo.indexOf(key) >= 0) {\r\n                vo[key].state = state;\r\n                vo[key].date = date;\r\n              }\r\n            }\r\n          });\r\n\r\n          resetTableRow();\r\n        });\r\n    } else {\r\n      bootbox.alert(\"请先选择您要结算或结算取消的行\");\r\n    }\r\n  }\r\n\r\n  function settleVesselPay(pay, state, date) {\r\n    if (selected_records.length || selectedInnerNo.length) {\r\n      var allPayWNo = [];\r\n      for (var i = 0, len = selected_records.length; i < len; ++i) {\r\n        var rec = selected_records[i];\r\n        allPayWNo.push(rec.waybill_no);\r\n      }\r\n\r\n      var wnoListFromInner = [];\r\n      var selectedInvFromInner = [];\r\n      for (var k = 0, klen = selectedInnerNo.length; k < klen; ++k) {\r\n        var innerNo = selectedInnerNo[k];\r\n        var inv = getInvoiceByInnerNo(innerNo);\r\n        if (inv) {\r\n          if (wnoListFromInner.indexOf(inv.waybill_no) < 0) {\r\n            wnoListFromInner.push(inv.waybill_no);\r\n          }\r\n\r\n          selectedInvFromInner.push(inv);\r\n        }\r\n      }\r\n\r\n      ajaxRequestHandle('/settle_vessel_pay', 'POST',\r\n        { allPayInvNo: allPayWNo, allInvNoFromInner: wnoListFromInner, allInnerNo: selectedInnerNo, forPay: pay}, '车船结算付款', function () {\r\n\r\n          selected_records.forEach(function (inv) {\r\n            if (allPayWNo.indexOf(inv.waybill_no) >= 0) {\r\n              inv.vessel_settle_state = state;\r\n              inv.pay_date = date;\r\n            }\r\n          });\r\n\r\n          selectedInvFromInner.forEach(function (inv) {\r\n            inv.inner_settle.forEach(function (iis) {\r\n              if (selectedInnerNo.indexOf(iis.inner_waybill_no) >= 0) {\r\n                iis.state = state;\r\n                iis.pay_date = date;\r\n              }\r\n            });\r\n\r\n            var vo = getVehiclesInfo(inv, false);\r\n            for (var key in vo) {\r\n              if (vo.hasOwnProperty(key) && selectedInnerNo.indexOf(key) >= 0) {\r\n                vo[key].state = state;\r\n                vo[key].pay_date = date;\r\n              }\r\n            }\r\n          });\r\n\r\n          resetTableRow();\r\n        });\r\n    }\r\n  }\r\n\r\n  elementEventRegister(btnShowDetail, 'click', function() {\r\n    if (selected_records.length > 0) {\r\n      var inv = selected_records[0];\r\n      var isVessel = false;\r\n      inv.bills.forEach(function (bill) {\r\n        if (bill.vehicles.length) {\r\n          isVessel = true;\r\n        }\r\n      });\r\n\r\n      $.get('/get_waybill', { q: inv.waybill_no }, function (data) {\r\n        var obj = jQuery.parseJSON(data); // bills: bills, invoices: invoices\r\n        var allBills = obj.bills;\r\n        var html = \"\";\r\n        allBills.forEach(function (b) {\r\n          for (var i = 0; i < inv.bills.length; ++i) {\r\n            var ib = inv.bills[i];\r\n            if (String(b._id) === String(ib.bill_id)) {\r\n              html += buildTableTr(b, ib.num, ib.weight);\r\n              if (ib.vehicles.length) {\r\n                var str = \"\";\r\n                ib.vehicles.forEach(function (veh) {\r\n                  str = \"{0}, <code>{1}</code><code>{2}</code><br />\".format(veh.veh_name, veh.send_num, getStrValue(veh.send_weight));\r\n                });\r\n                html += \"<td>\" + str + \"</td></tr>\";\r\n              } else {\r\n                html += \"<td></td></tr>\";\r\n              }\r\n              break;\r\n            }\r\n          }\r\n        });\r\n\r\n        $('#tb-detail-tbody').html(html);\r\n\r\n        showHtmlElement($('#tb-detail th:last-child, #tb-detail td:last-child'), isVessel);\r\n        $('#settle-detail-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n      });\r\n    }\r\n  });\r\n\r\n  function buildTableTr(bill, send_num, send_weight) {\r\n    var str = '<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td>';\r\n    if (bill.block_num > 0) {\r\n      return str.format(bill.bill_no, getOrder(bill.order_no, bill.order_item_no), bill.ship_warehouse? bill.ship_warehouse : \"\",\r\n        getStrValue(bill.thickness), getStrValue(bill.width), getStrValue(bill.len),\r\n        getStrValue(bill.weight), bill.block_num, getStrValue(bill.total_weight), send_num, getStrValue(bill.weight * send_num))\r\n    } else {\r\n      return str.format(bill.bill_no, getOrder(bill.order_no, bill.order_item_no), bill.ship_warehouse? bill.ship_warehouse : \"\",\r\n        getStrValue(bill.thickness), getStrValue(bill.width), getStrValue(bill.len),\r\n        \"\", \"\", getStrValue(bill.total_weight), send_num, getStrValue(send_weight))\r\n    }\r\n  }\r\n\r\n  btnPrintDetail.on('click', function() {\r\n    if (selected_records.length || selectedInnerNo.length) {\r\n      printBody.empty();\r\n      var trStr = '<tr><td style=\"border:1px solid black;padding:5px;\">{0}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{1}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{2}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{3}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{4}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{5}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{6}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{7}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{8}</td>' +\r\n        '<td style=\"border:1px solid black;padding:5px;\">{9}</td></tr>';\r\n      var totWeight = 0, totPrice = 0;\r\n      var payment = 0;\r\n      var numOfRow = tableBody.find(\"tr\").length;\r\n      for (var i = 0; i < numOfRow; ++i) {\r\n        var tr = getRowChildren(tableBody, i);\r\n        var check = getTableCellChildren(tr, 0).find(\"input\");\r\n        if (check.is(\":checked\")) {\r\n          var w = getTableCellChildren(tr, 10).text();\r\n          var p = getTableCellChildren(tr, 7).text();\r\n          printBody.append(trStr.format(getTableCellChildren(tr, 3).text(),\r\n            getTableCellChildren(tr, 4).text(),\r\n            getTableCellChildren(tr, 5).text(),\r\n            getTableCellChildren(tr, 6).text(),\r\n            w, getTableCellChildren(tr, 8).text(), p,\r\n            getTableCellChildren(tr, 11).text(),\r\n            getTableCellChildren(tr, 14).text(),\r\n            getTableCellChildren(tr, 15).text() ));\r\n          totWeight += (+w);\r\n          totPrice += (+p);\r\n\r\n          var tdText = getTableCellChildren(tr, 15).text();\r\n          if (tdText != '无') {\r\n            var tmp = tdText.split(':');\r\n            if (tmp.length === 3) {\r\n              payment += (+tmp[2]);\r\n              var idx1 = tmp[1].split(',')[0];\r\n              payment += (+idx1);\r\n            } else if (tmp.length === 2) {\r\n              payment += (+tmp[1]);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      $('#print-total-weight').text(getStrValue(totWeight));\r\n      $('#print-total-number').text(getStrValue(totPrice));\r\n      $('#print-unpay-number').text(getStrValue(totPrice - payment));\r\n      $('#settle-print-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n    } else {\r\n      bootbox.alert('请选择你要打印的清单列表');\r\n    }\r\n  });\r\n\r\n  $('#print-to').on('click', function() {\r\n    printDiv($('#print-div'));\r\n  });\r\n\r\n  $('#print-and-pay').on('click', function() {\r\n    if (printDiv($('#print-div'))) {\r\n      settleVesselPay(true, '已付款', new Date());\r\n    }\r\n  });\r\n\r\n  function printDiv(elem) {\r\n    var w = window.open();\r\n    if (!w) {\r\n      bootbox.alert('请允许弹出窗口!');\r\n      return false;\r\n    } else {\r\n      w.document.write(elem.html());\r\n      w.print();\r\n      w.close();\r\n      return true;\r\n    }\r\n  }\r\n\r\n  function getInvoiceByInnerNo(ino) {\r\n    var inv = null;\r\n    var wno = ino.substring(0, 17);\r\n    for (var n = 0; n < curr_records.length; ++n) {\r\n      if (wno === curr_records[n].waybill_no) {\r\n        inv = curr_records[n];\r\n        break;\r\n      }\r\n    }\r\n\r\n    return inv;\r\n  }\r\n\r\n  unshipDate.datetimepicker(getDateTimePickerOptions()).on('dp.change', function() {\r\n    if (!dayChanged) {\r\n      var date = unshipDate.data(\"DateTimePicker\").getDate();\r\n      if (date) {\r\n        var inv = (selected_records.length === 1) ? selected_records[0] : getInvoiceByInnerNo(selectedInnerNo[0]);\r\n        if (inv) {\r\n          var day = date.diff(inv.ship_date, 'days') - 7;\r\n          if (day > 0) {\r\n            iDelayDay.val(day);\r\n          } else {\r\n            iDelayDay.val('0');\r\n          }\r\n        }\r\n      }\r\n    } else {\r\n      dayChanged = false;\r\n    }\r\n  });\r\n\r\n  iDelayDay.on('keyup paste', function() {\r\n    var day = parseInt(this.value);\r\n    if (day > 0) {\r\n      var inv = (selected_records.length === 1) ? selected_records[0] : getInvoiceByInnerNo(selectedInnerNo[0]);\r\n      if (inv) {\r\n        dayChanged = true;\r\n        unshipDate.data(\"DateTimePicker\").setDate(moment(inv.ship_date).add(day + 7, 'days'));\r\n      }\r\n    }\r\n  });\r\n\r\n  elementEventRegister(checkReceipt, 'ifChecked', function() { receiptChecked = true; });\r\n  elementEventRegister(checkReceipt, 'ifUnchecked', function() { receiptChecked = false; });\r\n\r\n  elementEventRegister(btnUnshipDelay, 'click', function() {\r\n    var inv = (selected_records.length === 1) ? selected_records[0] :getInvoiceByInnerNo(selectedInnerNo[0]);\r\n    if (selected_records.length === 1) {\r\n      iChargeCash.val(inv.charge_cash);\r\n      iChargeOil.val(inv.charge_oil);\r\n      //sAdvanceMode.val(inv.advance_charge_mode);\r\n      //iAdvanceNum.val(inv.advance_charge);\r\n      iDelayDay.val(inv.delay_day);\r\n      unshipDate.data(\"DateTimePicker\").setMinDate(moment(inv.ship_date));\r\n      unshipDate.data(\"DateTimePicker\").setDate( inv.unship_date ? moment(inv.unship_date) : null );\r\n      checkReceipt.iCheck((inv.receipt === 1) ? 'check' : 'uncheck');\r\n      receiptRemark.val(inv.remark ? inv.remark : '');\r\n    }\r\n    else {\r\n      var innerNo = selectedInnerNo[0];\r\n      var vehObj = getVehiclesInfo(inv, false);\r\n      if (vehObj && vehObj[innerNo]) {\r\n        var tmp = vehObj[innerNo];\r\n        iChargeCash.val(tmp.charge_cash);\r\n        iChargeOil.val(tmp.charge_oil);\r\n        //sAdvanceMode.val(tmp.advance_charge_mode);\r\n        //iAdvanceNum.val(tmp.advance_charge);\r\n        iDelayDay.val(tmp.delay_day);\r\n        unshipDate.data(\"DateTimePicker\").setMinDate(moment(inv.ship_date));\r\n        unshipDate.data(\"DateTimePicker\").setDate(tmp.unship_date ? moment(tmp.unship_date) : null);\r\n        checkReceipt.iCheck((tmp.receipt === 1) ? 'check' : 'uncheck');\r\n        receiptRemark.val(tmp.remark ? tmp.remark : '');\r\n      }\r\n    }\r\n\r\n    showHtmlElement($('#delay_receipt'), true);\r\n    $('#settle-delay-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n  });\r\n\r\n  $('#batch-charge-ctrl').on('click', function() {\r\n    iChargeCash.val('0');\r\n    iChargeOil.val('0');\r\n    //sAdvanceMode.val('现金');\r\n    //iAdvanceNum.val('0');\r\n    showHtmlElement($('#delay_receipt'), false);\r\n    $('#settle-delay-dialog').modal({ backdrop: 'static', keyboard: false}).modal('show');\r\n  });\r\n\r\n  $('#batch-receipt-ctrl').on('click', function() {\r\n    var allNo = [];\r\n    var numOfRow = tableBody.find(\"tr\").length;\r\n    for (var i = 0; i < numOfRow; ++i) {\r\n      var tr = getRowChildren(tableBody, i);\r\n      allNo.push(getTableCellChildren(tr, 2).text());\r\n    }\r\n\r\n    var obj = { receipt: (allReceiptOk ? 0 : 1) }; // false -> true\r\n    updateDelayData({ unshipData: obj, wnoList: allNo, partInd: 2 });\r\n  });\r\n\r\n  $('#settle-delay-btn-ok').on('click', function() {\r\n    var obj = {\r\n      charge_cash: iChargeCash.val(),\r\n      charge_oil: iChargeOil.val()\r\n      //advance_charge_mode: sAdvanceMode.val(),\r\n      //advance_charge: iAdvanceNum.val()\r\n    };\r\n\r\n    if ($('#delay_receipt').css('display') == 'none') {\r\n      var allNo = [];\r\n      var numOfRow = tableBody.find(\"tr\").length;\r\n      for (var i = 0; i < numOfRow; ++i) {\r\n        var tr = getRowChildren(tableBody, i);\r\n        allNo.push(getTableCellChildren(tr, 2).text());\r\n      }\r\n\r\n      updateDelayData({ unshipData: obj, wnoList: allNo, partInd: 1 });\r\n    }\r\n    else {\r\n      obj.unship_date = unshipDate.data(\"DateTimePicker\").getDate();\r\n      obj.delay_day = iDelayDay.val();\r\n      obj.receipt = (receiptChecked ? 1 : 0);\r\n      obj.remark = receiptRemark.val();\r\n      var wno = (selected_records.length === 1) ? selected_records[0].waybill_no : selectedInnerNo[0];\r\n\r\n      updateDelayData({ unshipData: obj, wnoList: [ wno ], partInd: 0 });\r\n    }\r\n  });\r\n\r\n  function updateDelayData(data) {\r\n    var msg = 'no_message';\r\n    if (data.partInd === 0) {\r\n      msg = '车船结算滞留信息输入';\r\n    }\r\n    ajaxRequestHandle('/settle_vessel_delay_info', 'POST', data, msg, function () {\r\n      if (data.partInd === 0 || data.partInd === 1) {\r\n        $('#settle-delay-dialog').modal('hide');\r\n      }\r\n\r\n      data.wnoList.forEach(function(wno) {\r\n        var waybillNo = wno;\r\n        if (wno.length > 17) {\r\n          waybillNo = wno.substring(0, 17);\r\n        }\r\n\r\n        for (var i = 0; i < curr_records.length; ++i) {\r\n          if (waybillNo === curr_records[i].waybill_no) {\r\n            var inv = curr_records[i];\r\n            if (wno.length > 17) {\r\n              var vehObj = getVehiclesInfo(inv, false);\r\n              if (vehObj && isExist(vehObj[wno])) {\r\n                if (data.partInd === 0) {\r\n                  vehObj[wno].unship_date = data.unshipData.unship_date;\r\n                  vehObj[wno].delay_day = data.unshipData.delay_day;\r\n                  //vehObj[wno].advance_charge_mode = data.unshipData.advance_charge_mode;\r\n                  //vehObj[wno].advance_charge = data.unshipData.advance_charge;\r\n                  vehObj[wno].charge_cash = data.unshipData.charge_cash;\r\n                  vehObj[wno].charge_oil = data.unshipData.charge_oil;\r\n                  vehObj[wno].receipt = data.unshipData.receipt;\r\n                  vehObj[wno].remark = data.unshipData.remark;\r\n                } else if (data.partInd === 1) {\r\n                  vehObj[wno].charge_cash = data.unshipData.charge_cash;\r\n                  vehObj[wno].charge_oil = data.unshipData.charge_oil;\r\n                  //vehObj[wno].advance_charge_mode = data.unshipData.advance_charge_mode;\r\n                  //vehObj[wno].advance_charge = data.unshipData.advance_charge;\r\n                } else if (data.partInd === 2) {\r\n                  vehObj[wno].receipt = data.unshipData.receipt;\r\n                } else if (data.partInd === 3) {\r\n                  vehObj[wno].remark = data.unshipData.remark;\r\n                }\r\n              }\r\n            } else {\r\n              if (data.partInd === 0) {\r\n                inv.unship_date = data.unshipData.unship_date;\r\n                inv.delay_day = data.unshipData.delay_day;\r\n                inv.charge_cash = data.unshipData.charge_cash;\r\n                inv.charge_oil = data.unshipData.charge_oil;\r\n                //inv.advance_charge_mode = data.unshipData.advance_charge_mode;\r\n                //inv.advance_charge = data.unshipData.advance_charge;\r\n                inv.receipt = data.unshipData.receipt;\r\n                inv.remark = data.unshipData.remark;\r\n              } else if (data.partInd === 1) {\r\n                inv.charge_cash = data.unshipData.charge_cash;\r\n                inv.charge_oil = data.unshipData.charge_oil;\r\n                //inv.advance_charge_mode = data.unshipData.advance_charge_mode;\r\n                //inv.advance_charge = data.unshipData.advance_charge;\r\n              } else if (data.partInd === 2) {\r\n                inv.receipt = data.unshipData.receipt;\r\n              } else if (data.partInd === 3) {\r\n                inv.remark = data.unshipData.remark;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      });\r\n\r\n      var numOfRow = tableBody.find(\"tr\").length;\r\n      if (data.partInd === 2) {\r\n        allReceiptOk = !allReceiptOk;\r\n        for (var i = 0; i < numOfRow; ++i) {\r\n          getRowChildren(tableBody, i).find(\"td:last\").find('input').prop('checked', allReceiptOk);\r\n        }\r\n        switchElementClass(ckReceiptIcon, 'fa-check-square-o', 'fa-square-o');\r\n      } else {\r\n        for (var k = 0; k < numOfRow; ++k) {\r\n          var tr = getRowChildren(tableBody, k);\r\n          if (data.partInd === 1) {\r\n            if (data.unshipData.charge_cash > 0 && data.unshipData.charge_oil > 0) {\r\n              tr.find(\"td\").eq(15).text('现金:' + data.unshipData.charge_cash + ',油:' + data.unshipData.charge_oil);\r\n            } else if (data.unshipData.charge_cash > 0) {\r\n              tr.find(\"td\").eq(15).text('现金:' + data.unshipData.charge_cash);\r\n            } else if (data.unshipData.charge_oil > 0) {\r\n              tr.find(\"td\").eq(15).text('油:' + data.unshipData.charge_oil);\r\n            } else {\r\n              tr.find(\"td\").eq(15).text('无');\r\n            }\r\n          } else if (data.partInd === 0) {\r\n            var td_wno = getTableCellChildren(tr, 2).text();\r\n            if (td_wno === data.wnoList[0]) {\r\n              tr.find(\"td\").eq(13).text(date2Str(data.unshipData.unship_date));\r\n              tr.find(\"td\").eq(14).text(data.unshipData.delay_day);\r\n              if (data.unshipData.charge_cash > 0 && data.unshipData.charge_oil > 0) {\r\n                tr.find(\"td\").eq(15).text('现金:' + data.unshipData.charge_cash + ',油:' + data.unshipData.charge_oil);\r\n              } else if (data.unshipData.charge_cash > 0) {\r\n                tr.find(\"td\").eq(15).text('现金:' + data.unshipData.charge_cash);\r\n              } else if (data.unshipData.charge_oil > 0) {\r\n                tr.find(\"td\").eq(15).text('油:' + data.unshipData.charge_oil);\r\n              } else {\r\n                tr.find(\"td\").eq(15).text('无');\r\n              }\r\n\r\n              var td = tr.find(\"td:last\");\r\n              td.find('input').prop('checked', data.unshipData.receipt === 1);\r\n              var iElem = td.find('i');\r\n              if (data.unshipData.remark) {\r\n                iElem.show();\r\n                iElem.prop(\"title\", data.unshipData.remark);\r\n              } else {\r\n                iElem.hide();\r\n              }\r\n              break;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  /// Function list\r\n  ////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n  function enableButtons() {\r\n    setHtmlElementDisabled(btnExport, curr_records.length === 0);\r\n\r\n    if (selected_records.length || selectedInnerNo.length) {\r\n      var len = selected_records.length + selectedInnerNo.length;\r\n      if (len === 1) {\r\n        setHtmlElementDisabled(singlePriceInput, false);\r\n        setHtmlElementDisabled(btnUnshipDelay, false);\r\n      } else {\r\n        setHtmlElementDisabled(singlePriceInput, true);\r\n        setHtmlElementDisabled(btnUnshipDelay, true);\r\n      }\r\n\r\n      setHtmlElementDisabled(batchPriceInput, len < 2);\r\n      setHtmlElementDisabled(btnShowDetail, selected_records.length !== 1);\r\n      setHtmlElementDisabled(btnSettle, false);\r\n      setHtmlElementDisabled(btnSettleCancel, false);\r\n      setHtmlElementDisabled(btnPrintDetail, false);\r\n      setHtmlElementDisabled(btnPay, false);\r\n      setHtmlElementDisabled(btnPayCancel, false);\r\n    } else {\r\n      setHtmlElementDisabled(singlePriceInput, true);\r\n      setHtmlElementDisabled(batchPriceInput, true);\r\n      setHtmlElementDisabled(btnShowDetail, true);\r\n      setHtmlElementDisabled(btnUnshipDelay, true);\r\n      setHtmlElementDisabled(btnSettle, true);\r\n      setHtmlElementDisabled(btnSettleCancel, true);\r\n      setHtmlElementDisabled(btnPrintDetail, true);\r\n      setHtmlElementDisabled(btnPay, true);\r\n      setHtmlElementDisabled(btnPayCancel, true);\r\n    }\r\n  }\r\n\r\n  function buildPriceDialog(inv, forVessel, innerNo) {\r\n    var vehObj = getVehiclesInfo(inv, false);\r\n    var msg = '<div class=\"row form-horizontal\"><div class=\"col-md-10\">';\r\n    var str = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">{1}</label><div class=\"input-group col-sm-8\"><input id=\"{2}\" type=\"text\" name=\"{3}\" class=\"form-control\" value=\"{4}\"><span style=\"font-size: 11px\">始发: {5}, 目的地: {6}</span></div></div>';\r\n    var str_1 = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">{1}</label><div class=\"input-group col-sm-8\"><input id=\"{2}\" type=\"text\" name=\"{3}\" class=\"form-control\" value=\"{4}\" {5}><span style=\"font-size: 11px\">始发: {6}, 发运重量: {7} 吨</span></div></div>';\r\n\r\n    if (forVessel) {\r\n      var id = inv.waybill_no;\r\n      msg += str.format(id, inv.vehicle_vessel_name, id, id, getStrValue(inv.vessel_price), inv.ship_from ? inv.ship_from : '', inv.ship_to);\r\n    }\r\n    else {\r\n      var html = '<div><label>目的地为' + inv.vehicle_vessel_name + '的车辆价格</label>';\r\n      if (vehObj && vehObj[innerNo]) {\r\n        var tmp = vehObj[innerNo];\r\n        var disabled = (tmp.price < 0) ? \"disabled\" : \"\";\r\n        html += str_1.format(innerNo, tmp.name, innerNo, innerNo, getStrValue(tmp.price), disabled, tmp.ship_from ? tmp.ship_from : '', getStrValue(tmp.weight));\r\n      }\r\n      msg += html + '</div>';\r\n    }\r\n\r\n    msg += '</div>';\r\n\r\n    bootbox.dialog({\r\n      message: msg,\r\n      title: \"单行价格输入\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\" },\r\n        main:   { label: \"确定\", className: \"btn-primary\", callback: ok }\r\n      }\r\n    });\r\n\r\n    function ok() {\r\n      var priceData = [];\r\n      if (forVessel) {\r\n        var price = getPriceValue(inv.waybill_no); // id = inv.waybill_no\r\n        if (price >= 0 || price === -1) {\r\n          inv.vessel_price = price;\r\n          priceData.push({ wno: inv.waybill_no, price: price, inner: 0 });\r\n        }\r\n      }\r\n      else {\r\n        inv.bills.forEach(function (bill) {\r\n          bill.vehicles.forEach(function (veh) {\r\n            if (veh.inner_waybill_no === innerNo) {\r\n              var price = getPriceValue(veh.inner_waybill_no); // id = inv.waybill_no\r\n              if (price >= 0 || price === -1) {\r\n                veh.veh_price = price;\r\n                vehObj[innerNo].price = price;\r\n                priceData.push({ wno: veh.inner_waybill_no, price: price, inner: 1 });\r\n              }\r\n            }\r\n          });\r\n        });\r\n      }\r\n\r\n      ajaxRequestHandle('/settle_vessel_price', 'POST',\r\n        { wnoList: [ inv.waybill_no ], priceData: priceData }, 'no_message', function () {\r\n        updatePriceStateColumnText(inv, true);\r\n      });\r\n    }\r\n  }\r\n\r\n  function updatePriceStateColumnText(inv, forPrice) {\r\n    var tr, td;\r\n    var color = (inv.vessel_price < 0) ? \"darkgray\" : \"red\";\r\n    var vehObj = getVehiclesInfo(inv, false);\r\n    var pText = getInvVesselPriceText(vehObj, inv);\r\n    var numOfRow = tableBody.find(\"tr\").length;\r\n    for (var i = 0; i < numOfRow; ++i) {\r\n      tr = getRowChildren(tableBody, i);\r\n      var wno = getTableCellChildren(tr, 2).text();\r\n      if (inv.waybill_no === wno) {\r\n        if (forPrice) {\r\n          tr.find(\"td\").eq(0).find(\"label\").css('color', color);\r\n          tr.find(\"td\").eq(7).html(pText.priceText);\r\n          if (inv.vessel_price < 0) {\r\n            tr.find(\"td\").eq(8).text('无');\r\n          } else {\r\n            tr.find(\"td\").eq(8).text(getStrValue(inv.vessel_price));\r\n          }\r\n        }\r\n        tr.find(\"td\").eq(1).html(getStrByStatus(inv.vessel_settle_state, inv.vessel_settle_state));\r\n        tr.find(\"td\").eq(12).text(date2Str(inv.vessel_settle_date));\r\n      }\r\n      else if (vehObj && isExist(vehObj[wno])) {\r\n        var tmp = vehObj[wno];\r\n        if (forPrice) {\r\n          if (tmp.price < 0) {\r\n            tr.find(\"td\").eq(0).find(\"label\").css('color', \"darkgray\");\r\n            tr.find(\"td\").eq(7).text('无');\r\n            tr.find(\"td\").eq(8).text('无');\r\n          } else {\r\n            tr.find(\"td\").eq(0).find(\"label\").css('color', \"red\");\r\n            tr.find(\"td\").eq(7).text(getStrValue(tmp.price * tmp.weight));\r\n            tr.find(\"td\").eq(8).text(getStrValue(tmp.price));\r\n          }\r\n        }\r\n\r\n        tr.find(\"td\").eq(1).html(getStrByStatus(tmp.state, tmp.state));\r\n        tr.find(\"td\").eq(12).text(date2Str(tmp.date));\r\n      }\r\n    }\r\n  }\r\n\r\n  function buildPriceBatchInputDialog() {\r\n    var allVehName = [];\r\n    var allVehNameWithVessel = [];\r\n    selected_records.forEach(function(record) {\r\n      if (allVehName.indexOf(record.vehicle_vessel_name) < 0) {\r\n        allVehName.push(record.vehicle_vessel_name);\r\n      }\r\n    });\r\n\r\n    selectedInnerNo.forEach(function(innerNo) {\r\n      var inv = getInvoiceByInnerNo(innerNo);\r\n      inv.bills.forEach(function(bill) {\r\n        bill.vehicles.forEach(function(veh) {\r\n          if (veh.inner_waybill_no === innerNo && allVehNameWithVessel.indexOf(veh.veh_name) < 0) {\r\n            allVehNameWithVessel.push(veh.veh_name);\r\n          }\r\n        })\r\n      })\r\n    });\r\n\r\n    var msg = '<div class=\"row form-horizontal\"><div class=\"col-md-10\">';\r\n    var str = '<div class=\"form-group\"><label for=\"{0}\" class=\"control-label col-sm-4\">{1}</label><div class=\"input-group col-sm-8\"><input id=\"{2}\" type=\"text\" name=\"{3}\" class=\"form-control\"></div></div>';\r\n    var id = \"\";\r\n    allVehName.forEach(function(vvName) {\r\n      id = vvName.replace(/[\\s\\(\\)#]+/g, \"999\") + \"999\";\r\n      msg += str.format(id, vvName, id, id);\r\n    });\r\n\r\n    if (allVehNameWithVessel.length) {\r\n      var veh_html = '<div class=\"col-md-12\"><label>目的地为(船)的车辆</label>';\r\n      allVehNameWithVessel.forEach(function(vessel) {\r\n        id = vessel.replace(/[\\s\\(\\)#]+/g, \"888\") + \"888\";\r\n        veh_html += str.format(id, vessel, id, id);\r\n      });\r\n      msg += veh_html + '</div>';\r\n    }\r\n    msg += '</div></div>';\r\n\r\n    bootbox.dialog({\r\n      message: msg,\r\n      title: \"批量输入价格\",\r\n      buttons: {\r\n        cancel: { label: \"取消\", className: \"btn-default\", callback: function() { }},\r\n        main:   { label: \"确定\", className: \"btn-primary\", callback: ok }\r\n      }\r\n    });\r\n\r\n    function ok() {\r\n      var id = \"\";\r\n      var priceObj = {};\r\n      var priceObj2 = {};\r\n      allVehName.forEach(function(vvName) {\r\n        id = vvName.replace(/[\\s\\(\\)#]+/g, \"999\") + \"999\";\r\n        var p = getPriceValue(id);\r\n        if (p > 0 || p === -1) {\r\n          priceObj[vvName] = p;\r\n        }\r\n      });\r\n\r\n      allVehNameWithVessel.forEach(function(vessel) {\r\n        id = vessel.replace(/[\\s\\(\\)#]+/g, \"888\") + \"888\";\r\n        var p2 = getPriceValue(id);\r\n        if (p2 > 0 || p2 === -1) {\r\n          priceObj2[vessel] = p2;\r\n        }\r\n      });\r\n\r\n      var allInv = [];\r\n      var wnoList = [];\r\n      var priceData = [];\r\n      selected_records.forEach(function(record) {\r\n        var price = priceObj[record.vehicle_vessel_name];\r\n        if (price > 0 || price === -1) {\r\n          record.vessel_price = price;\r\n          wnoList.push(record.waybill_no);\r\n          priceData.push({ wno: record.waybill_no, price: price, inner: 0 });\r\n          allInv.push(record);\r\n        }\r\n      });\r\n\r\n      selectedInnerNo.forEach(function(innerNo) {\r\n        var inv = getInvoiceByInnerNo(innerNo);\r\n        inv.bills.forEach(function(bill) {\r\n          bill.vehicles.forEach(function(veh) {\r\n            if (veh.inner_waybill_no === innerNo) {\r\n              var price = priceObj2[veh.veh_name];\r\n              if (price > 0 || price === -1) {\r\n                veh.veh_price = price;\r\n                if (wnoList.indexOf(inv.waybill_no) < 0) {\r\n                  wnoList.push(inv.waybill_no);\r\n                }\r\n\r\n                priceData.push({ wno: innerNo, price: price, inner: 1 });\r\n                var vehObj = getVehiclesInfo(inv, false);\r\n                if (vehObj) {\r\n                  vehObj[innerNo].price = price;\r\n                }\r\n\r\n                allInv.push(inv);\r\n              }\r\n            }\r\n          })\r\n        })\r\n      });\r\n\r\n      if (priceData.length) {\r\n        ajaxRequestHandle('/settle_vessel_price', 'POST', {wnoList: wnoList, priceData: priceData}, 'no_message', function () {\r\n          allInv.forEach(function(rec) {\r\n            updatePriceStateColumnText(rec, true);\r\n          });\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  function getPriceValue(id) {\r\n    var jqId = '#' + id;\r\n    var value = parseFloatHTML($(jqId).val());\r\n    if (isNaN(value) || value == 0) {\r\n      return 0;\r\n    } else {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  function makeInvVehInfo(invoice) {\r\n    var allVehicles = [];\r\n    invoice.bills.forEach(function(bill) {\r\n      allVehicles.push.apply(allVehicles, bill.vehicles);\r\n    });\r\n\r\n    var vehObj = {};\r\n    allVehicles.forEach(function(veh) {\r\n      if (isExist(vehObj[veh.inner_waybill_no])) {\r\n        vehObj[veh.inner_waybill_no].num += veh.send_num;\r\n        vehObj[veh.inner_waybill_no].weight += veh.send_weight;\r\n      } else {\r\n        vehObj[veh.inner_waybill_no] = {\r\n          name: veh.veh_name,\r\n          num: veh.send_num,\r\n          weight: veh.send_weight,\r\n          price: isExist(veh.veh_price) ? veh.veh_price : 0,\r\n          ship_from: veh.veh_ship_from,\r\n          state: '未结算', date: null,\r\n          unship_date: null, delay_day: 0, charge_cash:0, charge_oil: 0, receipt: 0, remark: '',\r\n          pay_date: null\r\n        };\r\n      }\r\n    });\r\n\r\n    if (isExist(invoice.inner_settle) && !isEmpty(invoice.inner_settle)) {\r\n      invoice.inner_settle.forEach(function(innset) {\r\n        vehObj[innset.inner_waybill_no].state = innset.state;\r\n        vehObj[innset.inner_waybill_no].date = innset.date;\r\n        vehObj[innset.inner_waybill_no].unship_date = innset.unship_date;\r\n        vehObj[innset.inner_waybill_no].delay_day = innset.delay_day;\r\n        //vehObj[innset.inner_waybill_no].advance_charge_mode = innset.advance_charge_mode;\r\n        //vehObj[innset.inner_waybill_no].advance_charge = innset.advance_charge;\r\n        vehObj[innset.inner_waybill_no].charge_cash = innset.charge_cash;\r\n        vehObj[innset.inner_waybill_no].charge_oil = innset.charge_oil;\r\n        vehObj[innset.inner_waybill_no].receipt = innset.receipt;\r\n        vehObj[innset.inner_waybill_no].remark = innset.remark;\r\n        vehObj[innset.inner_waybill_no].pay_date = innset.pay_date;\r\n      })\r\n    }\r\n\r\n    return vehObj;\r\n  }\r\n\r\n  function getVehiclesInfo(invoice, created) {\r\n    var vehObj;\r\n    var found = false;\r\n    for (var k = 0, len = allInvVehicles.length; k < len; ++k) {\r\n      if (invoice.waybill_no === allInvVehicles[k].wno) {\r\n        vehObj = allInvVehicles[k].vehInfo;\r\n        found = true;\r\n        break;\r\n      }\r\n    }\r\n    if (!found && created) {\r\n      vehObj = makeInvVehInfo(invoice);\r\n      allInvVehicles.push({ wno: invoice.waybill_no, vehInfo: vehObj });\r\n    }\r\n\r\n    return vehObj;\r\n  }\r\n\r\n  function getParameterText(state, receipt, cash, oil, remark) {\r\n    var color = (state === '不需要结算') ? \"gray\" : \"red\";\r\n    var show = remark ? \"\" : \"display:none\";\r\n    var checked = (receipt === 1) ? \"checked\" : \"\";\r\n    var ckReceipt = '<input class=\"select-receipt\" type=\"checkbox\" disabled ' + checked + '>&nbsp;<i class=\"fa fa-info-circle\" style=\"color:red; cursor:pointer; ' + show + '\" data-toggle=\"tooltip\" title=\"' + remark + '\"></i>';\r\n\r\n    var text = '无';\r\n    if (cash > 0 && oil > 0) {\r\n      text = '现金:' + cash + ',油:' + oil;\r\n    } else if (cash > 0) {\r\n      text = '现金:' + cash;\r\n    } else if (oil > 0) {\r\n      text = '油:' + oil;\r\n    }\r\n\r\n    return { state: getStrByStatus(state, state), color: color, ckReceipt: ckReceipt, chargeText: text};\r\n  }\r\n\r\n  function makeTableTrHtml(inv) {\r\n    var isVessel = false;\r\n    var vehObj = null;\r\n    var number = 0;\r\n    inv.bills.forEach(function(bill) {\r\n      number += bill.num;\r\n      if (!isVessel && bill.vehicles.length) {\r\n        isVessel = true;\r\n        vehObj = getVehiclesInfo(inv, true);\r\n      }\r\n    });\r\n\r\n    var allReceiptOk = true;\r\n    var allNotNeed = true;\r\n    var name = inv.ship_name + (inv.ship_customer ? \"/\" + inv.ship_customer : \"\");\r\n\r\n    var vehName = qFilter.getVehicleName();\r\n    if ((!vehName || vehName === inv.vehicle_vessel_name) && qFilter.settledState === inv.vessel_settle_state) {\r\n      allReceiptOk = (inv.receipt === 1);\r\n      allNotNeed = (inv.vessel_price < 0);\r\n      var paramText = getParameterText(inv.vessel_settle_state, inv.receipt, inv.charge_cash, inv.charge_oil, inv.remark);\r\n\r\n      var trHtml = '<tr class=\"tr_header\"><td nowrap><input class=\"select-inv\" type=\"checkbox\">&nbsp;<label class=\"fa fa-star-o not-need-settle\" data-toggle=\"tooltip\" title=\"点击可设置不需要结算和需要结算\" style=\"cursor:pointer; color:' + paramText.color + '; font-size:18px;\"></label>';\r\n      if (isVessel) {\r\n        trHtml += '&nbsp;<span data-toggle=\"tooltip\" title=\"点击展开和收缩\" style=\"cursor:pointer;font-size: 16px;\" class=\"fa fa-minus-square-o expand\"></span>';\r\n      }\r\n      trHtml += '</td><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td nowrap>{14}</td><td style=\"text-align: center\">{15}</td></tr>';\r\n\r\n      var pText = getInvVesselPriceText(vehObj, inv);\r\n      totalAmount += pText.price;\r\n      totalWeight += inv.total_weight;\r\n\r\n      if (inv.charge_cash > 0) {\r\n        prePayment += inv.charge_cash;\r\n      }\r\n      if (inv.charge_oil > 0) {\r\n        prePayment += inv.charge_oil;\r\n      }\r\n\r\n      tableBody.append(\r\n        trHtml.format(\r\n          paramText.state,\r\n          inv.waybill_no,\r\n          inv.vehicle_vessel_name + '/' + local_data.vehPersonMap[inv.vehicle_vessel_name],\r\n          name,\r\n          inv.ship_from,\r\n          inv.ship_to,\r\n          pText.priceText,\r\n          inv.vessel_price < 0 ? '无': getStrValue(inv.vessel_price),\r\n          number,\r\n          getStrValue(inv.total_weight),\r\n          date2Str(inv.ship_date),\r\n          date2Str(inv.vessel_settle_date),\r\n          date2Str(inv.unship_date, true),\r\n          inv.delay_day,\r\n          paramText.chargeText,\r\n          paramText.ckReceipt));\r\n    }\r\n\r\n    if (isVessel) {\r\n      var s = '<tr class=\"vessel_sub_item\" style=\"background: #e0e4f0;\"><td nowrap><input class=\"select-sub-inv\" type=\"checkbox\">&nbsp;<label class=\"fa fa-star-o not-need-settle\" data-toggle=\"tooltip\" title=\"点击可设置不需要结算和需要结算\" style=\"cursor:pointer; color:{16}; font-size:18px;\"></label></td>' +\r\n        '<td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td nowrap>{14}</td><td style=\"text-align: center\">{15}</td></tr>';\r\n\r\n      for (var key in vehObj) {\r\n        if (vehObj.hasOwnProperty(key) && ((!vehName || vehName === vehObj[key].name) && qFilter.settledState === vehObj[key].state)) {\r\n          var tmp = vehObj[key];\r\n          var hint = '无', ptext = '无';\r\n\r\n          //totalAmount += tmp.num;\r\n          totalWeight += tmp.weight;\r\n\r\n          if (tmp.price >= 0) {\r\n            var tp = tmp.price * tmp.weight;\r\n            hint = getStrValue(tmp.price);\r\n            ptext = getStrValue(tp);\r\n            totalAmount += tp;\r\n          }\r\n\r\n          if (tmp.charge_cash > 0) {\r\n            prePayment += tmp.charge_cash;\r\n          }\r\n          if (tmp.charge_oil > 0) {\r\n            prePayment += tmp.charge_oil;\r\n          }\r\n\r\n          allReceiptOk = allReceiptOk && (tmp.receipt === 1);\r\n          allNotNeed = allNotNeed && (tmp.price < 0);\r\n          paramText = getParameterText(tmp.state, tmp.receipt, tmp.charge_cash, tmp.charge_oil, tmp.remark);\r\n\r\n          tableBody.append(\r\n            s.format(\r\n              paramText.state,\r\n              key,\r\n              tmp.name + '/' + local_data.vehPersonMap[tmp.name],\r\n              name,\r\n              tmp.ship_from ? tmp.ship_from : '',\r\n              inv.vehicle_vessel_name,\r\n              ptext,\r\n              hint,\r\n              tmp.num,\r\n              getStrValue(tmp.weight),\r\n              date2Str(inv.ship_date),\r\n              date2Str(tmp.date),\r\n              date2Str(tmp.unship_date, true),\r\n              tmp.delay_day,\r\n              paramText.chargeText,\r\n              paramText.ckReceipt,\r\n              paramText.color));\r\n        }\r\n      }\r\n    }\r\n\r\n    return { receiptOk: allReceiptOk, notNeed: allNotNeed };\r\n  }\r\n\r\n  function resetTableRow() {\r\n    tableBody.empty();\r\n    selected_records = [];\r\n    selectedInnerNo = [];\r\n    totalAmount = 0;\r\n    totalWeight = 0;\r\n    prePayment  = 0;\r\n\r\n    var allNotNeed = true;\r\n    curr_records.forEach(function (inv) {\r\n      var res = makeTableTrHtml(inv);\r\n      if (!res.receiptOk) {\r\n        allReceiptOk = false;\r\n      }\r\n      if (!res.notNeed) {\r\n        allNotNeed = false;\r\n      }\r\n    });\r\n\r\n    if (allReceiptOk) {\r\n      ckReceiptIcon.addClass('fa-check-square-o');\r\n      ckReceiptIcon.removeClass('fa-square-o');\r\n    } else {\r\n      ckReceiptIcon.removeClass('fa-check-square-o');\r\n      ckReceiptIcon.addClass('fa-square-o');\r\n    }\r\n\r\n    if (allNotNeed) {\r\n      $('#all-not-need').css('color', 'gray');\r\n    } else {\r\n      $('#all-not-need').css('color', 'red');\r\n    }\r\n\r\n    $('#lb-total-weight').text(getStrValue(totalWeight));\r\n    $('#lb-total-amount').text(getStrValue(totalAmount));\r\n    $('#curr-number').text(tableBody.find(\"tr\").length);\r\n    $('#lb-unpay-amount').text(getStrValue(totalAmount - prePayment));\r\n    $('#select-all').prop(\"checked\", false);\r\n\r\n    enableButtons();\r\n\r\n    $('.tr_header').on('click', function () { selectRow($(this), true); });\r\n    $('.vessel_sub_item').on('click', function() { selectInnerRow($(this), true); });\r\n\r\n    $('.select-inv').on('click', function() { selectRow($(this).closest('tr'), false); });\r\n    $('.select-sub-inv').on('click', function() { selectInnerRow($(this).closest('tr'), false); });\r\n\r\n    $('.expand').on('click', function(e) {\r\n      e.stopImmediatePropagation();\r\n      var me = $(this);\r\n      var tr = me.closest('tr');\r\n      switchElementClass(me, 'fa-plus-square-o', 'fa-minus-square-o');\r\n      tr.nextUntil('tr.tr_header').slideToggle(100, function(){ });\r\n    });\r\n\r\n    $('.not-need-settle').on('click', function (e) {\r\n      e.stopImmediatePropagation();\r\n      if (qFilter.settledState === '未结算') {\r\n        var me = $(this);\r\n        var tr = me.closest('tr');\r\n        var wno = getTableCellChildren(tr, 2).text();\r\n        switchNotNeedSettle(me, [ wno ]);\r\n      } else {\r\n        bootbox.alert('已结算,不能再进行\"不需要结算操作\"');\r\n      }\r\n    });\r\n\r\n    $('[data-toggle=\"popover\"]').popover({ trigger: \"hover\", html: true, placement: \"bottom\" });\r\n  }\r\n\r\n  function selectInnerRow(me, needUpdateCheckBox) {\r\n    var innerNo = getTableCellChildren(me, 2).text();\r\n    var idx = selectedInnerNo.indexOf(innerNo);\r\n    if (idx < 0) {\r\n      selectedInnerNo.push(innerNo);\r\n//      me.addClass('invoice-highlighted');\r\n    } else {\r\n      selectedInnerNo.remove(idx);\r\n//      me.removeClass('invoice-highlighted');\r\n    }\r\n\r\n    if (needUpdateCheckBox) {\r\n      me.find('td:first').find('input[type=\"checkbox\"]').prop(\"checked\", (idx < 0));\r\n    }\r\n\r\n    $('#select-all').prop(\"checked\", (selected_records.length + selectedInnerNo.length) === tableBody.find(\"tr\").length);\r\n    enableButtons();\r\n  }\r\n\r\n  function selectRow(me, needUpdateCheckbox) {\r\n    if (me.hasClass(\"tr_header\")) {\r\n      var wno = getTableCellChildren(me, 2).text();\r\n      var found = false;\r\n      for (var i = 0; i < selected_records.length; ++i) {\r\n        if (wno === selected_records[i].waybill_no) {\r\n          selected_records.remove(i);\r\n          found = true;\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (found) {\r\n        me.removeClass('invoice-highlighted');\r\n      } else {\r\n        for (var k = 0, l = curr_records.length; k < l; ++k) {\r\n          if (wno === curr_records[k].waybill_no) {\r\n            selected_records.push(curr_records[k]);\r\n            break;\r\n          }\r\n        }\r\n        me.addClass('invoice-highlighted');\r\n      }\r\n\r\n      if (needUpdateCheckbox) {\r\n        me.find('td:first').find('input[type=\"checkbox\"]').prop(\"checked\", !found);\r\n      }\r\n\r\n      $('#select-all').prop(\"checked\", (selected_records.length + selectedInnerNo.length) === tableBody.find(\"tr\").length);\r\n      enableButtons();\r\n    }\r\n  }\r\n\r\n  function switchNotNeedSettle(me, wlist) {\r\n    var color = me.css('color');\r\n    if (color === 'rgb(255, 0, 0)') {\r\n      me.css('color', 'gray');\r\n      settleNotNeeded(wlist, true);\r\n    } else {\r\n      me.css('color', 'red');\r\n      settleNotNeeded(wlist, false);\r\n    }\r\n  }\r\n\r\n  function switchElementClass(elem, oc, nc) {\r\n    if (elem.hasClass(oc)) {\r\n      elem.addClass(nc);\r\n      elem.removeClass(oc);\r\n    }\r\n    else if (elem.hasClass(nc)) {\r\n      elem.addClass(oc);\r\n      elem.removeClass(nc);\r\n    }\r\n  }\r\n\r\n  function settleNotNeeded(wlist, notNeeded) {\r\n    ajaxRequestHandle('/settle_vessel_not_needed', 'POST', { wayNoList: wlist, notNeeded: notNeeded }, 'no_message', function () {\r\n      wlist.forEach(function (wno) {\r\n        var waybillNo = wno;\r\n        if (wno.length > 17) {\r\n          waybillNo = wno.substring(0, 17);\r\n        }\r\n        for (var i = 0; i < curr_records.length; ++i) {\r\n          if (waybillNo === curr_records[i].waybill_no) {\r\n            var inv = curr_records[i];\r\n            if (wno.length > 17) {\r\n              inv.bills.forEach(function (bill) {\r\n                bill.vehicles.forEach(function (bveh) {\r\n                  if (wno === bveh.inner_waybill_no) {\r\n                    bveh.veh_price = notNeeded ? -1 : 0;\r\n                  }\r\n                })\r\n              });\r\n\r\n              var vehObj = getVehiclesInfo(inv, false);\r\n              if (vehObj && isExist(vehObj[wno])) {\r\n                if (notNeeded) {\r\n                  vehObj[wno].price = -1;\r\n                  vehObj[wno].date = new Date();\r\n                  vehObj[wno].state = '不需要结算';\r\n                } else {\r\n                  vehObj[wno].price = 0;\r\n                  vehObj[wno].date = null;\r\n                  vehObj[wno].state = '未结算';\r\n                }\r\n              }\r\n\r\n              inv.inner_settle.forEach(function(inner) {\r\n                if (inner.inner_waybill_no === wno) {\r\n                  if (notNeeded) {\r\n                    inner.date = new Date();\r\n                    inner.state = '不需要结算';\r\n                  } else {\r\n                    inner.date = null;\r\n                    inner.state = '未结算';\r\n                  }\r\n                }\r\n              })\r\n            } else {\r\n              if (notNeeded) {\r\n                inv.vessel_price = -1;\r\n                inv.vessel_settle_state = '不需要结算';\r\n                inv.vessel_settle_date = new Date();\r\n              } else {\r\n                inv.vessel_price = 0;\r\n                inv.vessel_settle_state = '未结算';\r\n                inv.vessel_settle_date = null;\r\n              }\r\n            }\r\n\r\n            updatePriceStateColumnText(inv, true);\r\n            break;\r\n          }\r\n        }\r\n      })\r\n    });\r\n  }\r\n\r\n  function getInvVesselPriceText(vehObj, inv) {\r\n    var tip = \"\";\r\n    if (inv.vessel_price > 0) {\r\n      tip += '车船号:{0}, 发运重量:{1}, 单价:{2}, 目的地:{3}'.format(inv.vehicle_vessel_name, getStrValue(inv.total_weight), getStrValue(inv.vessel_price), inv.ship_to);\r\n    }\r\n\r\n    if (vehObj) {\r\n      var i = 1;\r\n      for (var key in vehObj) {\r\n        if (vehObj.hasOwnProperty(key)) {\r\n          tip += '\\r第{0}车: {1}, 发运重量:{2}, 单价:{3}, 目的地:{4}'.format(i, vehObj[key].name, getStrValue(vehObj[key].weight),\r\n              vehObj[key].price < 0 ? '无' : getStrValue(vehObj[key].price), inv.vehicle_vessel_name);\r\n          ++i\r\n        }\r\n      }\r\n    }\r\n\r\n    if (inv.vessel_price < 0) {\r\n      return { priceText: '<code style=\"color: darkgray\">无</code>', tooltip: tip, price: 0 };\r\n    } else {\r\n      var p = inv.vessel_price * inv.total_weight;\r\n      return {\r\n        priceText: '<code style=\"color: blue\">' + getStrValue(p) + '</code>',\r\n        tooltip: tip,\r\n        price: p\r\n      };\r\n    }\r\n  }\r\n\r\n  // Export function\r\n  elementEventRegister(btnExport, 'click', function() {  tableToExcel($('#table-content').html(), \"data\"); });\r\n  elementEventRegister(btnFilter, 'click', function() { $('#filter-ui').toggle() });\r\n});\r\n\r\n/////////////////////////////////////////\r\n//////// CLASS DEFINE////////////////////\r\n/////////////////////////////////////////\r\nvar QueryFilterD = function(options) {\r\n  this.uiElems = {\r\n    sBfBillName : $('#bf-bill-name'),\r\n    sBfDest : $('#bf-destination'),\r\n    sBfVehicle : $('#bf-vehicle'),\r\n    sBfVehContact: $('#bf-vehicle-contact'),\r\n    startDateGrp : $('#start-date-grp'),\r\n    endDateGrp : $('#end-date-grp'),\r\n    iStartDate : $('#start-date'),\r\n    iEndDate : $('#end-date'),\r\n    rSettled: $('#vessel-settled'),\r\n    rNoSettled: $('#no-vessel-settled'),\r\n    rSettledPay: $('#vessel-pay'),\r\n    rSettledNotNeeded: $('#vessel-no-need-settled')\r\n  };\r\n\r\n  this.options = options;\r\n  initSelect(this.uiElems.sBfBillName, options.nameList, true);\r\n  initSelect(this.uiElems.sBfVehicle, options.vehList, true);\r\n  initSelect(this.uiElems.sBfDest, options.destList, true);\r\n  initSelect(this.uiElems.sBfVehContact, options.contactNameList, true);\r\n  this.uiElems.rNoSettled.iCheck('check');//.prop('checked', false);\r\n  this.uiElems.iStartDate.val(\"\");\r\n  this.uiElems.iEndDate.val(\"\");\r\n\r\n  this.uiElems.sBfBillName.select2({allowClear:true});\r\n  this.uiElems.sBfVehicle.select2({allowClear:true});\r\n  this.uiElems.sBfDest.select2({allowClear:true});\r\n  this.selectedVeh;\r\n\r\n  this.currSelected = 0;\r\n  this.settledState = '未结算';\r\n  this.sDate = null;\r\n  this.eDate = null;\r\n\r\n  this._selectFliterFunc = function(which, filter) {\r\n    this.currSelected = which;\r\n    if (this.isAllEmpty()) {\r\n      //filter(false, true);       // return to initial state\r\n    }\r\n    else {\r\n      //filter(true, false);\r\n    }\r\n  };\r\n\r\n  this._dateFilterFunc = function(isStart, isEnd, filter) {\r\n    var d1 = this.uiElems.iStartDate.val();\r\n    var d2 = this.uiElems.iEndDate.val();\r\n    var b = false;\r\n    if (isStart && isEnd) {\r\n      b = !isEmpty(d1) && !isEmpty(d2);\r\n    } else if (isStart) {\r\n      b = isEmpty(this.uiElems.iStartDate.val());\r\n    } else if (isEnd) {\r\n      b = isEmpty(this.uiElems.iEndDate.val());\r\n    }\r\n\r\n    if (b) {\r\n      this.currSelected = 5;\r\n      //filter(true, false);\r\n    }\r\n  }\r\n};\r\n\r\nQueryFilterD.prototype.getQueryParams = function() {\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var d1 = this.uiElems.iStartDate.val();\r\n  var d2 = this.uiElems.iEndDate.val();\r\n  var b = !isEmpty(d1) && !isEmpty(d2);\r\n\r\n  return {\r\n    fName: name ? name : null,\r\n    fVeh: this.selectedVeh ?  this.selectedVeh : null,\r\n    fDest: dest ? dest : null,\r\n    fSettledState: this.settledState,\r\n    fDate1: b ? this.sDate.toISOString() : null,\r\n    fDate2: b ? this.eDate.toISOString(): null\r\n  };\r\n};\r\n\r\nQueryFilterD.prototype.getVehicleName = function() {\r\n  return this.selectedVeh;\r\n};\r\n\r\nQueryFilterD.prototype.eventHandler = function(filter) {\r\n  var self = this;\r\n  self.uiElems.sBfBillName.on('change', function() {\r\n    self._selectFliterFunc(1, filter);\r\n  });\r\n  self.uiElems.rNoSettled.on('ifChecked', function() {\r\n    self.settledState = '未结算';\r\n    self._selectFliterFunc(2, filter);\r\n  });\r\n  self.uiElems.rSettled.on('ifChecked', function() {\r\n    self.settledState = '已结算';\r\n    self._selectFliterFunc(2, filter);\r\n  });\r\n  self.uiElems.rSettledPay.on('ifChecked', function() {\r\n    self.settledState = '已付款';\r\n    self._selectFliterFunc(2, filter);\r\n  });\r\n  self.uiElems.rSettledNotNeeded.on('ifChecked', function() {\r\n    self.settledState = '不需要结算';\r\n    self._selectFliterFunc(2, filter);\r\n  });\r\n  self.uiElems.sBfVehicle.on('change', function(e) {\r\n    self.selectedVeh = e.val;\r\n    if (self.selectedVeh === '无-取消选择') self.selectedVeh = '';\r\n\r\n    self._selectFliterFunc(3, filter);\r\n  });\r\n  self.uiElems.sBfVehContact.on('change', function() {\r\n    self.currSelected = 6;\r\n    //filter(false, false);\r\n  });\r\n  self.uiElems.sBfDest.on('change', function() {\r\n    self._selectFliterFunc(4, filter);\r\n  });\r\n\r\n  self.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.sDate = e.date.startOf('day');\r\n    self.uiElems.endDateGrp.data(\"DateTimePicker\").setMinDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions()).on('dp.change', function(e) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    self.eDate = e.date.endOf('day');\r\n    self.uiElems.startDateGrp.data(\"DateTimePicker\").setMaxDate(e.date);\r\n    self._dateFilterFunc(true, true, filter);\r\n  });\r\n  self.uiElems.iStartDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(true, false, filter);\r\n  });\r\n  self.uiElems.iEndDate.on('change', function(e) {\r\n    e.stopImmediatePropagation();\r\n    self._dateFilterFunc(false, true, filter);\r\n  });\r\n};\r\n\r\nQueryFilterD.prototype.isAllEmpty = function() {\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var d1 = this.uiElems.iStartDate.val();\r\n  var d2 = this.uiElems.iEndDate.val();\r\n  return isEmpty(this.selectedVeh) && isEmpty(dest) && isEmpty(name) && isEmpty(d1) && isEmpty(d2);\r\n};\r\n\r\nQueryFilterD.prototype.updateOptions = function(records, reset) {\r\n  var vehicle = this.selectedVeh;\r\n  var vehicleContactName = getSelectValue(this.uiElems.sBfVehContact);\r\n  var dest = getSelectValue(this.uiElems.sBfDest);\r\n  var name = getSelectValue(this.uiElems.sBfBillName);\r\n  var nOptions = { vehList: [], destList: [], contactNameList: [] };\r\n  var visibleRecs = [];\r\n\r\n  var clearContactName = false;\r\n  if (this.currSelected === 6 && !vehicleContactName) {\r\n    vehicle = '';\r\n    this.selectedVeh = '';\r\n    clearContactName = true;\r\n  }\r\n\r\n  if (!vehicle && this.currSelected === 3) {\r\n    vehicleContactName = null;\r\n  }\r\n\r\n  if (reset) {\r\n    nOptions = this.options;\r\n    visibleRecs = records;\r\n    records.forEach(function (bill) {\r\n      if (bill.ship_to && nOptions.destList.indexOf(bill.ship_to) < 0) {\r\n        nOptions.destList.push(bill.ship_to);\r\n      }\r\n    });\r\n  } else {\r\n    var vList = [], dList = [], k, m;\r\n    var allVehList = [];\r\n    if (vehicleContactName) {\r\n      var pList = this.options.vehPersonMap;\r\n      for (var key in pList) {\r\n        if (pList[key] === vehicleContactName) {\r\n          allVehList.push(key);\r\n        }\r\n      }\r\n    }\r\n\r\n    records.forEach(function (rec) {\r\n      var b2 = false;\r\n      if (clearContactName) {\r\n        b2 = false;\r\n      } else if (allVehList.length) {\r\n        if (allVehList.indexOf(rec.vehicle_vessel_name) >= 0) {\r\n          b2 = true;\r\n        } else {\r\n          for (k = 0; k < rec.bills.length; ++k) {\r\n            for (m = 0; m < rec.bills[k].vehicles.length && !b2; ++m) {\r\n              if (allVehList.indexOf(rec.bills[k].vehicles[m].veh_name) >= 0) {\r\n                b2 = true;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n      else if (vehicle) {\r\n        if (vehicle === rec.vehicle_vessel_name) {\r\n          b2 = true;\r\n        } else {\r\n          for (k = 0; k < rec.bills.length; ++k) {\r\n            for (m = 0; m < rec.bills[k].vehicles.length && !b2; ++m) {\r\n              if (rec.bills[k].vehicles[m].veh_name === vehicle) {\r\n                b2 = true;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      } else {\r\n        b2 = true;\r\n      }\r\n\r\n      var b3 = !dest || dest === rec.ship_to;\r\n      var b4 = !name || name === rec.ship_name;\r\n      if (b2 && b3 && b4) {\r\n        visibleRecs.push(rec);\r\n        if (rec.ship_to && dList.indexOf(rec.ship_to) < 0) {\r\n          dList.push(rec.ship_to);\r\n        }\r\n\r\n        if (allVehList.length === 0) {\r\n          if (rec.vehicle_vessel_name && vList.indexOf(rec.vehicle_vessel_name) < 0) {\r\n            vList.push(rec.vehicle_vessel_name);\r\n          }\r\n\r\n          for (k = 0; k < rec.bills.length; ++k) {\r\n            for (m = 0; m < rec.bills[k].vehicles.length; ++m) {\r\n              if (vList.indexOf(rec.bills[k].vehicles[m].veh_name) < 0) {\r\n                vList.push(rec.bills[k].vehicles[m].veh_name);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    nOptions.vehList = sort_pinyin(allVehList.length ? allVehList : vList);\r\n    nOptions.destList = sort_pinyin(dList);\r\n\r\n    if (this.currSelected === 6) {\r\n      if (this.isAllEmpty() && !vehicleContactName) {\r\n        nOptions.vehList = this.options.vehList;\r\n        nOptions.destList = this.options.destList;\r\n      }\r\n    } else if (nOptions.vehList.length) {\r\n      var nList = this.options.vehPersonMap;\r\n      nOptions.vehList.forEach(function (nv) {\r\n        var cname = nList[nv];\r\n        if (cname && nOptions.contactNameList.indexOf(cname) < 0) {\r\n          nOptions.contactNameList.push(cname);\r\n        }\r\n      });\r\n\r\n      nOptions.contactNameList = sort_pinyin(nOptions.contactNameList);\r\n    }\r\n  }\r\n\r\n  var contactName = (vehicle) ? this.options.vehPersonMap[vehicle] : null;\r\n\r\n  if (this.currSelected === 2) {\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n    initSelect(this.uiElems.sBfVehContact, nOptions.contactNameList, true, contactName);\r\n  }\r\n  else if (this.currSelected === 3) {\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n    if (contactName) {\r\n      this.uiElems.sBfVehContact.val(contactName);\r\n    } else {\r\n      unselected(this.uiElems.sBfVehContact);\r\n    }\r\n  }\r\n  else if (this.currSelected === 6) {\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, true);\r\n    if (!vehicleContactName) {\r\n      initSelect(this.uiElems.sBfVehContact, this.options.contactNameList, true);\r\n    }\r\n  }\r\n  else if (this.currSelected === 4) {\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfVehContact, nOptions.contactNameList, true, contactName);\r\n  }\r\n  else {\r\n    initSelect(this.uiElems.sBfVehicle, nOptions.vehList, true);\r\n    this.uiElems.sBfVehicle.select2('val', this.selectedVeh);\r\n    initSelect(this.uiElems.sBfDest, nOptions.destList, true, dest);\r\n    initSelect(this.uiElems.sBfVehContact, nOptions.contactNameList, true, contactName);\r\n  }\r\n\r\n  return visibleRecs;\r\n};\r\n"]}