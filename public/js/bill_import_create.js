$(function(){"use strict";var _,l,f=["bill_no","order","brand_no","block_len","width","thickness","size_type","weight","block_num","total_weight","warehouse","ship_warehouse","sales_dep","billing_name","contract_no","shipping_address","order_item_no","dimensions","product_type","sources"],h={"提单号":0,"移拨码单号":0,"入库单号":0,"订单项次号":1,"订单编号-项次":1,"订单编号":1,"订单号-项次":1,"订单号":1,"牌号":2,"标准全名":2,"标准号":2,"标准名":2,"钢号":2,"长度":3,"长":3,"宽度":4,"宽":4,"厚度":5,"厚":5,"尺寸":6,"尺寸信息":6,"单重":7,"发运数":8,"块数":8,"数量(块)":8,"数量（块）":8,"支数":8,"计划出货重量":9,"发货重量":9,"可发货重量":9,"计划重量":9,"重量（T）":9,"重量(T)":9,"重量":9,"发货库别":11,"发货仓库":11,"仓库":11,"始发库":11,"销售部门":12,"销售组别":12,"客户名称":13,"客户":13,"客户信息":13,"客户编号":13,"现有货主":13,"现在货主":13,"合同号":14,"合同":14,"客户采购案号":14,"收货地址":15,"订单项次":16,"项次":16,"规格":17,"产品型态":18,"货物来源":19},o="undefined"!=typeof FileReader&&void 0!==FileReader.prototype&&void 0!==FileReader.prototype.readAsBinaryString,n="undefined"!=typeof Worker,m=!0,a=$("#import_execl"),u=[],d=0,g=!1;function t(e){e.stopPropagation(),e.preventDefault(),0<e.target.files.length&&(nlApp.setTitle("读取文件,请稍等..."),nlApp.showPleaseWait(),function(e){u=[];for(var t=0;t<e.length;++t){i=e[t];var r=new FileReader,l=i.name.split(".").pop().toLowerCase();_=(m="xlsx"===l)?XLSX:XLS,r.onload=function(e){var t=e.target.result;if(n)c(t,v);else{var r=o?_.read(t,{type:"binary"}):_.read(btoa(p(t)),{type:"base64"});v(r)}},o?r.readAsBinaryString(i):r.readAsArrayBuffer(i)}}(e.target.files))}$("#execl_file").on("change",function(e){d=0,t(e)}),$("#execl_file_1").on("change",function(e){d=1,t(e)});var i,s=[{msg:"xls",rABS:"../js/plugins/sheetJS/XLS/xlsworker2.js",norABS:"../js/plugins/sheetJS/XLS/xlsworker1.js",noxfer:"../js/plugins/sheetJS/XLS/xlsworker.js"},{msg:"xlsx",rABS:"../js/plugins/sheetJS/XLSX/xlsxworker2.js",norABS:"../js/plugins/sheetJS/XLSX/xlsxworker1.js",noxfer:"../js/plugins/sheetJS/XLSX/xlsxworker.js"}];function c(e,r){var t;if(n)if((t=m?new Worker(o?s[1].rABS:s[1].norABS):new Worker(o?s[0].rABS:s[0].norABS)).onmessage=function(e){switch(e.data.t){case"ready":break;case"e":console.error(e.data.d);break;default:var t=function(e){for(var t="",r=0,l=10240;r<e.byteLength/l;++r)t+=String.fromCharCode.apply(null,new Uint16Array(e.slice(r*l,r*l+l)));return t+=String.fromCharCode.apply(null,new Uint16Array(e.slice(r*l)))}(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r");console.log("done"),r(JSON.parse(t))}},o){var l=function(e){for(var t=new ArrayBuffer(2*e.length),r=new Uint16Array(t),l=0;l!=e.length;++l)r[l]=e.charCodeAt(l);return[r,t]}(e);t.postMessage(l[1],[l[1]])}else t.postMessage(e,[e]);else{(t=m?new Worker(s[1].noxfer):new Worker(s[0].noxfer)).onmessage=function(e){switch(e.data.t){case"ready":break;case"e":console.error(e.data.d);break;case"xlsx":case"xls":r(JSON.parse(e.data.d))}};var a=o?e:btoa(p(e));t.postMessage({d:a,b:o})}}function p(e){for(var t="",r=0,l=10240;r<e.byteLength/l;++r)t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(r*l,r*l+l)));return t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(r*l)))}function v(e){var t,r,c,p,u;m||"undefined"==typeof Worker||XLS.SSF.load_table(e.SSF),t=i.name,p="<thead><tr>",u=!0,(c=e).SheetNames.forEach(function(e){var t,r=m?_.utils.sheet_to_csv(c.Sheets[e]):_.utils.make_csv(c.Sheets[e]);if(0<r.length){var l=(r=r.replace(/([^"]+)|("[^"]+")/g,function(e,t,r){return r?r.replace(/[\s+""]/g,"").replace(/,/g,"`"):t})).match(/[^\r\n]+/g),a=!1,o=[],n=[],i=-1;g=!1;for(var s=0;s<l.length;s++)if(a){var d=b(l[s],o,n,i);0<d.length&&(p+=d)}else{if(20<s){u=!1,console.log("No Header found!");break}0<=(t=l[s]).indexOf("订单")&&(0<=t.indexOf("长")&&0<=t.indexOf("宽")&&0<=t.indexOf("厚")||0<=t.indexOf("规格"))&&(a=!0,o=l[s].split(","),n=o.map(function(e){var t=-1;for(var r in h)if(e===r){t=h[r];break}return-1<t?f[t]:e}),$.each(o,function(e,t){t&&(p+="<th>"+t+"</th>","承运单位"===t?i=e:"货物来源"===t&&(g=!0))}),p+="</tr></thead><tbody>")}a&&(p+="</tbody>")}}),(r=u?p:"")?(a.html(r),l&&l.fnDestroy(),setElementValue($("#excel-filename"),"打开的文件: "+t),a.html(r),l=a.dataTable(getDataTableParams(!1,"300%")),$(l).show()):bootbox.alert("不正确的Excel数据文件或文件无数据..."),nlApp.hidePleaseWait()}function b(e,t,r,l){var a=e.split(","),o=a.length,n=t.length;if(0<=l&&l<o&&"南京鑫鸿图储运有限公司"!=$.trim(a[l]))return"";for(var i=!0,s=0;s<o;s++)a[s]=$.trim(a[s]).replace(/`/g,","),a[s].length&&(i=!1);if(i)return"";var d={},c="<tr>";if(o<=n){for(var p=0;p<o&&t[p];++p)c+="<td>"+a[p]+"</td>",d[r[p]]=a[p];for(p=o;p<n&&t[p];++p)c+="<td></td>",d[r[p]]=""}else for(s=0;s<n&&t[s];++s)c+="<td>"+a[s]+"</td>",d[r[s]]=a[s];return c+="</tr>",u.push(d),c}$("#excel_submit").on("click",function(e){if(e.stopPropagation(),e.preventDefault(),0!==u.length){$("body").css("cursor","progress");var i=[],s=!0;u.forEach(function(e){if(s=!1,isExist(e.order_item_no)&&11===e.order.length)e.order_no=e.order,e.order=getOrder(e.order_no,e.order_item_no),e.order_item_no=parseInt(e.order_item_no),s=!0;else{var t=e.order.split("-");if(2===t.length)e.order_no=t[0],e.order_item_no=parseInt(t[1]),e.order=getOrder(e.order_no,e.order_item_no),s=!0;else{e.order_no=e.order.substring(0,11),e.order_item_no=0;var r=e.order.substring(11);if(r){var l=parseInt(r);isNaN(l)||(e.order_item_no=l,e.order=getOrder(e.order_no,e.order_item_no),s=!0)}}}if(s)if(1===d){for(var a=!1,o=0;o<i.length;++o){var n=i[o];if(n.bill_no===e.bill_no&&n.order===e.order){n.block_num=+n.block_num+ +e.block_num,n.weight=+n.weight+ +e.block_num,n.total_weight=+n.total_weight+ +e.total_weight,a=!0;break}}a||(g&&(e.ship_warehouse="转外库"),i.push(e))}else i.push(e)});var t=getAJAXRequest("/create_bill","POST",i);t.done(function(e){if($("body").css("cursor","auto"),e.ok)if(e.noUpdatedData.length){var t=$("#part-imprt-tbody");t.empty();e.noUpdatedData.forEach(function(e){t.append('<tr><td style="text-align: center;"><span class="label label-info">{0}</span></td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td>{14}</td><td>{15}</td><td>{16}</td><td>{17}</td><td>{18}</td><td>{19}</td></tr>'.format(e.status,getOrder(e.order_no,e.order_item_no),e.bill_no,e.brand_no?e.brand_no:"",e.billing_name?e.billing_name:"",e.sales_dep?e.sales_dep:"",e.thickness?e.thickness:"",e.width?e.width:"",e.len?e.len:"",e.size_type?e.size_type:"",e.weight?e.weight:"",e.block_num?e.block_num:"",e.total_weight?e.total_weight:"",e.ship_warehouse?e.ship_warehouse:"",e.shipping_address?e.shipping_address:"",e.contract_no?e.contract_no:"",date2Str(e.create_date),date2Str(e.shipping_date),e.creater?e.creater:"",e.shipper?e.shipper:""))}),$("#part-import-btn-ok, #close-dialog").on("click",function(){$("#part-import-dialog").modal("hide"),setElementValue($("#excel-filename"),""),$(l).hide(),u=[],$("#execl_file").val(""),$("#execl_file_1").val("")}),$("#part-import-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}else bootbox.alert("导入数据成功",function(){setElementValue($("#excel-filename"),""),$(l).hide(),u=[],$("#execl_file").val(""),$("#execl_file_1").val("")});else bootbox.alert("导入数据失败:"+e.response)}),t.fail(function(e,t){bootbox.alert("导入数据失败: "+t),$("body").css("cursor","auto")})}else bootbox.alert("无数据！请导入正确的Excel数据")});var e=local_data,y=$("#bill-no"),k=$("#order-no"),w=$("#order-item-no"),x=$("#billing_name"),S=$("#sales_dep"),E=$("#ship_warehouse"),A=$("#bill-thickness"),O=$("#bill-width"),F=$("#bill-length"),L=$("#bill-weight"),r=$("#bill-forumla"),R=$("#bill-number"),X=$("#bill-tot-weight"),j=$("#brand_no"),B=$("#size_type"),C=$("#contract_no"),N=$("#product_type"),T=!0,D=[],H=$("#input-bill-content");function V(){y.val(""),k.val(""),w.val(""),A.val(""),O.val(""),F.val(""),L.val(""),R.val(""),X.val(""),C.val(""),N.val(""),x.select2("val",""),unselected(S),unselected(E),j.select2("val",""),B.val("定尺"),r.iCheck("check"),T=!0,H.empty(),D=[]}j.select2(),j.select2("val","");var J=[];function M(){if(T){var e=parseFloatHTML(F.val())*parseFloatHTML(O.val())*parseFloatHTML(A.val())*7.85*Math.pow(10,-9);if(0<e){var t=toFixedStr(e,3);setElementValue(L,t),setElementValue(X,getStrValue(+t*parseFloatHTML(R.val())))}else L.val(""),X.val("")}}e.company.forEach(function(e){J.push(e.name)}),e.warehouse=sort_pinyin(e.warehouse),initSelect(x,sort_pinyin(J),!1),initSelect(E,e.warehouse,!1),x.select2(),x.select2("val",""),E.select2(),V(),A.ForceNumericOnly(),O.ForceNumericOnly(),F.ForceNumericOnly(),L.ForceNumericOnly(),R.ForceNumericOnly(),X.ForceNumericOnly(),elementEventRegister(k,"blur",function(){var e=$(this).val();11!=e.length&&bootbox.alert("当前输入的订单号的长度是"+e.length+"位，长度必须为11位")}),elementEventRegister(F,"keyup paste",M),elementEventRegister(O,"keyup paste",M),elementEventRegister(A,"keyup paste",M),elementEventRegister(R,"keyup paste",M),elementEventRegister(r,"ifChecked",function(){T=!0,setHtmlElementDisabled(X,!0),setHtmlElementDisabled(R,!1),M()}),elementEventRegister(r,"ifUnchecked",function(){T=!1,setHtmlElementDisabled(X,!1),setHtmlElementDisabled(R,!0),L.val(""),X.val(""),R.val("")}),elementEventRegister($("#ui_input_save"),"click",function(){D.length?ajaxRequestHandle("/create_bill","POST",D,"数据保存",function(){V()}):bootbox.alert("没有数据, 请输入")}),elementEventRegister($("#add-one"),"click",function(){var e=y.val(),t=k.val(),r=w.val(),l=x.val(),a=X.val();if(isEmpty(e))bootbox.alert("请输入提单号");else if(isEmpty(t))bootbox.alert("请输入订单号");else if(11!=t.length)bootbox.alert("订单号的长度必须是11位, 当前输入长度为："+t.length);else if(isEmpty(r))bootbox.alert("请输入订单项次号");else if(isEmpty(l))bootbox.alert("请选择开单名称");else if(isEmpty(a)&&0<a)bootbox.alert("请输入总重量");else{for(var o=!0,n=getOrder(t,r),i=0;i<D.length;++i)if(D[i].order===n){bootbox.alert("不唯一, 订单号项次 + 提单号相同"),o=!1;break}if(o){D.push({order:getOrder(t,r),bill_no:e,order_no:t,order_item_no:r,brand_no:isEmpty(j.val())?"":j.val(),billing_name:l,sales_dep:isEmpty(S.val())?"":S.val(),block_len:isEmpty(F.val())?"":F.val(),width:isEmpty(O.val())?"":O.val(),thickness:isEmpty(A.val())?"":A.val(),size_type:B.val(),weight:isEmpty(L.val())?"":L.val(),block_num:isEmpty(R.val())?"":R.val(),total_weight:a,ship_warehouse:isEmpty(E.val())?"":E.val(),contract_no:isEmpty(C.val())?"":C.val(),product_type:isEmpty(N.val())?"":N.val()});var s="";D.forEach(function(e){s+=function(e){for(var t='<tr><td style="cursor:pointer" class="td-icon"><i title="删除" class="fa fa-trash-o redlink"></i></td>',r=0;r<14;++r)t+="<td>{"+r+"}</td>";return(t+="</tr>").format(e.bill_no,getOrder(e.order_no,e.order_item_no),e.billing_name,getStrValue(e.thickness),getStrValue(e.width),getStrValue(e.block_len),e.size_type,e.block_num,getStrValue(e.total_weight),e.brand_no?e.brand_no:"",e.sales_dep?e.sales_dep:"",e.ship_warehouse?e.ship_warehouse:"",e.contract_no?e.contract_no:"",e.product_type?e.product_type:"")}(e)}),H.html(s),$(".redlink").on("click",function(e){e.stopImmediatePropagation();var t=$(this).closest("tr");D.remove(t.index()),t.remove()})}}})});
//# sourceMappingURL=bill_import_create.js.map
