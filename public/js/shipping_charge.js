$(function(){"use strict";var f=$("#table-tbody"),e=$("#search-export"),t=$("#show-detail"),i=$("#settle-print-detail"),c=$("#print-detail-tbody"),l=[],s=[],d=[],g=void 0,a=new QueryFilterD(local_data);function n(e,t,i){var l="<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td>";return 0<e.block_num?l.format(e.bill_no,getOrder(e.order_no,e.order_item_no),e.ship_warehouse?e.ship_warehouse:"",getStrValue(e.thickness),getStrValue(e.width),getStrValue(e.len),getStrValue(e.weight),e.block_num,getStrValue(e.total_weight),t,getStrValue(e.weight*t),0<e.customer_price?getStrValue(e.customer_price):0,0<e.collection_price?getStrValue(e.collection_price):0):l.format(e.bill_no,getOrder(e.order_no,e.order_item_no),e.ship_warehouse?e.ship_warehouse:"",getStrValue(e.thickness),getStrValue(e.width),getStrValue(e.len),"","",getStrValue(e.total_weight),t,getStrValue(i),0<e.customer_price?getStrValue(e.customer_price):0,0<e.collection_price?getStrValue(e.collection_price):0)}a.eventHandler(function(e,t){e?$.get("/get_invoice_report",a.getQueryParams(),function(e){var t=jQuery.parseJSON(e);if(l=[],t.ok){if(t.hint){var i="查询到的数据记录为："+t.num+", (全部显示会比较慢，请进一步缩小查询条件！)";bootbox.alert(i),g=void 0}else g=t.prices;l=sortByKey(t.invs,"ship_date","DSC"),s=sortByKey(t.invs,"ship_date","DSC")}else s=[];a.updateOptions(s),o()}):(t&&(l=[]),s=a.updateOptions(l),o())}),elementEventRegister(t,"click",function(){if(0<d.length){var r=d[0],i=!1;r.bills.forEach(function(e){e.vehicles.length&&(i=!0)}),$.get("/get_waybill",{q:r.waybill_no},function(e){var t=jQuery.parseJSON(e).bills,a="";t.forEach(function(e){var t=0;t=0<e.customer_price?0<e.collection_price?e.collection_price+e.customer_price:e.customer_price:0<e.collection_price?e.collection_price:0;for(var i=0;i<r.bills.length;++i){var l=r.bills[i];if(String(e._id)===String(l.bill_id)){a+=n(e,l.num,l.weight);if(0<l.weight?t*l.weight:l.vehicles.length?l.vehicles.forEach(function(e){e.send_weight,e.send_weight*e.veh_price}):0<e.block_num&&l.num*e.weight,l.vehicles.length){var s="";l.vehicles.forEach(function(e){s="{0}, <code>重量:{1}</code><code>单价:{2}</code><code>价格:{3}</code><br />".format(e.veh_name,getStrValue(e.send_weight),getStrValue(e.veh_price),0<e.veh_price?getStrValue(e.veh_price*e.send_weight):0)}),a+="<td>"+s+"</td></tr>"}else a+="<td></td></tr>";break}}}),$("#tb-detail-tbody").html(a),showHtmlElement($("#tb-detail th:last-child, #tb-detail td:last-child"),i),$("#settle-detail-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")})}}),i.on("click",function(){if(d.length){c.empty();for(var e='<tr><td style="border:1px solid black;padding:5px;">{0}</td><td style="border:1px solid black;padding:5px;">{1}</td><td style="border:1px solid black;padding:5px;">{2}</td><td style="border:1px solid black;padding:5px;">{3}</td><td style="border:1px solid black;padding:5px;">{4}</td><td style="border:1px solid black;padding:5px;">{5}</td><td style="border:1px solid black;padding:5px;">{6}</td><td style="border:1px solid black;padding:5px;">{7}</td><td style="border:1px solid black;padding:5px;">{8}</td><td style="border:1px solid black;padding:5px;">{9}</td></tr>',t=0,i=0,l=f.find("tr").length,s=0;s<l;++s){var a=getRowChildren(f,s);if(getTableCellChildren(a,0).find("input").is(":checked")){var r=getTableCellChildren(a,10).text(),n=getTableCellChildren(a,7).text();c.append(e.format(getTableCellChildren(a,3).text(),getTableCellChildren(a,4).text(),getTableCellChildren(a,5).text(),getTableCellChildren(a,6).text(),r,getTableCellChildren(a,8).text(),n,getTableCellChildren(a,11).text(),getTableCellChildren(a,14).text(),getTableCellChildren(a,15).text())),t+=+r,i+=+n}}$("#print-total-weight").text(getStrValue(t)),$("#print-total-number").text(getStrValue(i)),$("#settle-print-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}else bootbox.alert("请选择你要打印的清单列表")}),$("#print-to").on("click",function(){var e=window.open();return e?(e.document.write($("#print-div").html()),e.print(),e.close(),!0):(bootbox.alert("请允许弹出窗口!"),!1)});function r(e){var t=!1,i=0;e.bills.forEach(function(e){i+=e.num,!t&&e.vehicles.length&&(t=!0)});var l,s,a,r,n,c,d,o=e.ship_name+(e.ship_customer?"/"+e.ship_customer:""),h=(l=e.vessel_settle_state,s=e.receipt,a=e.advance_charge_mode,r=e.advance_charge,n=e.remark,c="不需要结算"===l?"gray":"red",d='<input class="select-receipt" type="checkbox" disabled '+(1===s?"checked":"")+'>&nbsp;<i class="fa fa-info-circle" style="color:red; cursor:pointer; '+(n?"":"display:none")+'" data-toggle="tooltip" title="'+n+'"></i>',{state:getStrByStatus(l,l),color:c,ckReceipt:d,chargeText:a+": "+("number"==typeof r?r:"0")}),p='<tr class="tr_header"><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td></tr>',u=function(e,t){var i="";0<t.vessel_price&&(i+="车船号:{0}, 发运重量:{1}, 单价:{2}, 目的地:{3}".format(t.vehicle_vessel_name,getStrValue(t.total_weight),getStrValue(t.vessel_price),t.ship_to));if(e){var l=1;for(var s in e)e.hasOwnProperty(s)&&(i+="\r第{0}车: {1}, 发运重量:{2}, 单价:{3}, 目的地:{4}".format(l,e[s].name,getStrValue(e[s].weight),e[s].price<0?"无":getStrValue(e[s].price),t.vehicle_vessel_name),++l)}{if(t.veh_price<=0)return{priceText:'<code style="color: darkgray">无</code>',tooltip:i,price:0};var a=g[t.waybill_no];return{priceText:'<code style="color: blue">'+getStrValue(a.veh_price)+"</code>",tooltip:i,price:a.veh_price}}}(null,e);if(u.price,e.total_weight,null!=g){var m=g[e.waybill_no];f.append(p.format(h.state,o,e.vehicle_vessel_name,e.ship_to,i,getStrValue(e.total_weight),getStrValue(m.cust_price),u.priceText,getStrValue(m.net_income),date2Str(e.ship_date),e.shipper,e.waybill_no))}else f.append(p.format(h.state,o,e.vehicle_vessel_name,e.ship_to,i,getStrValue(e.total_weight),"...","...","...",date2Str(e.ship_date),e.shipper,e.waybill_no))}function o(){f.empty(),d=[],0,[],s.forEach(function(e){r(e)}),$(".tr_header").on("click",function(){!function(e){if(e.hasClass("tr_header")){f.find("tr").removeClass("invoice-highlighted"),d=[];for(var t=getTableCellChildren(e,11).text(),i=0,l=s.length;i<l;++i)if(t===s[i].waybill_no){d.push(s[i]);break}e.addClass("invoice-highlighted")}}($(this))}),$('[data-toggle="popover"]').popover({trigger:"hover",html:!0,placement:"bottom"})}elementEventRegister(e,"click",function(){tableToExcel($("#table-content").html(),"data")})});var QueryFilterD=function(e){this.uiElems={sBfBillName:$("#bf-shipping-name"),sBfDest:$("#bf-destination"),sBfVehicle:$("#bf-vehicle"),startDateGrp:$("#start-date-grp"),endDateGrp:$("#end-date-grp"),iStartDate:$("#start-date"),iEndDate:$("#end-date"),sBfShipper:$("#bf-shipper")},this.options=e,initSelect(this.uiElems.sBfBillName,e.ship_name,!0),initSelect(this.uiElems.sBfVehicle,e.vehicles,!0),initSelect(this.uiElems.sBfDest,e.destination,!0),initSelect(this.uiElems.sBfShipper,e.users,!0),this.uiElems.iStartDate.val(""),this.uiElems.iEndDate.val(""),this.uiElems.sBfBillName.select2({allowClear:!0}),this.uiElems.sBfVehicle.select2({allowClear:!0}),this.uiElems.sBfDest.select2({allowClear:!0}),this.uiElems.sBfShipper.select2({allowClear:!0}),this.currSelected=0,this.first=-1,this.selectedVeh=null,this.selectedName=null,this.selectedDest=null,this.selectedUser=null,this.sDate=null,this.eDate=null,this._selectFliterFunc=function(e,t,i){if(this.first<0&&(this.first=e),"无-取消选择"===t)switch(this.first===e&&(this.first=-1),e){case 1:this.selectedName=null;break;case 3:this.selectedVeh=null;break;case 4:this.selectedDest=null;break;case 6:this.selectedUser=null}this.currSelected=e,i(!0,!1)},this._dateFilterFunc=function(e,t,i){var l=this.uiElems.iStartDate.val(),s=this.uiElems.iEndDate.val(),a=!1;e&&t?a=!isEmpty(l)&&!isEmpty(s):e?a=isEmpty(this.uiElems.iStartDate.val()):t&&(a=isEmpty(this.uiElems.iEndDate.val())),a&&i(!0,!(this.currSelected=5))},this._initSelect=function(e){1===this.first&&1===this.currSelected||(initSelect(this.uiElems.sBfBillName,e.ship_name,!0),this.selectedName?this.uiElems.sBfBillName.select2("val",this.selectedName):this.uiElems.sBfBillName.select2("val","")),3===this.first&&3===this.currSelected||(initSelect(this.uiElems.sBfVehicle,e.vehicles,!0),this.selectedVeh?this.uiElems.sBfVehicle.select2("val",this.selectedVeh):this.uiElems.sBfVehicle.select2("val","")),4===this.first&&4===this.currSelected||(initSelect(this.uiElems.sBfDest,e.destination,!0),this.selectedDest?this.uiElems.sBfDest.select2("val",this.selectedDest):this.uiElems.sBfDest.select2("val",""))}};QueryFilterD.prototype.getQueryParams=function(){var e=this.uiElems.iStartDate.val(),t=this.uiElems.iEndDate.val(),i=!isEmpty(e)&&!isEmpty(t);return{fName:this.selectedName,fVeh:this.selectedVeh,fDest:this.selectedDest,fShipper:this.selectedUser,fDate1:i?this.sDate.toISOString():null,fDate2:i?this.eDate.toISOString():null}},QueryFilterD.prototype.getVehicleName=function(){return this.selectedVeh},QueryFilterD.prototype.eventHandler=function(t){var i=this;i.uiElems.sBfBillName.on("change",function(e){i.selectedName=e.val,i._selectFliterFunc(1,e.val,t)}),i.uiElems.sBfVehicle.on("change",function(e){i.selectedVeh=e.val,i._selectFliterFunc(3,e.val,t)}),i.uiElems.sBfShipper.on("change",function(e){i.selectedUser=e.val,i._selectFliterFunc(6,e.val,t)}),i.uiElems.sBfDest.on("change",function(e){i.selectedDest=e.val,i._selectFliterFunc(4,e.val,t)}),i.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(e){e.preventDefault(),e.stopImmediatePropagation(),i.sDate=e.date.startOf("day"),i.uiElems.endDateGrp.data("DateTimePicker").setMinDate(e.date),i._dateFilterFunc(!0,!0,t)}),i.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(e){e.preventDefault(),e.stopImmediatePropagation(),i.eDate=e.date.endOf("day"),i.uiElems.startDateGrp.data("DateTimePicker").setMaxDate(e.date),i._dateFilterFunc(!0,!0,t)}),i.uiElems.iStartDate.on("change",function(e){e.stopImmediatePropagation(),i._dateFilterFunc(!0,!1,t)}),i.uiElems.iEndDate.on("change",function(e){e.stopImmediatePropagation(),i._dateFilterFunc(!1,!0,t)})},QueryFilterD.prototype.isAllEmpty=function(){var e=getSelectValue(this.uiElems.sBfShipper),t=this.uiElems.iStartDate.val(),i=this.uiElems.iEndDate.val();return isEmpty(this.selectedVeh)&&isEmpty(this.selectedDest)&&isEmpty(this.selectedName)&&isEmpty(e)&&isEmpty(t)&&isEmpty(i)},QueryFilterD.prototype.updateOptions=function(e){var s=this.selectedVeh,a=this.selectedDest,r=this.selectedName,t={ship_name:[],vehicles:[],destination:[],users:this.options.users};if(this.first<0)t=this.options;else{var n,c,d=[],o=[],h=[];e.forEach(function(e){d.indexOf(e.ship_name)<0&&d.push(e.ship_name);var t=!1;if(s){if(s===e.vehicle_vessel_name)t=!0;else for(n=0;n<e.bills.length;++n)for(c=0;c<e.bills[n].vehicles.length&&!t;++c)if(e.bills[n].vehicles[c].veh_name===s){t=!0;break}}else t=!0;var i=!a||a===e.ship_to,l=!r||r===e.ship_name;if(t&&i&&l)for(e.ship_to&&h.indexOf(e.ship_to)<0&&h.push(e.ship_to),e.vehicle_vessel_name&&o.indexOf(e.vehicle_vessel_name)<0&&o.push(e.vehicle_vessel_name),n=0;n<e.bills.length;++n)for(c=0;c<e.bills[n].vehicles.length;++c)o.indexOf(e.bills[n].vehicles[c].veh_name)<0&&o.push(e.bills[n].vehicles[c].veh_name)}),t.vehicles=sort_pinyin(o),t.destination=sort_pinyin(h),t.ship_name=sort_pinyin(d)}this._initSelect(t)};
//# sourceMappingURL=shipping_charge.js.map
