$(function(){"use strict";var v=$("#table-tbody"),e=$("#filter"),t=$("#search-export"),l=$("#single-price-input"),i=$("#batch-price-input"),a=$("#settle-bill"),s=$("#settle-bill-cancel"),n=$("#settle-pay"),r=$("#settle-pay-cancel"),o=$("#show-detail"),c=$("#settle-print-detail"),d=$("#delay-info"),h=$("#receipt-icon"),p=$("#print-detail-tbody"),g=0,b=0,y=0,u=!0,f=$("#charge-cash"),m=$("#charge-oil"),_=$("#unpay-block"),E=$("#unship-date-grp"),w=$("#delay-day"),k=$("#sdd_receipt"),D=$("#delay-remark"),x=!1,S=!1,C=[],V=[],H=[],B=[],T=[];$("#first-th").html('<input id="select-all" type="checkbox" data-toggle="tooltip" title="选择所有记录" />&nbsp;<label id="all-not-need" class="fa fa-star-o" data-toggle="tooltip" title="点击可设置不需要结算和需要结算" style="cursor:pointer; color:red; font-size:18px;" ></label>');var N=new QueryFilterD(local_data);function O(e,t){if("未结算"===N.settledState?(showHtmlElement(a,!0),showHtmlElement(s,!1),showHtmlElement(n,!1),showHtmlElement(r,!1),showHtmlElement(c,!1),showHtmlElement(_,!1)):"已结算"===N.settledState?(showHtmlElement(a,!1),showHtmlElement(s,!0),showHtmlElement(n,!0),showHtmlElement(c,!0),showHtmlElement(r,!1),showHtmlElement(_,!0)):"已付款"===N.settledState?(showHtmlElement(a,!1),showHtmlElement(s,!1),showHtmlElement(n,!1),showHtmlElement(r,!0),showHtmlElement(c,!1),showHtmlElement(_,!1)):"不需要结算"===N.settledState&&(showHtmlElement(a,!1),showHtmlElement(s,!1),showHtmlElement(n,!1),showHtmlElement(r,!1),showHtmlElement(c,!1),showHtmlElement(_,!1)),e){var l=N.getQueryParams();$.get("/get_invoice_settle_vellel",l,function(e){var t=jQuery.parseJSON(e);C=[],t.ok&&(C=sortByKey(t.invs,"ship_date","DSC")),V=C,J()})}else t&&(C=[]),V=C,J()}function L(e,i,a,t){if(H.length||B.length){for(var l=[],s=0,n=H.length;s<n;++s){var r=H[s];if(e){if(r.vessel_price<0)return void bootbox.alert("您选择的运单: "+r.waybill_no+" 已设置为不需要结算, 请先取消不结算,再来结算");if(0===r.vessel_price)return void bootbox.alert("您选择的运单: "+r.waybill_no+" 还未输入价格, 不能继续结算");if(1!=r.receipt)return void bootbox.alert("您选择的运单: "+r.waybill_no+" 还未收到回执, 不能继续结算");"未结算"===r.vessel_settle_state&&l.push(r.waybill_no)}else{if(r.vessel_price<0)return void bootbox.alert("您选择的运单: "+r.waybill_no+" 已设置为不需要结算, 不能取消");"已结算"===r.vessel_settle_state&&l.push(r.waybill_no)}}for(var o=[],c=[],d=0,h=B.length;d<h;++d){var p=B[d],u=I(p);if(u){var f=G(u,!1);if(e){if(1!=f[p].receipt)return void bootbox.alert("您选择的内部运单: "+p+" 还未收到回执, 不能继续结算");if(f[p].price<0)return void bootbox.alert("您选择的内部运单: "+p+" 已设置为不需要结算, 请先取消不结算,再来结算");if(0===f[p].price)return void bootbox.alert("您选择的内部运单: "+p+" 还未输入价格, 不能继续结算")}else if(f[p].price<0)return void bootbox.alert("您选择的内部运单: "+p+" 已设置为不需要结算, 不能取消结算");o.indexOf(u.waybill_no)<0&&o.push(u.waybill_no),c.push(u)}}ajaxRequestHandle("/settle_vessel","POST",{allSelectedInvNo:l,allInvNoFromInner:o,allInnerNo:B,settle:e},"车船结算",function(){H.forEach(function(e){0<=l.indexOf(e.waybill_no)&&(e.vessel_settle_state=i,e.vessel_settle_date=a,e.vessel_settler=t)}),c.forEach(function(e){e.inner_settle.forEach(function(e){0<=B.indexOf(e.inner_waybill_no)&&(e.state=i,e.date=a)});var t=G(e,!1);for(var l in t)t.hasOwnProperty(l)&&0<=B.indexOf(l)&&(t[l].state=i,t[l].date=a)}),J()})}else bootbox.alert("请先选择您要结算或结算取消的行")}function q(e,i,a){if(H.length||B.length){for(var t=[],l=0,s=H.length;l<s;++l){var n=H[l];t.push(n.waybill_no)}for(var r=[],o=[],c=0,d=B.length;c<d;++c){var h=I(B[c]);h&&(r.indexOf(h.waybill_no)<0&&r.push(h.waybill_no),o.push(h))}ajaxRequestHandle("/settle_vessel_pay","POST",{allPayInvNo:t,allInvNoFromInner:r,allInnerNo:B,forPay:e},"车船结算付款",function(){H.forEach(function(e){0<=t.indexOf(e.waybill_no)&&(e.vessel_settle_state=i,e.pay_date=a)}),o.forEach(function(e){e.inner_settle.forEach(function(e){0<=B.indexOf(e.inner_waybill_no)&&(e.state=i,e.pay_date=a)});var t=G(e,!1);for(var l in t)t.hasOwnProperty(l)&&0<=B.indexOf(l)&&(t[l].state=i,t[l].pay_date=a)}),J()})}}function P(e,t,l){var i="<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td>";return 0<e.block_num?i.format(e.bill_no,getOrder(e.order_no,e.order_item_no),e.ship_warehouse?e.ship_warehouse:"",getStrValue(e.thickness),getStrValue(e.width),getStrValue(e.len),getStrValue(e.weight),e.block_num,getStrValue(e.total_weight),t,getStrValue(e.weight*t)):i.format(e.bill_no,getOrder(e.order_no,e.order_item_no),e.ship_warehouse?e.ship_warehouse:"",getStrValue(e.thickness),getStrValue(e.width),getStrValue(e.len),"","",getStrValue(e.total_weight),t,getStrValue(l))}function F(e){var t=window.open();return t?(t.document.write(e.html()),t.print(),t.close(),!0):(bootbox.alert("请允许弹出窗口!"),!1)}function I(e){for(var t=null,l=e.substring(0,17),i=0;i<V.length;++i)if(l===V[i].waybill_no){t=V[i];break}return t}function R(n){var e="no_message";0===n.partInd&&(e="车船结算滞留信息输入"),ajaxRequestHandle("/settle_vessel_delay_info","POST",n,e,function(){0!==n.partInd&&1!==n.partInd||$("#settle-delay-dialog").modal("hide"),n.wnoList.forEach(function(e){var t=e;17<e.length&&(t=e.substring(0,17));for(var l=0;l<V.length;++l)if(t===V[l].waybill_no){var i=V[l];if(17<e.length){var a=G(i,!1);a&&isExist(a[e])&&(0===n.partInd?(a[e].unship_date=n.unshipData.unship_date,a[e].delay_day=n.unshipData.delay_day,a[e].charge_cash=n.unshipData.charge_cash,a[e].charge_oil=n.unshipData.charge_oil,a[e].receipt=n.unshipData.receipt,a[e].remark=n.unshipData.remark):1===n.partInd?(a[e].charge_cash=n.unshipData.charge_cash,a[e].charge_oil=n.unshipData.charge_oil):2===n.partInd?a[e].receipt=n.unshipData.receipt:3===n.partInd&&(a[e].remark=n.unshipData.remark))}else 0===n.partInd?(i.unship_date=n.unshipData.unship_date,i.delay_day=n.unshipData.delay_day,i.charge_cash=n.unshipData.charge_cash,i.charge_oil=n.unshipData.charge_oil,i.receipt=n.unshipData.receipt,i.remark=n.unshipData.remark):1===n.partInd?(i.charge_cash=n.unshipData.charge_cash,i.charge_oil=n.unshipData.charge_oil):2===n.partInd?i.receipt=n.unshipData.receipt:3===n.partInd&&(i.remark=n.unshipData.remark)}});var e=v.find("tr").length;if(2===n.partInd){u=!u;for(var t=0;t<e;++t)getRowChildren(v,t).find("td:last").find("input").prop("checked",u);X(h,"fa-check-square-o","fa-square-o")}else for(var l=0;l<e;++l){var i=getRowChildren(v,l);if(1===n.partInd)0<n.unshipData.charge_cash&&0<n.unshipData.charge_oil?i.find("td").eq(15).text("现金:"+n.unshipData.charge_cash+",油:"+n.unshipData.charge_oil):0<n.unshipData.charge_cash?i.find("td").eq(15).text("现金:"+n.unshipData.charge_cash):0<n.unshipData.charge_oil?i.find("td").eq(15).text("油:"+n.unshipData.charge_oil):i.find("td").eq(15).text("无");else if(0===n.partInd){if(getTableCellChildren(i,2).text()===n.wnoList[0]){i.find("td").eq(13).text(date2Str(n.unshipData.unship_date)),i.find("td").eq(14).text(n.unshipData.delay_day),0<n.unshipData.charge_cash&&0<n.unshipData.charge_oil?i.find("td").eq(15).text("现金:"+n.unshipData.charge_cash+",油:"+n.unshipData.charge_oil):0<n.unshipData.charge_cash?i.find("td").eq(15).text("现金:"+n.unshipData.charge_cash):0<n.unshipData.charge_oil?i.find("td").eq(15).text("油:"+n.unshipData.charge_oil):i.find("td").eq(15).text("无");var a=i.find("td:last");a.find("input").prop("checked",1===n.unshipData.receipt);var s=a.find("i");n.unshipData.remark?(s.show(),s.prop("title",n.unshipData.remark)):s.hide();break}}}})}function Q(){if(setHtmlElementDisabled(t,0===V.length),H.length||B.length){var e=H.length+B.length;1===e?(setHtmlElementDisabled(l,!1),setHtmlElementDisabled(d,!1)):(setHtmlElementDisabled(l,!0),setHtmlElementDisabled(d,!0)),setHtmlElementDisabled(i,e<2),setHtmlElementDisabled(o,1!==H.length),setHtmlElementDisabled(a,!1),setHtmlElementDisabled(s,!1),setHtmlElementDisabled(c,!1),setHtmlElementDisabled(n,!1),setHtmlElementDisabled(r,!1)}else setHtmlElementDisabled(l,!0),setHtmlElementDisabled(i,!0),setHtmlElementDisabled(o,!0),setHtmlElementDisabled(d,!0),setHtmlElementDisabled(a,!0),setHtmlElementDisabled(s,!0),setHtmlElementDisabled(c,!0),setHtmlElementDisabled(n,!0),setHtmlElementDisabled(r,!0)}function M(t,i,a){var s=G(t,!1),e='<div class="row form-horizontal"><div class="col-md-10">';if(i){var l=t.waybill_no;e+='<div class="form-group"><label for="{0}" class="control-label col-sm-4">{1}</label><div class="input-group col-sm-8"><input id="{2}" type="text" name="{3}" class="form-control" value="{4}"><span style="font-size: 11px">始发: {5}, 目的地: {6}</span></div></div>'.format(l,t.vehicle_vessel_name,l,l,getStrValue(t.vessel_price),t.ship_from?t.ship_from:"",t.ship_to)}else{var n="<div><label>目的地为"+t.vehicle_vessel_name+"的车辆价格</label>";if(s&&s[a]){var r=s[a],o=r.price<0?"disabled":"";n+='<div class="form-group"><label for="{0}" class="control-label col-sm-4">{1}</label><div class="input-group col-sm-8"><input id="{2}" type="text" name="{3}" class="form-control" value="{4}" {5}><span style="font-size: 11px">始发: {6}, 发运重量: {7} 吨</span></div></div>'.format(a,r.name,a,a,getStrValue(r.price),o,r.ship_from?r.ship_from:"",getStrValue(r.weight))}e+=n+"</div>"}e+="</div>",bootbox.dialog({message:e,title:"单行价格输入",buttons:{cancel:{label:"取消",className:"btn-default"},main:{label:"确定",className:"btn-primary",callback:function(){var l=[];if(i){var e=z(t.waybill_no);(0<=e||-1===e)&&(t.vessel_price=e,l.push({wno:t.waybill_no,price:e,inner:0}))}else t.bills.forEach(function(e){e.vehicles.forEach(function(e){if(e.inner_waybill_no===a){var t=z(e.inner_waybill_no);(0<=t||-1===t)&&(e.veh_price=t,s[a].price=t,l.push({wno:e.inner_waybill_no,price:t,inner:1}))}})});ajaxRequestHandle("/settle_vessel_price","POST",{wnoList:[t.waybill_no],priceData:l},"no_message",function(){j(t,!0)})}}}})}function j(e,t){for(var l,i=e.vessel_price<0?"darkgray":"red",a=G(e,!1),s=Z(a,e),n=v.find("tr").length,r=0;r<n;++r){l=getRowChildren(v,r);var o=getTableCellChildren(l,2).text();if(e.waybill_no===o)t&&(l.find("td").eq(0).find("label").css("color",i),l.find("td").eq(7).html(s.priceText),e.vessel_price<0?l.find("td").eq(8).text("无"):l.find("td").eq(8).text(getStrValue(e.vessel_price))),l.find("td").eq(1).html(getStrByStatus(e.vessel_settle_state,e.vessel_settle_state)),l.find("td").eq(12).text(date2Str(e.vessel_settle_date));else if(a&&isExist(a[o])){var c=a[o];t&&(c.price<0?(l.find("td").eq(0).find("label").css("color","darkgray"),l.find("td").eq(7).text("无"),l.find("td").eq(8).text("无")):(l.find("td").eq(0).find("label").css("color","red"),l.find("td").eq(7).text(getStrValue(c.price*c.weight)),l.find("td").eq(8).text(getStrValue(c.price)))),l.find("td").eq(1).html(getStrByStatus(c.state,c.state)),l.find("td").eq(12).text(date2Str(c.date))}}}function z(e){var t=parseFloatHTML($("#"+e).val());return isNaN(t)||0==t?0:t}function G(e,t){for(var l,i=!1,a=0,s=T.length;a<s;++a)if(e.waybill_no===T[a].wno){l=T[a].vehInfo,i=!0;break}return!i&&t&&(l=function(e){var t=[];e.bills.forEach(function(e){t.push.apply(t,e.vehicles)});var l={};return t.forEach(function(e){isExist(l[e.inner_waybill_no])?(l[e.inner_waybill_no].num+=e.send_num,l[e.inner_waybill_no].weight+=e.send_weight):l[e.inner_waybill_no]={name:e.veh_name,num:e.send_num,weight:e.send_weight,price:isExist(e.veh_price)?e.veh_price:0,ship_from:e.veh_ship_from,state:"未结算",date:null,unship_date:null,delay_day:0,charge_cash:0,charge_oil:0,receipt:0,remark:"",pay_date:null}}),isExist(e.inner_settle)&&!isEmpty(e.inner_settle)&&e.inner_settle.forEach(function(e){l[e.inner_waybill_no].state=e.state,l[e.inner_waybill_no].date=e.date,l[e.inner_waybill_no].unship_date=e.unship_date,l[e.inner_waybill_no].delay_day=e.delay_day,l[e.inner_waybill_no].charge_cash=e.charge_cash,l[e.inner_waybill_no].charge_oil=e.charge_oil,l[e.inner_waybill_no].receipt=e.receipt,l[e.inner_waybill_no].remark=e.remark,l[e.inner_waybill_no].pay_date=e.pay_date}),l}(e),T.push({wno:e.waybill_no,vehInfo:l})),l}function A(e,t,l,i,a){var s="不需要结算"===e?"gray":"red",n='<input class="select-receipt" type="checkbox" disabled '+(1===t?"checked":"")+'>&nbsp;<i class="fa fa-info-circle" style="color:red; cursor:pointer; '+(a?"":"display:none")+'" data-toggle="tooltip" title="'+a+'"></i>',r="无";return 0<l&&0<i?r="现金:"+l+",油:"+i:0<l?r="现金:"+l:0<i&&(r="油:"+i),{state:getStrByStatus(e,e),color:s,ckReceipt:n,chargeText:r}}function J(){v.empty(),H=[],B=[];var l=!(y=b=g=0);V.forEach(function(e){var t=function(t){var l=!1,i=null,a=0;t.bills.forEach(function(e){a+=e.num,!l&&e.vehicles.length&&(i=G(t,l=!0))});var e=!0,s=!0,n=t.ship_name+(t.ship_customer?"/"+t.ship_customer:""),r=N.getVehicleName();if((!r||r===t.vehicle_vessel_name)&&N.settledState===t.vessel_settle_state){e=1===t.receipt,s=t.vessel_price<0;var o=A(t.vessel_settle_state,t.receipt,t.charge_cash,t.charge_oil,t.remark),c='<tr class="tr_header"><td nowrap><input class="select-inv" type="checkbox">&nbsp;<label class="fa fa-star-o not-need-settle" data-toggle="tooltip" title="点击可设置不需要结算和需要结算" style="cursor:pointer; color:'+o.color+'; font-size:18px;"></label>';l&&(c+='&nbsp;<span data-toggle="tooltip" title="点击展开和收缩" style="cursor:pointer;font-size: 16px;" class="fa fa-minus-square-o expand"></span>'),c+='</td><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td nowrap>{14}</td><td style="text-align: center">{15}</td></tr>';var d=Z(i,t);g+=d.price,b+=t.total_weight,0<t.charge_cash&&(y+=t.charge_cash),0<t.charge_oil&&(y+=t.charge_oil),v.append(c.format(o.state,t.waybill_no,t.vehicle_vessel_name+"/"+local_data.vehPersonMap[t.vehicle_vessel_name],n,t.ship_from,t.ship_to,d.priceText,t.vessel_price<0?"无":getStrValue(t.vessel_price),a,getStrValue(t.total_weight),date2Str(t.ship_date),date2Str(t.vessel_settle_date),date2Str(t.unship_date,!0),t.delay_day,o.chargeText,o.ckReceipt))}if(l){var h='<tr class="vessel_sub_item" style="background: #e0e4f0;"><td nowrap><input class="select-sub-inv" type="checkbox">&nbsp;<label class="fa fa-star-o not-need-settle" data-toggle="tooltip" title="点击可设置不需要结算和需要结算" style="cursor:pointer; color:{16}; font-size:18px;"></label></td><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td><td>{13}</td><td nowrap>{14}</td><td style="text-align: center">{15}</td></tr>';for(var p in i)if(i.hasOwnProperty(p)&&(!r||r===i[p].name)&&N.settledState===i[p].state){var u=i[p],f="无",m="无";if(b+=u.weight,0<=u.price){var _=u.price*u.weight;f=getStrValue(u.price),m=getStrValue(_),g+=_}0<u.charge_cash&&(y+=u.charge_cash),0<u.charge_oil&&(y+=u.charge_oil),e=e&&1===u.receipt,s=s&&u.price<0,o=A(u.state,u.receipt,u.charge_cash,u.charge_oil,u.remark),v.append(h.format(o.state,p,u.name+"/"+local_data.vehPersonMap[u.name],n,u.ship_from?u.ship_from:"",t.vehicle_vessel_name,m,f,u.num,getStrValue(u.weight),date2Str(t.ship_date),date2Str(u.date),date2Str(u.unship_date,!0),u.delay_day,o.chargeText,o.ckReceipt,o.color))}}return{receiptOk:e,notNeed:s}}(e);t.receiptOk||(u=!1),t.notNeed||(l=!1)}),u?(h.addClass("fa-check-square-o"),h.removeClass("fa-square-o")):(h.removeClass("fa-check-square-o"),h.addClass("fa-square-o")),l?$("#all-not-need").css("color","gray"):$("#all-not-need").css("color","red"),$("#lb-total-weight").text(getStrValue(b)),$("#lb-total-amount").text(getStrValue(g)),$("#curr-number").text(v.find("tr").length),$("#lb-unpay-amount").text(getStrValue(g-y)),$("#select-all").prop("checked",!1),Q(),$(".tr_header").on("click",function(){K($(this),!0)}),$(".vessel_sub_item").on("click",function(){U($(this),!0)}),$(".select-inv").on("click",function(){K($(this).closest("tr"),!1)}),$(".select-sub-inv").on("click",function(){U($(this).closest("tr"),!1)}),$(".expand").on("click",function(e){e.stopImmediatePropagation();var t=$(this),l=t.closest("tr");X(t,"fa-plus-square-o","fa-minus-square-o"),l.nextUntil("tr.tr_header").slideToggle(100,function(){})}),$(".not-need-settle").on("click",function(e){if(e.stopImmediatePropagation(),"未结算"===N.settledState){var t=$(this),l=t.closest("tr");W(t,[getTableCellChildren(l,2).text()])}else bootbox.alert('已结算,不能再进行"不需要结算操作"')}),$('[data-toggle="popover"]').popover({trigger:"hover",html:!0,placement:"bottom"})}function U(e,t){var l=getTableCellChildren(e,2).text(),i=B.indexOf(l);i<0?B.push(l):B.remove(i),t&&e.find("td:first").find('input[type="checkbox"]').prop("checked",i<0),$("#select-all").prop("checked",H.length+B.length===v.find("tr").length),Q()}function K(e,t){if(e.hasClass("tr_header")){for(var l=getTableCellChildren(e,2).text(),i=!1,a=0;a<H.length;++a)if(l===H[a].waybill_no){H.remove(a),i=!0;break}if(i)e.removeClass("invoice-highlighted");else{for(var s=0,n=V.length;s<n;++s)if(l===V[s].waybill_no){H.push(V[s]);break}e.addClass("invoice-highlighted")}t&&e.find("td:first").find('input[type="checkbox"]').prop("checked",!i),$("#select-all").prop("checked",H.length+B.length===v.find("tr").length),Q()}}function W(e,t){"rgb(255, 0, 0)"===e.css("color")?(e.css("color","gray"),Y(t,!0)):(e.css("color","red"),Y(t,!1))}function X(e,t,l){e.hasClass(t)?(e.addClass(l),e.removeClass(t)):e.hasClass(l)&&(e.addClass(t),e.removeClass(l))}function Y(e,s){ajaxRequestHandle("/settle_vessel_not_needed","POST",{wayNoList:e,notNeeded:s},"no_message",function(){e.forEach(function(t){var e=t;17<t.length&&(e=t.substring(0,17));for(var l=0;l<V.length;++l)if(e===V[l].waybill_no){var i=V[l];if(17<t.length){i.bills.forEach(function(e){e.vehicles.forEach(function(e){t===e.inner_waybill_no&&(e.veh_price=s?-1:0)})});var a=G(i,!1);a&&isExist(a[t])&&(a[t].state=s?(a[t].price=-1,a[t].date=new Date,"不需要结算"):(a[t].price=0,a[t].date=null,"未结算")),i.inner_settle.forEach(function(e){e.inner_waybill_no===t&&(e.state=s?(e.date=new Date,"不需要结算"):(e.date=null,"未结算"))})}else i.vessel_settle_date=s?(i.vessel_price=-1,i.vessel_settle_state="不需要结算",new Date):(i.vessel_price=0,i.vessel_settle_state="未结算",null);j(i,!0);break}})})}function Z(e,t){var l="";if(0<t.vessel_price&&(l+="车船号:{0}, 发运重量:{1}, 单价:{2}, 目的地:{3}".format(t.vehicle_vessel_name,getStrValue(t.total_weight),getStrValue(t.vessel_price),t.ship_to)),e){var i=1;for(var a in e)e.hasOwnProperty(a)&&(l+="\r第{0}车: {1}, 发运重量:{2}, 单价:{3}, 目的地:{4}".format(i,e[a].name,getStrValue(e[a].weight),e[a].price<0?"无":getStrValue(e[a].price),t.vehicle_vessel_name),++i)}if(t.vessel_price<0)return{priceText:'<code style="color: darkgray">无</code>',tooltip:l,price:0};var s=t.vessel_price*t.total_weight;return{priceText:'<code style="color: blue">'+getStrValue(s)+"</code>",tooltip:l,price:s}}N.eventHandler(O),showHtmlElement(a,!0),showHtmlElement(s,!1),showHtmlElement(n,!1),showHtmlElement(r,!1),showHtmlElement(c,!1),showHtmlElement(_,!1),Q(),elementEventRegister($("#settle-search"),"click",function(){O(!0,!1)}),elementEventRegister(l,"click",function(){1===H.length?M(H[0],!0):M(I(B[0]),!1,B[0])}),elementEventRegister(i,"click",function(){var t=[],i=[];H.forEach(function(e){t.indexOf(e.vehicle_vessel_name)<0&&t.push(e.vehicle_vessel_name)}),B.forEach(function(t){var e=I(t);e.bills.forEach(function(e){e.vehicles.forEach(function(e){e.inner_waybill_no===t&&i.indexOf(e.veh_name)<0&&i.push(e.veh_name)})})});var l='<div class="row form-horizontal"><div class="col-md-10">',a='<div class="form-group"><label for="{0}" class="control-label col-sm-4">{1}</label><div class="input-group col-sm-8"><input id="{2}" type="text" name="{3}" class="form-control"></div></div>',s="";if(t.forEach(function(e){s=e.replace(/[\s\(\)#]+/g,"999")+"999",l+=a.format(s,e,s,s)}),i.length){var n='<div class="col-md-12"><label>目的地为(船)的车辆</label>';i.forEach(function(e){s=e.replace(/[\s\(\)#]+/g,"888")+"888",n+=a.format(s,e,s,s)}),l+=n+"</div>"}l+="</div></div>",bootbox.dialog({message:l,title:"批量输入价格",buttons:{cancel:{label:"取消",className:"btn-default",callback:function(){}},main:{label:"确定",className:"btn-primary",callback:function(){var l={},s={};t.forEach(function(e){var t=z(e.replace(/[\s\(\)#]+/g,"999")+"999");(0<t||-1===t)&&(l[e]=t)}),i.forEach(function(e){var t=z(e.replace(/[\s\(\)#]+/g,"888")+"888");(0<t||-1===t)&&(s[e]=t)});var n=[],r=[],o=[];H.forEach(function(e){var t=l[e.vehicle_vessel_name];(0<t||-1===t)&&(e.vessel_price=t,r.push(e.waybill_no),o.push({wno:e.waybill_no,price:t,inner:0}),n.push(e))}),B.forEach(function(i){var a=I(i);a.bills.forEach(function(e){e.vehicles.forEach(function(e){if(e.inner_waybill_no===i){var t=s[e.veh_name];if(0<t||-1===t){e.veh_price=t,r.indexOf(a.waybill_no)<0&&r.push(a.waybill_no),o.push({wno:i,price:t,inner:1});var l=G(a,!1);l&&(l[i].price=t),n.push(a)}}})})}),o.length&&ajaxRequestHandle("/settle_vessel_price","POST",{wnoList:r,priceData:o},"no_message",function(){n.forEach(function(e){j(e,!0)})})}}}})}),elementEventRegister($("#select-all"),"click",function(){var e=$(this).is(":checked");if(V.length){if(H=[],B=[],e){for(var t=v.find("tr").length,l=0;l<t;++l){var i=getRowChildren(v,l),a=getTableCellChildren(i,2).text();if(17<a.length)B.push(a);else for(var s=0;s<V.length;++s)if(a===V[s].waybill_no){H.push(V[s]);break}}$(".tr_header").addClass("invoice-highlighted")}else $(".tr_header").removeClass("invoice-highlighted");$(".select-inv").prop("checked",e),$(".select-sub-inv").prop("checked",e),Q()}}),$("#all-not-need").on("click",function(){if(V.length)if("未结算"===N.settledState){for(var t=$(this),l=[],e=v.find("tr").length,i=0;i<e;++i){var a=getRowChildren(v,i);l.push(getTableCellChildren(a,2).text())}bootbox.confirm("您确定要批量不结算操作",function(e){e&&W(t,l)})}else bootbox.alert("在已结算状态下不能进行此操作")}),elementEventRegister(a,"click",function(){L(!0,"已结算",new Date,local_user_name)}),elementEventRegister(s,"click",function(){L(!1,"未结算","","")}),elementEventRegister(n,"click",function(){q(!0,"已付款",new Date)}),elementEventRegister(r,"click",function(){q(!1,"已结算","")}),elementEventRegister(o,"click",function(){if(0<H.length){var s=H[0],l=!1;s.bills.forEach(function(e){e.vehicles.length&&(l=!0)}),$.get("/get_waybill",{q:s.waybill_no},function(e){var t=jQuery.parseJSON(e).bills,a="";t.forEach(function(e){for(var t=0;t<s.bills.length;++t){var l=s.bills[t];if(String(e._id)===String(l.bill_id)){if(a+=P(e,l.num,l.weight),l.vehicles.length){var i="";l.vehicles.forEach(function(e){i="{0}, <code>{1}</code><code>{2}</code><br />".format(e.veh_name,e.send_num,getStrValue(e.send_weight))}),a+="<td>"+i+"</td></tr>"}else a+="<td></td></tr>";break}}}),$("#tb-detail-tbody").html(a),showHtmlElement($("#tb-detail th:last-child, #tb-detail td:last-child"),l),$("#settle-detail-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")})}}),c.on("click",function(){if(H.length||B.length){p.empty();for(var e='<tr><td style="border:1px solid black;padding:5px;">{0}</td><td style="border:1px solid black;padding:5px;">{1}</td><td style="border:1px solid black;padding:5px;">{2}</td><td style="border:1px solid black;padding:5px;">{3}</td><td style="border:1px solid black;padding:5px;">{4}</td><td style="border:1px solid black;padding:5px;">{5}</td><td style="border:1px solid black;padding:5px;">{6}</td><td style="border:1px solid black;padding:5px;">{7}</td><td style="border:1px solid black;padding:5px;">{8}</td><td style="border:1px solid black;padding:5px;">{9}</td></tr>',t=0,l=0,i=0,a=v.find("tr").length,s=0;s<a;++s){var n=getRowChildren(v,s);if(getTableCellChildren(n,0).find("input").is(":checked")){var r=getTableCellChildren(n,10).text(),o=getTableCellChildren(n,7).text();p.append(e.format(getTableCellChildren(n,3).text(),getTableCellChildren(n,4).text(),getTableCellChildren(n,5).text(),getTableCellChildren(n,6).text(),r,getTableCellChildren(n,8).text(),o,getTableCellChildren(n,11).text(),getTableCellChildren(n,14).text(),getTableCellChildren(n,15).text())),t+=+r,l+=+o;var c=getTableCellChildren(n,15).text();if("无"!=c){var d=c.split(":");if(3===d.length)i+=+d[2],i+=+d[1].split(",")[0];else 2===d.length&&(i+=+d[1])}}}$("#print-total-weight").text(getStrValue(t)),$("#print-total-number").text(getStrValue(l)),$("#print-unpay-number").text(getStrValue(l-i)),$("#settle-print-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}else bootbox.alert("请选择你要打印的清单列表")}),$("#print-to").on("click",function(){F($("#print-div"))}),$("#print-and-pay").on("click",function(){F($("#print-div"))&&q(!0,"已付款",new Date)}),E.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(){if(x)x=!1;else{var e=E.data("DateTimePicker").getDate();if(e){var t=1===H.length?H[0]:I(B[0]);if(t){var l=e.diff(t.ship_date,"days")-7;0<l?w.val(l):w.val("0")}}}}),w.on("keyup paste",function(){var e=parseInt(this.value);if(0<e){var t=1===H.length?H[0]:I(B[0]);t&&(x=!0,E.data("DateTimePicker").setDate(moment(t.ship_date).add(e+7,"days")))}}),elementEventRegister(k,"ifChecked",function(){S=!0}),elementEventRegister(k,"ifUnchecked",function(){S=!1}),elementEventRegister(d,"click",function(){var e=1===H.length?H[0]:I(B[0]);if(1===H.length)f.val(e.charge_cash),m.val(e.charge_oil),w.val(e.delay_day),E.data("DateTimePicker").setMinDate(moment(e.ship_date)),E.data("DateTimePicker").setDate(e.unship_date?moment(e.unship_date):null),k.iCheck(1===e.receipt?"check":"uncheck"),D.val(e.remark?e.remark:"");else{var t=B[0],l=G(e,!1);if(l&&l[t]){var i=l[t];f.val(i.charge_cash),m.val(i.charge_oil),w.val(i.delay_day),E.data("DateTimePicker").setMinDate(moment(e.ship_date)),E.data("DateTimePicker").setDate(i.unship_date?moment(i.unship_date):null),k.iCheck(1===i.receipt?"check":"uncheck"),D.val(i.remark?i.remark:"")}}showHtmlElement($("#delay_receipt"),!0),$("#settle-delay-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}),$("#batch-charge-ctrl").on("click",function(){f.val("0"),m.val("0"),showHtmlElement($("#delay_receipt"),!1),$("#settle-delay-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}),$("#batch-receipt-ctrl").on("click",function(){for(var e=[],t=v.find("tr").length,l=0;l<t;++l){var i=getRowChildren(v,l);e.push(getTableCellChildren(i,2).text())}R({unshipData:{receipt:u?0:1},wnoList:e,partInd:2})}),$("#settle-delay-btn-ok").on("click",function(){var e={charge_cash:f.val(),charge_oil:m.val()};if("none"==$("#delay_receipt").css("display")){for(var t=[],l=v.find("tr").length,i=0;i<l;++i){var a=getRowChildren(v,i);t.push(getTableCellChildren(a,2).text())}R({unshipData:e,wnoList:t,partInd:1})}else{e.unship_date=E.data("DateTimePicker").getDate(),e.delay_day=w.val(),e.receipt=S?1:0,e.remark=D.val(),R({unshipData:e,wnoList:[1===H.length?H[0].waybill_no:B[0]],partInd:0})}}),elementEventRegister(t,"click",function(){tableToExcel($("#table-content").html(),"data")}),elementEventRegister(e,"click",function(){$("#filter-ui").toggle()})});var QueryFilterD=function(e){this.uiElems={sBfBillName:$("#bf-bill-name"),sBfDest:$("#bf-destination"),sBfVehicle:$("#bf-vehicle"),sBfVehContact:$("#bf-vehicle-contact"),startDateGrp:$("#start-date-grp"),endDateGrp:$("#end-date-grp"),iStartDate:$("#start-date"),iEndDate:$("#end-date"),rSettled:$("#vessel-settled"),rNoSettled:$("#no-vessel-settled"),rSettledPay:$("#vessel-pay"),rSettledNotNeeded:$("#vessel-no-need-settled")},this.options=e,initSelect(this.uiElems.sBfBillName,e.nameList,!0),initSelect(this.uiElems.sBfVehicle,e.vehList,!0),initSelect(this.uiElems.sBfDest,e.destList,!0),initSelect(this.uiElems.sBfVehContact,e.contactNameList,!0),this.uiElems.rNoSettled.iCheck("check"),this.uiElems.iStartDate.val(""),this.uiElems.iEndDate.val(""),this.uiElems.sBfBillName.select2({allowClear:!0}),this.uiElems.sBfVehicle.select2({allowClear:!0}),this.uiElems.sBfDest.select2({allowClear:!0}),this.selectedVeh,this.currSelected=0,this.settledState="未结算",this.sDate=null,this.eDate=null,this._selectFliterFunc=function(e,t){this.currSelected=e,this.isAllEmpty()},this._dateFilterFunc=function(e,t,l){var i=this.uiElems.iStartDate.val(),a=this.uiElems.iEndDate.val(),s=!1;e&&t?s=!isEmpty(i)&&!isEmpty(a):e?s=isEmpty(this.uiElems.iStartDate.val()):t&&(s=isEmpty(this.uiElems.iEndDate.val())),s&&(this.currSelected=5)}};QueryFilterD.prototype.getQueryParams=function(){var e=getSelectValue(this.uiElems.sBfBillName),t=getSelectValue(this.uiElems.sBfDest),l=this.uiElems.iStartDate.val(),i=this.uiElems.iEndDate.val(),a=!isEmpty(l)&&!isEmpty(i);return{fName:e||null,fVeh:this.selectedVeh?this.selectedVeh:null,fDest:t||null,fSettledState:this.settledState,fDate1:a?this.sDate.toISOString():null,fDate2:a?this.eDate.toISOString():null}},QueryFilterD.prototype.getVehicleName=function(){return this.selectedVeh},QueryFilterD.prototype.eventHandler=function(t){var l=this;l.uiElems.sBfBillName.on("change",function(){l._selectFliterFunc(1,t)}),l.uiElems.rNoSettled.on("ifChecked",function(){l.settledState="未结算",l._selectFliterFunc(2,t)}),l.uiElems.rSettled.on("ifChecked",function(){l.settledState="已结算",l._selectFliterFunc(2,t)}),l.uiElems.rSettledPay.on("ifChecked",function(){l.settledState="已付款",l._selectFliterFunc(2,t)}),l.uiElems.rSettledNotNeeded.on("ifChecked",function(){l.settledState="不需要结算",l._selectFliterFunc(2,t)}),l.uiElems.sBfVehicle.on("change",function(e){l.selectedVeh=e.val,"无-取消选择"===l.selectedVeh&&(l.selectedVeh=""),l._selectFliterFunc(3,t)}),l.uiElems.sBfVehContact.on("change",function(){l.currSelected=6}),l.uiElems.sBfDest.on("change",function(){l._selectFliterFunc(4,t)}),l.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(e){e.preventDefault(),e.stopImmediatePropagation(),l.sDate=e.date.startOf("day"),l.uiElems.endDateGrp.data("DateTimePicker").setMinDate(e.date),l._dateFilterFunc(!0,!0,t)}),l.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(e){e.preventDefault(),e.stopImmediatePropagation(),l.eDate=e.date.endOf("day"),l.uiElems.startDateGrp.data("DateTimePicker").setMaxDate(e.date),l._dateFilterFunc(!0,!0,t)}),l.uiElems.iStartDate.on("change",function(e){e.stopImmediatePropagation(),l._dateFilterFunc(!0,!1,t)}),l.uiElems.iEndDate.on("change",function(e){e.stopImmediatePropagation(),l._dateFilterFunc(!1,!0,t)})},QueryFilterD.prototype.isAllEmpty=function(){var e=getSelectValue(this.uiElems.sBfDest),t=getSelectValue(this.uiElems.sBfBillName),l=this.uiElems.iStartDate.val(),i=this.uiElems.iEndDate.val();return isEmpty(this.selectedVeh)&&isEmpty(e)&&isEmpty(t)&&isEmpty(l)&&isEmpty(i)},QueryFilterD.prototype.updateOptions=function(e,t){var a=this.selectedVeh,l=getSelectValue(this.uiElems.sBfVehContact),s=getSelectValue(this.uiElems.sBfDest),n=getSelectValue(this.uiElems.sBfBillName),i={vehList:[],destList:[],contactNameList:[]},r=[],o=!1;if(6!==this.currSelected||l||(a="",this.selectedVeh="",o=!0),a||3!==this.currSelected||(l=null),t)i=this.options,(r=e).forEach(function(e){e.ship_to&&i.destList.indexOf(e.ship_to)<0&&i.destList.push(e.ship_to)});else{var c,d,h=[],p=[],u=[];if(l){var f=this.options.vehPersonMap;for(var m in f)f[m]===l&&u.push(m)}if(e.forEach(function(e){var t=!1;if(o)t=!1;else if(u.length){if(0<=u.indexOf(e.vehicle_vessel_name))t=!0;else for(c=0;c<e.bills.length;++c)for(d=0;d<e.bills[c].vehicles.length&&!t;++d)if(0<=u.indexOf(e.bills[c].vehicles[d].veh_name)){t=!0;break}}else if(a){if(a===e.vehicle_vessel_name)t=!0;else for(c=0;c<e.bills.length;++c)for(d=0;d<e.bills[c].vehicles.length&&!t;++d)if(e.bills[c].vehicles[d].veh_name===a){t=!0;break}}else t=!0;var l=!s||s===e.ship_to,i=!n||n===e.ship_name;if(t&&l&&i&&(r.push(e),e.ship_to&&p.indexOf(e.ship_to)<0&&p.push(e.ship_to),0===u.length))for(e.vehicle_vessel_name&&h.indexOf(e.vehicle_vessel_name)<0&&h.push(e.vehicle_vessel_name),c=0;c<e.bills.length;++c)for(d=0;d<e.bills[c].vehicles.length;++d)h.indexOf(e.bills[c].vehicles[d].veh_name)<0&&h.push(e.bills[c].vehicles[d].veh_name)}),i.vehList=sort_pinyin(u.length?u:h),i.destList=sort_pinyin(p),6===this.currSelected)this.isAllEmpty()&&!l&&(i.vehList=this.options.vehList,i.destList=this.options.destList);else if(i.vehList.length){var _=this.options.vehPersonMap;i.vehList.forEach(function(e){var t=_[e];t&&i.contactNameList.indexOf(t)<0&&i.contactNameList.push(t)}),i.contactNameList=sort_pinyin(i.contactNameList)}}var v=a?this.options.vehPersonMap[a]:null;return 2===this.currSelected?(initSelect(this.uiElems.sBfVehicle,i.vehList,!0),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),initSelect(this.uiElems.sBfDest,i.destList,!0,s),initSelect(this.uiElems.sBfVehContact,i.contactNameList,!0,v)):3===this.currSelected?(initSelect(this.uiElems.sBfDest,i.destList,!0,s),v?this.uiElems.sBfVehContact.val(v):unselected(this.uiElems.sBfVehContact)):6===this.currSelected?(initSelect(this.uiElems.sBfVehicle,i.vehList,!0),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),initSelect(this.uiElems.sBfDest,i.destList,!0),l||initSelect(this.uiElems.sBfVehContact,this.options.contactNameList,!0)):(4===this.currSelected?(initSelect(this.uiElems.sBfVehicle,i.vehList,!0),this.uiElems.sBfVehicle.select2("val",this.selectedVeh)):(initSelect(this.uiElems.sBfVehicle,i.vehList,!0),this.uiElems.sBfVehicle.select2("val",this.selectedVeh),initSelect(this.uiElems.sBfDest,i.destList,!0,s)),initSelect(this.uiElems.sBfVehContact,i.contactNameList,!0,v)),r};
//# sourceMappingURL=settle_vessel.js.map
