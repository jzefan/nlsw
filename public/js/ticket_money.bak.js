function QueryFilterD(e,t){this.currSelected=0;var i=this;this.uiElems={sBfBillName:$("#bf-bill-name"),sBfSerialNumber:$("#bf-serial-number"),sBfDest:$("#bf-destination"),startDateGrp:$("#start-date-grp"),endDateGrp:$("#end-date-grp"),iStartDate:$("#start-date"),iEndDate:$("#end-date")},this.options=e,this.sDate=null,this.eDate=null,initSelect(this.uiElems.sBfBillName,e.nameList,!0),initSelect(this.uiElems.sBfSerialNumber,e.serials,!0),initSelect(this.uiElems.sBfDest,e.destList,!0),this.uiElems.iStartDate.val(""),this.uiElems.iEndDate.val(""),this._selectFliterFunc=function(e,t){this.currSelected=e,t(this.isAllEmpty()?!0:!1)},this._dateFilterFunc=function(e,t,i){var s=this.uiElems.iStartDate.val(),l=this.uiElems.iEndDate.val(),a=!1;e&&t?a=!isEmpty(s)&&!isEmpty(l):e?a=isEmpty(this.uiElems.iStartDate.val()):t&&(a=isEmpty(this.uiElems.iEndDate.val())),a&&(this.currSelected=5,i(!1))},i.uiElems.sBfBillName.on("change",function(){i._selectFliterFunc(1,t)}),i.uiElems.sBfSerialNumber.on("change",function(){i._selectFliterFunc(2,t)}),i.uiElems.sBfDest.on("change",function(){i._selectFliterFunc(4,t)}),i.uiElems.startDateGrp.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(e){e.preventDefault(),e.stopImmediatePropagation(),i.sDate=e.date.startOf("day"),i.uiElems.endDateGrp.data("DateTimePicker").setMinDate(e.date),i._dateFilterFunc(!0,!0,t)}),i.uiElems.endDateGrp.datetimepicker(getDateTimePickerOptions()).on("dp.change",function(e){e.preventDefault(),e.stopImmediatePropagation(),i.eDate=e.date.endOf("day"),i.uiElems.startDateGrp.data("DateTimePicker").setMaxDate(e.date),i._dateFilterFunc(!0,!0,t)}),i.uiElems.iStartDate.on("change",function(e){e.stopImmediatePropagation(),i._dateFilterFunc(!0,!1,t)}),i.uiElems.iEndDate.on("change",function(e){e.stopImmediatePropagation(),i._dateFilterFunc(!1,!0,t)})}$(function(){"use strict";function e(e,t){v!=e&&("CUSTOMER"===v?(D.removeClass("btn-primary"),D.addClass("btn-default")):"COLLECTION"===v&&(y.removeClass("btn-primary"),y.addClass("btn-default")),t.removeClass("btn-default"),t.addClass("btn-primary"),v=e,w.reset(d(local_dbData)),n())}function t(e){H=e,w.reset(d(local_dbData)),n()}function i(e){for(var t=h.find("tr").length;t--;)for(var i=getRowChildren(h,t),l=getTableCellChildren(i,2).text(),a=0;a<e.length;++a)if(e[a].serial_number===l){i.remove();break}T.prop("checked",e.length===h.find("tr").length),s()}function s(){if(b.length?(setHtmlElementDisabled(R,!1),setHtmlElementDisabled(C,!1)):(setHtmlElementDisabled(R,!0),setHtmlElementDisabled(C,!0)),g.length)if(setHtmlElementDisabled(V,1!=g.length),setHtmlElementDisabled(N,1!=g.length),B.length){for(var e=0,t=0,i=0;i<g.length;++i)"已开票"===g[i].status?++e:"已回款"===g[i].status&&++t;setHtmlElementDisabled(B,0===e),setHtmlElementDisabled(O,0===t)}else{setHtmlElementDisabled(k,!1);for(var s=0;s<g.length;++s)if("已开票"===g[s].status){setHtmlElementDisabled(L,!1);break}1===g.length&&setHtmlElementDisabled(x,!1)}else setHtmlElementDisabled(V,!0),B.length?(setHtmlElementDisabled(B,!0),setHtmlElementDisabled(O,!0),setHtmlElementDisabled(N,!0)):(setHtmlElementDisabled(x,!0),setHtmlElementDisabled(L,!0),setHtmlElementDisabled(k,!0))}function l(){var e=g[0],t='<div class="row form-horizontal"><div class="col-md-10">',s='<div class="form-group"><label for="{0}" class="control-label col-sm-4">开票号</label><div class="input-group col-sm-8"><input id="{1}" type="text" name="{2}" class="form-control"></div></div>';t+=s.format(e.serial_number,e.serial_number,e.serial_number)+"</div></div>",bootbox.dialog({message:t,title:"开票:请输入票号",buttons:{cancel:{label:"取消",className:"btn-default"},main:{label:"确定",className:"btn-primary",callback:function(){var t="#"+e.serial_number;e.ticket_no=$(t).val(),e.ticket_date=new Date,e.ticket_person=local_user.userid,e.status="已开票",ajaxRequestHandle("/settle_ticket","POST",[e],"开票",function(){i([e])})}}}})}function a(){var e=g[0],t='<div class="row form-horizontal"><div class="col-md-10">',i='<div class="form-group"><label for="{0}" class="control-label col-sm-4">实收价格</label><div class="input-group col-sm-8"><input id="{1}" type="text" name="{2}" class="form-control"></div></div>';t+=i.format(e.serial_number,e.serial_number,e.serial_number)+"</div></div>",bootbox.dialog({message:t,title:"请输入实收价格",buttons:{cancel:{label:"取消",className:"btn-default"},main:{label:"确定",className:"btn-primary",callback:function(){var t="#"+e.serial_number,i=$(t).val();i>0?(e.real_price=i,ajaxRequestHandle("/settle_real_price","POST",{sno:e.serial_number,price:i},"实收价格",function(){for(var t=h.find("tr").length,s=0;s<t;++s){var l=getRowChildren(h,s),a=getTableCellChildren(l,2).text();if(a===e.serial_number){var n="";n=i!=e.price?'<code style="color:red;font-weight:bold">'+getStrValue(i)+"</code>":'<code style="color:green">'+getStrValue(e.price)+"</code>",getTableCellChildren(l,6).html(n);break}}})):bootbox.alert("无效的价格")}}}})}function n(){h.empty(),b=[],g=[];var e=[],t=0,i=0,a=0;_.forEach(function(s){(0===H&&"已结算"===s.status||1===H&&"已开票"===s.status||2===H&&"已回款"===s.status)&&(B.length||"CUSTOMER"===v&&"客户结算"===s.settle_type||"COLLECTION"===v&&"代收代付结算"===s.settle_type)&&(e.push(o(s)),b.push(s),t+=s.ship_number,i+=s.ship_weight,a+=s.price)}),h.append(e.join("\n")),T.prop("checked",!1),s(),h.find("tr").on("click",function(){r($(this),!0)}).on("dblclick",function(){l()}),$(".select-item").on("click",function(e){e.stopImmediatePropagation(),r($(this).closest("tr"),!1)}),$('[data-toggle="popover"]').popover({trigger:"hover",html:!0,placement:"bottom"}),$(".td-icon").on("click",function(e){e.stopImmediatePropagation(),e.preventDefault();var t=$(this).closest("tr"),i=t.index(),l=b[i];"已结算"!=l.status?bootbox.alert("当前选择的结算纪录状态为"+l.status+", 不能删除!"):bootbox.confirm("您是否真的要删除此结算数据?",function(e){e&&ajaxRequestHandle("/delete_settle","POST",{allSelected:[l],which:v},"no_message",function(){for(var e=0;e<g.length;++e)if(g[e].serial_number===l.serial_number){g.remove(e);break}for(e=0;e<f.length;++e)if(f[e].serial_number===l.serial_number){f.remove(e);break}b.remove(i),t.remove(),$("#curr-settle-num").text(b.length),s(),bootbox.alert("删除成功!")})})}),$("#curr-settle-num").text(b.length),$("#lb-total-num").text(t),$("#lb-total-weight").text(getStrValue(i)),$("#lb-total-amount").text(getStrValue(a))}function r(e,t){for(var i=b[e.index()],l=!1,a=0;a<g.length;++a)if(g[a].serial_number===i.serial_number){g.remove(a),l=!0;break}l?e.removeClass("invoice-highlighted"):(g.push(i),e.addClass("invoice-highlighted")),t&&e.find('input[type="checkbox"]').prop("checked",!l),T.prop("checked",g.length===b.length),s()}function o(e){var t=getStrByStatus(e.status,e.status),i='<tr data-toggle="popover" title="" data-content=""><td align="center"><input type="checkbox" class="select-item" /></td>',s="";return s=isExist(e.real_price)&&0!=e.real_price&&e.real_price!=e.price?'<code style="color:red;font-weight:bold">'+getStrValue(e.real_price)+"</code>":'<code style="color:green">'+getStrValue(e.price)+"</code>",i+='<td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td align="center" style="cursor:pointer" class="td-icon"><i title="删除" class="fa fa-trash-o redlink"></i></td></tr>',i.format(t,e.serial_number,e.settle_type,e.billing_name,getStrValue(e.price),s,e.ship_number,getStrValue(e.ship_weight),isEmpty(e.settle_date)?"":moment(e.settle_date).format("YYYY-MM-DD"),e.settler?e.settler:"",isEmpty(e.ticket_date)?"":moment(e.ticket_date).format("YYYY-MM-DD"),e.ticket_no?e.ticket_no:"")}function c(e,t,i){var s="";if("已结算"===e.status){var l=[];(e.settle_flag&E)===E&&l.push("客户"),(e.settle_flag&S)===S&&l.push("代收付"),s=getStrByStatus(l.join(",")+"已结算",e.status)}else s=getStrByStatus(e.status,e.status);for(var a,n,r=getInvoicePriceInfo(e),o=u(e,r.totalCustomerPrice,r.totalVehPrice),c="",d=0;d<e.invoices.length;++d){var m=e.invoices[d];if(m.inv_no===i.inv_no){"客户结算"===t?(a=m.veh_ves_name,n=getStrValue(m.price)):"代收代付结算"===t&&(a="",n=getStrValue(e.collection_price)),c=m.ship_to;break}}var h=getStrValue(e.thickness)+"*"+getStrValue(e.width)+"*"+e.len,f="<tr {0}><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td><td>{6}</td><td>{7}</td><td>{8}</td><td>{9}</td><td>{10}</td><td>{11}</td><td>{12}</td></tr>";return f.format(o,s,getOrder(e.order_no,e.order_item_no),e.bill_no,h,e.billing_name,a,c,n,i.num,getStrValue(i.weight),getStrValue(n*i.weight),date2Str(e.shipping_date))}function u(e,t,i){var s=e.order+" "+e.bill_no,l='data-toggle="popover" title="'+s+'" data-content="客户价格: {0}<br />车船价格: {1}<br />代收代付价格: {2}<br />厚度: {3}<br />宽度: {4}<br />长度: {5}<br />尺寸: {6}<br />牌号: {7}<br />销售部门: {8}<br />发货仓库: {9}<br />合同号: {10}<br />"';return l.format(getStrValue(t),getStrValue(i),getStrValue(e.collection_price*e.total_weight),getStrValue(e.thickness),getStrValue(e.width),getStrValue(e.len),e.size_type?e.size_type:"",e.brand_no?e.brand_no:"",e.sales_dep?e.sales_dep:"",e.ship_warehouse?e.ship_warehouse:"",e.contract_no?e.contract_no:"")}function d(e){var t=e,i={serials:[],destList:[],nameList:[]};return B.length?t.forEach(function(e){(1===H&&"已开票"===e.status||2===H&&"已回款"===e.status)&&(i.nameList.indexOf(e.billing_name)<0&&i.nameList.push(e.billing_name),i.serials.indexOf(e.serial_number)<0&&i.serials.push(e.serial_number),i.destList.indexOf(e.ship_to)<0&&i.destList.push(e.ship_to))}):t.forEach(function(e){(1===H&&"已开票"===e.status||0===H&&"已结算"===e.status)&&("CUSTOMER"===v&&"客户结算"===e.settle_type||"COLLECTION"===v&&"代收代付结算"===e.settle_type)&&(i.nameList.indexOf(e.billing_name)<0&&i.nameList.push(e.billing_name),i.serials.indexOf(e.serial_number)<0&&i.serials.push(e.serial_number),i.destList.indexOf(e.ship_to)<0&&i.destList.push(e.ship_to))}),i.serials.sort(),i.destList=sort_pinyin(i.destList),i.nameList=sort_pinyin(i.nameList),i}function m(e){_=w.updateOptions(f,e),n()}var h=$("#table-tbody"),f=local_dbData,p=[],b=[],g=[],_=f,v="CUSTOMER",E=1,S=2,D=$("#customer-btn"),y=$("#collection-btn"),k=$("#settle-delete"),x=$("#settle-ticket"),L=$("#settle-ticket-cancel"),B=$("#settle-money"),O=$("#settle-money-cancel"),C=$("#filter"),R=$("#search-export"),V=$("#show-detail"),N=$("#real-price-input"),H=0;B.length&&(H=1);var w=new QueryFilterD(d(local_dbData),m);$("#first-th").html('<input id="select-all" type="checkbox" data-toggle="tooltip" data-placement="bottom" title="选择所有记录" />');var T=$("#select-all");n(),elementEventRegister(T,"click",function(){$(this).is(":checked")?($(".select-item").prop("checked",!0),g=b,h.find("tr").addClass("invoice-highlighted")):($(".select-item").prop("checked",!1),g=[],h.find("tr").removeClass("invoice-highlighted")),s()}),elementEventRegister(D,"click",function(){e("CUSTOMER",$(this))}),elementEventRegister(y,"click",function(){e("COLLECTION",$(this))}),elementEventRegister(x,"click",l),elementEventRegister(L,"click",function(){bootbox.confirm("您是否真的要取消所选择的已开票数据?",function(e){if(e){var t=[];g.forEach(function(e){"已开票"===e.status&&(e.status="已结算",e.ticket_no="",e.ticket_date=null,e.ticket_person="",t.push(e))}),ajaxRequestHandle("/settle_ticket","POST",t,"开票取消",function(){i(t)})}})}),elementEventRegister(k,"click",function(){for(var e=0;e<g.length;++e)if("已结算"!=g[e].status)return void bootbox.alert("选择的结算纪录中存在状态["+g[e].status+"], 不能删除!");bootbox.confirm("您是否真的要删除选择的结算数据?",function(e){e&&ajaxRequestHandle("/delete_settle","POST",{allSelected:g,which:v},"no_message",function(){for(var e=f.length;e--;)for(var t=f[e],i=0;i<g.length;++i)if(g[i].serial_number===t.serial_number){f.remove(e),g.remove(i);break}n(),bootbox.alert("删除成功!")})})}),elementEventRegister(B,"click",function(){var e=[];g.forEach(function(t){"车船结算"!=t.settle_type&&(t.status="已回款",t.return_money_date=new Date,t.return_person=local_user.userid,e.push(t))}),ajaxRequestHandle("/settle_money","POST",e,"回款",function(){i(e)})}),elementEventRegister(O,"click",function(){bootbox.confirm("取消回款: 您是否真的要取消所选择的已回款数据?",function(e){if(e){var t=[];g.forEach(function(e){"已回款"===e.status&&(e.status="已开票",e.return_person="",e.return_money_date=null,t.push(e))}),ajaxRequestHandle("/settle_ticket","POST",t,"回款取消",function(){i(t)})}})}),elementEventRegister(V,"click",function(){var e=g[0];$("body").css({cursor:"wait"}),$.get("/get_settle_bill",{fSerial:e.serial_number},function(t){var i=jQuery.parseJSON(t);if(i.ok){p=i.bills;var s="",l=e.bills;p.forEach(function(t){l.forEach(function(i){i.bill_id==t._id&&(s+=c(t,e.settle_type,i))})});var a=$("#settle-bill-tbody");a.empty(),a.append(s),$('[data-toggle="popover"]').popover({trigger:"hover",html:!0,placement:"bottom"}),$("#settle-detail-dialog").modal({backdrop:"static",keyboard:!1}).modal("show")}else p=[];$("body").css({cursor:"default"})})}),elementEventRegister($("#settle-radio"),"ifChecked",function(){t(0)}),elementEventRegister($("#ticket-radio"),"ifChecked",function(){t(1)}),elementEventRegister($("#money-radio"),"ifChecked",function(){t(2)}),elementEventRegister(N,"click",a),elementEventRegister(R,"click",function(){if(g.length>0){var e=g[0],t="",i=e.bills;p.forEach(function(s){i.forEach(function(i){i.bill_id==s._id&&(t+=c(s,e.settle_type,i))})});var s=$("#settle-bill-tbody");s.empty(),s.append(t),tableToExcel($("#table-content").html(),"data")}else bootbox.alert("请选择要导出的结算记录")}),elementEventRegister(C,"click",function(){$("#filter-ui").toggle()})}),QueryFilterD.prototype.isAllEmpty=function(){var e=getSelectValue(this.uiElems.sBfSerialNumber),t=getSelectValue(this.uiElems.sBfDest),i=getSelectValue(this.uiElems.sBfBillName),s=this.uiElems.iStartDate.val(),l=this.uiElems.iEndDate.val();return isEmpty(e)&&isEmpty(t)&&isEmpty(i)&&isEmpty(s)&&isEmpty(l)},QueryFilterD.prototype.updateOptions=function(e,t){var i=getSelectValue(this.uiElems.sBfSerialNumber),s=getSelectValue(this.uiElems.sBfDest),l=getSelectValue(this.uiElems.sBfBillName),a={serials:[],destList:[],nameList:[]},n=[];if(t)initSelect(this.uiElems.sBfBillName,this.options.nameList,!0),initSelect(this.uiElems.sBfSerialNumber,this.options.serials,!0),initSelect(this.uiElems.sBfDest,this.options.destList,!0),n=e;else{var r=this.uiElems.iStartDate.val(),o=this.uiElems.iEndDate.val(),c=!isEmpty(r)&&!isEmpty(o);e.forEach(function(e){var t=!i||i===e.serial_number,u=!s||s===e.ship_to,d=!l||l===e.billing_name,m=moment(e.settle_date);t&&u&&d&&(!c||m.isAfter(r,"minute")&&m.isBefore(o,"minute"))&&(a.serials.indexOf(e.serial_number)<0&&a.serials.push(e.serial_number),a.destList.indexOf(e.ship_to)<0&&a.destList.push(e.ship_to),n.push(e))}),a.serials.sort(),a.destList=sort_pinyin(a.destList),a.nameList=sort_pinyin(a.nameList),2===this.currSelected?initSelect(this.uiElems.sBfDest,a.destList,!0,s):3===this.currSelected?(initSelect(this.uiElems.sBfDest,a.destList,!0,s),initSelect(this.uiElems.sBfSerialNumber,a.serials,!0,i)):4===this.currSelected?initSelect(this.uiElems.sBfSerialNumber,a.serials,!0,i):(initSelect(this.uiElems.sBfSerialNumber,a.serials,!0,i),initSelect(this.uiElems.sBfDest,a.destList,!0,s))}return n},QueryFilterD.prototype.reset=function(e){this.options=e,initSelect(this.uiElems.sBfBillName,this.options.nameList,!0),initSelect(this.uiElems.sBfSerialNumber,this.options.serials,!0),initSelect(this.uiElems.sBfDest,this.options.destList,!0)};
//# sourceMappingURL=ticket_money.js.map
