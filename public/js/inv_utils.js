var ShipBillD=function(e){this.no=e,this.left_num=0,this.allBills=[]};ShipBillD.prototype.getOptionWithTip=function(e){return'<option {0} value="{1}" data-toggle="tooltip" title="{2}" data-html="true">{3}</option>'.format(0<this.left_num?"":"disabled",this.no,this.getTip(e),this.no)},ShipBillD.prototype.getTip=function(n){var l=[];return this.allBills.forEach(function(e){e.billing_name===n&&l.push(e.tip)}),l.join("\n")},ShipBillD.prototype.getOptions=function(n){var e=[],l={};this.allBills.forEach(function(e){e.billing_name===n&&(e.bill_no in l?l[e.bill_no].push(e):l[e.bill_no]=[e])});var i=Object.keys(l);i.sort();for(var t=0;t<i.length;++t){var s=i[t],a=[],o=0;l[s].forEach(function(e){a.push(e.tip),o+=e.left_num});var r='data-toggle="tooltip" title="{0}" data-html="true"'.format(a.join("\n"));0<o&&e.push('<option value="'+s+'" '+r+">"+s+"</option>")}return e},ShipBillD.prototype.getBillTips=function(n,l){var i=0,t=[];return this.allBills.forEach(function(e){e.billing_name==n&&e.bill_no==l&&(i+=e.left_num,t.push(e.tip))}),{left_num:i,tip:t.join("\n")}},ShipBillD.prototype.find=function(e){for(var n={found:!1},l=0;l<this.allBills.length;++l)if(sameBill(e,this.allBills[l])){n.found=!0,n.bill=this.allBills[l],n.index=l;break}return n},ShipBillD.prototype.findOne=function(e,n){for(var l=0;l<this.allBills.length;++l){var i=this.allBills[l];if(n===getOrder(i.order_no,i.order_item_no)&&e===i.bill_no)return i}return!1},ShipBillD.prototype.add=function(e){e.selected=!1,e.select_number=0,(e.left=0)<=e.left_num&&(this.left_num+=e.left_num,e.left=e.left_num),setTip(e,0),e.prev_select_num=0,e.prev_wnum_danding=0,e.wnum=0,e.wnum_danding=0,e.vehicles=[],this.allBills.push(e)},ShipBillD.prototype.save=function(){this.allBills.forEach(function(e){e.selected&&(e.selected=!1,e.select_number=0,e.left=e.left_num)})},ShipBillD.prototype.saveToContinue=function(){this.allBills.forEach(function(e){e.selected&&(e.prev_select_num=0<e.prev_select_num?e.prev_select_num+e.select_number:e.select_number,e.select_number=0,e.left=e.left_num,0===e.block_num&&(e.prev_wnum_danding=0<e.prev_wnum_danding?e.prev_wnum_danding+e.wnum_danding:e.wnum_danding,e.wnum_danding=0))})},ShipBillD.prototype.selectedWithWaybillNum=function(e,n,l){var i=this.allBills[e];i.openToNew=n,0<l&&(i.selected=!0,n?(i.prev_select_num=l,i.select_number=0):(i.select_number=l,0<=i.left_num&&(this.left_num-=i.left_num,i.left_num=i.left,i.left=i.left_num+l,this.left_num+=i.left_num)),setTip(i,l))},ShipBillD.prototype.selected=function(e,n){for(var l=[],i=0,t=this.allBills.length;i<t;++i)0<this.allBills[i].left_num&&this.allBills[i].bill_no===e&&(this.allBills[i].selected=!0,this.allBills[i].inner_waybill_no=n,l.push(this.allBills[i]));return l},ShipBillD.prototype.hasSelected=function(){for(var e=0;e<this.allBills.length;++e){var n=this.allBills[e];if(n.selected&&0<n.select_number&&(0<n.block_num||0<n.wnum_danding))return!0}return!1},ShipBillD.prototype.getAllSelected=function(){var t=[];return this.allBills.forEach(function(e){if(e.selected){var n=0<e.prev_select_num?e.prev_select_num+e.select_number:e.select_number,l=0,i=0;e.vehicles.forEach(function(e){i+=e.send_num}),0<e.block_num||(l=n,n=0<e.prev_wnum_danding?e.prev_wnum_danding+e.wnum_danding:e.wnum_danding),0<i&&(n=i),(0<n||0<l)&&t.push({bill_id:e._id,num:n,weight:l,vehicles:e.vehicles.slice(0)})}}),t},ShipBillD.prototype.clearVehicle=function(n){this.allBills.forEach(function(e){e.selected&&e.inner_waybill_no&&(e.inner_waybill_no.substring(0,17)===n&&(e.vehicles=[],e.inner_waybill_no=""))})};var waybillHandler={billsInfo:[],queryWaybillData:{},shipName:"",openToNew:!(ShipBillD.prototype.vehicleComplete=function(i,t,s){this.allBills.forEach(function(e){if(e.selected&&e.inner_waybill_no===i&&0<e.select_number){var n=0,l=0;l=0<e.block_num?(n=e.select_number,toFixedNumber(e.select_number*e.weight,3)):(n=e.wnum_danding,toFixedNumber(e.select_number,3)),e.vehicles.push({inner_waybill_no:i,veh_name:t,veh_ship_from:s,send_num:n,send_weight:l}),void 0===e.prev_select_num?e.prev_select_num=e.select_number:e.prev_select_num+=e.select_number,void 0===e.prev_wnum_danding?e.prev_wnum_danding=0<e.wnum_danding?e.wnum_danding:0:e.prev_wnum_danding+=0<e.wnum_danding?e.wnum_danding:0,e.select_number=0,e.wnum_danding=0,e.left=e.left_num,e.inner_waybill_no=""}})}),init:function(e){this.shipName=e},setName:function(e){this.shipName=e},reset:function(e){this.billsInfo=[],this.shipName=e,this.openToNew=!1},resetWithQueryData:function(e,n){var l=null;return this.billsInfo=[],this.openToNew=!1,this.queryWaybillData=e,0<=n&&n<e.invoices.length&&(l=e.invoices[n],this.shipName=l.ship_name),l},save:function(){this.billsInfo.forEach(function(e){e.save()})},saveInvoice:function(e){if(!$.isEmptyObject(this.queryWaybillData)&&void 0!==this.queryWaybillData.invoices)for(var n=0,l=this.queryWaybillData.invoices.length;n<l;++n)if(this.queryWaybillData.invoices[n].waybill_no===e.waybill_no){this.queryWaybillData.invoices[n].vehicle_vessel_name=e.vehicle_vessel_name,this.queryWaybillData.invoices[n].ship_name=e.ship_name,this.queryWaybillData.invoices[n].ship_customer=e.ship_customer,this.queryWaybillData.invoices[n].ship_from=e.ship_from,this.queryWaybillData.invoices[n].ship_to=e.ship_to,this.queryWaybillData.invoices[n].ship_date=e.ship_date,this.queryWaybillData.invoices[n].bills=e.bills,this.queryWaybillData.invoices[n].total_weight=e.total_weight,this.queryWaybillData.invoices[n].username=e.username,this.queryWaybillData.invoices[n].shipper=e.shipper,this.queryWaybillData.invoices[n].state=e.state;break}this.billsInfo.forEach(function(e){e.saveToContinue()})},addBill:function(e){var n=this.findCreate(e.order_no,!0);n.found&&n.data.find(e).found||n.data.add(e)},addBillAndTableRow:function(e,n,l){var i=this.findCreate(e.order_no,!0),t=i.data.find(e);i.found&&t.found?(i.data.selectedWithWaybillNum(t.index,this.openToNew,n),t.bill.vehicles=e.vehicles.slice(0),t.bill.wnum_danding=e.wnum_danding,t.bill.prev_wnum_danding=e.prev_wnum_danding,l(t.bill,i.data.getTip(this.shipName))):(e.openToNew=this.openToNew,e.selected=!0,this.openToNew?(e.prev_select_num=n,e.select_number=0):e.select_number=n,0<=e.left_num&&!this.openToNew&&(e.left=e.left_num+ +n,this.left_num+=e.left),setTip(e,n),i.data.allBills.push(e),l(e,i.data.getTip(this.shipName)))},addBillAndTableRow_1:function(e,n){var l=this.findCreate(e.order_no,!0),i=l.data.find(e);return l.found&&i.found?(0<n&&(i.bill.selected=!0,i.bill.prev_select_num=n,i.bill.select_number=0,i.bill.vehicles=e.vehicles.slice(0),i.bill.wnum_danding=e.wnum_danding,i.bill.prev_wnum_danding=e.prev_wnum_danding,setTip(i.bill,n)),{updatedBill:i.bill,tips:l.data.getTip(this.shipName)}):(e.openToNew=this.openToNew,e.selected=!0,this.openToNew?(e.prev_select_num=n,e.select_number=0):e.select_number=n,0<=e.left_num&&!this.openToNew&&(e.left=e.left_num+ +n,this.left_num+=e.left),setTip(e,n),l.data.allBills.push(e),{updatedBill:e,tips:l.data.getTip(this.shipName)})},addAndInsertTable:function(e,n,l){var i=this.findCreate(e,!1);return i.found?{bills:i.data.selected(n,l),tip:i.data.getTip(this.shipName),billtips:i.data.getBillTips(this.shipName,n)}:null},addAndInsertTable_1:function(e,n,l,i){var t=e.val(),s=this.findCreate(t,!1);if(!s.found)return!1;var a=n.val(),o=s.data.selected(a,l);if(0<o.length){i(o),e.find(":selected").prop("title",s.data.getTip(this.shipName));var r=s.data.getBillTips(this.shipName,a),u='option[value="{0}"]'.format(a),_=n.find(u);_.prop("title",r.tip),_.prop("disabled",0==r.left_num)}return 0<o.length},deleteTableRow:function(e,n,l,i){var t=this.findCreate(e.order_no,!1);t.found&&(void 0===e.prev_select_num&&(e.prev_select_num=0),n?(0<e.block_num?(e.select_number-=l.num,e.left_num+=l.num,t.data.left_num+=l.num):(e.select_number-=l.weight,e.wnum_danding-=l.num,e.left_num+=l.weight,t.data.left_num+=l.weight),setTip(e,0<e.select_number+e.prev_select_num?0<e.select_number+e.prev_select_num:0)):((e.select_number=0)<=e.left?(e.left_num=e.left,t.data.left_num+=e.left):e.left_num=0,setTip(e,0<e.prev_select_num?e.prev_select_num:0)),i(t.data.getBillTips(this.shipName,e.bill_no),t.data.getTip(this.shipName)))},updateShipNum:function(e,n,l){var i=this.findCreate(e.order_no,!1);i.found&&(0<=e.left_num&&(e.left_num-=n,e.select_number+=n,i.data.left_num-=n,0===e.block_num&&(Math.abs(e.left_num)<1e-5&&(e.left_num=0),Math.abs(e.select_number)<1e-5&&(e.select_number=0)),setTip(e,0<e.prev_select_num||e.openToNew?e.select_number+e.prev_select_num:e.select_number)),l(i.data.getBillTips(this.shipName,e.bill_no),i.data.getTip(this.shipName)))},findCreate:function(e,n){for(var l={found:!1},i=0;i<this.billsInfo.length;++i)if(this.billsInfo[i].no===e){l.found=!0,l.data=this.billsInfo[i];break}return!l.found&&n&&(this.billsInfo.push(new ShipBillD(e)),l.data=this.billsInfo[this.billsInfo.length-1]),l},getBill:function(e){for(var n=getTableCellChildren(e,1).text(),l=getTableCellChildren(e,2).text(),i=l.split("-"),t=0;t<this.billsInfo.length;++t)if(this.billsInfo[t].no===i[0]){var s=this.billsInfo[t].findOne(n,l);if(s)return s}return null},handleVehicleComplete:function(n,l,i){this.billsInfo.forEach(function(e){e.vehicleComplete(n,l,i)})},clearVehicles:function(n){this.billsInfo.forEach(function(e){e.clearVehicle(n)})},hasSelectedBills:function(){for(var e=0;e<this.billsInfo.length;++e)if(this.billsInfo[e].hasSelected())return!0;return!1},getSelectedBills:function(){var n=[];return this.billsInfo.forEach(function(e){Array.prototype.push.apply(n,e.getAllSelected())}),n},showSelectedBill:function(i,t,e){var s=!1;this.billsInfo.forEach(function(e){e.allBills.forEach(function(e){if(e.selected){var n=0<e.prev_wnum_danding?e.prev_wnum_danding+e.wnum_danding:e.wnum_danding,l=0<e.prev_select_num?e.prev_select_num+e.select_number:e.select_number;0<e.block_num?0<l&&(t(e,e.block_num,l,l*e.weight),e.inner_waybill_no=i,e.prev_select_num=0,e.select_number=l,s=!0):0<l&&0<n&&(t(e,e.total_weight,n,l),e.inner_waybill_no=i,e.prev_wnum_danding=0,e.wnum_danding=n,e.prev_select_num=0,e.select_number=l,s=!0)}})}),s&&e()},hasMixedBill:function(){for(var e=0,n=0;n<this.billsInfo.length;++n)for(var l=this.billsInfo[n],i=0;i<l.allBills.length;++i){var t=l.allBills[i];if(t.selected&&(e=0<t.block_num?2===e?3:1:1===e?3:2),3===e)return 3}return e},compare:function(e){for(var n=0,l=0;l<this.billsInfo.length;++l)for(var i=this.billsInfo[l],t=0;t<i.allBills.length;++t){var s=i.allBills[t];if(s.selected){++n;for(var a=!1,o=0;o<e.bills.length;++o){var r=e.bills[o];if(String(s._id)===String(r.bill_id)){a=0<s.block_num?s.select_number==r.num:s.select_number==r.weight&&s.wnum_danding==r.num;break}}if(!a)return!1}}return n==e.bills.length},insertSelectOptions:function(n,l){n.empty(),l||(l=this.shipName);var i=[],t=[];this.billsInfo.forEach(function(e){for(var n=0;n<e.allBills.length;++n)if(l===e.allBills[n].billing_name){0<e.left_num?t.push(e):i.push(e.getOptionWithTip(l));break}}),t.sort(function(e,n){return e.no>n.no?1:e.no<n.no?-1:0}),t.forEach(function(e){n.append(e.getOptionWithTip(l))}),i.forEach(function(e){n.append(e)}),unselected(n)},setQueryData:function(e){this.queryWaybillData=e},getWaybill:function(e){for(var n=this.queryWaybillData.invoices,l=0;l<n.length;++l)if(e==n[l].waybill_no)return n[l];return null},getBillsFromInvoice:function(l){var i=[],t=l.bills.length;return this.queryWaybillData.bills.forEach(function(e){for(var n=0;n<t;++n)if(String(l.bills[n].bill_id)===String(e._id)){0<e.block_num?e.wnum=l.bills[n].num:(e.wnum=l.bills[n].weight,e.prev_wnum_danding=0,e.wnum_danding=l.bills[n].num),e.vehicles=l.bills[n].vehicles.slice(0),i.push(e);break}}),i}};function sortObject(l){return Object.keys(l).sort().reduce(function(e,n){return e[n]=l[n],e},{})}function sameBill(e,n){return n.order_no===e.order_no&&n.order_item_no===e.order_item_no&&n.bill_no===e.bill_no}function setTip(e,n){0<e.block_num?e.tip="订单项次号:{0}, 提单号:{1}, 实际块数:{2}, 可用块数:{3}, 当前运单已用块数:{4}".format(e.order_item_no,e.bill_no,e.block_num,e.left_num,n):e.tip="订单项次号:{0}, 提单号:{1}, 实际重量:{2}, 剩余重量:{3}, 当前运单已用重量:{4}".format(e.order_item_no,e.bill_no,getStrValue(e.total_weight),getStrValue(e.left_num),getStrValue(n))}function getMaxInnerWaybillNo(e,n){var l=0;return e.forEach(function(e){e.invoices.forEach(function(e){e.inv_no===n&&e.vehicles.forEach(function(e){l=Math.max(l,parseInt(e.inner_waybill_no.substring(17)))})})}),++l}function inputEventRegister(e,n){0<e.length&&(e.on("focus",function(){$(this).one("mouseup",function(){return $(this).select(),!1}).select(),$(this).data("old",this.value||"")}),e.on("keyup paste",function(e){e.stopImmediatePropagation(),n($(this))}),e.ForceNumericOnly())}
//# sourceMappingURL=inv_utils.js.map
